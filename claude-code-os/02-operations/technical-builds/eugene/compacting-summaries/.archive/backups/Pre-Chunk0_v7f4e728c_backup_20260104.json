{
  "id": "70n97A6OmYCsHMmV",
  "name": "V4 Pre-Chunk 0: Intake & Client Identification",
  "versionId": "7f4e728c-a97d-411a-96f6-d2fc35f0b269",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "simple": false,
        "filters": {
          "labelIds": [
            "INBOX",
            "UNREAD",
            "Label_4133960118153091049"
          ],
          "q": "has:attachment"
        },
        "options": {
          "dataPropertyAttachmentsPrefixName": "attachment_",
          "downloadAttachments": true
        }
      },
      "name": "Gmail Trigger - Unread with Attachments",
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        112,
        480
      ],
      "id": "gmail-trigger-001",
      "credentials": {
        "gmailOAuth2": {
          "id": "aYzk7sZF8ZVyfOan",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Filter PDF and ZIP attachments only\nconst items = $input.all();\nconst filtered = [];\n\nfor (const item of items) {\n  // Gmail trigger stores attachments in item.binary, not item.json.attachments\n  if (!item.binary) continue;\n  \n  // Iterate over binary keys (attachment_0, attachment_1, etc.)\n  for (const [key, attachment] of Object.entries(item.binary)) {\n    const filename = attachment.fileName;\n    if (!filename) continue;\n    \n    const ext = filename.toLowerCase().split('.').pop();\n    \n    if (['pdf', 'zip'].includes(ext)) {\n      filtered.push({\n        json: {\n          emailId: item.json.id,\n          emailSubject: item.json.Subject || item.json.subject,\n          emailFrom: item.json.From || item.json.from,\n          emailDate: item.json.date,\n          attachmentKey: key,\n          filename: filename,\n          mimeType: attachment.mimeType,\n          size: attachment.fileSize\n        },\n        binary: {\n          data: attachment\n        }\n      });\n    }\n  }\n}\n\nreturn filtered;"
      },
      "name": "Filter PDF/ZIP Attachments",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        480
      ],
      "id": "filter-attachments-001"
    },
    {
      "parameters": {
        "url": "=https://gmail.googleapis.com/gmail/v1/users/me/messages/{{ $json.emailId }}/attachments/{{ $json.attachmentId }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "gmailOAuth2",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "name": "Download Attachment",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        560,
        480
      ],
      "id": "download-attachment-001",
      "credentials": {
        "gmailOAuth2": {
          "id": "aYzk7sZF8ZVyfOan",
          "name": "Gmail account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {
          "joinPages": true,
          "keepSource": "json"
        }
      },
      "name": "Extract Text from PDF",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        784,
        480
      ],
      "id": "extract-text-001"
    },
    {
      "parameters": {
        "jsCode": " // V4: Evaluate extraction quality for each PDF\n  const items = $input.all();\n  const results = [];\n\n  for (const item of items) {\n    const extractedText = item.json.text || '';\n    const wordCount = extractedText.trim().split(/\\s+/).length;\n\n    results.push({\n      json: {\n        ...item.json,\n        wordCount: wordCount,\n        needsOCR: wordCount < 10,\n        extractionQuality: wordCount < 10 ? 'poor' : 'good'\n      },\n      binary: item.binary  // ✅ Pass through binary data\n    });\n  }\n\n  return results;"
      },
      "name": "Evaluate Extraction Quality",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        480
      ],
      "id": "evaluate-extraction-001"
    },
    {
      "parameters": {
        "resource": "chat",
        "prompt": {
          "messages": [
            {
              "role": "system",
              "content": "You are an AI that extracts client company names from German real estate documents. Extract ONLY the client/investor company name. Return the name without any explanation or additional text."
            },
            {
              "content": "=Extract the client company name from this text:\n\n={{ $json.text }}"
            }
          ]
        },
        "options": {
          "maxTokens": 50,
          "temperature": 0.1
        },
        "requestOptions": {}
      },
      "name": "AI Extract Client Name",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1.1,
      "position": [
        1232,
        480
      ],
      "id": "ai-extract-client-001",
      "credentials": {
        "openAiApi": {
          "id": "xmJ7t6kaKgMwA1ce",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Normalize German client name for folder creation\n  function normalizeClientName(rawName) {\n    if (!rawName) return null;\n\n    return rawName\n      .toLowerCase()\n      .trim()\n      // Replace German characters\n      .replace(/ä/g, 'ae')\n      .replace(/ö/g, 'oe')\n      .replace(/ü/g, 'ue')\n      .replace(/ß/g, 'ss')\n      // Remove legal entities\n      .replace(/\\s*(gmbh|ag|kg|e\\.v\\.|mbh|co\\.|&\\s*co\\.?)\\s*/gi, '')\n      // Replace non-alphanumeric with underscore\n      .replace(/[^a-z0-9]/g, '_')\n      // Remove duplicate underscores\n      .replace(/_+/g, '_')\n      // Remove leading/trailing underscores\n      .replace(/^_|_$/g, '');\n  }\n\n  const items = $input.all();\n  const results = [];\n\n  for (const item of items) {\n    const aiResponse = item.json.message?.content || item.json.text;\n    const clientNameRaw = aiResponse.trim();\n    const clientNormalized = normalizeClientName(clientNameRaw);\n\n    results.push({\n      json: {\n        client_name_raw: clientNameRaw,\n        client_normalized: clientNormalized,\n        parent_folder_id: '1ikw3k-EgpVg_h2ySDdqdUFB7-FQyYDFm'\n      }\n    });\n  }\n\n  return results;"
      },
      "name": "Normalize Client Name",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        480
      ],
      "id": "normalize-name-001"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 762792134,
          "mode": "list",
          "cachedResultName": "Client_Registry",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI/edit#gid=762792134"
        },
        "options": {}
      },
      "name": "Lookup Client Registry",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1680,
        480
      ],
      "id": "lookup-registry-001",
      "credentials": {
        "googleApi": {
          "id": "VdNWQlkZQ0BxcEK2",
          "name": "Google Service Account account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Check if client exists in registry\n  const normalizeData = $('Normalize Client Name').first().json;\n  const clientNormalized = normalizeData.client_normalized;\n  const registryRows = $input.all();\n\n  // Skip header row\n  const clientRow = registryRows.slice(1).find(row =>\n    row.json.client_normalized === clientNormalized\n  );\n\n  if (clientRow) {\n    // Client exists\n    const subfolderIds = JSON.parse(clientRow.json.subfolder_ids_json || '{}');\n\n    return [{\n      json: {\n        ...normalizeData,\n        folders_exist: true,\n        root_folder_id: clientRow.json.root_folder_id,\n        subfolder_ids: subfolderIds,\n        registry_status: clientRow.json.status\n      }\n    }];\n  } else {\n    // New client\n    return [{\n      json: {\n        ...normalizeData,\n        folders_exist: false,\n        root_folder_id: null,\n        subfolder_ids: {},\n        registry_status: 'NEW'\n      }\n    }];\n  }"
      },
      "name": "Check Client Exists",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        480
      ],
      "id": "check-exists-001"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.client_normalized }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "isEmpty"
                    },
                    "id": "0757241b-e92b-4f8c-b0b4-be5e5c6fff0a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "no_client_identified"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.folders_exist }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "c6333268-d815-4b0f-807a-2c4c49fc29e9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create_folders"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.folders_exist }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    },
                    "id": "57d62868-ae39-45bf-93c1-86528a2bb677"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "folders_exist"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "name": "Decision Gate",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        2128,
        464
      ],
      "id": "decision-gate-001"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "zbxHkXOoD1qaz6OS",
          "mode": "list",
          "cachedResultUrl": "/workflow/zbxHkXOoD1qaz6OS",
          "cachedResultName": "Chunk 0: Folder Initialization (V4 - Parameterized)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "client_name": "={{ $json.client_name_raw }}",
            "client_normalized": "={{ $json.client_normalized }}",
            "parent_folder_id": "={{ $json.parent_folder_id }}"
          },
          "schema": [
            {
              "id": "client_name",
              "displayName": "client_name",
              "required": false,
              "type": "string"
            },
            {
              "id": "client_normalized",
              "displayName": "client_normalized",
              "required": false,
              "type": "string"
            },
            {
              "id": "parent_folder_id",
              "displayName": "parent_folder_id",
              "required": false,
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Execute Chunk 0 - Create Folders",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2352,
        288
      ],
      "id": "execute-chunk0-001"
    },
    {
      "parameters": {
        "jsCode": "// Handle unidentified client - send to manual queue\n  const items = $input.all();\n  const results = [];\n\n  for (const item of items) {\n    results.push({\n      json: {\n        status: 'FAILED',\n        reason: 'Client name could not be identified',\n        email_id: item.json.emailId,\n        email_subject: item.json.emailSubject,\n        timestamp: new Date().toISOString()\n      }\n    });\n  }\n\n  return results;"
      },
      "name": "Handle Unidentified Client",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2352,
        672
      ],
      "id": "handle-unknown-001"
    },
    {
      "parameters": {
        "jsCode": "// Client exists - prepare for Chunk 3 (classification)\n  const items = $input.all();\n  const results = [];\n\n  for (const item of items) {\n    results.push({\n      json: {\n        status: 'SUCCESS',\n        client_name: item.json.client_name_raw,\n        client_normalized: item.json.client_normalized,\n        root_folder_id: item.json.root_folder_id,\n        subfolder_ids: item.json.subfolder_ids,\n        ready_for_classification: true\n      }\n    });\n  }\n\n  return results;\n"
      },
      "name": "Prepare for Chunk 3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2352,
        480
      ],
      "id": "prepare-chunk3-001"
    }
  ],
  "connections": {
    "Gmail Trigger - Unread with Attachments": {
      "main": [
        [
          {
            "node": "Filter PDF/ZIP Attachments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter PDF/ZIP Attachments": {
      "main": [
        [
          {
            "node": "Download Attachment",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract Text from PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Attachment": {
      "main": [
        [
          {
            "node": "Extract Text from PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Text from PDF": {
      "main": [
        [
          {
            "node": "Evaluate Extraction Quality",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evaluate Extraction Quality": {
      "main": [
        [
          {
            "node": "AI Extract Client Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Extract Client Name": {
      "main": [
        [
          {
            "node": "Normalize Client Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Client Name": {
      "main": [
        [
          {
            "node": "Lookup Client Registry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lookup Client Registry": {
      "main": [
        [
          {
            "node": "Check Client Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Client Exists": {
      "main": [
        [
          {
            "node": "Decision Gate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decision Gate": {
      "main": [
        [
          {
            "node": "Handle Unidentified Client",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Chunk 0 - Create Folders",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare for Chunk 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
