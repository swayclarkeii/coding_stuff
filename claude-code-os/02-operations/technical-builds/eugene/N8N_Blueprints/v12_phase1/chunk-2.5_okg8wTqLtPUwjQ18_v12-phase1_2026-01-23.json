{
  "workflow": {
    "updatedAt": "2026-01-23T10:14:41.947Z",
    "createdAt": "2026-01-08T21:33:22.263Z",
    "id": "okg8wTqLtPUwjQ18",
    "name": "Chunk 2.5 - Client Document Tracking (Eugene Document Organizer)",
    "description": null,
    "active": true,
    "isArchived": false,
    "nodes": [
      {
        "parameters": {
          "inputSource": "passthrough"
        },
        "id": "trigger-1",
        "name": "Execute Workflow Trigger (Refreshed)",
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "typeVersion": 1.1,
        "position": [
          80,
          208
        ]
      },
      {
        "parameters": {
          "jsCode": "// Build Tier 1 Classification Prompt\n// Classify document into 1 of 4 broad categories\n\n// === Process ALL items, not just first ===\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  // === CRITICAL: Extract and preserve ALL file metadata fields ===\n  const fileId = item.json.fileId || item.json.body?.fileId || null;\n  const filename = item.json.fileName || item.json.filename || item.json.body?.fileName || item.json.body?.filename || 'unknown_file.pdf';\n  const fileUrl = item.json.fileUrl || item.json.body?.fileUrl || null;\n  \n  // FIX: Use actual emailFrom instead of hardcoded test email\n  const clientEmail = item.json.emailFrom || item.json.senderEmail || item.json.clientEmail || item.json.body?.emailFrom || item.json.body?.clientEmail || 'unknown@example.com';\n\n  // Tier 1 Prompt: Classify into 4 broad categories\n  const tier1Prompt = `You are a German real estate document classifier for AMA Capital.\n\nTASK: Classify this document into ONE of 4 broad categories based on the filename.\n\nFILENAME: ${filename}\nCLIENT: ${clientEmail}\n\nCATEGORIES:\n\n1. OBJEKTUNTERLAGEN (Property/Object Documents)\n   Keywords: Projekt, Beschreibung, Expose, Grundbuch, Kaufvertrag, Bau, Lageplan, Zeichnungen, Genehmigung, DIN276, DIN277, Werkvertrag, Flaeche\n   Examples: Project descriptions, land register, purchase agreements, building permits, construction drawings, calculations\n\n2. WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents)\n   Keywords: Verkauf, Preis, Bauzeitenplan, Liquiditaet, Vertrieb, Ausstattung, Teilung, Versicherung, Umsatzsteuer, BWA, Jahresabschluss, Finanzierung, Darlehen\n   Examples: Sales prices, construction schedules, insurance, VAT returns, financial statements, loan agreements\n\n3. RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents)\n   Keywords: Gesellschaft, Vertrag, Handelsregister, Gewerbe, Steuer, ID, Freistellung, Vollmacht\n   Examples: Partnership agreements, commercial register, business registration, tax ID, powers of attorney\n\n4. SONSTIGES (Miscellaneous)\n   Keywords: Gutachter, Korrespondenz, Sonstiges, Others\n   Examples: Expert assignments, correspondence, general miscellaneous\n\nINSTRUCTIONS:\n1. Analyze the filename for German keywords\n2. Match to the most appropriate category\n3. Provide confidence score (0-100)\n4. Explain your reasoning in 1-2 sentences\n\nRESPONSE FORMAT (JSON only, no markdown):\n{\n  \"tier1Category\": \"OBJEKTUNTERLAGEN | WIRTSCHAFTLICHE_UNTERLAGEN | RECHTLICHE_UNTERLAGEN | SONSTIGES\",\n  \"tier1Confidence\": 85,\n  \"reasoning\": \"Brief explanation of why this category was chosen\"\n}\n\nSTRICT RULES:\n- Response must be valid JSON only\n- tier1Confidence must be 0-100 number\n- tier1Category must be exactly one of the 4 options above\n- No markdown formatting\n- No code blocks\n- No explanatory text outside JSON`;\n\n  outputItems.push({\n    json: {\n      tier1Prompt,\n      // === EXPLICITLY PRESERVE ALL FILE METADATA (CRITICAL) ===\n      fileId,\n      fileName: filename,\n      fileUrl,\n      clientEmail,\n      // === CRITICAL: Preserve client_name and client_normalized ===\n      client_name: item.json.client_name,\n      client_normalized: item.json.client_normalized,\n      // Pass through all input data for additional fields\n      ...item.json\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-1",
        "name": "Build AI Classification Prompt",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1008,
          256
        ]
      },
      {
        "parameters": {
          "jsCode": "// Parse Tier 1 Classification Result + Build Dynamic Tier 2 Prompt\n// FIX: Process ALL items, not just first\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  \n  // Get corresponding items from previous nodes\n  const promptData = $('Build AI Classification Prompt').all()[i].json;\n  const tier1Result = $('Parse Claude Tier 1 Response').all()[i].json;\n  \n  const fileId = promptData.fileId;\n  const fileName = promptData.fileName;\n  const fileUrl = promptData.fileUrl;\n  const clientEmail = promptData.clientEmail;\n  const client_name = promptData.client_name;\n  const client_normalized = promptData.client_normalized;\n\n  if (!tier1Result || !tier1Result.tier1Category) {\n    outputItems.push({\n      json: {\n        error: 'Failed to parse Tier 1 classification',\n        tier1Category: 'UNKNOWN',\n        tier1Confidence: 0,\n        tier2Prompt: 'ERROR: Failed to parse Tier 1 classification',\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        ...item.json\n      }\n    });\n    continue;\n  }\n\n  const { tier1Category, tier1Confidence, tier1Reasoning } = tier1Result;\n  const reasoning = tier1Reasoning || '';\n\n  let tier2Prompt = '';\n\n  if (tier1Category === 'OBJEKTUNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as OBJEKTUNTERLAGEN (Property/Object Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n01_Projektbeschreibung (Exposé/Project Description) ⭐ CORE\\n   Keywords: Projekt, Beschreibung, Expose, Overview, Proposal\\n   Description: Project overview, property description, investment proposal\\n\\n02_Kaufvertrag (Purchase Agreement)\\n   Keywords: Kauf, Vertrag, Purchase, Agreement\\n   Description: Property purchase contract\\n\\n03_Grundbuchauszug (Land Register Extract) ⭐ CORE\\n   Keywords: Grundbuch, Land, Register, Auszug\\n   Description: Official land registry extract\\n\\n04_Eintragungsbewilligungen (Entry Permits)\\n   Keywords: Eintragung, Bewilligung, Entry, Permit\\n   Description: Permits for land register entries\\n\\n05_Bodenrichtwert (Land Value)\\n   Keywords: Boden, Richtwert, Land, Value\\n   Description: Official land value assessment\\n\\n06_Baulastenverzeichnis (Building Encumbrance Register)\\n   Keywords: Baulast, Verzeichnis, Encumbrance\\n   Description: Register of building encumbrances\\n\\n07_Altlastenkataster (Contaminated Sites Register)\\n   Keywords: Altlast, Kataster, Contaminated\\n   Description: Register of contaminated sites\\n\\n08_Baugrundgutachten (Soil Survey)\\n   Keywords: Baugrund, Gutachten, Soil, Survey\\n   Description: Soil conditions assessment\\n\\n09_Lageplan (Site Plan)\\n   Keywords: Lage, Plan, Site\\n   Description: Site location plan\\n\\n10_Bautraegerkalkulation_DIN276 (Developer Calculation) ⭐ CORE\\n   Keywords: Bautraeger, Kalkulation, DIN276, Calculation\\n   Description: Developer cost calculation per DIN276 standard\\n\\n15_Flaechenberechnung_DIN277 (Area Calculation DIN277)\\n   Keywords: Flaeche, Berechnung, DIN277, Area\\n   Description: Area calculation per DIN277 standard\\n\\n16_GU_Werkvertraege (General Contractor Agreements)\\n   Keywords: GU, Werkvertrag, Contractor, Agreement\\n   Description: General contractor work agreements\\n\\n17_Bauzeichnungen (Construction Drawings)\\n   Keywords: Bau, Zeichnung, Construction, Drawing\\n   Description: Construction and architectural drawings\\n\\n18_Baugenehmigung (Building Permit)\\n   Keywords: Bau, Genehmigung, Building, Permit\\n   Description: Official building permit\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"01_Projektbeschreibung\\\",\\n  \\\"tier2Confidence\\\": 88,\\n  \\\"germanName\\\": \\\"Projektbeschreibung\\\",\\n  \\\"englishName\\\": \\\"Exposé/Project Description\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above (e.g., \\\"01_Projektbeschreibung\\\")\\n- isCoreType: true for ⭐ CORE types, false for others\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'WIRTSCHAFTLICHE_UNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n11_Verkaufspreise (Sales Prices)\\n   Keywords: Verkauf, Preis, Sales, Price\\n   Description: Sales price lists and calculations\\n\\n12_Bauzeitenplan_Liquiditaet (Construction Schedule & Liquidity)\\n   Keywords: Bauzeit, Plan, Liquiditaet, Schedule\\n   Description: Construction timeline and liquidity planning\\n\\n13_Vertriebsweg (Distribution Channel)\\n   Keywords: Vertrieb, Weg, Distribution, Channel\\n   Description: Sales and distribution strategy\\n\\n14_Bau_Ausstattungsbeschreibung (Construction & Equipment Description)\\n   Keywords: Bau, Ausstattung, Beschreibung, Equipment\\n   Description: Construction specifications and equipment details\\n\\n19_Teilungserklaerung (Declaration of Division)\\n   Keywords: Teilung, Erklaerung, Division, Declaration\\n   Description: Property division declaration\\n\\n20_Versicherungen (Insurance)\\n   Keywords: Versicherung, Insurance\\n   Description: Insurance policies and documentation\\n\\n21_Muster_Verkaufsvertrag (Sample Sales Contract)\\n   Keywords: Muster, Verkauf, Vertrag, Sample, Sales\\n   Description: Template sales contract\\n\\n23_Umsatzsteuervoranmeldung (VAT Advance Return)\\n   Keywords: Umsatz, Steuer, Voranmeldung, VAT\\n   Description: VAT advance return filings\\n\\n24_BWA (Business Evaluation)\\n   Keywords: BWA, Business, Evaluation\\n   Description: Business evaluation report\\n\\n25_Jahresabschluss (Annual Financial Statement)\\n   Keywords: Jahres, Abschluss, Annual, Financial\\n   Description: Annual financial statement\\n\\n26_Finanzierungsbestaetigung (Financing Confirmation)\\n   Keywords: Finanzierung, Bestaetigung, Financing, Confirmation\\n   Description: Financing approval or confirmation\\n\\n27_Darlehensvertrag (Loan Agreement)\\n   Keywords: Darlehen, Vertrag, Loan, Agreement\\n   Description: Loan contract\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"11_Verkaufspreise\\\",\\n  \\\"tier2Confidence\\\": 92,\\n  \\\"germanName\\\": \\\"Verkaufspreise\\\",\\n  \\\"englishName\\\": \\\"Sales Prices\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all WIRTSCHAFTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'RECHTLICHE_UNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n28_Gesellschaftsvertrag (Partnership Agreement)\\n   Keywords: Gesellschaft, Vertrag, Partnership, Agreement\\n   Description: Company partnership or shareholder agreement\\n\\n29_Handelsregisterauszug (Commercial Register Extract)\\n   Keywords: Handelsregister, Auszug, Commercial, Register\\n   Description: Commercial register extract\\n\\n30_Gewerbeanmeldung (Business Registration)\\n   Keywords: Gewerbe, Anmeldung, Business, Registration\\n   Description: Business registration documentation\\n\\n31_Steuer_ID (Tax ID)\\n   Keywords: Steuer, ID, Tax\\n   Description: Tax identification number\\n\\n32_Freistellungsbescheinigung (Exemption Certificate)\\n   Keywords: Freistellung, Bescheinigung, Exemption, Certificate\\n   Description: Tax exemption certificate\\n\\n33_Vollmachten (Powers of Attorney)\\n   Keywords: Vollmacht, Power, Attorney\\n   Description: Power of attorney documents\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"28_Gesellschaftsvertrag\\\",\\n  \\\"tier2Confidence\\\": 85,\\n  \\\"germanName\\\": \\\"Gesellschaftsvertrag\\\",\\n  \\\"englishName\\\": \\\"Partnership Agreement\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all RECHTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'SONSTIGES') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as SONSTIGES (Miscellaneous) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n22_Gutachterauftrag (Expert Assignment)\\n   Keywords: Gutachter, Auftrag, Expert, Assignment\\n   Description: Expert assessment assignment\\n\\n34_Korrespondenz (Correspondence)\\n   Keywords: Korrespondenz, Email, Brief, Letter, Correspondence\\n   Description: Email correspondence and letters\\n\\n35_Sonstiges_Allgemein (General Miscellaneous)\\n   Keywords: Sonstiges, Misc, General\\n   Description: General miscellaneous documents\\n\\n36_Exit_Strategie (Exit Strategy) ⭐ CORE\\n   Keywords: Exit, Strategie, Strategy\\n   Description: Investment exit strategy\\n\\n37_Others (Others)\\n   Keywords: Other, Andere\\n   Description: Other unclassified documents\\n\\n38_Unknowns (Unknowns)\\n   Keywords: Unknown, Unbekannt\\n   Description: Unknown document type\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n5. Use 38_Unknowns ONLY if truly unclear\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"36_Exit_Strategie\\\",\\n  \\\"tier2Confidence\\\": 95,\\n  \\\"germanName\\\": \\\"Exit Strategie\\\",\\n  \\\"englishName\\\": \\\"Exit Strategy\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: true ONLY for 36_Exit_Strategie\\n- Valid JSON only, no markdown`;\n  } else {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nERROR: Unknown category \\\"${tier1Category}\\\". Please classify as SONSTIGES > 38_Unknowns.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"38_Unknowns\\\",\\n  \\\"tier2Confidence\\\": 0,\\n  \\\"germanName\\\": \\\"Unknowns\\\",\\n  \\\"englishName\\\": \\\"Unknown\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Unknown Tier 1 category: ${tier1Category}\\\"\\n}`;\n  }\n\n  if (tier1Confidence < 60) {\n    outputItems.push({\n      json: {\n        tier1Category, tier1Confidence, tier1Reasoning: reasoning, tier2Prompt,\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        lowConfidence: true, confidenceFailureStage: 'tier1',\n        ...item.json\n      }\n    });\n  } else {\n    outputItems.push({\n      json: {\n        tier1Category, tier1Confidence, tier1Reasoning: reasoning, tier2Prompt,\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        ...item.json\n      }\n    });\n  }\n}\n\nreturn outputItems;"
        },
        "id": "code-2",
        "name": "Parse Classification Result",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2128,
          256
        ]
      },
      {
        "parameters": {
          "documentId": {
            "mode": "id",
            "value": "12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I"
          },
          "sheetName": {
            "mode": "name",
            "value": "Client_Tracker"
          },
          "options": {}
        },
        "id": "sheets-1",
        "name": "Lookup Client in Client_Tracker",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          3920,
          256
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H7ewI1sOrDYabelt",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// FIX: Reference classification data from upstream node directly\n// The Sheets lookup output overwrites $input, so we must reference Determine Action Type\n\nconst items = $input.all();\nconst outputItems = [];\n\n// Get classification data from upstream (preserved across Sheets lookup)\nconst classificationData = $('Determine Action Type').first().json;\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const trackerData = $('Lookup Client in Client_Tracker').all();\n  \n  // Get client info from classification data (not from Sheets output)\n  const clientNormalized = classificationData.client_normalized || classificationData.clientNormalized || '';\n  const documentType = classificationData.documentType || '';\n  const confidence = classificationData.combinedConfidence || classificationData.tier2Confidence || 0;\n  const fileId = classificationData.fileId || '';\n  const fileName = classificationData.fileName || '';\n\n  // Check if confidence is too low\n  if (confidence < 70) {\n    outputItems.push({\n      json: {\n        ...classificationData,  // Preserve all classification data\n        ...item.json,           // Include sheet row data\n        chunk2_5_status: 'error_unclear_type',\n        errorMessage: `Low confidence (${confidence}%) - document type unclear`\n      }\n    });\n    continue;\n  }\n\n  // Check if any data was returned from tracker\n  if (!trackerData || trackerData.length === 0) {\n    outputItems.push({\n      json: {\n        ...classificationData,\n        chunk2_5_status: 'error_client_not_found',\n        errorMessage: 'No data returned from Client_Tracker lookup'\n      }\n    });\n    continue;\n  }\n\n  // Find matching client row\n  const clientRow = trackerData.find(row => {\n    const sheetClientName = row.json.Client_Name || '';\n    const normalizedSheetName = sheetClientName\n      .toLowerCase()\n      .trim()\n      .replace(/ä/g, 'ae')\n      .replace(/ö/g, 'oe')\n      .replace(/ü/g, 'ue')\n      .replace(/ß/g, 'ss')\n      .replace(/\\s*(gmbh|ag|kg|e\\.v\\.|mbh|co\\.|&\\s*co\\.?)\\s*/gi, '')\n      .replace(/[^a-z0-9]/g, '_')\n      .replace(/_+/g, '_')\n      .replace(/^_|_$/g, '');\n    return normalizedSheetName === clientNormalized;\n  });\n\n  if (!clientRow || !clientRow.json.Client_Name) {\n    outputItems.push({\n      json: {\n        ...classificationData,\n        chunk2_5_status: 'error_client_not_found',\n        errorMessage: `Client not found in tracker: \"${clientNormalized}\"`\n      }\n    });\n    continue;\n  }\n\n  // Client found and validated - prepare for success path\n  outputItems.push({\n    json: {\n      ...classificationData,        // All classification data (fileId, confidence, documentType, etc.)\n      ...clientRow.json,            // Sheet row data\n      clientFound: true,\n      trackerRowIndex: clientRow.json.row_number || 0,\n      trackerClientName: clientRow.json.Client_Name,\n      chunk2_5_status: 'success'\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-3",
        "name": "Find Client Row and Validate",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4080,
          64
        ]
      },
      {
        "parameters": {
          "documentId": {
            "__rl": true,
            "value": "12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I",
            "mode": "list",
            "cachedResultName": "AMA Client Document Tracker",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I/edit?usp=drivesdk"
          },
          "sheetName": {
            "__rl": true,
            "value": 1217593734,
            "mode": "list",
            "cachedResultName": "Client_Tracker",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I/edit#gid=1217593734"
          },
          "options": {}
        },
        "id": "sheets-2",
        "name": "Update Client_Tracker Row",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          4816,
          112
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H7ewI1sOrDYabelt",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "documentId": {
            "mode": "id",
            "value": "1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU"
          },
          "sheetName": {
            "__rl": true,
            "value": "gid=0",
            "mode": "list",
            "cachedResultName": "AMA_Folder_IDs",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU/edit#gid=0"
          },
          "options": {}
        },
        "id": "sheets-3",
        "name": "Lookup Client in AMA_Folder_IDs",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          5040,
          176
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H7ewI1sOrDYabelt",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Get Destination Folder ID - V13 Clean\n// 6 DESTINATIONS:\n// 1-4: CORE docs -> Specific folders\n// 5: SECONDARY (known but not core) -> 37_Others\n// 6: LOW_CONFIDENCE/Unknown -> 38_Unknowns\n\nconst classificationData = $('Find Client Row and Validate').first().json;\n\n// Get fileId from classification data (passed through from trigger)\nconst fileId = classificationData.fileId;\nconst fileName = classificationData.fileName;\n\n// Get classification info\nconst actionType = classificationData.actionType;\nconst documentType = classificationData.documentType;\nconst tier1Category = classificationData.tier1Category;\nconst client_name = classificationData.client_name;\nconst client_normalized = classificationData.client_normalized;\n\n// Build lookup from ALL folder rows\nconst allFolderRows = $input.all();\nconst folderLookup = {};\nfor (const row of allFolderRows) {\n  folderLookup[row.json.Variable_Name] = row.json.Folder_ID;\n}\n\nlet finalFolderId;\nlet destinationFolderName;\nlet variableNameSearched;\n\n// CORE DOCUMENTS (4 types) -> Specific Folders\nif (actionType === 'CORE') {\n  const coreMapping = {\n    '01_Projektbeschreibung': { varName: 'FOLDER_01_PROJEKTBESCHREIBUNG', displayName: '01_Projektbeschreibung' },\n    '03_Grundbuchauszug': { varName: 'FOLDER_03_GRUNDBUCHAUSZUG', displayName: '03_Grundbuchauszug' },\n    '10_Bautraegerkalkulation_DIN276': { varName: 'FOLDER_10_BAUTRAEGERKALKULATION', displayName: '10_Bautraegerkalkulation' },\n    '36_Exit_Strategie': { varName: 'FOLDER_36_EXIT_STRATEGIE', displayName: '36_Exit_Strategie' }\n  };\n\n  const mapping = coreMapping[documentType];\n  if (mapping) {\n    variableNameSearched = mapping.varName;\n    destinationFolderName = mapping.displayName;\n  } else {\n    variableNameSearched = 'FOLDER_38_UNKNOWNS';\n    destinationFolderName = '38_Unknowns';\n  }\n}\n// SECONDARY DOCUMENTS (known but not core) -> 37_Others\nelse if (actionType === 'SECONDARY') {\n  variableNameSearched = 'FOLDER_37_OTHERS';\n  destinationFolderName = '37_Others';\n}\n// LOW_CONFIDENCE or UNKNOWN -> 38_Unknowns\nelse {\n  variableNameSearched = 'FOLDER_38_UNKNOWNS';\n  destinationFolderName = '38_Unknowns';\n}\n\n// Get folder ID from lookup\nfinalFolderId = folderLookup[variableNameSearched];\n\nreturn [{\n  json: {\n    fileId: fileId,\n    fileName: fileName,\n    finalFolderId: finalFolderId,\n    destinationFolderName: destinationFolderName,\n    actionType: actionType,\n    documentType: documentType,\n    tier1Category: tier1Category,\n    client_name: client_name,\n    client_normalized: client_normalized,\n    debug_variableNameSearched: variableNameSearched,\n    debug_folderLookupSize: Object.keys(folderLookup).length\n  }\n}];"
        },
        "id": "code-4",
        "name": "Get Destination Folder ID",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5264,
          176
        ]
      },
      {
        "parameters": {
          "operation": "move",
          "fileId": {
            "__rl": true,
            "mode": "id",
            "value": "={{ $json.fileId }}"
          },
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "mode": "id",
            "value": "={{ $json.finalFolderId }}"
          }
        },
        "id": "drive-1",
        "name": "Move File to Final Location",
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          5488,
          176
        ],
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "a4m50EefR3DJoU0R",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// FIX: Process ALL items\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  outputItems.push({\n    json: {\n      ...item.json,\n      trackerUpdated: true,\n      chunk2_5_status: 'success',\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-5",
        "name": "Prepare Success Output",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5712,
          352
        ]
      },
      {
        "parameters": {
          "documentId": {
            "mode": "id",
            "value": "1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU"
          },
          "sheetName": {
            "__rl": true,
            "value": "gid=0",
            "mode": "list",
            "cachedResultName": "AMA_Folder_IDs",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU/edit#gid=0"
          },
          "options": {}
        },
        "id": "sheets-4",
        "name": "Lookup 38_Unknowns Folder",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          4592,
          432
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H7ewI1sOrDYabelt",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// FIX: Process ALL items from main data\nconst folderData = $input.all();\nconst mainDataItems = $('Find Client Row and Validate').all();\nconst outputItems = [];\n\n// Skip header row from folder data\nconst dataRows = folderData.slice(1);\n\n// Look for 38_Unknowns folder ID (should be same for all items)\nlet unknownsFolderId = null;\nif (dataRows.length > 0) {\n  for (const row of dataRows) {\n    const rowData = row.json;\n    for (const key in rowData) {\n      if (key.includes('38_Unknowns')) {\n        unknownsFolderId = rowData[key];\n        break;\n      }\n    }\n    if (unknownsFolderId) break;\n  }\n\n  if (!unknownsFolderId) {\n    // Try to get from first row (assuming it might be a global folder)\n    unknownsFolderId = dataRows[0].json['38_Unknowns'] || null;\n  }\n}\n\n// Return one output item per main data item\nfor (const mainData of mainDataItems) {\n  outputItems.push({\n    json: {\n      ...mainData.json,\n      unknownsFolderId: unknownsFolderId,\n      errorFallbackUsed: !unknownsFolderId\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-6",
        "name": "Get 38_Unknowns Folder ID",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4816,
          432
        ]
      },
      {
        "parameters": {
          "operation": "move",
          "fileId": {
            "__rl": true,
            "mode": "id",
            "value": "={{ $json.fileId }}"
          },
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "mode": "id",
            "value": "={{ $json.unknownsFolderId }}"
          }
        },
        "id": "drive-2",
        "name": "Move File to 38_Unknowns",
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          5040,
          432
        ],
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "a4m50EefR3DJoU0R",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// FIX: Process ALL items\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const mainData = item.json;\n\n  // FIX: Use client_normalized (snake_case) to match what's being passed\n  const clientName = mainData.client_normalized || mainData.clientNormalized || 'Unknown';\n  const fileName = mainData.fileName || 'Unknown';\n  const fileId = mainData.fileId || '';\n  const errorStatus = mainData.chunk2_5_status || 'unknown_error';\n  const errorMessage = mainData.errorMessage || 'No error details provided';\n  const documentType = mainData.documentType || 'Unknown';\n  const confidence = mainData.documentClassificationConfidence || 0;\n\n  let issueDescription = '';\n  if (errorStatus === 'error_client_not_found') {\n    issueDescription = `Client \\\"${clientName}\\\" was not found in the Client_Tracker sheet.`;\n  } else if (errorStatus === 'error_unclear_type') {\n    issueDescription = `Document type classification had low confidence (${confidence}%). Classified as: ${documentType}.`;\n  } else if (errorStatus === 'error_folder_not_found') {\n    issueDescription = `Destination folder for document type \\\"${documentType}\\\" was not found in AMA_Folder_IDs.`;\n  } else {\n    issueDescription = errorMessage;\n  }\n\n  const fileLink = `https://drive.google.com/file/d/${fileId}/view`;\n\n  const emailSubject = `Eugene: Document Classification Issue - ${clientName}`;\n  const emailBody = `<html>\n<body>\n<h2>Document Classification Issue</h2>\n<p>A document could not be automatically classified and has been moved to the 38_Unknowns folder.</p>\n\n<h3>Details:</h3>\n<ul>\n  <li><strong>Client:</strong> ${clientName}</li>\n  <li><strong>Filename:</strong> ${fileName}</li>\n  <li><strong>Issue:</strong> ${issueDescription}</li>\n  <li><strong>Classified Type:</strong> ${documentType} (${confidence}% confidence)</li>\n  <li><strong>Error Status:</strong> ${errorStatus}</li>\n</ul>\n\n<h3>File Location:</h3>\n<p><a href=\\\"${fileLink}\\\">View file in Google Drive</a></p>\n\n<p>Please review this document and manually classify it.</p>\n</body>\n</html>`;\n\n  outputItems.push({\n    json: {\n      ...mainData,\n      emailSubject: emailSubject,\n      emailBody: emailBody,\n      trackerUpdated: false,\n      chunk2_5_status: errorStatus,\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-7",
        "name": "Prepare Error Email Body",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5264,
          432
        ]
      },
      {
        "parameters": {
          "sendTo": "={{ $json.emailRecipient || 'sway@thebluebottle.io' }}",
          "subject": "Document Classification Error - Action Required",
          "message": "={{ $json.emailBody }}",
          "options": {}
        },
        "id": "gmail-1",
        "name": "Send Error Notification Email",
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          5488,
          432
        ],
        "webhookId": "d50e78b4-8ae0-4171-b62f-c2afdafc7e58",
        "credentials": {
          "gmailOAuth2": {
            "id": "gmailOAuth2",
            "name": "Gmail OAuth2"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Prepare Tracker Update Data - V8 Conditional (CORE types only)\n// FIX: Process ALL items\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const data = item.json;\n\n  // CONDITIONAL: Only prepare tracker data if trackerUpdate === true\n  if (data.trackerUpdate !== true) {\n    // SECONDARY or LOW_CONFIDENCE: Skip tracker update, pass through to folder move\n    outputItems.push({\n      json: {\n        skipTrackerUpdate: true,\n        ...data\n      }\n    });\n    continue;\n  }\n\n  // CORE types: Prepare tracker update data\n  const documentType = data.documentType;\n\n  // Map document type to tracker column\n  const trackerColumnMapping = {\n    '01_Projektbeschreibung': 'Status_Expose',\n    '03_Grundbuchauszug': 'Status_Grundbuch',\n    '10_Bautraegerkalkulation_DIN276': 'Status_Calculation',\n    '36_Exit_Strategie': 'Status_Exit_Strategy'\n  };\n\n  const trackerColumn = trackerColumnMapping[documentType];\n\n  if (!trackerColumn) {\n    // Should not happen if CORE mapping is correct\n    outputItems.push({\n      json: {\n        error: 'Unknown CORE document type for tracker mapping',\n        skipTrackerUpdate: true,\n        ...data\n      }\n    });\n    continue;\n  }\n\n  // Prepare update data for Client_Tracker\n  const updateData = {\n    [trackerColumn]: '✓'\n  };\n\n  outputItems.push({\n    json: {\n      trackerColumn,\n      trackerValue: '✓',\n      updateData,\n      skipTrackerUpdate: false,\n      ...data\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-8",
        "name": "Prepare Tracker Update Data",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4592,
          112
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.openai.com/v1/chat/completions",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ ({ \"model\": \"gpt-4\", \"messages\": [{\"role\": \"user\", \"content\": $json.tier1Prompt}], \"temperature\": 0 }) }}",
          "options": {}
        },
        "id": "http-openai-1",
        "name": "Classify Document with GPT-4",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1904,
          816
        ],
        "credentials": {
          "openAiApi": {
            "id": "xmJ7t6kaKgMwA1ce",
            "name": "OpenAi account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.openai.com/v1/chat/completions",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ ({ \"model\": \"gpt-4\", \"messages\": [{\"role\": \"user\", \"content\": $json.tier2Prompt}], \"temperature\": 0 }) }}",
          "options": {}
        },
        "id": "3732e080-c0d3-4763-957d-d4d90761ddd8",
        "name": "Tier 2 GPT-4 API Call",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          3024,
          816
        ],
        "credentials": {
          "openAiApi": {
            "id": "xmJ7t6kaKgMwA1ce",
            "name": "OpenAi account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "jsCode": "// Parse Tier 2 Classification Result from Claude Vision\n// FIX: Process ALL items, not just first\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  // Get corresponding Tier 2 result\n  const tier2Result = $('Parse Claude Tier 2 Response').all()[i].json;\n\n  if (!tier2Result || !tier2Result.documentType) {\n    // Parsing failed - route to LOW_CONFIDENCE\n    outputItems.push({\n      json: {\n        error: 'Failed to parse Tier 2 classification',\n        lowConfidence: true,\n        confidenceFailureStage: 'tier2_parse_error',\n        ...tier2Result\n      }\n    });\n    continue;\n  }\n\n  const {\n    documentType, tier2Confidence, germanName, englishName, isCoreType, tier2Reasoning,\n    fileId, fileName, fileUrl, clientEmail,\n    client_name, client_normalized,  // FIX: Preserve client data\n    tier1Category, tier1Confidence, tier1Reasoning\n  } = tier2Result;\n\n  // THRESHOLD CHECK: Tier 2 confidence must be >= 70%\n  if (tier2Confidence < 70) {\n    outputItems.push({\n      json: {\n        documentType, tier2Confidence, lowConfidence: true, confidenceFailureStage: 'tier2',\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        tier1Category, tier1Confidence, tier1Reasoning\n      }\n    });\n  } else {\n    // Calculate combined confidence\n    const combinedConfidence = Math.round((tier1Confidence + tier2Confidence) / 2);\n\n    outputItems.push({\n      json: {\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        tier1Category, tier1Confidence, tier1Reasoning,\n        documentType, tier2Confidence, combinedConfidence,\n        germanName, englishName, isCoreType, tier2Reasoning\n      }\n    });\n  }\n}\n\nreturn outputItems;"
        },
        "id": "86d8d160-de91-464d-92d0-7db05b7c3f4f",
        "name": "Parse Tier 2 Result",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3248,
          256
        ]
      },
      {
        "parameters": {
          "jsCode": "// Action Mapper: Determine routing based on classification results\n\nconst data = $input.first().json;\n\n// Check for low confidence flags\nif (data.lowConfidence === true) {\n  return [{\n    json: {\n      ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n      actionType: 'LOW_CONFIDENCE',\n      destinationFolder: '38_Unknowns',\n      trackerUpdate: false,\n      sendNotification: true\n    }\n  }];\n}\n\n// Check if CORE type\nif (data.isCoreType === true) {\n  // CORE types: Specific folder + tracker update\n  return [{\n    json: {\n      ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n      actionType: 'CORE',\n      trackerUpdate: true,\n      sendNotification: false\n    }\n  }];\n}\n\n// SECONDARY types: 37_Other folder + tracker update (so Eugene can see what they are)\nreturn [{\n  json: {\n    ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n    actionType: 'SECONDARY',\n    destinationFolder: '37_Other',\n    trackerUpdate: true,\n    sendNotification: false\n  }\n}];"
        },
        "id": "89b7324c-80e6-4902-9ab5-3f26be09e92a",
        "name": "Determine Action Type",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3472,
          256
        ]
      },
      {
        "parameters": {
          "operation": "download",
          "fileId": "={{ $json.fileId }}",
          "options": {}
        },
        "id": "drive-download-1",
        "name": "Download PDF for Classification",
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          560,
          256
        ],
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "a4m50EefR3DJoU0R",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Convert PDF to Base64\n// Processing one file at a time (via Split In Batches upstream)\n// Rate limiting handled by Wait nodes between Claude Vision calls\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  try {\n    const binaryKey = Object.keys(item.binary || {})[0];\n    \n    if (!binaryKey) {\n      // No binary data, pass through\n      outputItems.push({\n        json: {\n          ...item.json,\n          pdfError: 'No binary data found'\n        }\n      });\n      continue;\n    }\n    \n    const buffer = await this.helpers.getBinaryDataBuffer(items.indexOf(item), binaryKey);\n    const base64Content = buffer.toString('base64');\n    const mimeType = item.json.mimeType || 'application/pdf';\n    const fileSizeKB = Math.round(buffer.length / 1024);\n    \n    outputItems.push({\n      json: {\n        ...item.json,\n        imageData: {\n          type: 'base64',\n          media_type: mimeType,\n          data: base64Content\n        },\n        pdfMetadata: {\n          fileSizeKB: fileSizeKB,\n          note: 'Full PDF sent - rate limiting via Wait nodes'\n        }\n      },\n      binary: item.binary\n    });\n  } catch (error) {\n    outputItems.push({\n      json: {\n        ...item.json,\n        pdfError: error.message\n      }\n    });\n  }\n}\n\nreturn outputItems;"
        },
        "id": "code-convert-pdf",
        "name": "Convert PDF to Base64",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          784,
          256
        ]
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  // FIX: Get tier1Prompt from the SAME item, not always from first()\n  const tier1Prompt = item.json.tier1Prompt;\n  const imageData = item.json.imageData;\n\n  if (!imageData || !imageData.data) {\n    throw new Error('No image data found in item');\n  }\n\n  const requestBody = {\n    model: 'claude-sonnet-4-20250514',\n    max_tokens: 200,\n    messages: [\n      {\n        role: 'user',\n        content: [\n          {\n            type: 'document',\n            source: {\n              type: 'base64',\n              media_type: imageData.media_type,\n              data: imageData.data\n            }\n          },\n          {\n            type: 'text',\n            text: tier1Prompt\n          }\n        ]\n      }\n    ]\n  };\n\n  outputItems.push({\n    json: {\n      ...item.json,\n      claudeRequestBody: requestBody\n    },\n    binary: item.binary\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-build-claude-tier1",
        "name": "Build Claude Tier 1 Request Body",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1232,
          256
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.anthropic.com/v1/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "anthropic-version",
                "value": "2023-06-01"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ $json.claudeRequestBody }}",
          "options": {}
        },
        "id": "http-claude-tier1",
        "name": "Claude Vision Tier 1 Classification",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1456,
          256
        ],
        "credentials": {
          "httpHeaderAuth": {
            "id": "vfoYopBRX35Znmq6",
            "name": "Anthropic API key"
          }
        },
        "retryOnFail": true,
        "maxTries": 3,
        "waitBetweenTries": 30000
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const response = item.json;\n\n  if (!response.content || !response.content[0] || !response.content[0].text) {\n    throw new Error('Invalid Claude API response structure');\n  }\n\n  let textContent = response.content[0].text.trim();\n\n  // Strip markdown code fences if present\n  if (textContent.startsWith('```json')) {\n    textContent = textContent\n      .replace(/^```json\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  } else if (textContent.startsWith('```')) {\n    textContent = textContent\n      .replace(/^```\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  }\n\n  const parsedResult = JSON.parse(textContent);\n  \n  // FIX CRITICAL: Get metadata from the corresponding item in previous node\n  const previousData = $('Build Claude Tier 1 Request Body').all()[i].json;\n\n  outputItems.push({\n    json: {\n      ...previousData,  // PRESERVE ALL INCOMING DATA including client_name, client_normalized\n      tier1Category: parsedResult.tier1Category,\n      tier1Confidence: parsedResult.tier1Confidence,\n      tier1Reasoning: parsedResult.reasoning || ''\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-parse-claude-tier1",
        "name": "Parse Claude Tier 1 Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1904,
          256
        ]
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const tier2Prompt = item.json.tier2Prompt;\n  \n  // FIX: Get imageData from the corresponding item, not always first()\n  const imageData = $('Convert PDF to Base64').all()[i].json.imageData;\n\n  if (!imageData || !imageData.data) {\n    throw new Error('No image data found for Tier 2 classification');\n  }\n\n  const requestBody = {\n    model: 'claude-sonnet-4-20250514',\n    max_tokens: 300,\n    messages: [\n      {\n        role: 'user',\n        content: [\n          {\n            type: 'document',\n            source: {\n              type: 'base64',\n              media_type: imageData.media_type,\n              data: imageData.data\n            }\n          },\n          {\n            type: 'text',\n            text: tier2Prompt\n          }\n        ]\n      }\n    ]\n  };\n\n  outputItems.push({\n    json: {\n      ...item.json,\n      claudeTier2RequestBody: requestBody\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-build-claude-tier2",
        "name": "Build Claude Tier 2 Request Body",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2352,
          256
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.anthropic.com/v1/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "anthropic-version",
                "value": "2023-06-01"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ $json.claudeTier2RequestBody }}",
          "options": {}
        },
        "id": "http-claude-tier2",
        "name": "Claude Vision Tier 2 Classification",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2576,
          256
        ],
        "credentials": {
          "httpHeaderAuth": {
            "id": "vfoYopBRX35Znmq6",
            "name": "Anthropic API key"
          }
        },
        "retryOnFail": true,
        "maxTries": 3,
        "waitBetweenTries": 30000
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const response = item.json;\n\n  if (!response.content || !response.content[0] || !response.content[0].text) {\n    throw new Error('Invalid Claude API Tier 2 response structure');\n  }\n\n  let textContent = response.content[0].text.trim();\n\n  // Strip markdown code fences if present\n  if (textContent.startsWith('```json')) {\n    textContent = textContent\n      .replace(/^```json\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  } else if (textContent.startsWith('```')) {\n    textContent = textContent\n      .replace(/^```\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  }\n\n  const parsedResult = JSON.parse(textContent);\n\n  // FIX: Get metadata from the corresponding item in previous node\n  const previousData = $('Parse Classification Result').all()[i].json;\n\n  outputItems.push({\n    json: {\n      ...previousData,  // This preserves client_name, client_normalized, etc.\n      documentType: parsedResult.documentType,\n      tier2Confidence: parsedResult.tier2Confidence,\n      germanName: parsedResult.germanName,\n      englishName: parsedResult.englishName,\n      isCoreType: parsedResult.isCoreType,\n      tier2Reasoning: parsedResult.reasoning || ''\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-parse-claude-tier2",
        "name": "Parse Claude Tier 2 Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3024,
          256
        ]
      },
      {
        "parameters": {
          "amount": 30
        },
        "id": "wait-after-tier1",
        "name": "Wait After Tier 1",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          1680,
          256
        ],
        "webhookId": "09d67e4e-d872-45b3-8421-4639ada494f7"
      },
      {
        "parameters": {
          "amount": 30
        },
        "id": "wait-after-tier2",
        "name": "Wait After Tier 2",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          2800,
          256
        ],
        "webhookId": "2ebc9318-2e89-4007-9cdc-f38f3121d489"
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "split-batches-001",
        "name": "Process One File at a Time",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          288,
          240
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "85b5d5c7-cb7b-43fb-a47a-7def8098a29b",
                      "leftValue": "={{ $json.chunk2_5_status }}",
                      "rightValue": "error_unclear_type",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "error"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "bc10ada4-798c-4d82-9b0b-062f7679e1c2",
                      "leftValue": "={{ $json.chunk2_5_status }}",
                      "rightValue": "success",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "update_tracker"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "032787ac-b6d7-417a-8011-f68246aed0e6",
                      "leftValue": "={{ $json.chunk2_5_status }}",
                      "rightValue": "error_client_not_found",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "skip_tracker"
              }
            ]
          },
          "options": {
            "fallbackOutput": "extra"
          }
        },
        "id": "d4336ded-fbdb-4dff-9518-4523471dc798",
        "name": "Route Based on Document Type1",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          4304,
          -16
        ]
      }
    ],
    "connections": {
      "Lookup Client in Client_Tracker": {
        "main": [
          [
            {
              "node": "Find Client Row and Validate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update Client_Tracker Row": {
        "main": [
          [
            {
              "node": "Lookup Client in AMA_Folder_IDs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Lookup Client in AMA_Folder_IDs": {
        "main": [
          [
            {
              "node": "Get Destination Folder ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Destination Folder ID": {
        "main": [
          [
            {
              "node": "Move File to Final Location",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Move File to Final Location": {
        "main": [
          [
            {
              "node": "Prepare Success Output",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Lookup 38_Unknowns Folder": {
        "main": [
          [
            {
              "node": "Get 38_Unknowns Folder ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get 38_Unknowns Folder ID": {
        "main": [
          [
            {
              "node": "Move File to 38_Unknowns",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Move File to 38_Unknowns": {
        "main": [
          [
            {
              "node": "Prepare Error Email Body",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Error Email Body": {
        "main": [
          [
            {
              "node": "Send Error Notification Email",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Tracker Update Data": {
        "main": [
          [
            {
              "node": "Update Client_Tracker Row",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Classify Document with GPT-4": {
        "main": [
          [
            {
              "node": "Parse Classification Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tier 2 GPT-4 API Call": {
        "main": [
          [
            {
              "node": "Parse Tier 2 Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Tier 2 Result": {
        "main": [
          [
            {
              "node": "Determine Action Type",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Determine Action Type": {
        "main": [
          [
            {
              "node": "Lookup Client in Client_Tracker",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Find Client Row and Validate": {
        "main": [
          [
            {
              "node": "Route Based on Document Type1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Download PDF for Classification": {
        "main": [
          [
            {
              "node": "Convert PDF to Base64",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert PDF to Base64": {
        "main": [
          [
            {
              "node": "Build AI Classification Prompt",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build AI Classification Prompt": {
        "main": [
          [
            {
              "node": "Build Claude Tier 1 Request Body",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Claude Tier 1 Request Body": {
        "main": [
          [
            {
              "node": "Claude Vision Tier 1 Classification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Claude Tier 1 Response": {
        "main": [
          [
            {
              "node": "Parse Classification Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Classification Result": {
        "main": [
          [
            {
              "node": "Build Claude Tier 2 Request Body",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Claude Tier 2 Request Body": {
        "main": [
          [
            {
              "node": "Claude Vision Tier 2 Classification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Claude Tier 2 Response": {
        "main": [
          [
            {
              "node": "Parse Tier 2 Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Claude Vision Tier 1 Classification": {
        "main": [
          [
            {
              "node": "Wait After Tier 1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait After Tier 1": {
        "main": [
          [
            {
              "node": "Parse Claude Tier 1 Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Claude Vision Tier 2 Classification": {
        "main": [
          [
            {
              "node": "Wait After Tier 2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait After Tier 2": {
        "main": [
          [
            {
              "node": "Parse Claude Tier 2 Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Execute Workflow Trigger (Refreshed)": {
        "main": [
          [
            {
              "node": "Process One File at a Time",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process One File at a Time": {
        "main": [
          [
            {
              "node": "Download PDF for Classification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Success Output": {
        "main": [
          [
            {
              "node": "Process One File at a Time",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Error Notification Email": {
        "main": [
          [
            {
              "node": "Process One File at a Time",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Route Based on Document Type1": {
        "main": [
          [
            {
              "node": "Lookup 38_Unknowns Folder",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Prepare Tracker Update Data",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Lookup 38_Unknowns Folder",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Lookup 38_Unknowns Folder",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "settings": {
      "executionOrder": "v1",
      "callerPolicy": "workflowsFromSameOwner",
      "availableInMCP": false
    },
    "staticData": null,
    "meta": {
      "templateCredsSetupCompleted": true
    },
    "pinData": {},
    "versionId": "b3504eb4-b992-4640-92ca-d2a8a42a644d",
    "activeVersionId": "b3504eb4-b992-4640-92ca-d2a8a42a644d",
    "versionCounter": 446,
    "triggerCount": 0,
    "shared": [
      {
        "updatedAt": "2026-01-08T21:33:22.263Z",
        "createdAt": "2026-01-08T21:33:22.263Z",
        "role": "workflow:owner",
        "workflowId": "okg8wTqLtPUwjQ18",
        "projectId": "Rs8mhw052fnrzWZM",
        "project": {
          "updatedAt": "2025-12-31T15:54:29.115Z",
          "createdAt": "2025-12-31T15:27:33.865Z",
          "id": "Rs8mhw052fnrzWZM",
          "name": "Sway Clarke <sway@oloxa.ai>",
          "type": "personal",
          "icon": null,
          "description": null,
          "creatorId": "e9bd9112-c2e3-4f67-873a-e1001baeafd8",
          "projectRelations": [
            {
              "updatedAt": "2025-12-31T15:27:33.865Z",
              "createdAt": "2025-12-31T15:27:33.865Z",
              "userId": "e9bd9112-c2e3-4f67-873a-e1001baeafd8",
              "projectId": "Rs8mhw052fnrzWZM",
              "user": {
                "updatedAt": "2026-01-22T23:10:14.178Z",
                "createdAt": "2025-12-31T15:27:33.119Z",
                "id": "e9bd9112-c2e3-4f67-873a-e1001baeafd8",
                "email": "sway@oloxa.ai",
                "firstName": "Sway",
                "lastName": "Clarke",
                "personalizationAnswers": {
                  "version": "v4",
                  "personalization_survey_submitted_at": "2025-12-31T15:54:37.562Z",
                  "personalization_survey_n8n_version": "2.1.4"
                },
                "settings": {
                  "userActivated": true,
                  "easyAIWorkflowOnboarded": true,
                  "firstSuccessfulWorkflowId": "zbxHkXOoD1qaz6OS",
                  "userActivatedAt": 1767398053308,
                  "npsSurvey": {
                    "responded": true,
                    "lastShownAt": 1767684846804
                  }
                },
                "disabled": false,
                "mfaEnabled": false,
                "lastActiveAt": "2026-01-22",
                "isPending": false
              }
            }
          ]
        }
      }
    ],
    "tags": [],
    "activeVersion": {
      "updatedAt": "2026-01-23T10:14:41.950Z",
      "createdAt": "2026-01-23T10:14:41.950Z",
      "versionId": "b3504eb4-b992-4640-92ca-d2a8a42a644d",
      "workflowId": "okg8wTqLtPUwjQ18",
      "nodes": [
        {
          "parameters": {
            "inputSource": "passthrough"
          },
          "id": "trigger-1",
          "name": "Execute Workflow Trigger (Refreshed)",
          "type": "n8n-nodes-base.executeWorkflowTrigger",
          "typeVersion": 1.1,
          "position": [
            80,
            208
          ]
        },
        {
          "parameters": {
            "jsCode": "// Build Tier 1 Classification Prompt\n// Classify document into 1 of 4 broad categories\n\n// === Process ALL items, not just first ===\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  // === CRITICAL: Extract and preserve ALL file metadata fields ===\n  const fileId = item.json.fileId || item.json.body?.fileId || null;\n  const filename = item.json.fileName || item.json.filename || item.json.body?.fileName || item.json.body?.filename || 'unknown_file.pdf';\n  const fileUrl = item.json.fileUrl || item.json.body?.fileUrl || null;\n  \n  // FIX: Use actual emailFrom instead of hardcoded test email\n  const clientEmail = item.json.emailFrom || item.json.senderEmail || item.json.clientEmail || item.json.body?.emailFrom || item.json.body?.clientEmail || 'unknown@example.com';\n\n  // Tier 1 Prompt: Classify into 4 broad categories\n  const tier1Prompt = `You are a German real estate document classifier for AMA Capital.\n\nTASK: Classify this document into ONE of 4 broad categories based on the filename.\n\nFILENAME: ${filename}\nCLIENT: ${clientEmail}\n\nCATEGORIES:\n\n1. OBJEKTUNTERLAGEN (Property/Object Documents)\n   Keywords: Projekt, Beschreibung, Expose, Grundbuch, Kaufvertrag, Bau, Lageplan, Zeichnungen, Genehmigung, DIN276, DIN277, Werkvertrag, Flaeche\n   Examples: Project descriptions, land register, purchase agreements, building permits, construction drawings, calculations\n\n2. WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents)\n   Keywords: Verkauf, Preis, Bauzeitenplan, Liquiditaet, Vertrieb, Ausstattung, Teilung, Versicherung, Umsatzsteuer, BWA, Jahresabschluss, Finanzierung, Darlehen\n   Examples: Sales prices, construction schedules, insurance, VAT returns, financial statements, loan agreements\n\n3. RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents)\n   Keywords: Gesellschaft, Vertrag, Handelsregister, Gewerbe, Steuer, ID, Freistellung, Vollmacht\n   Examples: Partnership agreements, commercial register, business registration, tax ID, powers of attorney\n\n4. SONSTIGES (Miscellaneous)\n   Keywords: Gutachter, Korrespondenz, Sonstiges, Others\n   Examples: Expert assignments, correspondence, general miscellaneous\n\nINSTRUCTIONS:\n1. Analyze the filename for German keywords\n2. Match to the most appropriate category\n3. Provide confidence score (0-100)\n4. Explain your reasoning in 1-2 sentences\n\nRESPONSE FORMAT (JSON only, no markdown):\n{\n  \"tier1Category\": \"OBJEKTUNTERLAGEN | WIRTSCHAFTLICHE_UNTERLAGEN | RECHTLICHE_UNTERLAGEN | SONSTIGES\",\n  \"tier1Confidence\": 85,\n  \"reasoning\": \"Brief explanation of why this category was chosen\"\n}\n\nSTRICT RULES:\n- Response must be valid JSON only\n- tier1Confidence must be 0-100 number\n- tier1Category must be exactly one of the 4 options above\n- No markdown formatting\n- No code blocks\n- No explanatory text outside JSON`;\n\n  outputItems.push({\n    json: {\n      tier1Prompt,\n      // === EXPLICITLY PRESERVE ALL FILE METADATA (CRITICAL) ===\n      fileId,\n      fileName: filename,\n      fileUrl,\n      clientEmail,\n      // === CRITICAL: Preserve client_name and client_normalized ===\n      client_name: item.json.client_name,\n      client_normalized: item.json.client_normalized,\n      // Pass through all input data for additional fields\n      ...item.json\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-1",
          "name": "Build AI Classification Prompt",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            1008,
            256
          ]
        },
        {
          "parameters": {
            "jsCode": "// Parse Tier 1 Classification Result + Build Dynamic Tier 2 Prompt\n// FIX: Process ALL items, not just first\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  \n  // Get corresponding items from previous nodes\n  const promptData = $('Build AI Classification Prompt').all()[i].json;\n  const tier1Result = $('Parse Claude Tier 1 Response').all()[i].json;\n  \n  const fileId = promptData.fileId;\n  const fileName = promptData.fileName;\n  const fileUrl = promptData.fileUrl;\n  const clientEmail = promptData.clientEmail;\n  const client_name = promptData.client_name;\n  const client_normalized = promptData.client_normalized;\n\n  if (!tier1Result || !tier1Result.tier1Category) {\n    outputItems.push({\n      json: {\n        error: 'Failed to parse Tier 1 classification',\n        tier1Category: 'UNKNOWN',\n        tier1Confidence: 0,\n        tier2Prompt: 'ERROR: Failed to parse Tier 1 classification',\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        ...item.json\n      }\n    });\n    continue;\n  }\n\n  const { tier1Category, tier1Confidence, tier1Reasoning } = tier1Result;\n  const reasoning = tier1Reasoning || '';\n\n  let tier2Prompt = '';\n\n  if (tier1Category === 'OBJEKTUNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as OBJEKTUNTERLAGEN (Property/Object Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n01_Projektbeschreibung (Exposé/Project Description) ⭐ CORE\\n   Keywords: Projekt, Beschreibung, Expose, Overview, Proposal\\n   Description: Project overview, property description, investment proposal\\n\\n02_Kaufvertrag (Purchase Agreement)\\n   Keywords: Kauf, Vertrag, Purchase, Agreement\\n   Description: Property purchase contract\\n\\n03_Grundbuchauszug (Land Register Extract) ⭐ CORE\\n   Keywords: Grundbuch, Land, Register, Auszug\\n   Description: Official land registry extract\\n\\n04_Eintragungsbewilligungen (Entry Permits)\\n   Keywords: Eintragung, Bewilligung, Entry, Permit\\n   Description: Permits for land register entries\\n\\n05_Bodenrichtwert (Land Value)\\n   Keywords: Boden, Richtwert, Land, Value\\n   Description: Official land value assessment\\n\\n06_Baulastenverzeichnis (Building Encumbrance Register)\\n   Keywords: Baulast, Verzeichnis, Encumbrance\\n   Description: Register of building encumbrances\\n\\n07_Altlastenkataster (Contaminated Sites Register)\\n   Keywords: Altlast, Kataster, Contaminated\\n   Description: Register of contaminated sites\\n\\n08_Baugrundgutachten (Soil Survey)\\n   Keywords: Baugrund, Gutachten, Soil, Survey\\n   Description: Soil conditions assessment\\n\\n09_Lageplan (Site Plan)\\n   Keywords: Lage, Plan, Site\\n   Description: Site location plan\\n\\n10_Bautraegerkalkulation_DIN276 (Developer Calculation) ⭐ CORE\\n   Keywords: Bautraeger, Kalkulation, DIN276, Calculation\\n   Description: Developer cost calculation per DIN276 standard\\n\\n15_Flaechenberechnung_DIN277 (Area Calculation DIN277)\\n   Keywords: Flaeche, Berechnung, DIN277, Area\\n   Description: Area calculation per DIN277 standard\\n\\n16_GU_Werkvertraege (General Contractor Agreements)\\n   Keywords: GU, Werkvertrag, Contractor, Agreement\\n   Description: General contractor work agreements\\n\\n17_Bauzeichnungen (Construction Drawings)\\n   Keywords: Bau, Zeichnung, Construction, Drawing\\n   Description: Construction and architectural drawings\\n\\n18_Baugenehmigung (Building Permit)\\n   Keywords: Bau, Genehmigung, Building, Permit\\n   Description: Official building permit\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"01_Projektbeschreibung\\\",\\n  \\\"tier2Confidence\\\": 88,\\n  \\\"germanName\\\": \\\"Projektbeschreibung\\\",\\n  \\\"englishName\\\": \\\"Exposé/Project Description\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above (e.g., \\\"01_Projektbeschreibung\\\")\\n- isCoreType: true for ⭐ CORE types, false for others\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'WIRTSCHAFTLICHE_UNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n11_Verkaufspreise (Sales Prices)\\n   Keywords: Verkauf, Preis, Sales, Price\\n   Description: Sales price lists and calculations\\n\\n12_Bauzeitenplan_Liquiditaet (Construction Schedule & Liquidity)\\n   Keywords: Bauzeit, Plan, Liquiditaet, Schedule\\n   Description: Construction timeline and liquidity planning\\n\\n13_Vertriebsweg (Distribution Channel)\\n   Keywords: Vertrieb, Weg, Distribution, Channel\\n   Description: Sales and distribution strategy\\n\\n14_Bau_Ausstattungsbeschreibung (Construction & Equipment Description)\\n   Keywords: Bau, Ausstattung, Beschreibung, Equipment\\n   Description: Construction specifications and equipment details\\n\\n19_Teilungserklaerung (Declaration of Division)\\n   Keywords: Teilung, Erklaerung, Division, Declaration\\n   Description: Property division declaration\\n\\n20_Versicherungen (Insurance)\\n   Keywords: Versicherung, Insurance\\n   Description: Insurance policies and documentation\\n\\n21_Muster_Verkaufsvertrag (Sample Sales Contract)\\n   Keywords: Muster, Verkauf, Vertrag, Sample, Sales\\n   Description: Template sales contract\\n\\n23_Umsatzsteuervoranmeldung (VAT Advance Return)\\n   Keywords: Umsatz, Steuer, Voranmeldung, VAT\\n   Description: VAT advance return filings\\n\\n24_BWA (Business Evaluation)\\n   Keywords: BWA, Business, Evaluation\\n   Description: Business evaluation report\\n\\n25_Jahresabschluss (Annual Financial Statement)\\n   Keywords: Jahres, Abschluss, Annual, Financial\\n   Description: Annual financial statement\\n\\n26_Finanzierungsbestaetigung (Financing Confirmation)\\n   Keywords: Finanzierung, Bestaetigung, Financing, Confirmation\\n   Description: Financing approval or confirmation\\n\\n27_Darlehensvertrag (Loan Agreement)\\n   Keywords: Darlehen, Vertrag, Loan, Agreement\\n   Description: Loan contract\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"11_Verkaufspreise\\\",\\n  \\\"tier2Confidence\\\": 92,\\n  \\\"germanName\\\": \\\"Verkaufspreise\\\",\\n  \\\"englishName\\\": \\\"Sales Prices\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all WIRTSCHAFTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'RECHTLICHE_UNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n28_Gesellschaftsvertrag (Partnership Agreement)\\n   Keywords: Gesellschaft, Vertrag, Partnership, Agreement\\n   Description: Company partnership or shareholder agreement\\n\\n29_Handelsregisterauszug (Commercial Register Extract)\\n   Keywords: Handelsregister, Auszug, Commercial, Register\\n   Description: Commercial register extract\\n\\n30_Gewerbeanmeldung (Business Registration)\\n   Keywords: Gewerbe, Anmeldung, Business, Registration\\n   Description: Business registration documentation\\n\\n31_Steuer_ID (Tax ID)\\n   Keywords: Steuer, ID, Tax\\n   Description: Tax identification number\\n\\n32_Freistellungsbescheinigung (Exemption Certificate)\\n   Keywords: Freistellung, Bescheinigung, Exemption, Certificate\\n   Description: Tax exemption certificate\\n\\n33_Vollmachten (Powers of Attorney)\\n   Keywords: Vollmacht, Power, Attorney\\n   Description: Power of attorney documents\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"28_Gesellschaftsvertrag\\\",\\n  \\\"tier2Confidence\\\": 85,\\n  \\\"germanName\\\": \\\"Gesellschaftsvertrag\\\",\\n  \\\"englishName\\\": \\\"Partnership Agreement\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all RECHTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'SONSTIGES') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as SONSTIGES (Miscellaneous) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n22_Gutachterauftrag (Expert Assignment)\\n   Keywords: Gutachter, Auftrag, Expert, Assignment\\n   Description: Expert assessment assignment\\n\\n34_Korrespondenz (Correspondence)\\n   Keywords: Korrespondenz, Email, Brief, Letter, Correspondence\\n   Description: Email correspondence and letters\\n\\n35_Sonstiges_Allgemein (General Miscellaneous)\\n   Keywords: Sonstiges, Misc, General\\n   Description: General miscellaneous documents\\n\\n36_Exit_Strategie (Exit Strategy) ⭐ CORE\\n   Keywords: Exit, Strategie, Strategy\\n   Description: Investment exit strategy\\n\\n37_Others (Others)\\n   Keywords: Other, Andere\\n   Description: Other unclassified documents\\n\\n38_Unknowns (Unknowns)\\n   Keywords: Unknown, Unbekannt\\n   Description: Unknown document type\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n5. Use 38_Unknowns ONLY if truly unclear\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"36_Exit_Strategie\\\",\\n  \\\"tier2Confidence\\\": 95,\\n  \\\"germanName\\\": \\\"Exit Strategie\\\",\\n  \\\"englishName\\\": \\\"Exit Strategy\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: true ONLY for 36_Exit_Strategie\\n- Valid JSON only, no markdown`;\n  } else {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nERROR: Unknown category \\\"${tier1Category}\\\". Please classify as SONSTIGES > 38_Unknowns.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"38_Unknowns\\\",\\n  \\\"tier2Confidence\\\": 0,\\n  \\\"germanName\\\": \\\"Unknowns\\\",\\n  \\\"englishName\\\": \\\"Unknown\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Unknown Tier 1 category: ${tier1Category}\\\"\\n}`;\n  }\n\n  if (tier1Confidence < 60) {\n    outputItems.push({\n      json: {\n        tier1Category, tier1Confidence, tier1Reasoning: reasoning, tier2Prompt,\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        lowConfidence: true, confidenceFailureStage: 'tier1',\n        ...item.json\n      }\n    });\n  } else {\n    outputItems.push({\n      json: {\n        tier1Category, tier1Confidence, tier1Reasoning: reasoning, tier2Prompt,\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        ...item.json\n      }\n    });\n  }\n}\n\nreturn outputItems;"
          },
          "id": "code-2",
          "name": "Parse Classification Result",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            2128,
            256
          ]
        },
        {
          "parameters": {
            "documentId": {
              "mode": "id",
              "value": "12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I"
            },
            "sheetName": {
              "mode": "name",
              "value": "Client_Tracker"
            },
            "options": {}
          },
          "id": "sheets-1",
          "name": "Lookup Client in Client_Tracker",
          "type": "n8n-nodes-base.googleSheets",
          "typeVersion": 4.7,
          "position": [
            3920,
            256
          ],
          "credentials": {
            "googleSheetsOAuth2Api": {
              "id": "H7ewI1sOrDYabelt",
              "name": "Google Sheets account"
            }
          }
        },
        {
          "parameters": {
            "jsCode": "// FIX: Reference classification data from upstream node directly\n// The Sheets lookup output overwrites $input, so we must reference Determine Action Type\n\nconst items = $input.all();\nconst outputItems = [];\n\n// Get classification data from upstream (preserved across Sheets lookup)\nconst classificationData = $('Determine Action Type').first().json;\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const trackerData = $('Lookup Client in Client_Tracker').all();\n  \n  // Get client info from classification data (not from Sheets output)\n  const clientNormalized = classificationData.client_normalized || classificationData.clientNormalized || '';\n  const documentType = classificationData.documentType || '';\n  const confidence = classificationData.combinedConfidence || classificationData.tier2Confidence || 0;\n  const fileId = classificationData.fileId || '';\n  const fileName = classificationData.fileName || '';\n\n  // Check if confidence is too low\n  if (confidence < 70) {\n    outputItems.push({\n      json: {\n        ...classificationData,  // Preserve all classification data\n        ...item.json,           // Include sheet row data\n        chunk2_5_status: 'error_unclear_type',\n        errorMessage: `Low confidence (${confidence}%) - document type unclear`\n      }\n    });\n    continue;\n  }\n\n  // Check if any data was returned from tracker\n  if (!trackerData || trackerData.length === 0) {\n    outputItems.push({\n      json: {\n        ...classificationData,\n        chunk2_5_status: 'error_client_not_found',\n        errorMessage: 'No data returned from Client_Tracker lookup'\n      }\n    });\n    continue;\n  }\n\n  // Find matching client row\n  const clientRow = trackerData.find(row => {\n    const sheetClientName = row.json.Client_Name || '';\n    const normalizedSheetName = sheetClientName\n      .toLowerCase()\n      .trim()\n      .replace(/ä/g, 'ae')\n      .replace(/ö/g, 'oe')\n      .replace(/ü/g, 'ue')\n      .replace(/ß/g, 'ss')\n      .replace(/\\s*(gmbh|ag|kg|e\\.v\\.|mbh|co\\.|&\\s*co\\.?)\\s*/gi, '')\n      .replace(/[^a-z0-9]/g, '_')\n      .replace(/_+/g, '_')\n      .replace(/^_|_$/g, '');\n    return normalizedSheetName === clientNormalized;\n  });\n\n  if (!clientRow || !clientRow.json.Client_Name) {\n    outputItems.push({\n      json: {\n        ...classificationData,\n        chunk2_5_status: 'error_client_not_found',\n        errorMessage: `Client not found in tracker: \"${clientNormalized}\"`\n      }\n    });\n    continue;\n  }\n\n  // Client found and validated - prepare for success path\n  outputItems.push({\n    json: {\n      ...classificationData,        // All classification data (fileId, confidence, documentType, etc.)\n      ...clientRow.json,            // Sheet row data\n      clientFound: true,\n      trackerRowIndex: clientRow.json.row_number || 0,\n      trackerClientName: clientRow.json.Client_Name,\n      chunk2_5_status: 'success'\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-3",
          "name": "Find Client Row and Validate",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            4080,
            64
          ]
        },
        {
          "parameters": {
            "documentId": {
              "__rl": true,
              "value": "12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I",
              "mode": "list",
              "cachedResultName": "AMA Client Document Tracker",
              "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I/edit?usp=drivesdk"
            },
            "sheetName": {
              "__rl": true,
              "value": 1217593734,
              "mode": "list",
              "cachedResultName": "Client_Tracker",
              "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I/edit#gid=1217593734"
            },
            "options": {}
          },
          "id": "sheets-2",
          "name": "Update Client_Tracker Row",
          "type": "n8n-nodes-base.googleSheets",
          "typeVersion": 4.7,
          "position": [
            4816,
            112
          ],
          "credentials": {
            "googleSheetsOAuth2Api": {
              "id": "H7ewI1sOrDYabelt",
              "name": "Google Sheets account"
            }
          }
        },
        {
          "parameters": {
            "documentId": {
              "mode": "id",
              "value": "1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU"
            },
            "sheetName": {
              "__rl": true,
              "value": "gid=0",
              "mode": "list",
              "cachedResultName": "AMA_Folder_IDs",
              "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU/edit#gid=0"
            },
            "options": {}
          },
          "id": "sheets-3",
          "name": "Lookup Client in AMA_Folder_IDs",
          "type": "n8n-nodes-base.googleSheets",
          "typeVersion": 4.7,
          "position": [
            5040,
            176
          ],
          "credentials": {
            "googleSheetsOAuth2Api": {
              "id": "H7ewI1sOrDYabelt",
              "name": "Google Sheets account"
            }
          }
        },
        {
          "parameters": {
            "jsCode": "// Get Destination Folder ID - V13 Clean\n// 6 DESTINATIONS:\n// 1-4: CORE docs -> Specific folders\n// 5: SECONDARY (known but not core) -> 37_Others\n// 6: LOW_CONFIDENCE/Unknown -> 38_Unknowns\n\nconst classificationData = $('Find Client Row and Validate').first().json;\n\n// Get fileId from classification data (passed through from trigger)\nconst fileId = classificationData.fileId;\nconst fileName = classificationData.fileName;\n\n// Get classification info\nconst actionType = classificationData.actionType;\nconst documentType = classificationData.documentType;\nconst tier1Category = classificationData.tier1Category;\nconst client_name = classificationData.client_name;\nconst client_normalized = classificationData.client_normalized;\n\n// Build lookup from ALL folder rows\nconst allFolderRows = $input.all();\nconst folderLookup = {};\nfor (const row of allFolderRows) {\n  folderLookup[row.json.Variable_Name] = row.json.Folder_ID;\n}\n\nlet finalFolderId;\nlet destinationFolderName;\nlet variableNameSearched;\n\n// CORE DOCUMENTS (4 types) -> Specific Folders\nif (actionType === 'CORE') {\n  const coreMapping = {\n    '01_Projektbeschreibung': { varName: 'FOLDER_01_PROJEKTBESCHREIBUNG', displayName: '01_Projektbeschreibung' },\n    '03_Grundbuchauszug': { varName: 'FOLDER_03_GRUNDBUCHAUSZUG', displayName: '03_Grundbuchauszug' },\n    '10_Bautraegerkalkulation_DIN276': { varName: 'FOLDER_10_BAUTRAEGERKALKULATION', displayName: '10_Bautraegerkalkulation' },\n    '36_Exit_Strategie': { varName: 'FOLDER_36_EXIT_STRATEGIE', displayName: '36_Exit_Strategie' }\n  };\n\n  const mapping = coreMapping[documentType];\n  if (mapping) {\n    variableNameSearched = mapping.varName;\n    destinationFolderName = mapping.displayName;\n  } else {\n    variableNameSearched = 'FOLDER_38_UNKNOWNS';\n    destinationFolderName = '38_Unknowns';\n  }\n}\n// SECONDARY DOCUMENTS (known but not core) -> 37_Others\nelse if (actionType === 'SECONDARY') {\n  variableNameSearched = 'FOLDER_37_OTHERS';\n  destinationFolderName = '37_Others';\n}\n// LOW_CONFIDENCE or UNKNOWN -> 38_Unknowns\nelse {\n  variableNameSearched = 'FOLDER_38_UNKNOWNS';\n  destinationFolderName = '38_Unknowns';\n}\n\n// Get folder ID from lookup\nfinalFolderId = folderLookup[variableNameSearched];\n\nreturn [{\n  json: {\n    fileId: fileId,\n    fileName: fileName,\n    finalFolderId: finalFolderId,\n    destinationFolderName: destinationFolderName,\n    actionType: actionType,\n    documentType: documentType,\n    tier1Category: tier1Category,\n    client_name: client_name,\n    client_normalized: client_normalized,\n    debug_variableNameSearched: variableNameSearched,\n    debug_folderLookupSize: Object.keys(folderLookup).length\n  }\n}];"
          },
          "id": "code-4",
          "name": "Get Destination Folder ID",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            5264,
            176
          ]
        },
        {
          "parameters": {
            "operation": "move",
            "fileId": {
              "__rl": true,
              "mode": "id",
              "value": "={{ $json.fileId }}"
            },
            "driveId": {
              "__rl": true,
              "mode": "list",
              "value": "My Drive"
            },
            "folderId": {
              "__rl": true,
              "mode": "id",
              "value": "={{ $json.finalFolderId }}"
            }
          },
          "id": "drive-1",
          "name": "Move File to Final Location",
          "type": "n8n-nodes-base.googleDrive",
          "typeVersion": 3,
          "position": [
            5488,
            176
          ],
          "credentials": {
            "googleDriveOAuth2Api": {
              "id": "a4m50EefR3DJoU0R",
              "name": "Google Drive account"
            }
          }
        },
        {
          "parameters": {
            "jsCode": "// FIX: Process ALL items\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  outputItems.push({\n    json: {\n      ...item.json,\n      trackerUpdated: true,\n      chunk2_5_status: 'success',\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-5",
          "name": "Prepare Success Output",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            5712,
            352
          ]
        },
        {
          "parameters": {
            "documentId": {
              "mode": "id",
              "value": "1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU"
            },
            "sheetName": {
              "__rl": true,
              "value": "gid=0",
              "mode": "list",
              "cachedResultName": "AMA_Folder_IDs",
              "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU/edit#gid=0"
            },
            "options": {}
          },
          "id": "sheets-4",
          "name": "Lookup 38_Unknowns Folder",
          "type": "n8n-nodes-base.googleSheets",
          "typeVersion": 4.7,
          "position": [
            4592,
            432
          ],
          "credentials": {
            "googleSheetsOAuth2Api": {
              "id": "H7ewI1sOrDYabelt",
              "name": "Google Sheets account"
            }
          }
        },
        {
          "parameters": {
            "jsCode": "// FIX: Process ALL items from main data\nconst folderData = $input.all();\nconst mainDataItems = $('Find Client Row and Validate').all();\nconst outputItems = [];\n\n// Skip header row from folder data\nconst dataRows = folderData.slice(1);\n\n// Look for 38_Unknowns folder ID (should be same for all items)\nlet unknownsFolderId = null;\nif (dataRows.length > 0) {\n  for (const row of dataRows) {\n    const rowData = row.json;\n    for (const key in rowData) {\n      if (key.includes('38_Unknowns')) {\n        unknownsFolderId = rowData[key];\n        break;\n      }\n    }\n    if (unknownsFolderId) break;\n  }\n\n  if (!unknownsFolderId) {\n    // Try to get from first row (assuming it might be a global folder)\n    unknownsFolderId = dataRows[0].json['38_Unknowns'] || null;\n  }\n}\n\n// Return one output item per main data item\nfor (const mainData of mainDataItems) {\n  outputItems.push({\n    json: {\n      ...mainData.json,\n      unknownsFolderId: unknownsFolderId,\n      errorFallbackUsed: !unknownsFolderId\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-6",
          "name": "Get 38_Unknowns Folder ID",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            4816,
            432
          ]
        },
        {
          "parameters": {
            "operation": "move",
            "fileId": {
              "__rl": true,
              "mode": "id",
              "value": "={{ $json.fileId }}"
            },
            "driveId": {
              "__rl": true,
              "mode": "list",
              "value": "My Drive"
            },
            "folderId": {
              "__rl": true,
              "mode": "id",
              "value": "={{ $json.unknownsFolderId }}"
            }
          },
          "id": "drive-2",
          "name": "Move File to 38_Unknowns",
          "type": "n8n-nodes-base.googleDrive",
          "typeVersion": 3,
          "position": [
            5040,
            432
          ],
          "credentials": {
            "googleDriveOAuth2Api": {
              "id": "a4m50EefR3DJoU0R",
              "name": "Google Drive account"
            }
          }
        },
        {
          "parameters": {
            "jsCode": "// FIX: Process ALL items\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const mainData = item.json;\n\n  // FIX: Use client_normalized (snake_case) to match what's being passed\n  const clientName = mainData.client_normalized || mainData.clientNormalized || 'Unknown';\n  const fileName = mainData.fileName || 'Unknown';\n  const fileId = mainData.fileId || '';\n  const errorStatus = mainData.chunk2_5_status || 'unknown_error';\n  const errorMessage = mainData.errorMessage || 'No error details provided';\n  const documentType = mainData.documentType || 'Unknown';\n  const confidence = mainData.documentClassificationConfidence || 0;\n\n  let issueDescription = '';\n  if (errorStatus === 'error_client_not_found') {\n    issueDescription = `Client \\\"${clientName}\\\" was not found in the Client_Tracker sheet.`;\n  } else if (errorStatus === 'error_unclear_type') {\n    issueDescription = `Document type classification had low confidence (${confidence}%). Classified as: ${documentType}.`;\n  } else if (errorStatus === 'error_folder_not_found') {\n    issueDescription = `Destination folder for document type \\\"${documentType}\\\" was not found in AMA_Folder_IDs.`;\n  } else {\n    issueDescription = errorMessage;\n  }\n\n  const fileLink = `https://drive.google.com/file/d/${fileId}/view`;\n\n  const emailSubject = `Eugene: Document Classification Issue - ${clientName}`;\n  const emailBody = `<html>\n<body>\n<h2>Document Classification Issue</h2>\n<p>A document could not be automatically classified and has been moved to the 38_Unknowns folder.</p>\n\n<h3>Details:</h3>\n<ul>\n  <li><strong>Client:</strong> ${clientName}</li>\n  <li><strong>Filename:</strong> ${fileName}</li>\n  <li><strong>Issue:</strong> ${issueDescription}</li>\n  <li><strong>Classified Type:</strong> ${documentType} (${confidence}% confidence)</li>\n  <li><strong>Error Status:</strong> ${errorStatus}</li>\n</ul>\n\n<h3>File Location:</h3>\n<p><a href=\\\"${fileLink}\\\">View file in Google Drive</a></p>\n\n<p>Please review this document and manually classify it.</p>\n</body>\n</html>`;\n\n  outputItems.push({\n    json: {\n      ...mainData,\n      emailSubject: emailSubject,\n      emailBody: emailBody,\n      trackerUpdated: false,\n      chunk2_5_status: errorStatus,\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-7",
          "name": "Prepare Error Email Body",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            5264,
            432
          ]
        },
        {
          "parameters": {
            "sendTo": "={{ $json.emailRecipient || 'sway@thebluebottle.io' }}",
            "subject": "Document Classification Error - Action Required",
            "message": "={{ $json.emailBody }}",
            "options": {}
          },
          "id": "gmail-1",
          "name": "Send Error Notification Email",
          "type": "n8n-nodes-base.gmail",
          "typeVersion": 2.1,
          "position": [
            5488,
            432
          ],
          "webhookId": "d50e78b4-8ae0-4171-b62f-c2afdafc7e58",
          "credentials": {
            "gmailOAuth2": {
              "id": "gmailOAuth2",
              "name": "Gmail OAuth2"
            }
          }
        },
        {
          "parameters": {
            "jsCode": "// Prepare Tracker Update Data - V8 Conditional (CORE types only)\n// FIX: Process ALL items\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const data = item.json;\n\n  // CONDITIONAL: Only prepare tracker data if trackerUpdate === true\n  if (data.trackerUpdate !== true) {\n    // SECONDARY or LOW_CONFIDENCE: Skip tracker update, pass through to folder move\n    outputItems.push({\n      json: {\n        skipTrackerUpdate: true,\n        ...data\n      }\n    });\n    continue;\n  }\n\n  // CORE types: Prepare tracker update data\n  const documentType = data.documentType;\n\n  // Map document type to tracker column\n  const trackerColumnMapping = {\n    '01_Projektbeschreibung': 'Status_Expose',\n    '03_Grundbuchauszug': 'Status_Grundbuch',\n    '10_Bautraegerkalkulation_DIN276': 'Status_Calculation',\n    '36_Exit_Strategie': 'Status_Exit_Strategy'\n  };\n\n  const trackerColumn = trackerColumnMapping[documentType];\n\n  if (!trackerColumn) {\n    // Should not happen if CORE mapping is correct\n    outputItems.push({\n      json: {\n        error: 'Unknown CORE document type for tracker mapping',\n        skipTrackerUpdate: true,\n        ...data\n      }\n    });\n    continue;\n  }\n\n  // Prepare update data for Client_Tracker\n  const updateData = {\n    [trackerColumn]: '✓'\n  };\n\n  outputItems.push({\n    json: {\n      trackerColumn,\n      trackerValue: '✓',\n      updateData,\n      skipTrackerUpdate: false,\n      ...data\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-8",
          "name": "Prepare Tracker Update Data",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            4592,
            112
          ]
        },
        {
          "parameters": {
            "method": "POST",
            "url": "https://api.openai.com/v1/chat/completions",
            "authentication": "predefinedCredentialType",
            "nodeCredentialType": "openAiApi",
            "sendBody": true,
            "specifyBody": "json",
            "jsonBody": "={{ ({ \"model\": \"gpt-4\", \"messages\": [{\"role\": \"user\", \"content\": $json.tier1Prompt}], \"temperature\": 0 }) }}",
            "options": {}
          },
          "id": "http-openai-1",
          "name": "Classify Document with GPT-4",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.2,
          "position": [
            1904,
            816
          ],
          "credentials": {
            "openAiApi": {
              "id": "xmJ7t6kaKgMwA1ce",
              "name": "OpenAi account"
            }
          },
          "disabled": true
        },
        {
          "parameters": {
            "method": "POST",
            "url": "https://api.openai.com/v1/chat/completions",
            "authentication": "predefinedCredentialType",
            "nodeCredentialType": "openAiApi",
            "sendBody": true,
            "specifyBody": "json",
            "jsonBody": "={{ ({ \"model\": \"gpt-4\", \"messages\": [{\"role\": \"user\", \"content\": $json.tier2Prompt}], \"temperature\": 0 }) }}",
            "options": {}
          },
          "id": "3732e080-c0d3-4763-957d-d4d90761ddd8",
          "name": "Tier 2 GPT-4 API Call",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.2,
          "position": [
            3024,
            816
          ],
          "credentials": {
            "openAiApi": {
              "id": "xmJ7t6kaKgMwA1ce",
              "name": "OpenAi account"
            }
          },
          "disabled": true
        },
        {
          "parameters": {
            "jsCode": "// Parse Tier 2 Classification Result from Claude Vision\n// FIX: Process ALL items, not just first\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  // Get corresponding Tier 2 result\n  const tier2Result = $('Parse Claude Tier 2 Response').all()[i].json;\n\n  if (!tier2Result || !tier2Result.documentType) {\n    // Parsing failed - route to LOW_CONFIDENCE\n    outputItems.push({\n      json: {\n        error: 'Failed to parse Tier 2 classification',\n        lowConfidence: true,\n        confidenceFailureStage: 'tier2_parse_error',\n        ...tier2Result\n      }\n    });\n    continue;\n  }\n\n  const {\n    documentType, tier2Confidence, germanName, englishName, isCoreType, tier2Reasoning,\n    fileId, fileName, fileUrl, clientEmail,\n    client_name, client_normalized,  // FIX: Preserve client data\n    tier1Category, tier1Confidence, tier1Reasoning\n  } = tier2Result;\n\n  // THRESHOLD CHECK: Tier 2 confidence must be >= 70%\n  if (tier2Confidence < 70) {\n    outputItems.push({\n      json: {\n        documentType, tier2Confidence, lowConfidence: true, confidenceFailureStage: 'tier2',\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        tier1Category, tier1Confidence, tier1Reasoning\n      }\n    });\n  } else {\n    // Calculate combined confidence\n    const combinedConfidence = Math.round((tier1Confidence + tier2Confidence) / 2);\n\n    outputItems.push({\n      json: {\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        tier1Category, tier1Confidence, tier1Reasoning,\n        documentType, tier2Confidence, combinedConfidence,\n        germanName, englishName, isCoreType, tier2Reasoning\n      }\n    });\n  }\n}\n\nreturn outputItems;"
          },
          "id": "86d8d160-de91-464d-92d0-7db05b7c3f4f",
          "name": "Parse Tier 2 Result",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            3248,
            256
          ]
        },
        {
          "parameters": {
            "jsCode": "// Action Mapper: Determine routing based on classification results\n\nconst data = $input.first().json;\n\n// Check for low confidence flags\nif (data.lowConfidence === true) {\n  return [{\n    json: {\n      ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n      actionType: 'LOW_CONFIDENCE',\n      destinationFolder: '38_Unknowns',\n      trackerUpdate: false,\n      sendNotification: true\n    }\n  }];\n}\n\n// Check if CORE type\nif (data.isCoreType === true) {\n  // CORE types: Specific folder + tracker update\n  return [{\n    json: {\n      ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n      actionType: 'CORE',\n      trackerUpdate: true,\n      sendNotification: false\n    }\n  }];\n}\n\n// SECONDARY types: 37_Other folder + tracker update (so Eugene can see what they are)\nreturn [{\n  json: {\n    ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n    actionType: 'SECONDARY',\n    destinationFolder: '37_Other',\n    trackerUpdate: true,\n    sendNotification: false\n  }\n}];"
          },
          "id": "89b7324c-80e6-4902-9ab5-3f26be09e92a",
          "name": "Determine Action Type",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            3472,
            256
          ]
        },
        {
          "parameters": {
            "operation": "download",
            "fileId": "={{ $json.fileId }}",
            "options": {}
          },
          "id": "drive-download-1",
          "name": "Download PDF for Classification",
          "type": "n8n-nodes-base.googleDrive",
          "typeVersion": 3,
          "position": [
            560,
            256
          ],
          "credentials": {
            "googleDriveOAuth2Api": {
              "id": "a4m50EefR3DJoU0R",
              "name": "Google Drive account"
            }
          }
        },
        {
          "parameters": {
            "jsCode": "// Convert PDF to Base64\n// Processing one file at a time (via Split In Batches upstream)\n// Rate limiting handled by Wait nodes between Claude Vision calls\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  try {\n    const binaryKey = Object.keys(item.binary || {})[0];\n    \n    if (!binaryKey) {\n      // No binary data, pass through\n      outputItems.push({\n        json: {\n          ...item.json,\n          pdfError: 'No binary data found'\n        }\n      });\n      continue;\n    }\n    \n    const buffer = await this.helpers.getBinaryDataBuffer(items.indexOf(item), binaryKey);\n    const base64Content = buffer.toString('base64');\n    const mimeType = item.json.mimeType || 'application/pdf';\n    const fileSizeKB = Math.round(buffer.length / 1024);\n    \n    outputItems.push({\n      json: {\n        ...item.json,\n        imageData: {\n          type: 'base64',\n          media_type: mimeType,\n          data: base64Content\n        },\n        pdfMetadata: {\n          fileSizeKB: fileSizeKB,\n          note: 'Full PDF sent - rate limiting via Wait nodes'\n        }\n      },\n      binary: item.binary\n    });\n  } catch (error) {\n    outputItems.push({\n      json: {\n        ...item.json,\n        pdfError: error.message\n      }\n    });\n  }\n}\n\nreturn outputItems;"
          },
          "id": "code-convert-pdf",
          "name": "Convert PDF to Base64",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            784,
            256
          ]
        },
        {
          "parameters": {
            "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  // FIX: Get tier1Prompt from the SAME item, not always from first()\n  const tier1Prompt = item.json.tier1Prompt;\n  const imageData = item.json.imageData;\n\n  if (!imageData || !imageData.data) {\n    throw new Error('No image data found in item');\n  }\n\n  const requestBody = {\n    model: 'claude-sonnet-4-20250514',\n    max_tokens: 200,\n    messages: [\n      {\n        role: 'user',\n        content: [\n          {\n            type: 'document',\n            source: {\n              type: 'base64',\n              media_type: imageData.media_type,\n              data: imageData.data\n            }\n          },\n          {\n            type: 'text',\n            text: tier1Prompt\n          }\n        ]\n      }\n    ]\n  };\n\n  outputItems.push({\n    json: {\n      ...item.json,\n      claudeRequestBody: requestBody\n    },\n    binary: item.binary\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-build-claude-tier1",
          "name": "Build Claude Tier 1 Request Body",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            1232,
            256
          ]
        },
        {
          "parameters": {
            "method": "POST",
            "url": "https://api.anthropic.com/v1/messages",
            "authentication": "genericCredentialType",
            "genericAuthType": "httpHeaderAuth",
            "sendHeaders": true,
            "headerParameters": {
              "parameters": [
                {
                  "name": "anthropic-version",
                  "value": "2023-06-01"
                },
                {
                  "name": "Content-Type",
                  "value": "application/json"
                }
              ]
            },
            "sendBody": true,
            "specifyBody": "json",
            "jsonBody": "={{ $json.claudeRequestBody }}",
            "options": {}
          },
          "id": "http-claude-tier1",
          "name": "Claude Vision Tier 1 Classification",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.2,
          "position": [
            1456,
            256
          ],
          "credentials": {
            "httpHeaderAuth": {
              "id": "vfoYopBRX35Znmq6",
              "name": "Anthropic API key"
            }
          },
          "retryOnFail": true,
          "maxTries": 3,
          "waitBetweenTries": 30000
        },
        {
          "parameters": {
            "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const response = item.json;\n\n  if (!response.content || !response.content[0] || !response.content[0].text) {\n    throw new Error('Invalid Claude API response structure');\n  }\n\n  let textContent = response.content[0].text.trim();\n\n  // Strip markdown code fences if present\n  if (textContent.startsWith('```json')) {\n    textContent = textContent\n      .replace(/^```json\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  } else if (textContent.startsWith('```')) {\n    textContent = textContent\n      .replace(/^```\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  }\n\n  const parsedResult = JSON.parse(textContent);\n  \n  // FIX CRITICAL: Get metadata from the corresponding item in previous node\n  const previousData = $('Build Claude Tier 1 Request Body').all()[i].json;\n\n  outputItems.push({\n    json: {\n      ...previousData,  // PRESERVE ALL INCOMING DATA including client_name, client_normalized\n      tier1Category: parsedResult.tier1Category,\n      tier1Confidence: parsedResult.tier1Confidence,\n      tier1Reasoning: parsedResult.reasoning || ''\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-parse-claude-tier1",
          "name": "Parse Claude Tier 1 Response",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            1904,
            256
          ]
        },
        {
          "parameters": {
            "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const tier2Prompt = item.json.tier2Prompt;\n  \n  // FIX: Get imageData from the corresponding item, not always first()\n  const imageData = $('Convert PDF to Base64').all()[i].json.imageData;\n\n  if (!imageData || !imageData.data) {\n    throw new Error('No image data found for Tier 2 classification');\n  }\n\n  const requestBody = {\n    model: 'claude-sonnet-4-20250514',\n    max_tokens: 300,\n    messages: [\n      {\n        role: 'user',\n        content: [\n          {\n            type: 'document',\n            source: {\n              type: 'base64',\n              media_type: imageData.media_type,\n              data: imageData.data\n            }\n          },\n          {\n            type: 'text',\n            text: tier2Prompt\n          }\n        ]\n      }\n    ]\n  };\n\n  outputItems.push({\n    json: {\n      ...item.json,\n      claudeTier2RequestBody: requestBody\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-build-claude-tier2",
          "name": "Build Claude Tier 2 Request Body",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            2352,
            256
          ]
        },
        {
          "parameters": {
            "method": "POST",
            "url": "https://api.anthropic.com/v1/messages",
            "authentication": "genericCredentialType",
            "genericAuthType": "httpHeaderAuth",
            "sendHeaders": true,
            "headerParameters": {
              "parameters": [
                {
                  "name": "anthropic-version",
                  "value": "2023-06-01"
                },
                {
                  "name": "Content-Type",
                  "value": "application/json"
                }
              ]
            },
            "sendBody": true,
            "specifyBody": "json",
            "jsonBody": "={{ $json.claudeTier2RequestBody }}",
            "options": {}
          },
          "id": "http-claude-tier2",
          "name": "Claude Vision Tier 2 Classification",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.2,
          "position": [
            2576,
            256
          ],
          "credentials": {
            "httpHeaderAuth": {
              "id": "vfoYopBRX35Znmq6",
              "name": "Anthropic API key"
            }
          },
          "retryOnFail": true,
          "maxTries": 3,
          "waitBetweenTries": 30000
        },
        {
          "parameters": {
            "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const response = item.json;\n\n  if (!response.content || !response.content[0] || !response.content[0].text) {\n    throw new Error('Invalid Claude API Tier 2 response structure');\n  }\n\n  let textContent = response.content[0].text.trim();\n\n  // Strip markdown code fences if present\n  if (textContent.startsWith('```json')) {\n    textContent = textContent\n      .replace(/^```json\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  } else if (textContent.startsWith('```')) {\n    textContent = textContent\n      .replace(/^```\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  }\n\n  const parsedResult = JSON.parse(textContent);\n\n  // FIX: Get metadata from the corresponding item in previous node\n  const previousData = $('Parse Classification Result').all()[i].json;\n\n  outputItems.push({\n    json: {\n      ...previousData,  // This preserves client_name, client_normalized, etc.\n      documentType: parsedResult.documentType,\n      tier2Confidence: parsedResult.tier2Confidence,\n      germanName: parsedResult.germanName,\n      englishName: parsedResult.englishName,\n      isCoreType: parsedResult.isCoreType,\n      tier2Reasoning: parsedResult.reasoning || ''\n    }\n  });\n}\n\nreturn outputItems;"
          },
          "id": "code-parse-claude-tier2",
          "name": "Parse Claude Tier 2 Response",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [
            3024,
            256
          ]
        },
        {
          "parameters": {
            "amount": 30
          },
          "id": "wait-after-tier1",
          "name": "Wait After Tier 1",
          "type": "n8n-nodes-base.wait",
          "typeVersion": 1.1,
          "position": [
            1680,
            256
          ],
          "webhookId": "09d67e4e-d872-45b3-8421-4639ada494f7"
        },
        {
          "parameters": {
            "amount": 30
          },
          "id": "wait-after-tier2",
          "name": "Wait After Tier 2",
          "type": "n8n-nodes-base.wait",
          "typeVersion": 1.1,
          "position": [
            2800,
            256
          ],
          "webhookId": "2ebc9318-2e89-4007-9cdc-f38f3121d489"
        },
        {
          "parameters": {
            "options": {}
          },
          "id": "split-batches-001",
          "name": "Process One File at a Time",
          "type": "n8n-nodes-base.splitInBatches",
          "typeVersion": 3,
          "position": [
            288,
            240
          ]
        },
        {
          "parameters": {
            "rules": {
              "values": [
                {
                  "conditions": {
                    "options": {
                      "caseSensitive": true,
                      "leftValue": "",
                      "typeValidation": "strict",
                      "version": 3
                    },
                    "conditions": [
                      {
                        "id": "85b5d5c7-cb7b-43fb-a47a-7def8098a29b",
                        "leftValue": "={{ $json.chunk2_5_status }}",
                        "rightValue": "error_unclear_type",
                        "operator": {
                          "type": "string",
                          "operation": "equals",
                          "name": "filter.operator.equals"
                        }
                      }
                    ],
                    "combinator": "and"
                  },
                  "renameOutput": true,
                  "outputKey": "error"
                },
                {
                  "conditions": {
                    "options": {
                      "caseSensitive": true,
                      "leftValue": "",
                      "typeValidation": "strict",
                      "version": 3
                    },
                    "conditions": [
                      {
                        "id": "bc10ada4-798c-4d82-9b0b-062f7679e1c2",
                        "leftValue": "={{ $json.chunk2_5_status }}",
                        "rightValue": "success",
                        "operator": {
                          "type": "string",
                          "operation": "equals",
                          "name": "filter.operator.equals"
                        }
                      }
                    ],
                    "combinator": "and"
                  },
                  "renameOutput": true,
                  "outputKey": "update_tracker"
                },
                {
                  "conditions": {
                    "options": {
                      "caseSensitive": true,
                      "leftValue": "",
                      "typeValidation": "strict",
                      "version": 3
                    },
                    "conditions": [
                      {
                        "id": "032787ac-b6d7-417a-8011-f68246aed0e6",
                        "leftValue": "={{ $json.chunk2_5_status }}",
                        "rightValue": "error_client_not_found",
                        "operator": {
                          "type": "string",
                          "operation": "equals",
                          "name": "filter.operator.equals"
                        }
                      }
                    ],
                    "combinator": "and"
                  },
                  "renameOutput": true,
                  "outputKey": "skip_tracker"
                }
              ]
            },
            "options": {
              "fallbackOutput": "extra"
            }
          },
          "id": "d4336ded-fbdb-4dff-9518-4523471dc798",
          "name": "Route Based on Document Type1",
          "type": "n8n-nodes-base.switch",
          "typeVersion": 3.4,
          "position": [
            4304,
            -16
          ]
        }
      ],
      "connections": {
        "Lookup Client in Client_Tracker": {
          "main": [
            [
              {
                "node": "Find Client Row and Validate",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Update Client_Tracker Row": {
          "main": [
            [
              {
                "node": "Lookup Client in AMA_Folder_IDs",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Lookup Client in AMA_Folder_IDs": {
          "main": [
            [
              {
                "node": "Get Destination Folder ID",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Get Destination Folder ID": {
          "main": [
            [
              {
                "node": "Move File to Final Location",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Move File to Final Location": {
          "main": [
            [
              {
                "node": "Prepare Success Output",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Lookup 38_Unknowns Folder": {
          "main": [
            [
              {
                "node": "Get 38_Unknowns Folder ID",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Get 38_Unknowns Folder ID": {
          "main": [
            [
              {
                "node": "Move File to 38_Unknowns",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Move File to 38_Unknowns": {
          "main": [
            [
              {
                "node": "Prepare Error Email Body",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Prepare Error Email Body": {
          "main": [
            [
              {
                "node": "Send Error Notification Email",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Prepare Tracker Update Data": {
          "main": [
            [
              {
                "node": "Update Client_Tracker Row",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Classify Document with GPT-4": {
          "main": [
            [
              {
                "node": "Parse Classification Result",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Tier 2 GPT-4 API Call": {
          "main": [
            [
              {
                "node": "Parse Tier 2 Result",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Parse Tier 2 Result": {
          "main": [
            [
              {
                "node": "Determine Action Type",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Determine Action Type": {
          "main": [
            [
              {
                "node": "Lookup Client in Client_Tracker",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Find Client Row and Validate": {
          "main": [
            [
              {
                "node": "Route Based on Document Type1",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Download PDF for Classification": {
          "main": [
            [
              {
                "node": "Convert PDF to Base64",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Convert PDF to Base64": {
          "main": [
            [
              {
                "node": "Build AI Classification Prompt",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Build AI Classification Prompt": {
          "main": [
            [
              {
                "node": "Build Claude Tier 1 Request Body",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Build Claude Tier 1 Request Body": {
          "main": [
            [
              {
                "node": "Claude Vision Tier 1 Classification",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Parse Claude Tier 1 Response": {
          "main": [
            [
              {
                "node": "Parse Classification Result",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Parse Classification Result": {
          "main": [
            [
              {
                "node": "Build Claude Tier 2 Request Body",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Build Claude Tier 2 Request Body": {
          "main": [
            [
              {
                "node": "Claude Vision Tier 2 Classification",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Parse Claude Tier 2 Response": {
          "main": [
            [
              {
                "node": "Parse Tier 2 Result",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Claude Vision Tier 1 Classification": {
          "main": [
            [
              {
                "node": "Wait After Tier 1",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Wait After Tier 1": {
          "main": [
            [
              {
                "node": "Parse Claude Tier 1 Response",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Claude Vision Tier 2 Classification": {
          "main": [
            [
              {
                "node": "Wait After Tier 2",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Wait After Tier 2": {
          "main": [
            [
              {
                "node": "Parse Claude Tier 2 Response",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Execute Workflow Trigger (Refreshed)": {
          "main": [
            [
              {
                "node": "Process One File at a Time",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Process One File at a Time": {
          "main": [
            [
              {
                "node": "Download PDF for Classification",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Prepare Success Output": {
          "main": [
            [
              {
                "node": "Process One File at a Time",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Send Error Notification Email": {
          "main": [
            [
              {
                "node": "Process One File at a Time",
                "type": "main",
                "index": 0
              }
            ]
          ]
        },
        "Route Based on Document Type1": {
          "main": [
            [
              {
                "node": "Lookup 38_Unknowns Folder",
                "type": "main",
                "index": 0
              }
            ],
            [
              {
                "node": "Prepare Tracker Update Data",
                "type": "main",
                "index": 0
              }
            ],
            [
              {
                "node": "Lookup 38_Unknowns Folder",
                "type": "main",
                "index": 0
              }
            ],
            [
              {
                "node": "Lookup 38_Unknowns Folder",
                "type": "main",
                "index": 0
              }
            ]
          ]
        }
      },
      "authors": "Sway Clarke",
      "name": null,
      "description": null,
      "autosaved": false,
      "workflowPublishHistory": [
        {
          "createdAt": "2026-01-23T10:14:42.068Z",
          "id": 1140,
          "workflowId": "okg8wTqLtPUwjQ18",
          "versionId": "b3504eb4-b992-4640-92ca-d2a8a42a644d",
          "event": "activated",
          "userId": "e9bd9112-c2e3-4f67-873a-e1001baeafd8"
        }
      ]
    }
  },
  "executionStats": {
    "totalExecutions": 10,
    "successCount": 2,
    "errorCount": 8,
    "lastExecutionTime": "2026-01-22T23:22:15.813Z"
  },
  "hasWebhookTrigger": false,
  "webhookPath": null
}
