[
  {
    "type": "text",
    "text": "{\n  \"success\": true,\n  \"data\": {\n    \"updatedAt\": \"2026-01-14T14:28:42.992Z\",\n    \"createdAt\": \"2026-01-08T21:33:22.263Z\",\n    \"id\": \"okg8wTqLtPUwjQ18\",\n    \"name\": \"Chunk 2.5 - Client Document Tracking (Eugene Document Organizer)\",\n    \"description\": null,\n    \"active\": true,\n    \"isArchived\": false,\n    \"nodes\": [\n      {\n        \"parameters\": {\n          \"inputSource\": \"passthrough\"\n        },\n        \"id\": \"trigger-1\",\n        \"name\": \"Execute Workflow Trigger (Refreshed)\",\n        \"type\": \"n8n-nodes-base.executeWorkflowTrigger\",\n        \"typeVersion\": 1.1,\n        \"position\": [\n          112,\n          376\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Build Tier 1 Classification Prompt\\n// Classify document into 1 of 4 broad categories\\n\\n// === CRITICAL: Extract and preserve ALL file metadata fields ===\\n// Try to get fields from different possible data structures\\n// Handles both test data and production data from Pre-Chunk 0\\n\\nconst fileId = $input.first().json.fileId ||              // Direct from Pre-Chunk 0\\n               $input.first().json.body?.fileId ||        // Nested in body\\n               null;                                      // Explicit null if missing\\n\\nconst filename = $input.first().json.fileName ||              // Test data (camelCase)\\n                 $input.first().json.filename ||              // Legacy lowercase\\n                 $input.first().json.body?.fileName ||        // Production from Pre-Chunk 0\\n                 $input.first().json.body?.filename ||        // Fallback lowercase in body\\n                 'unknown_file.pdf';                          // Last resort default\\n\\nconst fileUrl = $input.first().json.fileUrl ||            // Direct from Pre-Chunk 0\\n                $input.first().json.body?.fileUrl ||      // Nested in body\\n                null;                                     // Explicit null if missing\\n\\n// Same fallback pattern for clientEmail\\nconst clientEmail = $input.first().json.clientEmail ||        // Test data\\n                    $input.first().json.body?.clientEmail ||  // Production from Pre-Chunk 0\\n                    'unknown_client@test.de';                 // Last resort default\\n\\n// Tier 1 Prompt: Classify into 4 broad categories\\nconst tier1Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTASK: Classify this document into ONE of 4 broad categories based on the filename.\\n\\nFILENAME: ${filename}\\nCLIENT: ${clientEmail}\\n\\nCATEGORIES:\\n\\n1. OBJEKTUNTERLAGEN (Property/Object Documents)\\n   Keywords: Projekt, Beschreibung, Expose, Grundbuch, Kaufvertrag, Bau, Lageplan, Zeichnungen, Genehmigung, DIN276, DIN277, Werkvertrag, Flaeche\\n   Examples: Project descriptions, land register, purchase agreements, building permits, construction drawings, calculations\\n\\n2. WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents)\\n   Keywords: Verkauf, Preis, Bauzeitenplan, Liquiditaet, Vertrieb, Ausstattung, Teilung, Versicherung, Umsatzsteuer, BWA, Jahresabschluss, Finanzierung, Darlehen\\n   Examples: Sales prices, construction schedules, insurance, VAT returns, financial statements, loan agreements\\n\\n3. RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents)\\n   Keywords: Gesellschaft, Vertrag, Handelsregister, Gewerbe, Steuer, ID, Freistellung, Vollmacht\\n   Examples: Partnership agreements, commercial register, business registration, tax ID, powers of attorney\\n\\n4. SONSTIGES (Miscellaneous)\\n   Keywords: Gutachter, Korrespondenz, Sonstiges, Others\\n   Examples: Expert assignments, correspondence, general miscellaneous\\n\\nINSTRUCTIONS:\\n1. Analyze the filename for German keywords\\n2. Match to the most appropriate category\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning in 1-2 sentences\\n\\nRESPONSE FORMAT (JSON only, no markdown):\\n{\\n  \\\"tier1Category\\\": \\\"OBJEKTUNTERLAGEN | WIRTSCHAFTLICHE_UNTERLAGEN | RECHTLICHE_UNTERLAGEN | SONSTIGES\\\",\\n  \\\"tier1Confidence\\\": 85,\\n  \\\"reasoning\\\": \\\"Brief explanation of why this category was chosen\\\"\\n}\\n\\nSTRICT RULES:\\n- Response must be valid JSON only\\n- tier1Confidence must be 0-100 number\\n- tier1Category must be exactly one of the 4 options above\\n- No markdown formatting\\n- No code blocks\\n- No explanatory text outside JSON`;\\n\\nreturn {\\n  json: {\\n    tier1Prompt,\\n    // === EXPLICITLY PRESERVE ALL FILE METADATA (CRITICAL) ===\\n    fileId,\\n    fileName: filename,     // Normalize to camelCase for consistency\\n    fileUrl,\\n    clientEmail,\\n    // Pass through all input data for additional fields\\n    ...($input.first().json)\\n  }\\n};\"\n        },\n        \"id\": \"code-1\",\n        \"name\": \"Build AI Classification Prompt\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          336,\n          256\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Parse Tier 1 Classification Result + Build Dynamic Tier 2 Prompt\\n\\nconst response = $input.first().json;\\n\\n// === PRESERVE CRITICAL FILE METADATA FROM EARLIER NODE ===\\n// Get ALL file metadata fields from \\\"Build AI Classification Prompt\\\" node (earlier in chain)\\n// This node already extracted these fields with proper fallback logic\\nconst fileId = $node[\\\"Build AI Classification Prompt\\\"].json.fileId;\\nconst fileName = $node[\\\"Build AI Classification Prompt\\\"].json.fileName;\\nconst fileUrl = $node[\\\"Build AI Classification Prompt\\\"].json.fileUrl;\\nconst clientEmail = $node[\\\"Build AI Classification Prompt\\\"].json.clientEmail;\\n\\n// Extract Tier 1 classification from GPT-4 response\\nlet tier1Result;\\ntry {\\n  // GPT-4 response is in response.choices[0].message.content\\n  const content = response.choices[0].message.content;\\n  tier1Result = JSON.parse(content);\\n} catch (error) {\\n  // If parsing fails, return error for LOW_CONFIDENCE routing\\n  return {\\n    json: {\\n      error: 'Failed to parse Tier 1 classification',\\n      tier1Category: 'UNKNOWN',\\n      tier1Confidence: 0,\\n      tier2Prompt: 'ERROR: Failed to parse Tier 1 classification',\\n      // === PRESERVE FILE METADATA (CRITICAL) ===\\n      fileId,\\n      fileName,\\n      fileUrl,\\n      clientEmail,\\n      ...($input.first().json)\\n    }\\n  };\\n}\\n\\nconst { tier1Category, tier1Confidence, reasoning } = tier1Result;\\n\\n// Build category-specific Tier 2 prompt\\nlet tier2Prompt = '';\\n\\n// === OBJEKTUNTERLAGEN (14 types) ===\\nif (tier1Category === 'OBJEKTUNTERLAGEN') {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as OBJEKTUNTERLAGEN (Property/Object Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n01_Projektbeschreibung (Exposé/Project Description) ⭐ CORE\\n   Keywords: Projekt, Beschreibung, Expose, Overview, Proposal\\n   Description: Project overview, property description, investment proposal\\n\\n02_Kaufvertrag (Purchase Agreement)\\n   Keywords: Kauf, Vertrag, Purchase, Agreement\\n   Description: Property purchase contract\\n\\n03_Grundbuchauszug (Land Register Extract) ⭐ CORE\\n   Keywords: Grundbuch, Land, Register, Auszug\\n   Description: Official land registry extract\\n\\n04_Eintragungsbewilligungen (Entry Permits)\\n   Keywords: Eintragung, Bewilligung, Entry, Permit\\n   Description: Permits for land register entries\\n\\n05_Bodenrichtwert (Land Value)\\n   Keywords: Boden, Richtwert, Land, Value\\n   Description: Official land value assessment\\n\\n06_Baulastenverzeichnis (Building Encumbrance Register)\\n   Keywords: Baulast, Verzeichnis, Encumbrance\\n   Description: Register of building encumbrances\\n\\n07_Altlastenkataster (Contaminated Sites Register)\\n   Keywords: Altlast, Kataster, Contaminated\\n   Description: Register of contaminated sites\\n\\n08_Baugrundgutachten (Soil Survey)\\n   Keywords: Baugrund, Gutachten, Soil, Survey\\n   Description: Soil conditions assessment\\n\\n09_Lageplan (Site Plan)\\n   Keywords: Lage, Plan, Site\\n   Description: Site location plan\\n\\n10_Bautraegerkalkulation_DIN276 (Developer Calculation) ⭐ CORE\\n   Keywords: Bautraeger, Kalkulation, DIN276, Calculation\\n   Description: Developer cost calculation per DIN276 standard\\n\\n15_Flaechenberechnung_DIN277 (Area Calculation DIN277)\\n   Keywords: Flaeche, Berechnung, DIN277, Area\\n   Description: Area calculation per DIN277 standard\\n\\n16_GU_Werkvertraege (General Contractor Agreements)\\n   Keywords: GU, Werkvertrag, Contractor, Agreement\\n   Description: General contractor work agreements\\n\\n17_Bauzeichnungen (Construction Drawings)\\n   Keywords: Bau, Zeichnung, Construction, Drawing\\n   Description: Construction and architectural drawings\\n\\n18_Baugenehmigung (Building Permit)\\n   Keywords: Bau, Genehmigung, Building, Permit\\n   Description: Official building permit\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"01_Projektbeschreibung\\\",\\n  \\\"tier2Confidence\\\": 88,\\n  \\\"germanName\\\": \\\"Projektbeschreibung\\\",\\n  \\\"englishName\\\": \\\"Exposé/Project Description\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above (e.g., \\\"01_Projektbeschreibung\\\")\\n- isCoreType: true for ⭐ CORE types, false for others\\n- Valid JSON only, no markdown`;\\n}\\n\\n// === WIRTSCHAFTLICHE_UNTERLAGEN (12 types) ===\\nelse if (tier1Category === 'WIRTSCHAFTLICHE_UNTERLAGEN') {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n11_Verkaufspreise (Sales Prices)\\n   Keywords: Verkauf, Preis, Sales, Price\\n   Description: Sales price lists and calculations\\n\\n12_Bauzeitenplan_Liquiditaet (Construction Schedule & Liquidity)\\n   Keywords: Bauzeit, Plan, Liquiditaet, Schedule\\n   Description: Construction timeline and liquidity planning\\n\\n13_Vertriebsweg (Distribution Channel)\\n   Keywords: Vertrieb, Weg, Distribution, Channel\\n   Description: Sales and distribution strategy\\n\\n14_Bau_Ausstattungsbeschreibung (Construction & Equipment Description)\\n   Keywords: Bau, Ausstattung, Beschreibung, Equipment\\n   Description: Construction specifications and equipment details\\n\\n19_Teilungserklaerung (Declaration of Division)\\n   Keywords: Teilung, Erklaerung, Division, Declaration\\n   Description: Property division declaration\\n\\n20_Versicherungen (Insurance)\\n   Keywords: Versicherung, Insurance\\n   Description: Insurance policies and documentation\\n\\n21_Muster_Verkaufsvertrag (Sample Sales Contract)\\n   Keywords: Muster, Verkauf, Vertrag, Sample, Sales\\n   Description: Template sales contract\\n\\n23_Umsatzsteuervoranmeldung (VAT Advance Return)\\n   Keywords: Umsatz, Steuer, Voranmeldung, VAT\\n   Description: VAT advance return filings\\n\\n24_BWA (Business Evaluation)\\n   Keywords: BWA, Business, Evaluation\\n   Description: Business evaluation report\\n\\n25_Jahresabschluss (Annual Financial Statement)\\n   Keywords: Jahres, Abschluss, Annual, Financial\\n   Description: Annual financial statement\\n\\n26_Finanzierungsbestaetigung (Financing Confirmation)\\n   Keywords: Finanzierung, Bestaetigung, Financing, Confirmation\\n   Description: Financing approval or confirmation\\n\\n27_Darlehensvertrag (Loan Agreement)\\n   Keywords: Darlehen, Vertrag, Loan, Agreement\\n   Description: Loan contract\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"11_Verkaufspreise\\\",\\n  \\\"tier2Confidence\\\": 92,\\n  \\\"germanName\\\": \\\"Verkaufspreise\\\",\\n  \\\"englishName\\\": \\\"Sales Prices\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all WIRTSCHAFTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\\n}\\n\\n// === RECHTLICHE_UNTERLAGEN (6 types) ===\\nelse if (tier1Category === 'RECHTLICHE_UNTERLAGEN') {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n28_Gesellschaftsvertrag (Partnership Agreement)\\n   Keywords: Gesellschaft, Vertrag, Partnership, Agreement\\n   Description: Company partnership or shareholder agreement\\n\\n29_Handelsregisterauszug (Commercial Register Extract)\\n   Keywords: Handelsregister, Auszug, Commercial, Register\\n   Description: Commercial register extract\\n\\n30_Gewerbeanmeldung (Business Registration)\\n   Keywords: Gewerbe, Anmeldung, Business, Registration\\n   Description: Business registration documentation\\n\\n31_Steuer_ID (Tax ID)\\n   Keywords: Steuer, ID, Tax\\n   Description: Tax identification number\\n\\n32_Freistellungsbescheinigung (Exemption Certificate)\\n   Keywords: Freistellung, Bescheinigung, Exemption, Certificate\\n   Description: Tax exemption certificate\\n\\n33_Vollmachten (Powers of Attorney)\\n   Keywords: Vollmacht, Power, Attorney\\n   Description: Power of attorney documents\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"28_Gesellschaftsvertrag\\\",\\n  \\\"tier2Confidence\\\": 85,\\n  \\\"germanName\\\": \\\"Gesellschaftsvertrag\\\",\\n  \\\"englishName\\\": \\\"Partnership Agreement\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all RECHTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\\n}\\n\\n// === SONSTIGES (6 types) ===\\nelse if (tier1Category === 'SONSTIGES') {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as SONSTIGES (Miscellaneous) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n22_Gutachterauftrag (Expert Assignment)\\n   Keywords: Gutachter, Auftrag, Expert, Assignment\\n   Description: Expert assessment assignment\\n\\n34_Korrespondenz (Correspondence)\\n   Keywords: Korrespondenz, Email, Brief, Letter, Correspondence\\n   Description: Email correspondence and letters\\n\\n35_Sonstiges_Allgemein (General Miscellaneous)\\n   Keywords: Sonstiges, Misc, General\\n   Description: General miscellaneous documents\\n\\n36_Exit_Strategie (Exit Strategy) ⭐ CORE\\n   Keywords: Exit, Strategie, Strategy\\n   Description: Investment exit strategy\\n\\n37_Others (Others)\\n   Keywords: Other, Andere\\n   Description: Other unclassified documents\\n\\n38_Unknowns (Unknowns)\\n   Keywords: Unknown, Unbekannt\\n   Description: Unknown document type\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n5. Use 38_Unknowns ONLY if truly unclear\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"36_Exit_Strategie\\\",\\n  \\\"tier2Confidence\\\": 95,\\n  \\\"germanName\\\": \\\"Exit Strategie\\\",\\n  \\\"englishName\\\": \\\"Exit Strategy\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: true ONLY for 36_Exit_Strategie\\n- Valid JSON only, no markdown`;\\n}\\n\\n// Unknown category fallback\\nelse {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nERROR: Unknown category \\\"${tier1Category}\\\". Please classify as SONSTIGES > 38_Unknowns.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"38_Unknowns\\\",\\n  \\\"tier2Confidence\\\": 0,\\n  \\\"germanName\\\": \\\"Unknowns\\\",\\n  \\\"englishName\\\": \\\"Unknown\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Unknown Tier 1 category: ${tier1Category}\\\"\\n}`;\\n}\\n\\n// NOW check confidence AFTER building tier2Prompt\\nif (tier1Confidence < 60) {\\n  return {\\n    json: {\\n      tier1Category,\\n      tier1Confidence,\\n      tier1Reasoning: reasoning,\\n      tier2Prompt,  // ← Include tier2Prompt even for low confidence\\n      // === PRESERVE FILE METADATA (CRITICAL) ===\\n      fileId,\\n      fileName,\\n      fileUrl,\\n      clientEmail,\\n      lowConfidence: true,\\n      confidenceFailureStage: 'tier1',\\n      ...($input.first().json)\\n    }\\n  };\\n}\\n\\n// High confidence path - return with tier2Prompt AND preserved fields\\nreturn {\\n  json: {\\n    tier1Category,\\n    tier1Confidence,\\n    tier1Reasoning: reasoning,\\n    tier2Prompt,\\n    // === PRESERVE FILE METADATA (CRITICAL) ===\\n    fileId,\\n    fileName,\\n    fileUrl,\\n    clientEmail,\\n    // Pass through all input data for additional fields\\n    ...($input.first().json)\\n  }\\n};\"\n        },\n        \"id\": \"code-2\",\n        \"name\": \"Parse Classification Result\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          784,\n          256\n        ]\n      },\n      {\n        \"parameters\": {\n          \"documentId\": {\n            \"mode\": \"id\",\n            \"value\": \"12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I\"\n          },\n          \"sheetName\": {\n            \"mode\": \"name\",\n            \"value\": \"Client_Tracker\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"sheets-1\",\n        \"name\": \"Lookup Client in Client_Tracker\",\n        \"type\": \"n8n-nodes-base.googleSheets\",\n        \"typeVersion\": 4.7,\n        \"position\": [\n          1904,\n          256\n        ],\n        \"credentials\": {\n          \"googleSheetsOAuth2Api\": {\n            \"id\": \"H7ewI1sOrDYabelt\",\n            \"name\": \"Google Sheets account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"const trackerData = $('Lookup Client in Client_Tracker').all();\\nconst mainData = $('Parse Classification Result').first().json;\\n\\nconst clientNormalized = mainData.clientNormalized || '';\\nconst documentType = mainData.documentType || '';\\nconst confidence = mainData.documentClassificationConfidence || 0;\\n\\n// Check if confidence is too low\\nif (confidence < 70) {\\n  return {\\n    json: {\\n      ...mainData,\\n      chunk2_5_status: 'error_unclear_type',\\n      errorMessage: `Low confidence (${confidence}%) - document type unclear`\\n    }\\n  };\\n}\\n\\n// Check if any data was returned\\nif (!trackerData || trackerData.length === 0) {\\n  return {\\n    json: {\\n      ...mainData,\\n      chunk2_5_status: 'error_client_not_found',\\n      errorMessage: 'No data returned from Client_Tracker lookup'\\n    }\\n  };\\n}\\n\\n// Google Sheets lookup returns matching rows (no header in result)\\n// If we got results, the first row is the client data\\nconst clientRow = trackerData[0];\\n\\n// Validate that we have a Client_Name field\\nif (!clientRow.json.Client_Name) {\\n  return {\\n    json: {\\n      ...mainData,\\n      chunk2_5_status: 'error_client_not_found',\\n      errorMessage: 'Client_Tracker returned invalid data (no Client_Name field)'\\n    }\\n  };\\n}\\n\\n// Verify this is the correct client by comparing normalized names\\nconst sheetClientName = clientRow.json.Client_Name || '';\\nconst normalizedSheetName = sheetClientName\\n  .toLowerCase()\\n  .trim()\\n  .replace(/ä/g, 'ae')\\n  .replace(/ö/g, 'oe')\\n  .replace(/ü/g, 'ue')\\n  .replace(/ß/g, 'ss')\\n  .replace(/\\\\s*(gmbh|ag|kg|e\\\\.v\\\\.|mbh|co\\\\.|&\\\\s*co\\\\.?)\\\\s*/gi, '')\\n  .replace(/[^a-z0-9]/g, '_')\\n  .replace(/_+/g, '_')\\n  .replace(/^_|_$/g, '');\\n\\nif (normalizedSheetName !== clientNormalized) {\\n  return {\\n    json: {\\n      ...mainData,\\n      chunk2_5_status: 'error_client_not_found',\\n      errorMessage: `Client name mismatch: expected \\\"${clientNormalized}\\\", got \\\"${normalizedSheetName}\\\"`\\n    }\\n  };\\n}\\n\\n// Client found and validated - prepare for update\\nreturn {\\n  json: {\\n    ...mainData,\\n    trackerRowIndex: 0, // First row in lookup result\\n    trackerClientName: clientRow.json.Client_Name,\\n    chunk2_5_status: 'success'\\n  }\\n};\"\n        },\n        \"id\": \"code-3\",\n        \"name\": \"Find Client Row and Validate\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          2128,\n          256\n        ]\n      },\n      {\n        \"parameters\": {\n          \"documentId\": {\n            \"__rl\": true,\n            \"value\": \"12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I\",\n            \"mode\": \"list\",\n            \"cachedResultName\": \"AMA Client Document Tracker\",\n            \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I/edit?usp=drivesdk\"\n          },\n          \"sheetName\": {\n            \"__rl\": true,\n            \"value\": 1217593734,\n            \"mode\": \"list\",\n            \"cachedResultName\": \"Client_Tracker\",\n            \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I/edit#gid=1217593734\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"sheets-2\",\n        \"name\": \"Update Client_Tracker Row\",\n        \"type\": \"n8n-nodes-base.googleSheets\",\n        \"typeVersion\": 4.7,\n        \"position\": [\n          2800,\n          112\n        ],\n        \"credentials\": {\n          \"googleSheetsOAuth2Api\": {\n            \"id\": \"H7ewI1sOrDYabelt\",\n            \"name\": \"Google Sheets account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"documentId\": {\n            \"mode\": \"id\",\n            \"value\": \"1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU\"\n          },\n          \"sheetName\": {\n            \"mode\": \"name\",\n            \"value\": \"Sheet1\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"sheets-3\",\n        \"name\": \"Lookup Client in AMA_Folder_IDs\",\n        \"type\": \"n8n-nodes-base.googleSheets\",\n        \"typeVersion\": 4.7,\n        \"position\": [\n          3024,\n          184\n        ],\n        \"credentials\": {\n          \"googleSheetsOAuth2Api\": {\n            \"id\": \"H7ewI1sOrDYabelt\",\n            \"name\": \"Google Sheets account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Get Destination Folder ID - V8 Extended Mapping\\n\\nconst data = $input.first().json;\\nconst actionType = data.actionType;\\nconst documentType = data.documentType;\\nconst tier1Category = data.tier1Category;\\n\\n// Get folder IDs from AMA_Folder_IDs sheet\\nconst folderData = data; // Folder IDs are already in the data from sheets-3\\n\\nlet destinationFolderId;\\nlet destinationFolderName;\\n\\n// === LOW_CONFIDENCE → 38_Unknowns ===\\nif (actionType === 'LOW_CONFIDENCE') {\\n  destinationFolderId = folderData.FOLDER_38_Unknowns;\\n  destinationFolderName = '38_Unknowns';\\n}\\n\\n// === CORE TYPES → Specific Folders ===\\nelse if (actionType === 'CORE') {\\n  const coreMapping = {\\n    '01_Projektbeschreibung': { id: 'FOLDER_01_Expose', name: '01_Expose' },\\n    '03_Grundbuchauszug': { id: 'FOLDER_02_Grundbuch', name: '02_Grundbuch' },\\n    '10_Bautraegerkalkulation_DIN276': { id: 'FOLDER_03_Calculation', name: '03_Calculation' },\\n    '36_Exit_Strategie': { id: 'FOLDER_04_Exit_Strategy', name: '04_Exit_Strategy' }\\n  };\\n\\n  const mapping = coreMapping[documentType];\\n  if (mapping) {\\n    destinationFolderId = folderData[mapping.id];\\n    destinationFolderName = mapping.name;\\n  } else {\\n    // Fallback: should not happen if isCoreType is correct\\n    destinationFolderId = folderData.FOLDER_38_Unknowns;\\n    destinationFolderName = '38_Unknowns (CORE mapping error)';\\n  }\\n}\\n\\n// === SECONDARY TYPES → Holding Folders ===\\nelse if (actionType === 'SECONDARY') {\\n  // Map based on Tier 1 category to corresponding holding folder\\n  const holdingMapping = {\\n    'OBJEKTUNTERLAGEN': { id: 'FOLDER_HOLDING_PROPERTY', name: '_Holding_Property' },\\n    'WIRTSCHAFTLICHE_UNTERLAGEN': { id: 'FOLDER_HOLDING_FINANCIAL', name: '_Holding_Financial' },\\n    'RECHTLICHE_UNTERLAGEN': { id: 'FOLDER_HOLDING_LEGAL', name: '_Holding_Legal' },\\n    'SONSTIGES': { id: 'FOLDER_HOLDING_MISC', name: '_Holding_Misc' }\\n  };\\n\\n  const mapping = holdingMapping[tier1Category];\\n  if (mapping) {\\n    destinationFolderId = folderData[mapping.id];\\n    destinationFolderName = mapping.name;\\n  } else {\\n    // Fallback\\n    destinationFolderId = folderData.FOLDER_38_Unknowns;\\n    destinationFolderName = '38_Unknowns (SECONDARY mapping error)';\\n  }\\n}\\n\\n// Unknown action type fallback\\nelse {\\n  destinationFolderId = folderData.FOLDER_38_Unknowns;\\n  destinationFolderName = '38_Unknowns (Unknown action type)';\\n}\\n\\nreturn {\\n  json: {\\n    destinationFolderId,\\n    destinationFolderName,\\n    ...data\\n  }\\n};\\n\"\n        },\n        \"id\": \"code-4\",\n        \"name\": \"Get Destination Folder ID\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3248,\n          184\n        ]\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"move\",\n          \"fileId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"={{ $json.fileId }}\"\n          },\n          \"driveId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"My Drive\"\n          },\n          \"folderId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"={{ $json.finalFolderId }}\"\n          }\n        },\n        \"id\": \"drive-1\",\n        \"name\": \"Move File to Final Location\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          3472,\n          184\n        ],\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"const mainData = $('Get Destination Folder ID').first().json;\\n\\nreturn {\\n  json: {\\n    ...mainData,\\n    trackerUpdated: true,\\n    chunk2_5_status: 'success',\\n    processedAt: new Date().toISOString()\\n  }\\n};\"\n        },\n        \"id\": \"code-5\",\n        \"name\": \"Prepare Success Output\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3696,\n          184\n        ]\n      },\n      {\n        \"parameters\": {\n          \"documentId\": {\n            \"mode\": \"id\",\n            \"value\": \"1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU\"\n          },\n          \"sheetName\": {\n            \"mode\": \"name\",\n            \"value\": \"Sheet1\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"sheets-4\",\n        \"name\": \"Lookup 38_Unknowns Folder\",\n        \"type\": \"n8n-nodes-base.googleSheets\",\n        \"typeVersion\": 4.7,\n        \"position\": [\n          2576,\n          424\n        ],\n        \"credentials\": {\n          \"googleSheetsOAuth2Api\": {\n            \"id\": \"H7ewI1sOrDYabelt\",\n            \"name\": \"Google Sheets account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"const folderData = $input.all();\\nconst mainData = $('Find Client Row and Validate').first().json;\\n\\n// Skip header row\\nconst dataRows = folderData.slice(1);\\n\\nif (dataRows.length === 0) {\\n  return {\\n    json: {\\n      ...mainData,\\n      unknownsFolderId: null,\\n      errorMessage: 'Could not find 38_Unknowns folder - AMA_Folder_IDs is empty'\\n    }\\n  };\\n}\\n\\n// Look for row with \\\"38_Unknowns\\\" in any column\\nlet unknownsFolderId = null;\\nfor (const row of dataRows) {\\n  const rowData = row.json;\\n  for (const key in rowData) {\\n    if (key.includes('38_Unknowns')) {\\n      unknownsFolderId = rowData[key];\\n      break;\\n    }\\n  }\\n  if (unknownsFolderId) break;\\n}\\n\\nif (!unknownsFolderId) {\\n  // Try to get from first row (assuming it might be a global folder)\\n  unknownsFolderId = dataRows[0].json['38_Unknowns'] || null;\\n}\\n\\nreturn {\\n  json: {\\n    ...mainData,\\n    unknownsFolderId: unknownsFolderId,\\n    errorFallbackUsed: !unknownsFolderId\\n  }\\n};\"\n        },\n        \"id\": \"code-6\",\n        \"name\": \"Get 38_Unknowns Folder ID\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          2800,\n          424\n        ]\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"move\",\n          \"fileId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"={{ $json.fileId }}\"\n          },\n          \"driveId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"My Drive\"\n          },\n          \"folderId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"={{ $json.unknownsFolderId }}\"\n          }\n        },\n        \"id\": \"drive-2\",\n        \"name\": \"Move File to 38_Unknowns\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          3024,\n          424\n        ],\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"const mainData = $input.first().json;\\n\\nconst clientName = mainData.clientNormalized || 'Unknown';\\nconst fileName = mainData.fileName || 'Unknown';\\nconst fileId = mainData.fileId || '';\\nconst errorStatus = mainData.chunk2_5_status || 'unknown_error';\\nconst errorMessage = mainData.errorMessage || 'No error details provided';\\nconst documentType = mainData.documentType || 'Unknown';\\nconst confidence = mainData.documentClassificationConfidence || 0;\\n\\nlet issueDescription = '';\\nif (errorStatus === 'error_client_not_found') {\\n  issueDescription = `Client \\\"${clientName}\\\" was not found in the Client_Tracker sheet.`;\\n} else if (errorStatus === 'error_unclear_type') {\\n  issueDescription = `Document type classification had low confidence (${confidence}%). Classified as: ${documentType}.`;\\n} else if (errorStatus === 'error_folder_not_found') {\\n  issueDescription = `Destination folder for document type \\\"${documentType}\\\" was not found in AMA_Folder_IDs.`;\\n} else {\\n  issueDescription = errorMessage;\\n}\\n\\nconst fileLink = `https://drive.google.com/file/d/${fileId}/view`;\\n\\nconst emailSubject = `Eugene: Document Classification Issue - ${clientName}`;\\nconst emailBody = `<html>\\n<body>\\n<h2>Document Classification Issue</h2>\\n<p>A document could not be automatically classified and has been moved to the 38_Unknowns folder.</p>\\n\\n<h3>Details:</h3>\\n<ul>\\n  <li><strong>Client:</strong> ${clientName}</li>\\n  <li><strong>Filename:</strong> ${fileName}</li>\\n  <li><strong>Issue:</strong> ${issueDescription}</li>\\n  <li><strong>Classified Type:</strong> ${documentType} (${confidence}% confidence)</li>\\n  <li><strong>Error Status:</strong> ${errorStatus}</li>\\n</ul>\\n\\n<h3>File Location:</h3>\\n<p><a href=\\\"${fileLink}\\\">View file in Google Drive</a></p>\\n\\n<p>Please review this document and manually classify it.</p>\\n</body>\\n</html>`;\\n\\nreturn {\\n  json: {\\n    ...mainData,\\n    emailSubject: emailSubject,\\n    emailBody: emailBody,\\n    trackerUpdated: false,\\n    chunk2_5_status: errorStatus,\\n    processedAt: new Date().toISOString()\\n  }\\n};\"\n        },\n        \"id\": \"code-7\",\n        \"name\": \"Prepare Error Email Body\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3248,\n          424\n        ]\n      },\n      {\n        \"parameters\": {\n          \"sendTo\": \"={{ $json.emailRecipient || 'sway@thebluebottle.io' }}\",\n          \"subject\": \"Document Classification Error - Action Required\",\n          \"message\": \"={{ $json.emailBody }}\",\n          \"options\": {}\n        },\n        \"id\": \"gmail-1\",\n        \"name\": \"Send Error Notification Email\",\n        \"type\": \"n8n-nodes-base.gmail\",\n        \"typeVersion\": 2.1,\n        \"position\": [\n          3472,\n          424\n        ],\n        \"webhookId\": \"d50e78b4-8ae0-4171-b62f-c2afdafc7e58\",\n        \"credentials\": {\n          \"gmailOAuth2\": {\n            \"id\": \"gmailOAuth2\",\n            \"name\": \"Gmail OAuth2\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Prepare Tracker Update Data - V8 Conditional (CORE types only)\\n\\nconst data = $input.first().json;\\n\\n// CONDITIONAL: Only prepare tracker data if trackerUpdate === true\\nif (data.trackerUpdate !== true) {\\n  // SECONDARY or LOW_CONFIDENCE: Skip tracker update, pass through to folder move\\n  return {\\n    json: {\\n      skipTrackerUpdate: true,\\n      ...data\\n    }\\n  };\\n}\\n\\n// CORE types: Prepare tracker update data\\nconst documentType = data.documentType;\\n\\n// Map document type to tracker column\\nconst trackerColumnMapping = {\\n  '01_Projektbeschreibung': 'Status_Expose',\\n  '03_Grundbuchauszug': 'Status_Grundbuch',\\n  '10_Bautraegerkalkulation_DIN276': 'Status_Calculation',\\n  '36_Exit_Strategie': 'Status_Exit_Strategy'\\n};\\n\\nconst trackerColumn = trackerColumnMapping[documentType];\\n\\nif (!trackerColumn) {\\n  // Should not happen if CORE mapping is correct\\n  return {\\n    json: {\\n      error: 'Unknown CORE document type for tracker mapping',\\n      skipTrackerUpdate: true,\\n      ...data\\n    }\\n  };\\n}\\n\\n// Prepare update data for Client_Tracker\\nconst updateData = {\\n  [trackerColumn]: '✓'\\n};\\n\\nreturn {\\n  json: {\\n    trackerColumn,\\n    trackerValue: '✓',\\n    updateData,\\n    skipTrackerUpdate: false,\\n    ...data\\n  }\\n};\\n\"\n        },\n        \"id\": \"code-8\",\n        \"name\": \"Prepare Tracker Update Data\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          2576,\n          112\n        ]\n      },\n      {\n        \"parameters\": {\n          \"method\": \"POST\",\n          \"url\": \"https://api.openai.com/v1/chat/completions\",\n          \"authentication\": \"predefinedCredentialType\",\n          \"nodeCredentialType\": \"openAiApi\",\n          \"sendBody\": true,\n          \"specifyBody\": \"json\",\n          \"jsonBody\": \"={{ ({ \\\"model\\\": \\\"gpt-4\\\", \\\"messages\\\": [{\\\"role\\\": \\\"user\\\", \\\"content\\\": $json.tier1Prompt}], \\\"temperature\\\": 0 }) }}\",\n          \"options\": {}\n        },\n        \"id\": \"http-openai-1\",\n        \"name\": \"Classify Document with GPT-4\",\n        \"type\": \"n8n-nodes-base.httpRequest\",\n        \"typeVersion\": 4.2,\n        \"position\": [\n          560,\n          256\n        ],\n        \"credentials\": {\n          \"openAiApi\": {\n            \"id\": \"xmJ7t6kaKgMwA1ce\",\n            \"name\": \"OpenAi account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"method\": \"POST\",\n          \"url\": \"https://api.openai.com/v1/chat/completions\",\n          \"authentication\": \"predefinedCredentialType\",\n          \"nodeCredentialType\": \"openAiApi\",\n          \"sendBody\": true,\n          \"specifyBody\": \"json\",\n          \"jsonBody\": \"={{ ({ \\\"model\\\": \\\"gpt-4\\\", \\\"messages\\\": [{\\\"role\\\": \\\"user\\\", \\\"content\\\": $json.tier2Prompt}], \\\"temperature\\\": 0 }) }}\",\n          \"options\": {}\n        },\n        \"id\": \"3732e080-c0d3-4763-957d-d4d90761ddd8\",\n        \"name\": \"Tier 2 GPT-4 API Call\",\n        \"type\": \"n8n-nodes-base.httpRequest\",\n        \"typeVersion\": 4.2,\n        \"position\": [\n          1008,\n          256\n        ],\n        \"credentials\": {\n          \"openAiApi\": {\n            \"id\": \"xmJ7t6kaKgMwA1ce\",\n            \"name\": \"OpenAi account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Parse Tier 2 Classification Result\\n\\nconst response = $input.first().json;  // GPT-4 API response\\n\\n// === PRESERVE CRITICAL FILE METADATA FROM EARLIER NODE ===\\n// HTTP Request nodes REPLACE incoming data, so fetch from earlier node that preserved it\\nconst earlierData = $node[\\\"Parse Classification Result\\\"].json;\\nconst fileId = earlierData.fileId;\\nconst fileName = earlierData.fileName;\\nconst fileUrl = earlierData.fileUrl;\\nconst clientEmail = earlierData.clientEmail;\\nconst tier1Category = earlierData.tier1Category;\\nconst tier1Confidence = earlierData.tier1Confidence;\\nconst tier1Reasoning = earlierData.tier1Reasoning;\\n\\n// Extract Tier 2 classification from GPT-4 response\\nlet tier2Result;\\ntry {\\n  const content = response.choices[0].message.content;\\n  tier2Result = JSON.parse(content);\\n} catch (error) {\\n  // Parsing failed - route to LOW_CONFIDENCE\\n  return [{\\n    json: {\\n      error: 'Failed to parse Tier 2 classification',\\n      lowConfidence: true,\\n      confidenceFailureStage: 'tier2_parse_error',\\n      // === PRESERVE FILE METADATA (CRITICAL) ===\\n      fileId,\\n      fileName,\\n      fileUrl,\\n      clientEmail,\\n      tier1Category,\\n      tier1Confidence,\\n      tier1Reasoning\\n    }\\n  }];\\n}\\n\\nconst {\\n  documentType,\\n  tier2Confidence,\\n  germanName,\\n  englishName,\\n  isCoreType,\\n  reasoning: tier2Reasoning\\n} = tier2Result;\\n\\n// THRESHOLD CHECK: Tier 2 confidence must be >= 70%\\nif (tier2Confidence < 70) {\\n  return [{\\n    json: {\\n      documentType,\\n      tier2Confidence,\\n      lowConfidence: true,\\n      confidenceFailureStage: 'tier2',\\n      // === PRESERVE FILE METADATA (CRITICAL) ===\\n      fileId,\\n      fileName,\\n      fileUrl,\\n      clientEmail,\\n      tier1Category,\\n      tier1Confidence,\\n      tier1Reasoning\\n    }\\n  }];\\n}\\n\\n// Calculate combined confidence\\nconst combinedConfidence = Math.round((tier1Confidence + tier2Confidence) / 2);\\n\\nreturn [{\\n  json: {\\n    // === PRESERVE FILE METADATA (CRITICAL) ===\\n    fileId,\\n    fileName,\\n    fileUrl,\\n    clientEmail,\\n    // Tier 1 data\\n    tier1Category,\\n    tier1Confidence,\\n    tier1Reasoning,\\n    // Tier 2 classification results\\n    documentType,\\n    tier2Confidence,\\n    combinedConfidence,\\n    germanName,\\n    englishName,\\n    isCoreType,\\n    tier2Reasoning\\n  }\\n}];\"\n        },\n        \"id\": \"86d8d160-de91-464d-92d0-7db05b7c3f4f\",\n        \"name\": \"Parse Tier 2 Result\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          1232,\n          256\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Action Mapper: Determine routing based on classification results\\n\\nconst data = $input.first().json;\\n\\n// Check for low confidence flags\\nif (data.lowConfidence === true) {\\n  return [{\\n    json: {\\n      ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\\n      actionType: 'LOW_CONFIDENCE',\\n      destinationFolder: '38_Unknowns',\\n      trackerUpdate: false,\\n      sendNotification: true\\n    }\\n  }];\\n}\\n\\n// Check if CORE type\\nif (data.isCoreType === true) {\\n  // CORE types: Specific folder + tracker update\\n  return [{\\n    json: {\\n      ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\\n      actionType: 'CORE',\\n      trackerUpdate: true,\\n      sendNotification: false\\n    }\\n  }];\\n}\\n\\n// SECONDARY types: Holding folder + no tracker\\nreturn [{\\n  json: {\\n    ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\\n    actionType: 'SECONDARY',\\n    trackerUpdate: false,\\n    sendNotification: false\\n  }\\n}];\"\n        },\n        \"id\": \"89b7324c-80e6-4902-9ab5-3f26be09e92a\",\n        \"name\": \"Determine Action Type\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          1456,\n          256\n        ]\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"update\",\n          \"fileId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"={{ $json.fileId }}\"\n          },\n          \"newUpdatedFileName\": \"={{ $json.germanName }}\",\n          \"options\": {}\n        },\n        \"id\": \"74f574c1-626a-461d-85be-7f44591a7220\",\n        \"name\": \"Rename File with Confidence\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          1680,\n          256\n        ],\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        },\n        \"continueOnFail\": false,\n        \"alwaysOutputData\": false,\n        \"executeOnce\": false\n      },\n      {\n        \"parameters\": {\n          \"rules\": {\n            \"values\": [\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"combinator\": \"and\",\n                    \"conditions\": [\n                      {\n                        \"leftValue\": \"={{ $json.clientFound }}\",\n                        \"rightValue\": false,\n                        \"operator\": {\n                          \"type\": \"boolean\",\n                          \"operation\": \"equals\"\n                        }\n                      }\n                    ]\n                  }\n                },\n                \"renameOutput\": true,\n                \"outputKey\": \"error\"\n              },\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"combinator\": \"and\",\n                    \"conditions\": [\n                      {\n                        \"leftValue\": \"={{ $json.skipTrackerUpdate }}\",\n                        \"rightValue\": false,\n                        \"operator\": {\n                          \"type\": \"boolean\",\n                          \"operation\": \"equals\"\n                        }\n                      }\n                    ]\n                  }\n                },\n                \"renameOutput\": true,\n                \"outputKey\": \"update_tracker\"\n              },\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"combinator\": \"and\",\n                    \"conditions\": [\n                      {\n                        \"leftValue\": \"={{ $json.skipTrackerUpdate }}\",\n                        \"rightValue\": true,\n                        \"operator\": {\n                          \"type\": \"boolean\",\n                          \"operation\": \"equals\"\n                        }\n                      }\n                    ]\n                  }\n                },\n                \"renameOutput\": true,\n                \"outputKey\": \"skip_tracker\"\n              }\n            ]\n          },\n          \"options\": {\n            \"fallbackOutput\": \"extra\"\n          }\n        },\n        \"id\": \"33c19a5b-df8b-4c1b-99fe-bd11fe3e0111\",\n        \"name\": \"Route Based on Document Type\",\n        \"type\": \"n8n-nodes-base.switch\",\n        \"typeVersion\": 3.4,\n        \"position\": [\n          2352,\n          224\n        ]\n      },\n      {\n        \"parameters\": {\n          \"httpMethod\": \"POST\",\n          \"path\": \"test-chunk-2-5-v8\",\n          \"responseMode\": \"lastNode\",\n          \"options\": {}\n        },\n        \"id\": \"temp-webhook-test-node\",\n        \"name\": \"Temp Test Webhook - DELETE AFTER TESTING\",\n        \"type\": \"n8n-nodes-base.webhook\",\n        \"typeVersion\": 2,\n        \"position\": [\n          112,\n          184\n        ],\n        \"webhookId\": \"0e852796-4f14-4b08-9172-4bc660161e04\"\n      }\n    ],\n    \"connections\": {\n      \"Execute Workflow Trigger (Refreshed)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Build AI Classification Prompt\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Parse Classification Result\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Tier 2 GPT-4 API Call\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Lookup Client in Client_Tracker\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Find Client Row and Validate\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Update Client_Tracker Row\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Lookup Client in AMA_Folder_IDs\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Lookup Client in AMA_Folder_IDs\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Get Destination Folder ID\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Get Destination Folder ID\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Move File to Final Location\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Move File to Final Location\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare Success Output\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Lookup 38_Unknowns Folder\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Get 38_Unknowns Folder ID\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Get 38_Unknowns Folder ID\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Move File to 38_Unknowns\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Move File to 38_Unknowns\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare Error Email Body\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare Error Email Body\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Send Error Notification Email\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare Tracker Update Data\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Update Client_Tracker Row\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Build AI Classification Prompt\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Classify Document with GPT-4\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Classify Document with GPT-4\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Parse Classification Result\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Tier 2 GPT-4 API Call\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Parse Tier 2 Result\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Parse Tier 2 Result\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Determine Action Type\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Determine Action Type\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Rename File with Confidence\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Rename File with Confidence\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Lookup Client in Client_Tracker\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Find Client Row and Validate\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Route Based on Document Type\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Route Based on Document Type\": {\n        \"error\": [\n          [\n            {\n              \"node\": \"Lookup 38_Unknowns Folder\",\n              \"type\": \"error\",\n              \"index\": 0\n            }\n          ]\n        ],\n        \"update_tracker\": [\n          [\n            {\n              \"node\": \"Prepare Tracker Update Data\",\n              \"type\": \"update_tracker\",\n              \"index\": 0\n            }\n          ]\n        ],\n        \"skip_tracker\": [\n          [\n            {\n              \"node\": \"Lookup Client in AMA_Folder_IDs\",\n              \"type\": \"skip_tracker\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Temp Test Webhook - DELETE AFTER TESTING\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Build AI Classification Prompt\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      }\n    },\n    \"settings\": {\n      \"executionOrder\": \"v1\",\n      \"callerPolicy\": \"workflowsFromSameOwner\",\n      \"availableInMCP\": false\n    },\n    \"staticData\": null,\n    \"meta\": {\n      \"templateCredsSetupCompleted\": true\n    },\n    \"pinData\": {},\n    \"versionId\": \"f313f20f-d435-4414-9fdc-799de234da52\",\n    \"activeVersionId\": \"f313f20f-d435-4414-9fdc-799de234da52\",\n    \"versionCounter\": 278,\n    \"triggerCount\": 1,\n    \"shared\": [\n      {\n        \"updatedAt\": \"2026-01-08T21:33:22.263Z\",\n        \"createdAt\": \"2026-01-08T21:33:22.263Z\",\n        \"role\": \"workflow:owner\",\n        \"workflowId\": \"okg8wTqLtPUwjQ18\",\n        \"projectId\": \"Rs8mhw052fnrzWZM\",\n        \"project\": {\n          \"updatedAt\": \"2025-12-31T15:54:29.115Z\",\n          \"createdAt\": \"2025-12-31T15:27:33.865Z\",\n          \"id\": \"Rs8mhw052fnrzWZM\",\n          \"name\": \"Sway Clarke <sway@oloxa.ai>\",\n          \"type\": \"personal\",\n          \"icon\": null,\n          \"description\": null,\n          \"creatorId\": \"e9bd9112-c2e3-4f67-873a-e1001baeafd8\",\n          \"projectRelations\": [\n            {\n              \"updatedAt\": \"2025-12-31T15:27:33.865Z\",\n              \"createdAt\": \"2025-12-31T15:27:33.865Z\",\n              \"userId\": \"e9bd9112-c2e3-4f67-873a-e1001baeafd8\",\n              \"projectId\": \"Rs8mhw052fnrzWZM\",\n              \"user\": {\n                \"updatedAt\": \"2026-01-17T09:34:36.055Z\",\n                \"createdAt\": \"2025-12-31T15:27:33.119Z\",\n                \"id\": \"e9bd9112-c2e3-4f67-873a-e1001baeafd8\",\n                \"email\": \"sway@oloxa.ai\",\n                \"firstName\": \"Sway\",\n                \"lastName\": \"Clarke\",\n                \"personalizationAnswers\": {\n                  \"version\": \"v4\",\n                  \"personalization_survey_submitted_at\": \"2025-12-31T15:54:37.562Z\",\n                  \"personalization_survey_n8n_version\": \"2.1.4\"\n                },\n                \"settings\": {\n                  \"userActivated\": true,\n                  \"easyAIWorkflowOnboarded\": true,\n                  \"firstSuccessfulWorkflowId\": \"zbxHkXOoD1qaz6OS\",\n                  \"userActivatedAt\": 1767398053308,\n                  \"npsSurvey\": {\n                    \"responded\": true,\n                    \"lastShownAt\": 1767684846804\n                  }\n                },\n                \"disabled\": false,\n                \"mfaEnabled\": false,\n                \"lastActiveAt\": \"2026-01-16\",\n                \"isPending\": false\n              }\n            }\n          ]\n        }\n      }\n    ],\n    \"tags\": [],\n    \"activeVersion\": {\n      \"updatedAt\": \"2026-01-14T14:28:42.994Z\",\n      \"createdAt\": \"2026-01-14T14:28:42.994Z\",\n      \"versionId\": \"f313f20f-d435-4414-9fdc-799de234da52\",\n      \"workflowId\": \"okg8wTqLtPUwjQ18\",\n      \"nodes\": [\n        {\n          \"parameters\": {\n            \"inputSource\": \"passthrough\"\n          },\n          \"id\": \"trigger-1\",\n          \"name\": \"Execute Workflow Trigger (Refreshed)\",\n          \"type\": \"n8n-nodes-base.executeWorkflowTrigger\",\n          \"typeVersion\": 1.1,\n          \"position\": [\n            112,\n            376\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Build Tier 1 Classification Prompt\\n// Classify document into 1 of 4 broad categories\\n\\n// === CRITICAL: Extract and preserve ALL file metadata fields ===\\n// Try to get fields from different possible data structures\\n// Handles both test data and production data from Pre-Chunk 0\\n\\nconst fileId = $input.first().json.fileId ||              // Direct from Pre-Chunk 0\\n               $input.first().json.body?.fileId ||        // Nested in body\\n               null;                                      // Explicit null if missing\\n\\nconst filename = $input.first().json.fileName ||              // Test data (camelCase)\\n                 $input.first().json.filename ||              // Legacy lowercase\\n                 $input.first().json.body?.fileName ||        // Production from Pre-Chunk 0\\n                 $input.first().json.body?.filename ||        // Fallback lowercase in body\\n                 'unknown_file.pdf';                          // Last resort default\\n\\nconst fileUrl = $input.first().json.fileUrl ||            // Direct from Pre-Chunk 0\\n                $input.first().json.body?.fileUrl ||      // Nested in body\\n                null;                                     // Explicit null if missing\\n\\n// Same fallback pattern for clientEmail\\nconst clientEmail = $input.first().json.clientEmail ||        // Test data\\n                    $input.first().json.body?.clientEmail ||  // Production from Pre-Chunk 0\\n                    'unknown_client@test.de';                 // Last resort default\\n\\n// Tier 1 Prompt: Classify into 4 broad categories\\nconst tier1Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTASK: Classify this document into ONE of 4 broad categories based on the filename.\\n\\nFILENAME: ${filename}\\nCLIENT: ${clientEmail}\\n\\nCATEGORIES:\\n\\n1. OBJEKTUNTERLAGEN (Property/Object Documents)\\n   Keywords: Projekt, Beschreibung, Expose, Grundbuch, Kaufvertrag, Bau, Lageplan, Zeichnungen, Genehmigung, DIN276, DIN277, Werkvertrag, Flaeche\\n   Examples: Project descriptions, land register, purchase agreements, building permits, construction drawings, calculations\\n\\n2. WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents)\\n   Keywords: Verkauf, Preis, Bauzeitenplan, Liquiditaet, Vertrieb, Ausstattung, Teilung, Versicherung, Umsatzsteuer, BWA, Jahresabschluss, Finanzierung, Darlehen\\n   Examples: Sales prices, construction schedules, insurance, VAT returns, financial statements, loan agreements\\n\\n3. RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents)\\n   Keywords: Gesellschaft, Vertrag, Handelsregister, Gewerbe, Steuer, ID, Freistellung, Vollmacht\\n   Examples: Partnership agreements, commercial register, business registration, tax ID, powers of attorney\\n\\n4. SONSTIGES (Miscellaneous)\\n   Keywords: Gutachter, Korrespondenz, Sonstiges, Others\\n   Examples: Expert assignments, correspondence, general miscellaneous\\n\\nINSTRUCTIONS:\\n1. Analyze the filename for German keywords\\n2. Match to the most appropriate category\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning in 1-2 sentences\\n\\nRESPONSE FORMAT (JSON only, no markdown):\\n{\\n  \\\"tier1Category\\\": \\\"OBJEKTUNTERLAGEN | WIRTSCHAFTLICHE_UNTERLAGEN | RECHTLICHE_UNTERLAGEN | SONSTIGES\\\",\\n  \\\"tier1Confidence\\\": 85,\\n  \\\"reasoning\\\": \\\"Brief explanation of why this category was chosen\\\"\\n}\\n\\nSTRICT RULES:\\n- Response must be valid JSON only\\n- tier1Confidence must be 0-100 number\\n- tier1Category must be exactly one of the 4 options above\\n- No markdown formatting\\n- No code blocks\\n- No explanatory text outside JSON`;\\n\\nreturn {\\n  json: {\\n    tier1Prompt,\\n    // === EXPLICITLY PRESERVE ALL FILE METADATA (CRITICAL) ===\\n    fileId,\\n    fileName: filename,     // Normalize to camelCase for consistency\\n    fileUrl,\\n    clientEmail,\\n    // Pass through all input data for additional fields\\n    ...($input.first().json)\\n  }\\n};\"\n          },\n          \"id\": \"code-1\",\n          \"name\": \"Build AI Classification Prompt\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            336,\n            256\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Parse Tier 1 Classification Result + Build Dynamic Tier 2 Prompt\\n\\nconst response = $input.first().json;\\n\\n// === PRESERVE CRITICAL FILE METADATA FROM EARLIER NODE ===\\n// Get ALL file metadata fields from \\\"Build AI Classification Prompt\\\" node (earlier in chain)\\n// This node already extracted these fields with proper fallback logic\\nconst fileId = $node[\\\"Build AI Classification Prompt\\\"].json.fileId;\\nconst fileName = $node[\\\"Build AI Classification Prompt\\\"].json.fileName;\\nconst fileUrl = $node[\\\"Build AI Classification Prompt\\\"].json.fileUrl;\\nconst clientEmail = $node[\\\"Build AI Classification Prompt\\\"].json.clientEmail;\\n\\n// Extract Tier 1 classification from GPT-4 response\\nlet tier1Result;\\ntry {\\n  // GPT-4 response is in response.choices[0].message.content\\n  const content = response.choices[0].message.content;\\n  tier1Result = JSON.parse(content);\\n} catch (error) {\\n  // If parsing fails, return error for LOW_CONFIDENCE routing\\n  return {\\n    json: {\\n      error: 'Failed to parse Tier 1 classification',\\n      tier1Category: 'UNKNOWN',\\n      tier1Confidence: 0,\\n      tier2Prompt: 'ERROR: Failed to parse Tier 1 classification',\\n      // === PRESERVE FILE METADATA (CRITICAL) ===\\n      fileId,\\n      fileName,\\n      fileUrl,\\n      clientEmail,\\n      ...($input.first().json)\\n    }\\n  };\\n}\\n\\nconst { tier1Category, tier1Confidence, reasoning } = tier1Result;\\n\\n// Build category-specific Tier 2 prompt\\nlet tier2Prompt = '';\\n\\n// === OBJEKTUNTERLAGEN (14 types) ===\\nif (tier1Category === 'OBJEKTUNTERLAGEN') {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as OBJEKTUNTERLAGEN (Property/Object Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n01_Projektbeschreibung (Exposé/Project Description) ⭐ CORE\\n   Keywords: Projekt, Beschreibung, Expose, Overview, Proposal\\n   Description: Project overview, property description, investment proposal\\n\\n02_Kaufvertrag (Purchase Agreement)\\n   Keywords: Kauf, Vertrag, Purchase, Agreement\\n   Description: Property purchase contract\\n\\n03_Grundbuchauszug (Land Register Extract) ⭐ CORE\\n   Keywords: Grundbuch, Land, Register, Auszug\\n   Description: Official land registry extract\\n\\n04_Eintragungsbewilligungen (Entry Permits)\\n   Keywords: Eintragung, Bewilligung, Entry, Permit\\n   Description: Permits for land register entries\\n\\n05_Bodenrichtwert (Land Value)\\n   Keywords: Boden, Richtwert, Land, Value\\n   Description: Official land value assessment\\n\\n06_Baulastenverzeichnis (Building Encumbrance Register)\\n   Keywords: Baulast, Verzeichnis, Encumbrance\\n   Description: Register of building encumbrances\\n\\n07_Altlastenkataster (Contaminated Sites Register)\\n   Keywords: Altlast, Kataster, Contaminated\\n   Description: Register of contaminated sites\\n\\n08_Baugrundgutachten (Soil Survey)\\n   Keywords: Baugrund, Gutachten, Soil, Survey\\n   Description: Soil conditions assessment\\n\\n09_Lageplan (Site Plan)\\n   Keywords: Lage, Plan, Site\\n   Description: Site location plan\\n\\n10_Bautraegerkalkulation_DIN276 (Developer Calculation) ⭐ CORE\\n   Keywords: Bautraeger, Kalkulation, DIN276, Calculation\\n   Description: Developer cost calculation per DIN276 standard\\n\\n15_Flaechenberechnung_DIN277 (Area Calculation DIN277)\\n   Keywords: Flaeche, Berechnung, DIN277, Area\\n   Description: Area calculation per DIN277 standard\\n\\n16_GU_Werkvertraege (General Contractor Agreements)\\n   Keywords: GU, Werkvertrag, Contractor, Agreement\\n   Description: General contractor work agreements\\n\\n17_Bauzeichnungen (Construction Drawings)\\n   Keywords: Bau, Zeichnung, Construction, Drawing\\n   Description: Construction and architectural drawings\\n\\n18_Baugenehmigung (Building Permit)\\n   Keywords: Bau, Genehmigung, Building, Permit\\n   Description: Official building permit\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"01_Projektbeschreibung\\\",\\n  \\\"tier2Confidence\\\": 88,\\n  \\\"germanName\\\": \\\"Projektbeschreibung\\\",\\n  \\\"englishName\\\": \\\"Exposé/Project Description\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above (e.g., \\\"01_Projektbeschreibung\\\")\\n- isCoreType: true for ⭐ CORE types, false for others\\n- Valid JSON only, no markdown`;\\n}\\n\\n// === WIRTSCHAFTLICHE_UNTERLAGEN (12 types) ===\\nelse if (tier1Category === 'WIRTSCHAFTLICHE_UNTERLAGEN') {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n11_Verkaufspreise (Sales Prices)\\n   Keywords: Verkauf, Preis, Sales, Price\\n   Description: Sales price lists and calculations\\n\\n12_Bauzeitenplan_Liquiditaet (Construction Schedule & Liquidity)\\n   Keywords: Bauzeit, Plan, Liquiditaet, Schedule\\n   Description: Construction timeline and liquidity planning\\n\\n13_Vertriebsweg (Distribution Channel)\\n   Keywords: Vertrieb, Weg, Distribution, Channel\\n   Description: Sales and distribution strategy\\n\\n14_Bau_Ausstattungsbeschreibung (Construction & Equipment Description)\\n   Keywords: Bau, Ausstattung, Beschreibung, Equipment\\n   Description: Construction specifications and equipment details\\n\\n19_Teilungserklaerung (Declaration of Division)\\n   Keywords: Teilung, Erklaerung, Division, Declaration\\n   Description: Property division declaration\\n\\n20_Versicherungen (Insurance)\\n   Keywords: Versicherung, Insurance\\n   Description: Insurance policies and documentation\\n\\n21_Muster_Verkaufsvertrag (Sample Sales Contract)\\n   Keywords: Muster, Verkauf, Vertrag, Sample, Sales\\n   Description: Template sales contract\\n\\n23_Umsatzsteuervoranmeldung (VAT Advance Return)\\n   Keywords: Umsatz, Steuer, Voranmeldung, VAT\\n   Description: VAT advance return filings\\n\\n24_BWA (Business Evaluation)\\n   Keywords: BWA, Business, Evaluation\\n   Description: Business evaluation report\\n\\n25_Jahresabschluss (Annual Financial Statement)\\n   Keywords: Jahres, Abschluss, Annual, Financial\\n   Description: Annual financial statement\\n\\n26_Finanzierungsbestaetigung (Financing Confirmation)\\n   Keywords: Finanzierung, Bestaetigung, Financing, Confirmation\\n   Description: Financing approval or confirmation\\n\\n27_Darlehensvertrag (Loan Agreement)\\n   Keywords: Darlehen, Vertrag, Loan, Agreement\\n   Description: Loan contract\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"11_Verkaufspreise\\\",\\n  \\\"tier2Confidence\\\": 92,\\n  \\\"germanName\\\": \\\"Verkaufspreise\\\",\\n  \\\"englishName\\\": \\\"Sales Prices\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all WIRTSCHAFTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\\n}\\n\\n// === RECHTLICHE_UNTERLAGEN (6 types) ===\\nelse if (tier1Category === 'RECHTLICHE_UNTERLAGEN') {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n28_Gesellschaftsvertrag (Partnership Agreement)\\n   Keywords: Gesellschaft, Vertrag, Partnership, Agreement\\n   Description: Company partnership or shareholder agreement\\n\\n29_Handelsregisterauszug (Commercial Register Extract)\\n   Keywords: Handelsregister, Auszug, Commercial, Register\\n   Description: Commercial register extract\\n\\n30_Gewerbeanmeldung (Business Registration)\\n   Keywords: Gewerbe, Anmeldung, Business, Registration\\n   Description: Business registration documentation\\n\\n31_Steuer_ID (Tax ID)\\n   Keywords: Steuer, ID, Tax\\n   Description: Tax identification number\\n\\n32_Freistellungsbescheinigung (Exemption Certificate)\\n   Keywords: Freistellung, Bescheinigung, Exemption, Certificate\\n   Description: Tax exemption certificate\\n\\n33_Vollmachten (Powers of Attorney)\\n   Keywords: Vollmacht, Power, Attorney\\n   Description: Power of attorney documents\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"28_Gesellschaftsvertrag\\\",\\n  \\\"tier2Confidence\\\": 85,\\n  \\\"germanName\\\": \\\"Gesellschaftsvertrag\\\",\\n  \\\"englishName\\\": \\\"Partnership Agreement\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all RECHTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\\n}\\n\\n// === SONSTIGES (6 types) ===\\nelse if (tier1Category === 'SONSTIGES') {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as SONSTIGES (Miscellaneous) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n22_Gutachterauftrag (Expert Assignment)\\n   Keywords: Gutachter, Auftrag, Expert, Assignment\\n   Description: Expert assessment assignment\\n\\n34_Korrespondenz (Correspondence)\\n   Keywords: Korrespondenz, Email, Brief, Letter, Correspondence\\n   Description: Email correspondence and letters\\n\\n35_Sonstiges_Allgemein (General Miscellaneous)\\n   Keywords: Sonstiges, Misc, General\\n   Description: General miscellaneous documents\\n\\n36_Exit_Strategie (Exit Strategy) ⭐ CORE\\n   Keywords: Exit, Strategie, Strategy\\n   Description: Investment exit strategy\\n\\n37_Others (Others)\\n   Keywords: Other, Andere\\n   Description: Other unclassified documents\\n\\n38_Unknowns (Unknowns)\\n   Keywords: Unknown, Unbekannt\\n   Description: Unknown document type\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n5. Use 38_Unknowns ONLY if truly unclear\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"36_Exit_Strategie\\\",\\n  \\\"tier2Confidence\\\": 95,\\n  \\\"germanName\\\": \\\"Exit Strategie\\\",\\n  \\\"englishName\\\": \\\"Exit Strategy\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: true ONLY for 36_Exit_Strategie\\n- Valid JSON only, no markdown`;\\n}\\n\\n// Unknown category fallback\\nelse {\\n  tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nERROR: Unknown category \\\"${tier1Category}\\\". Please classify as SONSTIGES > 38_Unknowns.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"38_Unknowns\\\",\\n  \\\"tier2Confidence\\\": 0,\\n  \\\"germanName\\\": \\\"Unknowns\\\",\\n  \\\"englishName\\\": \\\"Unknown\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Unknown Tier 1 category: ${tier1Category}\\\"\\n}`;\\n}\\n\\n// NOW check confidence AFTER building tier2Prompt\\nif (tier1Confidence < 60) {\\n  return {\\n    json: {\\n      tier1Category,\\n      tier1Confidence,\\n      tier1Reasoning: reasoning,\\n      tier2Prompt,  // ← Include tier2Prompt even for low confidence\\n      // === PRESERVE FILE METADATA (CRITICAL) ===\\n      fileId,\\n      fileName,\\n      fileUrl,\\n      clientEmail,\\n      lowConfidence: true,\\n      confidenceFailureStage: 'tier1',\\n      ...($input.first().json)\\n    }\\n  };\\n}\\n\\n// High confidence path - return with tier2Prompt AND preserved fields\\nreturn {\\n  json: {\\n    tier1Category,\\n    tier1Confidence,\\n    tier1Reasoning: reasoning,\\n    tier2Prompt,\\n    // === PRESERVE FILE METADATA (CRITICAL) ===\\n    fileId,\\n    fileName,\\n    fileUrl,\\n    clientEmail,\\n    // Pass through all input data for additional fields\\n    ...($input.first().json)\\n  }\\n};\"\n          },\n          \"id\": \"code-2\",\n          \"name\": \"Parse Classification Result\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            784,\n            256\n          ]\n        },\n        {\n          \"parameters\": {\n            \"documentId\": {\n              \"mode\": \"id\",\n              \"value\": \"12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I\"\n            },\n            \"sheetName\": {\n              \"mode\": \"name\",\n              \"value\": \"Client_Tracker\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"sheets-1\",\n          \"name\": \"Lookup Client in Client_Tracker\",\n          \"type\": \"n8n-nodes-base.googleSheets\",\n          \"typeVersion\": 4.7,\n          \"position\": [\n            1904,\n            256\n          ],\n          \"credentials\": {\n            \"googleSheetsOAuth2Api\": {\n              \"id\": \"H7ewI1sOrDYabelt\",\n              \"name\": \"Google Sheets account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"const trackerData = $('Lookup Client in Client_Tracker').all();\\nconst mainData = $('Parse Classification Result').first().json;\\n\\nconst clientNormalized = mainData.clientNormalized || '';\\nconst documentType = mainData.documentType || '';\\nconst confidence = mainData.documentClassificationConfidence || 0;\\n\\n// Check if confidence is too low\\nif (confidence < 70) {\\n  return {\\n    json: {\\n      ...mainData,\\n      chunk2_5_status: 'error_unclear_type',\\n      errorMessage: `Low confidence (${confidence}%) - document type unclear`\\n    }\\n  };\\n}\\n\\n// Check if any data was returned\\nif (!trackerData || trackerData.length === 0) {\\n  return {\\n    json: {\\n      ...mainData,\\n      chunk2_5_status: 'error_client_not_found',\\n      errorMessage: 'No data returned from Client_Tracker lookup'\\n    }\\n  };\\n}\\n\\n// Google Sheets lookup returns matching rows (no header in result)\\n// If we got results, the first row is the client data\\nconst clientRow = trackerData[0];\\n\\n// Validate that we have a Client_Name field\\nif (!clientRow.json.Client_Name) {\\n  return {\\n    json: {\\n      ...mainData,\\n      chunk2_5_status: 'error_client_not_found',\\n      errorMessage: 'Client_Tracker returned invalid data (no Client_Name field)'\\n    }\\n  };\\n}\\n\\n// Verify this is the correct client by comparing normalized names\\nconst sheetClientName = clientRow.json.Client_Name || '';\\nconst normalizedSheetName = sheetClientName\\n  .toLowerCase()\\n  .trim()\\n  .replace(/ä/g, 'ae')\\n  .replace(/ö/g, 'oe')\\n  .replace(/ü/g, 'ue')\\n  .replace(/ß/g, 'ss')\\n  .replace(/\\\\s*(gmbh|ag|kg|e\\\\.v\\\\.|mbh|co\\\\.|&\\\\s*co\\\\.?)\\\\s*/gi, '')\\n  .replace(/[^a-z0-9]/g, '_')\\n  .replace(/_+/g, '_')\\n  .replace(/^_|_$/g, '');\\n\\nif (normalizedSheetName !== clientNormalized) {\\n  return {\\n    json: {\\n      ...mainData,\\n      chunk2_5_status: 'error_client_not_found',\\n      errorMessage: `Client name mismatch: expected \\\"${clientNormalized}\\\", got \\\"${normalizedSheetName}\\\"`\\n    }\\n  };\\n}\\n\\n// Client found and validated - prepare for update\\nreturn {\\n  json: {\\n    ...mainData,\\n    trackerRowIndex: 0, // First row in lookup result\\n    trackerClientName: clientRow.json.Client_Name,\\n    chunk2_5_status: 'success'\\n  }\\n};\"\n          },\n          \"id\": \"code-3\",\n          \"name\": \"Find Client Row and Validate\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            2128,\n            256\n          ]\n        },\n        {\n          \"parameters\": {\n            \"documentId\": {\n              \"__rl\": true,\n              \"value\": \"12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I\",\n              \"mode\": \"list\",\n              \"cachedResultName\": \"AMA Client Document Tracker\",\n              \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I/edit?usp=drivesdk\"\n            },\n            \"sheetName\": {\n              \"__rl\": true,\n              \"value\": 1217593734,\n              \"mode\": \"list\",\n              \"cachedResultName\": \"Client_Tracker\",\n              \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I/edit#gid=1217593734\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"sheets-2\",\n          \"name\": \"Update Client_Tracker Row\",\n          \"type\": \"n8n-nodes-base.googleSheets\",\n          \"typeVersion\": 4.7,\n          \"position\": [\n            2800,\n            112\n          ],\n          \"credentials\": {\n            \"googleSheetsOAuth2Api\": {\n              \"id\": \"H7ewI1sOrDYabelt\",\n              \"name\": \"Google Sheets account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"documentId\": {\n              \"mode\": \"id\",\n              \"value\": \"1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU\"\n            },\n            \"sheetName\": {\n              \"mode\": \"name\",\n              \"value\": \"Sheet1\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"sheets-3\",\n          \"name\": \"Lookup Client in AMA_Folder_IDs\",\n          \"type\": \"n8n-nodes-base.googleSheets\",\n          \"typeVersion\": 4.7,\n          \"position\": [\n            3024,\n            184\n          ],\n          \"credentials\": {\n            \"googleSheetsOAuth2Api\": {\n              \"id\": \"H7ewI1sOrDYabelt\",\n              \"name\": \"Google Sheets account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Get Destination Folder ID - V8 Extended Mapping\\n\\nconst data = $input.first().json;\\nconst actionType = data.actionType;\\nconst documentType = data.documentType;\\nconst tier1Category = data.tier1Category;\\n\\n// Get folder IDs from AMA_Folder_IDs sheet\\nconst folderData = data; // Folder IDs are already in the data from sheets-3\\n\\nlet destinationFolderId;\\nlet destinationFolderName;\\n\\n// === LOW_CONFIDENCE → 38_Unknowns ===\\nif (actionType === 'LOW_CONFIDENCE') {\\n  destinationFolderId = folderData.FOLDER_38_Unknowns;\\n  destinationFolderName = '38_Unknowns';\\n}\\n\\n// === CORE TYPES → Specific Folders ===\\nelse if (actionType === 'CORE') {\\n  const coreMapping = {\\n    '01_Projektbeschreibung': { id: 'FOLDER_01_Expose', name: '01_Expose' },\\n    '03_Grundbuchauszug': { id: 'FOLDER_02_Grundbuch', name: '02_Grundbuch' },\\n    '10_Bautraegerkalkulation_DIN276': { id: 'FOLDER_03_Calculation', name: '03_Calculation' },\\n    '36_Exit_Strategie': { id: 'FOLDER_04_Exit_Strategy', name: '04_Exit_Strategy' }\\n  };\\n\\n  const mapping = coreMapping[documentType];\\n  if (mapping) {\\n    destinationFolderId = folderData[mapping.id];\\n    destinationFolderName = mapping.name;\\n  } else {\\n    // Fallback: should not happen if isCoreType is correct\\n    destinationFolderId = folderData.FOLDER_38_Unknowns;\\n    destinationFolderName = '38_Unknowns (CORE mapping error)';\\n  }\\n}\\n\\n// === SECONDARY TYPES → Holding Folders ===\\nelse if (actionType === 'SECONDARY') {\\n  // Map based on Tier 1 category to corresponding holding folder\\n  const holdingMapping = {\\n    'OBJEKTUNTERLAGEN': { id: 'FOLDER_HOLDING_PROPERTY', name: '_Holding_Property' },\\n    'WIRTSCHAFTLICHE_UNTERLAGEN': { id: 'FOLDER_HOLDING_FINANCIAL', name: '_Holding_Financial' },\\n    'RECHTLICHE_UNTERLAGEN': { id: 'FOLDER_HOLDING_LEGAL', name: '_Holding_Legal' },\\n    'SONSTIGES': { id: 'FOLDER_HOLDING_MISC', name: '_Holding_Misc' }\\n  };\\n\\n  const mapping = holdingMapping[tier1Category];\\n  if (mapping) {\\n    destinationFolderId = folderData[mapping.id];\\n    destinationFolderName = mapping.name;\\n  } else {\\n    // Fallback\\n    destinationFolderId = folderData.FOLDER_38_Unknowns;\\n    destinationFolderName = '38_Unknowns (SECONDARY mapping error)';\\n  }\\n}\\n\\n// Unknown action type fallback\\nelse {\\n  destinationFolderId = folderData.FOLDER_38_Unknowns;\\n  destinationFolderName = '38_Unknowns (Unknown action type)';\\n}\\n\\nreturn {\\n  json: {\\n    destinationFolderId,\\n    destinationFolderName,\\n    ...data\\n  }\\n};\\n\"\n          },\n          \"id\": \"code-4\",\n          \"name\": \"Get Destination Folder ID\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3248,\n            184\n          ]\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"move\",\n            \"fileId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"={{ $json.fileId }}\"\n            },\n            \"driveId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"My Drive\"\n            },\n            \"folderId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"={{ $json.finalFolderId }}\"\n            }\n          },\n          \"id\": \"drive-1\",\n          \"name\": \"Move File to Final Location\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            3472,\n            184\n          ],\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"const mainData = $('Get Destination Folder ID').first().json;\\n\\nreturn {\\n  json: {\\n    ...mainData,\\n    trackerUpdated: true,\\n    chunk2_5_status: 'success',\\n    processedAt: new Date().toISOString()\\n  }\\n};\"\n          },\n          \"id\": \"code-5\",\n          \"name\": \"Prepare Success Output\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3696,\n            184\n          ]\n        },\n        {\n          \"parameters\": {\n            \"documentId\": {\n              \"mode\": \"id\",\n              \"value\": \"1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU\"\n            },\n            \"sheetName\": {\n              \"mode\": \"name\",\n              \"value\": \"Sheet1\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"sheets-4\",\n          \"name\": \"Lookup 38_Unknowns Folder\",\n          \"type\": \"n8n-nodes-base.googleSheets\",\n          \"typeVersion\": 4.7,\n          \"position\": [\n            2576,\n            424\n          ],\n          \"credentials\": {\n            \"googleSheetsOAuth2Api\": {\n              \"id\": \"H7ewI1sOrDYabelt\",\n              \"name\": \"Google Sheets account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"const folderData = $input.all();\\nconst mainData = $('Find Client Row and Validate').first().json;\\n\\n// Skip header row\\nconst dataRows = folderData.slice(1);\\n\\nif (dataRows.length === 0) {\\n  return {\\n    json: {\\n      ...mainData,\\n      unknownsFolderId: null,\\n      errorMessage: 'Could not find 38_Unknowns folder - AMA_Folder_IDs is empty'\\n    }\\n  };\\n}\\n\\n// Look for row with \\\"38_Unknowns\\\" in any column\\nlet unknownsFolderId = null;\\nfor (const row of dataRows) {\\n  const rowData = row.json;\\n  for (const key in rowData) {\\n    if (key.includes('38_Unknowns')) {\\n      unknownsFolderId = rowData[key];\\n      break;\\n    }\\n  }\\n  if (unknownsFolderId) break;\\n}\\n\\nif (!unknownsFolderId) {\\n  // Try to get from first row (assuming it might be a global folder)\\n  unknownsFolderId = dataRows[0].json['38_Unknowns'] || null;\\n}\\n\\nreturn {\\n  json: {\\n    ...mainData,\\n    unknownsFolderId: unknownsFolderId,\\n    errorFallbackUsed: !unknownsFolderId\\n  }\\n};\"\n          },\n          \"id\": \"code-6\",\n          \"name\": \"Get 38_Unknowns Folder ID\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            2800,\n            424\n          ]\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"move\",\n            \"fileId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"={{ $json.fileId }}\"\n            },\n            \"driveId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"My Drive\"\n            },\n            \"folderId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"={{ $json.unknownsFolderId }}\"\n            }\n          },\n          \"id\": \"drive-2\",\n          \"name\": \"Move File to 38_Unknowns\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            3024,\n            424\n          ],\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"const mainData = $input.first().json;\\n\\nconst clientName = mainData.clientNormalized || 'Unknown';\\nconst fileName = mainData.fileName || 'Unknown';\\nconst fileId = mainData.fileId || '';\\nconst errorStatus = mainData.chunk2_5_status || 'unknown_error';\\nconst errorMessage = mainData.errorMessage || 'No error details provided';\\nconst documentType = mainData.documentType || 'Unknown';\\nconst confidence = mainData.documentClassificationConfidence || 0;\\n\\nlet issueDescription = '';\\nif (errorStatus === 'error_client_not_found') {\\n  issueDescription = `Client \\\"${clientName}\\\" was not found in the Client_Tracker sheet.`;\\n} else if (errorStatus === 'error_unclear_type') {\\n  issueDescription = `Document type classification had low confidence (${confidence}%). Classified as: ${documentType}.`;\\n} else if (errorStatus === 'error_folder_not_found') {\\n  issueDescription = `Destination folder for document type \\\"${documentType}\\\" was not found in AMA_Folder_IDs.`;\\n} else {\\n  issueDescription = errorMessage;\\n}\\n\\nconst fileLink = `https://drive.google.com/file/d/${fileId}/view`;\\n\\nconst emailSubject = `Eugene: Document Classification Issue - ${clientName}`;\\nconst emailBody = `<html>\\n<body>\\n<h2>Document Classification Issue</h2>\\n<p>A document could not be automatically classified and has been moved to the 38_Unknowns folder.</p>\\n\\n<h3>Details:</h3>\\n<ul>\\n  <li><strong>Client:</strong> ${clientName}</li>\\n  <li><strong>Filename:</strong> ${fileName}</li>\\n  <li><strong>Issue:</strong> ${issueDescription}</li>\\n  <li><strong>Classified Type:</strong> ${documentType} (${confidence}% confidence)</li>\\n  <li><strong>Error Status:</strong> ${errorStatus}</li>\\n</ul>\\n\\n<h3>File Location:</h3>\\n<p><a href=\\\"${fileLink}\\\">View file in Google Drive</a></p>\\n\\n<p>Please review this document and manually classify it.</p>\\n</body>\\n</html>`;\\n\\nreturn {\\n  json: {\\n    ...mainData,\\n    emailSubject: emailSubject,\\n    emailBody: emailBody,\\n    trackerUpdated: false,\\n    chunk2_5_status: errorStatus,\\n    processedAt: new Date().toISOString()\\n  }\\n};\"\n          },\n          \"id\": \"code-7\",\n          \"name\": \"Prepare Error Email Body\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3248,\n            424\n          ]\n        },\n        {\n          \"parameters\": {\n            \"sendTo\": \"={{ $json.emailRecipient || 'sway@thebluebottle.io' }}\",\n            \"subject\": \"Document Classification Error - Action Required\",\n            \"message\": \"={{ $json.emailBody }}\",\n            \"options\": {}\n          },\n          \"id\": \"gmail-1\",\n          \"name\": \"Send Error Notification Email\",\n          \"type\": \"n8n-nodes-base.gmail\",\n          \"typeVersion\": 2.1,\n          \"position\": [\n            3472,\n            424\n          ],\n          \"webhookId\": \"d50e78b4-8ae0-4171-b62f-c2afdafc7e58\",\n          \"credentials\": {\n            \"gmailOAuth2\": {\n              \"id\": \"gmailOAuth2\",\n              \"name\": \"Gmail OAuth2\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Prepare Tracker Update Data - V8 Conditional (CORE types only)\\n\\nconst data = $input.first().json;\\n\\n// CONDITIONAL: Only prepare tracker data if trackerUpdate === true\\nif (data.trackerUpdate !== true) {\\n  // SECONDARY or LOW_CONFIDENCE: Skip tracker update, pass through to folder move\\n  return {\\n    json: {\\n      skipTrackerUpdate: true,\\n      ...data\\n    }\\n  };\\n}\\n\\n// CORE types: Prepare tracker update data\\nconst documentType = data.documentType;\\n\\n// Map document type to tracker column\\nconst trackerColumnMapping = {\\n  '01_Projektbeschreibung': 'Status_Expose',\\n  '03_Grundbuchauszug': 'Status_Grundbuch',\\n  '10_Bautraegerkalkulation_DIN276': 'Status_Calculation',\\n  '36_Exit_Strategie': 'Status_Exit_Strategy'\\n};\\n\\nconst trackerColumn = trackerColumnMapping[documentType];\\n\\nif (!trackerColumn) {\\n  // Should not happen if CORE mapping is correct\\n  return {\\n    json: {\\n      error: 'Unknown CORE document type for tracker mapping',\\n      skipTrackerUpdate: true,\\n      ...data\\n    }\\n  };\\n}\\n\\n// Prepare update data for Client_Tracker\\nconst updateData = {\\n  [trackerColumn]: '✓'\\n};\\n\\nreturn {\\n  json: {\\n    trackerColumn,\\n    trackerValue: '✓',\\n    updateData,\\n    skipTrackerUpdate: false,\\n    ...data\\n  }\\n};\\n\"\n          },\n          \"id\": \"code-8\",\n          \"name\": \"Prepare Tracker Update Data\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            2576,\n            112\n          ]\n        },\n        {\n          \"parameters\": {\n            \"method\": \"POST\",\n            \"url\": \"https://api.openai.com/v1/chat/completions\",\n            \"authentication\": \"predefinedCredentialType\",\n            \"nodeCredentialType\": \"openAiApi\",\n            \"sendBody\": true,\n            \"specifyBody\": \"json\",\n            \"jsonBody\": \"={{ ({ \\\"model\\\": \\\"gpt-4\\\", \\\"messages\\\": [{\\\"role\\\": \\\"user\\\", \\\"content\\\": $json.tier1Prompt}], \\\"temperature\\\": 0 }) }}\",\n            \"options\": {}\n          },\n          \"id\": \"http-openai-1\",\n          \"name\": \"Classify Document with GPT-4\",\n          \"type\": \"n8n-nodes-base.httpRequest\",\n          \"typeVersion\": 4.2,\n          \"position\": [\n            560,\n            256\n          ],\n          \"credentials\": {\n            \"openAiApi\": {\n              \"id\": \"xmJ7t6kaKgMwA1ce\",\n              \"name\": \"OpenAi account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"method\": \"POST\",\n            \"url\": \"https://api.openai.com/v1/chat/completions\",\n            \"authentication\": \"predefinedCredentialType\",\n            \"nodeCredentialType\": \"openAiApi\",\n            \"sendBody\": true,\n            \"specifyBody\": \"json\",\n            \"jsonBody\": \"={{ ({ \\\"model\\\": \\\"gpt-4\\\", \\\"messages\\\": [{\\\"role\\\": \\\"user\\\", \\\"content\\\": $json.tier2Prompt}], \\\"temperature\\\": 0 }) }}\",\n            \"options\": {}\n          },\n          \"id\": \"3732e080-c0d3-4763-957d-d4d90761ddd8\",\n          \"name\": \"Tier 2 GPT-4 API Call\",\n          \"type\": \"n8n-nodes-base.httpRequest\",\n          \"typeVersion\": 4.2,\n          \"position\": [\n            1008,\n            256\n          ],\n          \"credentials\": {\n            \"openAiApi\": {\n              \"id\": \"xmJ7t6kaKgMwA1ce\",\n              \"name\": \"OpenAi account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Parse Tier 2 Classification Result\\n\\nconst response = $input.first().json;  // GPT-4 API response\\n\\n// === PRESERVE CRITICAL FILE METADATA FROM EARLIER NODE ===\\n// HTTP Request nodes REPLACE incoming data, so fetch from earlier node that preserved it\\nconst earlierData = $node[\\\"Parse Classification Result\\\"].json;\\nconst fileId = earlierData.fileId;\\nconst fileName = earlierData.fileName;\\nconst fileUrl = earlierData.fileUrl;\\nconst clientEmail = earlierData.clientEmail;\\nconst tier1Category = earlierData.tier1Category;\\nconst tier1Confidence = earlierData.tier1Confidence;\\nconst tier1Reasoning = earlierData.tier1Reasoning;\\n\\n// Extract Tier 2 classification from GPT-4 response\\nlet tier2Result;\\ntry {\\n  const content = response.choices[0].message.content;\\n  tier2Result = JSON.parse(content);\\n} catch (error) {\\n  // Parsing failed - route to LOW_CONFIDENCE\\n  return [{\\n    json: {\\n      error: 'Failed to parse Tier 2 classification',\\n      lowConfidence: true,\\n      confidenceFailureStage: 'tier2_parse_error',\\n      // === PRESERVE FILE METADATA (CRITICAL) ===\\n      fileId,\\n      fileName,\\n      fileUrl,\\n      clientEmail,\\n      tier1Category,\\n      tier1Confidence,\\n      tier1Reasoning\\n    }\\n  }];\\n}\\n\\nconst {\\n  documentType,\\n  tier2Confidence,\\n  germanName,\\n  englishName,\\n  isCoreType,\\n  reasoning: tier2Reasoning\\n} = tier2Result;\\n\\n// THRESHOLD CHECK: Tier 2 confidence must be >= 70%\\nif (tier2Confidence < 70) {\\n  return [{\\n    json: {\\n      documentType,\\n      tier2Confidence,\\n      lowConfidence: true,\\n      confidenceFailureStage: 'tier2',\\n      // === PRESERVE FILE METADATA (CRITICAL) ===\\n      fileId,\\n      fileName,\\n      fileUrl,\\n      clientEmail,\\n      tier1Category,\\n      tier1Confidence,\\n      tier1Reasoning\\n    }\\n  }];\\n}\\n\\n// Calculate combined confidence\\nconst combinedConfidence = Math.round((tier1Confidence + tier2Confidence) / 2);\\n\\nreturn [{\\n  json: {\\n    // === PRESERVE FILE METADATA (CRITICAL) ===\\n    fileId,\\n    fileName,\\n    fileUrl,\\n    clientEmail,\\n    // Tier 1 data\\n    tier1Category,\\n    tier1Confidence,\\n    tier1Reasoning,\\n    // Tier 2 classification results\\n    documentType,\\n    tier2Confidence,\\n    combinedConfidence,\\n    germanName,\\n    englishName,\\n    isCoreType,\\n    tier2Reasoning\\n  }\\n}];\"\n          },\n          \"id\": \"86d8d160-de91-464d-92d0-7db05b7c3f4f\",\n          \"name\": \"Parse Tier 2 Result\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            1232,\n            256\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Action Mapper: Determine routing based on classification results\\n\\nconst data = $input.first().json;\\n\\n// Check for low confidence flags\\nif (data.lowConfidence === true) {\\n  return [{\\n    json: {\\n      ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\\n      actionType: 'LOW_CONFIDENCE',\\n      destinationFolder: '38_Unknowns',\\n      trackerUpdate: false,\\n      sendNotification: true\\n    }\\n  }];\\n}\\n\\n// Check if CORE type\\nif (data.isCoreType === true) {\\n  // CORE types: Specific folder + tracker update\\n  return [{\\n    json: {\\n      ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\\n      actionType: 'CORE',\\n      trackerUpdate: true,\\n      sendNotification: false\\n    }\\n  }];\\n}\\n\\n// SECONDARY types: Holding folder + no tracker\\nreturn [{\\n  json: {\\n    ...data,  // ← CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\\n    actionType: 'SECONDARY',\\n    trackerUpdate: false,\\n    sendNotification: false\\n  }\\n}];\"\n          },\n          \"id\": \"89b7324c-80e6-4902-9ab5-3f26be09e92a\",\n          \"name\": \"Determine Action Type\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            1456,\n            256\n          ]\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"update\",\n            \"fileId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"={{ $json.fileId }}\"\n            },\n            \"newUpdatedFileName\": \"={{ $json.germanName }}\",\n            \"options\": {}\n          },\n          \"id\": \"74f574c1-626a-461d-85be-7f44591a7220\",\n          \"name\": \"Rename File with Confidence\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            1680,\n            256\n          ],\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          },\n          \"continueOnFail\": false,\n          \"alwaysOutputData\": false,\n          \"executeOnce\": false\n        },\n        {\n          \"parameters\": {\n            \"rules\": {\n              \"values\": [\n                {\n                  \"conditions\": {\n                    \"options\": {\n                      \"combinator\": \"and\",\n                      \"conditions\": [\n                        {\n                          \"leftValue\": \"={{ $json.clientFound }}\",\n                          \"rightValue\": false,\n                          \"operator\": {\n                            \"type\": \"boolean\",\n                            \"operation\": \"equals\"\n                          }\n                        }\n                      ]\n                    }\n                  },\n                  \"renameOutput\": true,\n                  \"outputKey\": \"error\"\n                },\n                {\n                  \"conditions\": {\n                    \"options\": {\n                      \"combinator\": \"and\",\n                      \"conditions\": [\n                        {\n                          \"leftValue\": \"={{ $json.skipTrackerUpdate }}\",\n                          \"rightValue\": false,\n                          \"operator\": {\n                            \"type\": \"boolean\",\n                            \"operation\": \"equals\"\n                          }\n                        }\n                      ]\n                    }\n                  },\n                  \"renameOutput\": true,\n                  \"outputKey\": \"update_tracker\"\n                },\n                {\n                  \"conditions\": {\n                    \"options\": {\n                      \"combinator\": \"and\",\n                      \"conditions\": [\n                        {\n                          \"leftValue\": \"={{ $json.skipTrackerUpdate }}\",\n                          \"rightValue\": true,\n                          \"operator\": {\n                            \"type\": \"boolean\",\n                            \"operation\": \"equals\"\n                          }\n                        }\n                      ]\n                    }\n                  },\n                  \"renameOutput\": true,\n                  \"outputKey\": \"skip_tracker\"\n                }\n              ]\n            },\n            \"options\": {\n              \"fallbackOutput\": \"extra\"\n            }\n          },\n          \"id\": \"33c19a5b-df8b-4c1b-99fe-bd11fe3e0111\",\n          \"name\": \"Route Based on Document Type\",\n          \"type\": \"n8n-nodes-base.switch\",\n          \"typeVersion\": 3.4,\n          \"position\": [\n            2352,\n            224\n          ]\n        },\n        {\n          \"parameters\": {\n            \"httpMethod\": \"POST\",\n            \"path\": \"test-chunk-2-5-v8\",\n            \"responseMode\": \"lastNode\",\n            \"options\": {}\n          },\n          \"id\": \"temp-webhook-test-node\",\n          \"name\": \"Temp Test Webhook - DELETE AFTER TESTING\",\n          \"type\": \"n8n-nodes-base.webhook\",\n          \"typeVersion\": 2,\n          \"position\": [\n            112,\n            184\n          ],\n          \"webhookId\": \"0e852796-4f14-4b08-9172-4bc660161e04\"\n        }\n      ],\n      \"connections\": {\n        \"Execute Workflow Trigger (Refreshed)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Build AI Classification Prompt\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Parse Classification Result\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Tier 2 GPT-4 API Call\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Lookup Client in Client_Tracker\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Find Client Row and Validate\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Update Client_Tracker Row\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Lookup Client in AMA_Folder_IDs\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Lookup Client in AMA_Folder_IDs\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Get Destination Folder ID\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Get Destination Folder ID\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Move File to Final Location\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Move File to Final Location\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare Success Output\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Lookup 38_Unknowns Folder\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Get 38_Unknowns Folder ID\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Get 38_Unknowns Folder ID\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Move File to 38_Unknowns\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Move File to 38_Unknowns\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare Error Email Body\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare Error Email Body\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Send Error Notification Email\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare Tracker Update Data\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Update Client_Tracker Row\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Build AI Classification Prompt\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Classify Document with GPT-4\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Classify Document with GPT-4\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Parse Classification Result\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Tier 2 GPT-4 API Call\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Parse Tier 2 Result\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Parse Tier 2 Result\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Determine Action Type\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Determine Action Type\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Rename File with Confidence\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Rename File with Confidence\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Lookup Client in Client_Tracker\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Find Client Row and Validate\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Route Based on Document Type\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Route Based on Document Type\": {\n          \"error\": [\n            [\n              {\n                \"node\": \"Lookup 38_Unknowns Folder\",\n                \"type\": \"error\",\n                \"index\": 0\n              }\n            ]\n          ],\n          \"update_tracker\": [\n            [\n              {\n                \"node\": \"Prepare Tracker Update Data\",\n                \"type\": \"update_tracker\",\n                \"index\": 0\n              }\n            ]\n          ],\n          \"skip_tracker\": [\n            [\n              {\n                \"node\": \"Lookup Client in AMA_Folder_IDs\",\n                \"type\": \"skip_tracker\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Temp Test Webhook - DELETE AFTER TESTING\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Build AI Classification Prompt\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        }\n      },\n      \"authors\": \"Sway Clarke\",\n      \"name\": null,\n      \"description\": null,\n      \"autosaved\": false,\n      \"workflowPublishHistory\": [\n        {\n          \"createdAt\": \"2026-01-14T14:28:43.098Z\",\n          \"id\": 773,\n          \"workflowId\": \"okg8wTqLtPUwjQ18\",\n          \"versionId\": \"f313f20f-d435-4414-9fdc-799de234da52\",\n          \"event\": \"activated\",\n          \"userId\": \"e9bd9112-c2e3-4f67-873a-e1001baeafd8\"\n        }\n      ]\n    }\n  }\n}"
  }
]