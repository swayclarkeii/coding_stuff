[
  {
    "type": "text",
    "text": "{\n  \"success\": true,\n  \"data\": {\n    \"updatedAt\": \"2026-01-17T10:30:05.981Z\",\n    \"createdAt\": \"2026-01-07T09:49:33.855Z\",\n    \"id\": \"YGXWjWcBIk66ArvT\",\n    \"name\": \"AMA Pre-Chunk 0 - REBUILT v1\",\n    \"description\": null,\n    \"active\": true,\n    \"isArchived\": false,\n    \"nodes\": [\n      {\n        \"parameters\": {\n          \"pollTimes\": {\n            \"item\": [\n              {\n                \"mode\": \"everyMinute\"\n              }\n            ]\n          },\n          \"simple\": false,\n          \"filters\": {\n            \"labelIds\": [\n              \"INBOX\",\n              \"UNREAD\",\n              \"Label_8011160688574026773\"\n            ],\n            \"q\": \"has:attachment\"\n          },\n          \"options\": {\n            \"dataPropertyAttachmentsPrefixName\": \"attachment_\",\n            \"downloadAttachments\": true\n          }\n        },\n        \"id\": \"gmail-trigger-001\",\n        \"name\": \"Gmail Trigger - Unread with Attachments\",\n        \"type\": \"n8n-nodes-base.gmailTrigger\",\n        \"typeVersion\": 1.3,\n        \"position\": [\n          112,\n          304\n        ],\n        \"credentials\": {\n          \"gmailOAuth2\": {\n            \"id\": \"aYzk7sZF8ZVyfOan\",\n            \"name\": \"Gmail account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Filter PDF and ZIP attachments only\\nconst items = $input.all();\\nconst filtered = [];\\n\\nfor (const item of items) {\\n  // Gmail trigger stores attachments in item.binary, not item.json.attachments\\n  if (!item.binary) continue;\\n  \\n  // Iterate over binary keys (attachment_0, attachment_1, etc.)\\n  for (const [key, attachment] of Object.entries(item.binary)) {\\n    const filename = attachment.fileName;\\n    if (!filename) continue;\\n    \\n    const ext = filename.toLowerCase().split('.').pop();\\n    \\n    if (['pdf', 'zip'].includes(ext)) {\\n      filtered.push({\\n        json: {\\n          emailId: item.json.id,\\n          emailSubject: item.json.Subject || item.json.subject,\\n          emailFrom: item.json.From || item.json.from,\\n          emailDate: item.json.date,\\n          attachmentKey: key,\\n          filename: filename,\\n          mimeType: attachment.mimeType,\\n          size: attachment.fileSize\\n        },\\n        binary: {\\n          data: attachment\\n        }\\n      });\\n    }\\n  }\\n}\\n\\nreturn filtered;\"\n        },\n        \"id\": \"filter-attachments-001\",\n        \"name\": \"Filter PDF/ZIP Attachments\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          336,\n          304\n        ]\n      },\n      {\n        \"parameters\": {\n          \"driveId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"My Drive\"\n          },\n          \"folderId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"root\",\n            \"cachedResultName\": \"/ (Root folder)\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"upload-pdf-gdrive-001\",\n        \"name\": \"Upload PDF to Temp Folder\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          560,\n          304\n        ],\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Extract Google Drive file ID from upload response and preserve email metadata\\nconst uploadResult = $input.first().json;\\nconst emailData = $('Filter PDF/ZIP Attachments').first().json;\\n\\nreturn [{\\n  json: {\\n    file_id: uploadResult.id,\\n    filename: uploadResult.name,\\n    emailId: emailData.emailId,\\n    emailSubject: emailData.emailSubject,\\n    emailFrom: emailData.emailFrom,\\n    emailDate: emailData.emailDate\\n  }\\n}];\"\n        },\n        \"id\": \"extract-file-id-001\",\n        \"name\": \"Extract File ID & Metadata\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          784,\n          304\n        ]\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"download\",\n          \"fileId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"={{ $json.file_id }}\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"download-pdf-from-gdrive-001\",\n        \"name\": \"Download PDF from Drive\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          1008,\n          304\n        ],\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"pdf\",\n          \"options\": {\n            \"joinPages\": true,\n            \"keepSource\": \"json\"\n          }\n        },\n        \"id\": \"extract-text-001\",\n        \"name\": \"Extract Text from PDF\",\n        \"type\": \"n8n-nodes-base.extractFromFile\",\n        \"typeVersion\": 1.1,\n        \"position\": [\n          1232,\n          160\n        ],\n        \"disabled\": true,\n        \"notes\": \"‚ö†Ô∏è OLD METHOD - Disabled. Use 'Prepare Document AI Request' path instead for proper OCR.\"\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// V4: Evaluate extraction quality for each PDF\\nconst items = $input.all();\\nconst results = [];\\n\\nfor (const item of items) {\\n  // FIX: Check both extractedText (from OCR) and text (from digital extraction)\\n  const extractedText = item.json.extractedText || item.json.text || '';\\n  const wordCount = extractedText.trim().split(/\\\\s+/).length;\\n\\n  results.push({\\n    json: {\\n      ...item.json,\\n      wordCount: wordCount,\\n      needsOCR: wordCount < 10,\\n      extractionQuality: wordCount < 10 ? 'poor' : 'good',\\n      \\n      // Keep extracted text for downstream use\\n      extractedText: extractedText,\\n      textLength: extractedText.trim().length,\\n      extractionMethod: 'digital_pre_chunk'\\n    },\\n    binary: item.binary\\n  });\\n}\\n\\nreturn results;\"\n        },\n        \"id\": \"evaluate-extraction-001\",\n        \"name\": \"Evaluate Extraction Quality\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          1456,\n          304\n        ]\n      },\n      {\n        \"parameters\": {\n          \"resource\": \"chat\",\n          \"chatModel\": \"gpt-4.1-mini\",\n          \"prompt\": {\n            \"messages\": [\n              {\n                \"role\": \"system\",\n                \"content\": \"Extract the PROJECT or PROPERTY IDENTIFIER from this German real estate document.\\n\\nValid identifiers (in order of priority):\\n\\n1. STREET ADDRESS + CITY (MOST COMMON IN THESE DOCUMENTS):\\n   - \\\"Schlo√übergstra√üe 13, T√ºbingen\\\" ‚Üí \\\"Schlossberg 13\\\"\\n   - \\\"Schlo√übergstr. 13\\\" ‚Üí \\\"Schlossberg 13\\\"\\n   - Normalize: Remove \\\"stra√üe/str.\\\", keep number\\n\\n2. PROJECT CODES/ABBREVIATIONS:\\n   - \\\"BV Propos\\\" ‚Üí \\\"Propos\\\"\\n   - \\\"Projekt Schlo√überg\\\" ‚Üí \\\"Schlossberg\\\"\\n\\n3. PROPERTY/VILLA NAMES\\n\\n4. COMPANY NAMES (if property-related)\\n\\n5. PERSON/RECIPIENT NAMES (last resort)\\n\\nEXTRACTION RULES:\\n- Look for street addresses FIRST\\n- \\\"Schlo√überg\\\" and \\\"Schlossberg\\\" are the same (normalize to \\\"Schlossberg\\\")\\n- Combine street name + number: \\\"Schlo√übergstra√üe 13\\\" ‚Üí \\\"Schlossberg 13\\\"\\n\\nReturn ONLY the normalized identifier, nothing else.\\nIf no identifiable project/property exists, return exactly: UNKNOWN\"\n              },\n              {\n                \"content\": \"={{ $json.extractedText }}\"\n              }\n            ]\n          },\n          \"options\": {},\n          \"requestOptions\": {}\n        },\n        \"id\": \"ai-extract-client-001\",\n        \"name\": \"AI Extract Client Name\",\n        \"type\": \"n8n-nodes-base.openAi\",\n        \"typeVersion\": 1.1,\n        \"position\": [\n          1680,\n          304\n        ],\n        \"credentials\": {\n          \"openAiApi\": {\n            \"id\": \"xmJ7t6kaKgMwA1ce\",\n            \"name\": \"OpenAi account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Get all input items\\nconst items = $input.all();\\nconst results = [];\\n\\n// Process each item\\nfor (const item of items) {\\n  let clientNameRaw = '';\\n  \\n  // Extract AI response from OpenAI node output\\n  // Chat API (unsimplified): choices[0].message.content\\n  if (item.json && item.json.choices && item.json.choices[0] && item.json.choices[0].message) {\\n    clientNameRaw = String(item.json.choices[0].message.content);\\n  }\\n  // Chat API (simplified): message.content\\n  else if (item.json && item.json.message && item.json.message.content) {\\n    clientNameRaw = String(item.json.message.content);\\n  }\\n  // Text API (simplified): text\\n  else if (item.json && item.json.text) {\\n    clientNameRaw = String(item.json.text);\\n  }\\n  \\n  clientNameRaw = clientNameRaw.trim();\\n  \\n  // CRITICAL FIX: Remove duplicate responses from Chat API\\n  // Chat API sometimes returns \\\"Villa Martens\\\\n\\\\nVilla Martens\\\"\\n  // Split by double newline and take first occurrence\\n  if (clientNameRaw.includes('\\\\n\\\\n')) {\\n    const parts = clientNameRaw.split('\\\\n\\\\n');\\n    // Check if it's a duplicate (same text repeated)\\n    if (parts.length === 2 && parts[0].trim() === parts[1].trim()) {\\n      clientNameRaw = parts[0].trim();\\n    }\\n  }\\n  \\n  // Normalize German client name for folder creation\\n  let clientName = '';\\n  if (clientNameRaw) {\\n    clientName = clientNameRaw\\n      .toLowerCase()\\n      .trim()\\n      .replace(/√§/g, 'ae')\\n      .replace(/√∂/g, 'oe')\\n      .replace(/√º/g, 'ue')\\n      .replace(/√ü/g, 'ss')\\n      .replace(/\\\\s*(gmbh|ag|kg|e\\\\.v\\\\.|mbh|co\\\\.|&\\\\s*co\\\\.?)\\\\s*/gi, '')\\n      .replace(/[^a-z0-9]/g, '_')\\n      .replace(/_+/g, '_')\\n      .replace(/^_|_$/g, '');\\n  }\\n  \\n  results.push({\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: '1ikw3k-EgpVg_h2ySDdqdUFB7-FQyYDFm'\\n    }\\n  });\\n}\\n\\nreturn results;\"\n        },\n        \"id\": \"normalize-name-001\",\n        \"name\": \"Normalize Client Name\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          1904,\n          304\n        ]\n      },\n      {\n        \"parameters\": {\n          \"documentId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI\"\n          },\n          \"sheetName\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": 762792134,\n            \"cachedResultName\": \"Client_Registry\",\n            \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI/edit#gid=762792134\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"lookup-registry-001\",\n        \"name\": \"Lookup Client Registry\",\n        \"type\": \"n8n-nodes-base.googleSheets\",\n        \"typeVersion\": 4.7,\n        \"position\": [\n          2128,\n          304\n        ],\n        \"alwaysOutputData\": true,\n        \"credentials\": {\n          \"googleSheetsOAuth2Api\": {\n            \"id\": \"H7ewI1sOrDYabelt\",\n            \"name\": \"Google Sheets account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// V7: Check if client exists in Client_Registry\\n// CRITICAL FIX V3: Detect literal \\\"UNKNOWN\\\" response from AI\\n\\n// Get normalized client name from Normalize Client Name node (not from $input!)\\nconst normalizeOutput = $('Normalize Client Name').first().json;\\nconst clientName = normalizeOutput.client_name || '';\\nconst clientNameRaw = normalizeOutput.client_name_raw || '';\\nconst parentFolderId = normalizeOutput.parent_folder_id || '';\\n\\n// Get registry rows from $input (Lookup Client Registry output)\\nconst registryRows = $input.all();\\n\\n// ‚úÖ FIRST: Check if AI literally returned \\\"UNKNOWN\\\"\\nif (clientNameRaw.toUpperCase().trim() === 'UNKNOWN') {\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'UNKNOWN',\\n      root_folder_id: null,\\n      staging_folder_id: null,\\n      extraction_failure: true,\\n      extraction_error_message: 'AI returned UNKNOWN'\\n    }\\n  }];\\n}\\n\\n// ‚úÖ SECOND: Detect AI extraction failures (technical + polite refusals)\\nconst extractionFailurePatterns = [\\n  // Technical error messages\\n  'unable_to_extract',\\n  'error_extracting',\\n  'could_not_identify',\\n  'could_not_extract',\\n  'no_client_name',\\n  'extraction_failed',\\n  'cannot_identify',\\n  // Polite AI refusals\\n  'i_m_sorry',\\n  'sorry_but',\\n  'doesn_t_seem',\\n  'does_not_appear',\\n  'no_company_name',\\n  'cannot_find',\\n  'not_able_to'\\n];\\n\\nconst isExtractionFailure = extractionFailurePatterns.some(pattern => \\n  clientName.toLowerCase().includes(pattern)\\n);\\n\\nif (isExtractionFailure) {\\n  // AI failed to extract client name ‚Üí Route to UNKNOWN path\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'UNKNOWN',\\n      root_folder_id: null,\\n      staging_folder_id: null,\\n      extraction_failure: true,\\n      extraction_error_message: clientNameRaw\\n    }\\n  }];\\n}\\n\\n// If registry is empty, client is NEW\\nif (registryRows.length === 0) {\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'NEW',\\n      root_folder_id: null,\\n      staging_folder_id: null\\n    }\\n  }];\\n}\\n\\n// Search registry for matching client (with same normalization)\\nconst clientRow = registryRows.find(row => {\\n  const registryClientName = row.json.Client_Name || '';\\n  const normalizedRegistryName = registryClientName\\n    .toLowerCase()\\n    .trim()\\n    .replace(/√§/g, 'ae')\\n    .replace(/√∂/g, 'oe')\\n    .replace(/√º/g, 'ue')\\n    .replace(/√ü/g, 'ss')\\n    .replace(/\\\\s*(gmbh|ag|kg|e\\\\.v\\\\.|mbh|co\\\\.|&\\\\s*co\\\\.?)\\\\s*/gi, '')\\n    .replace(/[^a-z0-9]/g, '_')\\n    .replace(/_+/g, '_')\\n    .replace(/^_|_$/g, '');\\n  \\n  return normalizedRegistryName === clientName;\\n});\\n\\nif (clientRow) {\\n  // Client exists ‚Üí EXISTING path\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'EXISTING',\\n      root_folder_id: clientRow.json.Root_Folder_ID,\\n      staging_folder_id: clientRow.json.Staging_Folder_ID\\n    }\\n  }];\\n} else {\\n  // Client not in registry ‚Üí NEW path\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'NEW',\\n      root_folder_id: null,\\n      staging_folder_id: null\\n    }\\n  }];\\n}\"\n        },\n        \"id\": \"check-exists-001\",\n        \"name\": \"Check Client Exists\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          2352,\n          304\n        ]\n      },\n      {\n        \"parameters\": {\n          \"rules\": {\n            \"values\": [\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"caseSensitive\": true,\n                    \"leftValue\": \"\",\n                    \"typeValidation\": \"strict\",\n                    \"version\": 3\n                  },\n                  \"conditions\": [\n                    {\n                      \"leftValue\": \"={{ $json.client_normalized }}\",\n                      \"rightValue\": \"\",\n                      \"operator\": {\n                        \"type\": \"string\",\n                        \"operation\": \"isEmpty\"\n                      },\n                      \"id\": \"fcfa78d7-b736-4c5c-8123-d82d2456ad6d\"\n                    },\n                    {\n                      \"leftValue\": \"={{ $json.client_status }}\",\n                      \"rightValue\": \"UNKNOWN\",\n                      \"operator\": {\n                        \"type\": \"string\",\n                        \"operation\": \"equals\"\n                      },\n                      \"id\": \"0d66b8d3-e3c7-4314-9d28-b4d60c45bef2\"\n                    }\n                  ],\n                  \"combinator\": \"or\"\n                },\n                \"renameOutput\": true,\n                \"outputKey\": \"unknown_client\"\n              },\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"caseSensitive\": true,\n                    \"leftValue\": \"\",\n                    \"typeValidation\": \"strict\",\n                    \"version\": 3\n                  },\n                  \"conditions\": [\n                    {\n                      \"leftValue\": \"={{ $json.client_status }}\",\n                      \"rightValue\": \"NEW\",\n                      \"operator\": {\n                        \"type\": \"string\",\n                        \"operation\": \"equals\"\n                      },\n                      \"id\": \"ed430b2e-0251-4783-9c3f-a0d015a07a18\"\n                    }\n                  ],\n                  \"combinator\": \"and\"\n                },\n                \"renameOutput\": true,\n                \"outputKey\": \"new_client\"\n              },\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"caseSensitive\": true,\n                    \"leftValue\": \"\",\n                    \"typeValidation\": \"strict\",\n                    \"version\": 3\n                  },\n                  \"conditions\": [\n                    {\n                      \"leftValue\": \"={{ $json.client_status }}\",\n                      \"rightValue\": \"EXISTING\",\n                      \"operator\": {\n                        \"type\": \"string\",\n                        \"operation\": \"equals\"\n                      },\n                      \"id\": \"3db6573d-2127-4c22-855f-afca26e1b811\"\n                    }\n                  ],\n                  \"combinator\": \"and\"\n                },\n                \"renameOutput\": true,\n                \"outputKey\": \"existing_client\"\n              }\n            ]\n          },\n          \"options\": {}\n        },\n        \"id\": \"decision-gate-001\",\n        \"name\": \"Decision Gate\",\n        \"type\": \"n8n-nodes-base.switch\",\n        \"typeVersion\": 3.4,\n        \"position\": [\n          2576,\n          288\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Prepare UNKNOWN client data with simple static naming\\n// V3: Use simple UNKNOWN_CLIENT naming instead of timestamp\\nconst inputData = $input.first().json;\\n\\nconst clientName = \\\"unknown_client\\\";\\n\\nreturn [{\\n  json: {\\n    client_name: clientName,\\n    parent_folder_id: inputData.parent_folder_id,\\n    client_name_raw: inputData.client_name_raw,\\n    client_status: inputData.client_status,\\n    root_folder_id: inputData.root_folder_id,\\n    staging_folder_id: inputData.staging_folder_id,\\n    extraction_failure: inputData.extraction_failure,\\n    extraction_error_message: inputData.extraction_error_message,\\n    is_unknown_client: true,\\n    unknown_timestamp: new Date().toISOString()\\n  },\\n  binary: $input.first().binary\\n}];\"\n        },\n        \"id\": \"prepare-unknown-data-001\",\n        \"name\": \"Prepare UNKNOWN Client Data\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3024,\n          112\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Handle unidentified client - send to manual queue\\n  const items = $input.all();\\n  const results = [];\\n\\n  for (const item of items) {\\n    results.push({\\n      json: {\\n        status: 'FAILED',\\n        reason: 'Client name could not be identified',\\n        email_id: item.json.emailId,\\n        email_subject: item.json.emailSubject,\\n        timestamp: new Date().toISOString()\\n      }\\n    });\\n  }\\n\\n  return results;\"\n        },\n        \"id\": \"handle-unknown-001\",\n        \"name\": \"Handle Unidentified Client\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          2800,\n          112\n        ]\n      },\n      {\n        \"parameters\": {\n          \"documentId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI\"\n          },\n          \"sheetName\": {\n            \"__rl\": true,\n            \"value\": 762792134,\n            \"mode\": \"list\",\n            \"cachedResultName\": \"Client_Registry\",\n            \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI/edit#gid=762792134\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"lookup-staging-folder-001\",\n        \"name\": \"Lookup Staging Folder\",\n        \"type\": \"n8n-nodes-base.googleSheets\",\n        \"typeVersion\": 4.7,\n        \"position\": [\n          2800,\n          592\n        ],\n        \"credentials\": {\n          \"googleSheetsOAuth2Api\": {\n            \"id\": \"H7ewI1sOrDYabelt\",\n            \"name\": \"Google Sheets account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// V6: GRACEFUL ERROR HANDLING - No errors thrown, route to 38_Unknowns if missing\\n// Extract staging_folder_id from Client Registry lookup AND file_id from upload\\nconst clientName = $('Check Client Exists').first().json.client_name;\\nconst sheetRows = $input.all();\\nconst fileData = $('Extract File ID & Metadata').first().json;\\n\\n// Find matching row by normalizing Client_Name the same way as \\\"Normalize Client Name\\\" node\\nconst matchingRow = sheetRows.find(row => {\\n  const registryClientName = row.json.Client_Name || '';\\n  \\n  // Normalize Client_Name to match client_name format\\n  const normalizedName = registryClientName\\n    .toLowerCase()\\n    .trim()\\n    .replace(/√§/g, 'ae')\\n    .replace(/√∂/g, 'oe')\\n    .replace(/√º/g, 'ue')\\n    .replace(/√ü/g, 'ss')\\n    .replace(/\\\\s*(gmbh|ag|kg|e\\\\.v\\\\.|mbh|co\\\\.|&\\\\s*co\\\\.?)\\\\s*/gi, '')\\n    .replace(/[^a-z0-9]/g, '_')\\n    .replace(/_+/g, '_')\\n    .replace(/^_|_$/g, '');\\n  \\n  return normalizedName === clientName;\\n});\\n\\n// GRACEFUL HANDLING: Route to 38_Unknowns if no matching row\\nif (!matchingRow) {\\n  return [{\\n    json: {\\n      ...fileData,\\n      client_name: clientName,\\n      error: `No staging folder found for client: ${clientName}`,\\n      routeTo38Unknowns: true,\\n      errorType: 'missing_client_in_registry',\\n      skipChunk1: true\\n    }\\n  }];\\n}\\n\\nconst stagingFolderId = matchingRow.json.Staging_Folder_ID || matchingRow.json['01_Staging'];\\n\\n// GRACEFUL HANDLING: Route to 38_Unknowns if staging folder ID is empty\\nif (!stagingFolderId) {\\n  return [{\\n    json: {\\n      ...fileData,\\n      client_name: clientName,\\n      error: `Staging_Folder_ID is empty for client: ${clientName}`,\\n      routeTo38Unknowns: true,\\n      errorType: 'missing_staging_folder',\\n      skipChunk1: true\\n    }\\n  }];\\n}\\n\\n// SUCCESS PATH: Continue with staging folder ID\\nreturn [{\\n  json: {\\n    client_name: clientName,\\n    staging_folder_id: stagingFolderId,\\n    email_id: fileData.emailId,\\n    file_id: fileData.file_id,\\n    filename: fileData.filename,\\n    routeTo38Unknowns: false\\n  }\\n}];\"\n        },\n        \"id\": \"filter-staging-folder-001\",\n        \"name\": \"Filter Staging Folder ID\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3024,\n          592\n        ]\n      },\n      {\n        \"parameters\": {\n          \"conditions\": {\n            \"options\": {\n              \"caseSensitive\": true,\n              \"leftValue\": \"\",\n              \"typeValidation\": \"strict\",\n              \"version\": 2\n            },\n            \"conditions\": [\n              {\n                \"id\": \"route-unknowns-check\",\n                \"leftValue\": \"={{ $json.routeTo38Unknowns }}\",\n                \"rightValue\": true,\n                \"operator\": {\n                  \"type\": \"boolean\",\n                  \"operation\": \"true\",\n                  \"singleValue\": true\n                }\n              }\n            ],\n            \"combinator\": \"and\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"check-routing-decision-001\",\n        \"name\": \"Check Routing Decision\",\n        \"type\": \"n8n-nodes-base.if\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3248,\n          592\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Prepare data for routing to 38_Unknowns when staging folder is missing\\nconst item = $input.first().json;\\n\\n// Create UNKNOWN_CLIENT structure to match existing unknowns path\\nreturn [{\\n  json: {\\n    client_name: 'unknown_client',\\n    parent_folder_id: '1ikw3k-EgpVg_h2ySDdqdUFB7-FQyYDFm',\\n    client_status: 'UNKNOWN',\\n    is_unknown_client: true,\\n    error_reason: item.error || 'Missing staging folder',\\n    error_type: item.errorType || 'missing_staging_folder',\\n    file_id: item.file_id,\\n    filename: item.filename,\\n    email_id: item.email_id,\\n    unknown_timestamp: new Date().toISOString()\\n  }\\n}];\"\n        },\n        \"id\": \"prepare-missing-folder-error-001\",\n        \"name\": \"Prepare Missing Folder Error\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3472,\n          688\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Extract 38_Unknowns folder ID from Chunk 0 response\\n// ALSO get file_id from earlier in workflow\\n\\nconst chunk0Response = $input.first().json;\\nconst folderData = chunk0Response.folderIDs || [];\\n\\nconst unknownsFolder = folderData.find(item =>\\n  item.Variable_Name === 'FOLDER_38_UNKNOWNS'\\n);\\n\\nif (!unknownsFolder || !unknownsFolder.Folder_ID) {\\n  throw new Error('FOLDER_38_UNKNOWNS not found in Chunk 0 response');\\n}\\n\\n// Get file_id from Extract File ID & Metadata node\\nconst fileMetadata = $('Extract File ID & Metadata').first().json;\\nconst fileId = fileMetadata.file_id;\\n\\nif (!fileId) {\\n  throw new Error('file_id not found from Extract File ID & Metadata node');\\n}\\n\\nreturn {\\n  json: {\\n    unknowns_folder_id: unknownsFolder.Folder_ID,\\n    temp_pdf_file_id: fileId,\\n    root_folder_id: chunk0Response.Root_Folder_ID,\\n    client_name: chunk0Response.Client_Name,\\n    ...chunk0Response\\n  },\\n  binary: $input.first().binary\\n};\\n\"\n        },\n        \"id\": \"extract-unknowns-folder-001\",\n        \"name\": \"Extract 38_Unknowns Folder ID\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3472,\n          112\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"const folderId = $json.unknowns_folder_id;\\nconst fileId = $json.temp_pdf_file_id;\\n\\nif (!folderId || folderId === '') {\\n  throw new Error('Missing unknowns_folder_id - cannot move file');\\n}\\n\\nif (!fileId || fileId === '') {\\n  throw new Error('Missing temp_pdf_file_id - no file to move');\\n}\\n\\nreturn {\\n  json: {\\n    unknowns_folder_id: folderId,\\n    temp_pdf_file_id: fileId,\\n    ...$json\\n  },\\n  binary: $input.first().binary\\n};\"\n        },\n        \"id\": \"validate-folder-ids-001\",\n        \"name\": \"Validate Folder IDs\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3696,\n          112\n        ]\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"move\",\n          \"fileId\": \"={{ $json.temp_pdf_file_id }}\",\n          \"driveId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"My Drive\"\n          },\n          \"folderId\": {\n            \"__rl\": true,\n            \"value\": \"={{ $('Execute Chunk 0 - Create Folders (UNKNOWN)').item.json.folderIDs[43].Folder_ID }}\",\n            \"mode\": \"\"\n          }\n        },\n        \"id\": \"move-pdf-unknowns-001\",\n        \"name\": \"Move PDF to 38_Unknowns\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          3920,\n          112\n        ],\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Get data from correct sources\\n// CRITICAL FIX: Get root_folder_id from Validate Folder IDs (before Move PDF wiped data)\\nconst folderData = $('Validate Folder IDs').first().json;\\nconst emailData = $('Gmail Trigger - Unread with Attachments').first().json;\\nconst moveResult = $input.first().json;\\n\\nconst rootFolderId = folderData.Root_Folder_ID || folderData.root_folder_id;\\nconst rootFolderName = folderData.Client_Name || folderData.client_name || 'UNKNOWN';\\nconst unknownsFolderId = folderData.unknowns_folder_id;\\nconst pdfFileId = moveResult.id || folderData.temp_pdf_file_id;\\n\\nconst pdfLink = `https://drive.google.com/file/d/${pdfFileId}/view`;\\nconst rootFolderLink = `https://drive.google.com/drive/folders/${rootFolderId}`;\\n\\nconst emailFrom = emailData.from || 'Unknown Sender';\\nconst emailSubject = emailData.subject || 'No Subject';\\nconst pdfFilename = folderData.pdf_filename || 'unknown.pdf';\\n\\nconst timestamp = new Date().toLocaleString('en-US', {\\n  timeZone: 'Europe/Berlin',\\n  year: 'numeric',\\n  month: '2-digit',\\n  day: '2-digit',\\n  hour: '2-digit',\\n  minute: '2-digit',\\n  hour12: false\\n});\\n\\nreturn [{\\n  json: {\\n    to: 'swayclarkeii@gmail.com',\\n    pdf_filename: pdfFilename,\\n    email_from: emailFrom,\\n    email_subject: emailSubject,\\n    root_folder_name: rootFolderName,\\n    pdf_link: pdfLink,\\n    root_folder_link: rootFolderLink,\\n    timestamp: timestamp\\n  },\\n  binary: $input.first().binary\\n}];\"\n        },\n        \"id\": \"prepare-email-data-001\",\n        \"name\": \"Prepare Email Notification Data\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          4144,\n          112\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Build HTML email body for UNKNOWN client notification\\nconst data = $input.first().json;\\n\\n// Extract just the email address (not the display name)\\nconst emailAddress = data.email_from?.value?.[0]?.address || 'Unknown Sender';\\n\\nconst htmlBody = `<!DOCTYPE html>\\n<html>\\n<body style=\\\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\\\">\\n  <div style=\\\"max-width: 600px; margin: 0 auto; padding: 20px;\\\">\\n    <h2 style=\\\"color: #d32f2f;\\\">‚ö†Ô∏è Unknown Client Document Received</h2>\\n    \\n    <p>A document was received but the client could not be identified. Manual review is required.</p>\\n    \\n    <div style=\\\"background: #f5f5f5; padding: 15px; border-left: 4px solid #1976d2; margin: 20px 0;\\\">\\n      <h3 style=\\\"margin-top: 0;\\\">Document Details</h3>\\n      <ul style=\\\"list-style: none; padding: 0;\\\">\\n        <li><strong>Filename:</strong> ${data.pdf_filename}</li>\\n        <li><strong>From:</strong> ${emailAddress}</li>\\n        <li><strong>Subject:</strong> ${data.email_subject}</li>\\n      </ul>\\n    </div>\\n    \\n    <div style=\\\"background: #fff3e0; padding: 15px; border-left: 4px solid #f57c00; margin: 20px 0;\\\">\\n      <h3 style=\\\"margin-top: 0;\\\">üìÇ Created Folder Structure</h3>\\n      <p>A temporary folder structure has been created:</p>\\n      <ul style=\\\"list-style: none; padding: 0;\\\">\\n        <li><strong>Root Folder:</strong> ${data.root_folder_name}</li>\\n        <li><strong>Document Location:</strong> SONSTIGES/38_Unknowns/</li>\\n      </ul>\\n    </div>\\n    \\n    <div style=\\\"margin: 30px 0;\\\">\\n      <h3>üîó Quick Actions</h3>\\n      <div style=\\\"margin: 10px 0;\\\">\\n        <a href=\\\"${data.pdf_link}\\\" \\n           style=\\\"display: inline-block; padding: 12px 24px; background: #1976d2; color: white; text-decoration: none; border-radius: 4px; margin-right: 10px;\\\">\\n          üìÑ View PDF\\n        </a>\\n        <a href=\\\"${data.root_folder_link}\\\" \\n           style=\\\"display: inline-block; padding: 12px 24px; background: #43a047; color: white; text-decoration: none; border-radius: 4px;\\\">\\n          üìÅ Open Folder Structure\\n        </a>\\n      </div>\\n    </div>\\n    \\n    <div style=\\\"background: #e3f2fd; padding: 15px; border-left: 4px solid #1976d2; margin: 20px 0;\\\">\\n      <h3 style=\\\"margin-top: 0;\\\">‚úÖ Next Steps</h3>\\n      <ol>\\n        <li>Review the PDF to identify the client</li>\\n        <li>Rename the root folder to the correct client name</li>\\n        <li>Update the Client_Registry sheet with the correct client name</li>\\n        <li>Move the PDF from 38_Unknowns to the appropriate subfolder</li>\\n      </ol>\\n    </div>\\n    \\n    <hr style=\\\"border: none; border-top: 1px solid #ddd; margin: 30px 0;\\\">\\n    \\n    <p style=\\\"font-size: 12px; color: #666;\\\">\\n      <strong>System:</strong> Eugene AMA Document Organizer V4<br>\\n      <strong>Timestamp:</strong> ${data.timestamp}\\n    </p>\\n  </div>\\n</body>\\n</html>`;\\n\\nreturn [{\\n  json: {\\n    ...data,\\n    html_body: htmlBody\\n  },\\n  binary: $input.first().binary\\n}];\"\n        },\n        \"id\": \"build-email-html-001\",\n        \"name\": \"Build Email HTML Body\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          4368,\n          112\n        ]\n      },\n      {\n        \"parameters\": {\n          \"sendTo\": \"swayclarkeii@gmail.com\",\n          \"subject\": \"={{ $json.emailSubject || '[ACTION REQUIRED] Unknown Client Document' }}\",\n          \"message\": \"={{ $json.html_body }}\",\n          \"options\": {}\n        },\n        \"id\": \"send-email-notification-001\",\n        \"name\": \"Send Email Notification\",\n        \"type\": \"n8n-nodes-base.gmail\",\n        \"typeVersion\": 2,\n        \"position\": [\n          4592,\n          112\n        ],\n        \"webhookId\": \"e028968d-b3d1-4dd6-bb18-20d1b6594069\",\n        \"credentials\": {\n          \"gmailOAuth2\": {\n            \"id\": \"aYzk7sZF8ZVyfOan\",\n            \"name\": \"Gmail account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Format error email data for registry corruption\\nconst inputData = $input.all();\\n\\nconst output = inputData.map(item => {\\n  const clientName = item.json.client_name || 'Unknown Client';\\n  const fileName = item.json.file_name || 'Unknown File';\\n  const emailSubject = item.json.email_subject || 'N/A';\\n  const emailFrom = item.json.email_from || 'N/A';\\n  const emailDate = item.json.email_date || 'N/A';\\n  \\n  return {\\n    json: {\\n      ...item.json,\\n      email_to: 'swayclarkeii@gmail.com',\\n      email_subject: `[URGENT] Registry Error: ${clientName} - Missing Staging Folder`,\\n      email_message: `CRITICAL REGISTRY ERROR DETECTED\\n\\nClient: ${clientName}\\nError Type: Client marked EXISTING but staging_folder_id is MISSING in Client Registry\\n\\n--- ACTION TAKEN ---\\nFile moved to 38_Unknowns folder for manual review\\n\\n--- ORIGINAL EMAIL DETAILS ---\\nSubject: ${emailSubject}\\nFrom: ${emailFrom}\\nDate: ${emailDate}\\nAttachment: ${fileName}\\n\\n--- NEXT STEPS ---\\nPlease:\\n1. Open the Client Registry spreadsheet\\n2. Find the row for \\\"${clientName}\\\"\\n3. Add the missing staging_folder_id to column E\\n4. Manually move the file from 38_Unknowns to the correct staging folder\\n\\nThis is a data integrity issue that needs immediate attention.\\n\\n---\\nWorkflow: AMA Pre-Chunk 0\\nNode: Registry Error Handler`\\n    }\\n  };\\n});\\n\\nreturn output;\"\n        },\n        \"id\": \"prepare-registry-error-email-001\",\n        \"name\": \"Prepare Registry Error Email Data\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3696,\n          688\n        ]\n      },\n      {\n        \"parameters\": {\n          \"sendTo\": \"={{ $json.email_to }}\",\n          \"subject\": \"={{ $json.email_subject }}\",\n          \"message\": \"={{ $json.email_message }}\",\n          \"options\": {}\n        },\n        \"id\": \"send-registry-error-email-001\",\n        \"name\": \"Send Registry Error Email\",\n        \"type\": \"n8n-nodes-base.gmail\",\n        \"typeVersion\": 2.1,\n        \"position\": [\n          3920,\n          688\n        ],\n        \"webhookId\": \"6b7c8ac4-c32d-40d5-b4d0-44a55bc16b79\",\n        \"credentials\": {\n          \"gmailOAuth2\": {\n            \"id\": \"aYzk7sZF8ZVyfOan\",\n            \"name\": \"Gmail account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"move\",\n          \"fileId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"={{ $json.file_id }}\"\n          },\n          \"driveId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"My Drive\"\n          },\n          \"folderId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"1qdUu-dIkQR0oDaZKAL_8OhI0jST89_Vu\"\n          }\n        },\n        \"id\": \"move-to-unknowns-registry-001\",\n        \"name\": \"Move to 38_Unknowns (Registry Error)\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          4144,\n          688\n        ],\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"addLabels\",\n          \"messageId\": \"={{ $json.email_id }}\",\n          \"labelIds\": [\n            \"INBOX\"\n          ]\n        },\n        \"id\": \"mark-read-registry-error-001\",\n        \"name\": \"Mark Email as Read (Registry Error)\",\n        \"type\": \"n8n-nodes-base.gmail\",\n        \"typeVersion\": 2.1,\n        \"position\": [\n          4368,\n          688\n        ],\n        \"webhookId\": \"f229ca84-1e69-43a0-90a0-f6ac4544b40f\",\n        \"credentials\": {\n          \"gmailOAuth2\": {\n            \"id\": \"aYzk7sZF8ZVyfOan\",\n            \"name\": \"Gmail account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {},\n        \"id\": \"noop-registry-complete-001\",\n        \"name\": \"NoOp - Registry Error Complete\",\n        \"type\": \"n8n-nodes-base.noOp\",\n        \"typeVersion\": 1,\n        \"position\": [\n          4592,\n          688\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Merge Chunk 0 output with original file data for NEW client path\\nconst chunk0Output = $input.first().json;\\n\\n// Get file_id from Extract File ID & Metadata node (far upstream)\\nconst fileMetadata = $('Extract File ID & Metadata').first().json;\\n\\nreturn [{\\n  json: {\\n    ...chunk0Output,\\n    file_id: fileMetadata.file_id,\\n    email_id: fileMetadata.emailId,\\n    filename: fileMetadata.filename\\n  }\\n}];\"\n        },\n        \"id\": \"0180f051-407b-453b-89fc-faaf3439c20d\",\n        \"name\": \"Merge Chunk 0 Output (NEW)\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 1,\n        \"position\": [\n          3024,\n          304\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Get Google Drive upload result from previous node\\nconst driveUpload = $input.first().json;\\n\\n// Retrieve email metadata from Gmail Trigger\\nconst emailData = $('Gmail Trigger - Unread with Attachments').first().json;\\n\\n// Retrieve binary metadata from Gmail Trigger\\nconst binaryData = $('Gmail Trigger - Unread with Attachments').first().binary;\\n\\n// Get first attachment key\\nconst attachmentKeys = Object.keys(binaryData);\\nconst attachmentKey = attachmentKeys[0];\\nconst attachment = binaryData[attachmentKey];\\n\\n// Extract file extension from filename\\nconst fileName = driveUpload.name;\\nconst extension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();\\n\\n// Get client data from Normalize Client Name node\\nconst clientData = $('Normalize Client Name').first().json;\\nconst clientName = clientData.client_name || 'unknown';\\n\\n// Construct stagingPath\\nconst stagingPath = `${clientName}/_Staging/${fileName}`;\\n\\n// Parse file size\\nlet fileSizeBytes = 0;\\nif (attachment.fileSize) {\\n  const sizeStr = attachment.fileSize;\\n  const match = sizeStr.match(/^([\\\\d.]+)\\\\s*(KB|MB|GB)$/i);\\n  if (match) {\\n    const value = parseFloat(match[1]);\\n    const unit = match[2].toUpperCase();\\n    const multipliers = { KB: 1024, MB: 1024 * 1024, GB: 1024 * 1024 * 1024 };\\n    fileSizeBytes = Math.round(value * multipliers[unit]);\\n  }\\n}\\n\\n// Extract email sender\\nlet emailFrom = '';\\nif (emailData.from && emailData.from.value && emailData.from.value[0]) {\\n  emailFrom = emailData.from.value[0].address;\\n}\\n\\n// ‚úÖ NEW: Get extracted text from Evaluate Extraction Quality node\\nconst extractionData = $('Evaluate Extraction Quality').first().json;\\nconst extractedText = extractionData.extractedText || '';\\nconst extractionMethod = extractionData.extractionMethod || 'digital_pre_chunk';\\nconst textLength = extractionData.textLength || 0;\\n\\n// Build complete Chunk 2 input\\nreturn [{\\n  json: {\\n    fileId: driveUpload.id,\\n    fileName: driveUpload.name,\\n    mimeType: driveUpload.mimeType,\\n    extension: extension,\\n    size: fileSizeBytes,\\n    emailId: emailData.id,\\n    emailFrom: emailFrom,\\n    emailSubject: emailData.subject,\\n    emailDate: emailData.date,\\n    stagingPath: stagingPath,\\n    originalFileName: attachment.fileName,\\n    extractedFromZip: false,\\n    zipFileName: null,\\n    client_name: clientData.client_name_raw,\\n    client_normalized: clientData.client_name,\\n    \\n    // ‚úÖ NEW: Pass extracted text to Chunk 2 (skip re-download)\\n    extractedText: extractedText,\\n    extractionMethod: extractionMethod,\\n    textLength: textLength,\\n    skipDownload: textLength > 100  // Skip download if we have meaningful text\\n  }\\n}];\"\n        },\n        \"id\": \"prepare-chunk2-new-001\",\n        \"name\": \"Prepare for Chunk 2 (NEW)\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3472,\n          304\n        ],\n        \"notes\": \"Enriches Google Drive data with email metadata for Chunk 2\"\n      },\n      {\n        \"parameters\": {\n          \"workflowId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"qKyqsL64ReMiKpJ4\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"execute-chunk2-new-001\",\n        \"name\": \"Execute Chunk 2 (NEW)\",\n        \"type\": \"n8n-nodes-base.executeWorkflow\",\n        \"typeVersion\": 1.3,\n        \"position\": [\n          3696,\n          304\n        ],\n        \"notes\": \"Executes Chunk 2 text extraction workflow\"\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"markAsRead\",\n          \"messageId\": \"={{ $('Gmail Trigger - Unread with Attachments').first().json.id }}\"\n        },\n        \"id\": \"mark-read-new-001\",\n        \"name\": \"Mark Email as Read (NEW)\",\n        \"type\": \"n8n-nodes-base.gmail\",\n        \"typeVersion\": 2.1,\n        \"position\": [\n          3920,\n          304\n        ],\n        \"webhookId\": \"9967ebd9-7776-4d6d-a993-a3c7353a8c26\",\n        \"credentials\": {\n          \"gmailOAuth2\": {\n            \"id\": \"aYzk7sZF8ZVyfOan\",\n            \"name\": \"Gmail account\"\n          }\n        },\n        \"notes\": \"Marks the processed email as read\"\n      },\n      {\n        \"parameters\": {},\n        \"id\": \"noop-new-complete-001\",\n        \"name\": \"NoOp - NEW Complete\",\n        \"type\": \"n8n-nodes-base.noOp\",\n        \"typeVersion\": 1,\n        \"position\": [\n          4144,\n          304\n        ]\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Get Google Drive upload result from previous node\\nconst driveUpload = $input.first().json;\\n\\n// Retrieve email metadata from Gmail Trigger\\nconst emailData = $('Gmail Trigger - Unread with Attachments').first().json;\\n\\n// Retrieve binary metadata from Gmail Trigger\\nconst binaryData = $('Gmail Trigger - Unread with Attachments').first().binary;\\n\\n// Get first attachment key\\nconst attachmentKeys = Object.keys(binaryData);\\nconst attachmentKey = attachmentKeys[0];\\nconst attachment = binaryData[attachmentKey];\\n\\n// Extract file extension from filename\\nconst fileName = driveUpload.name;\\nconst extension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();\\n\\n// Get client data from Normalize Client Name node\\nconst clientData = $('Normalize Client Name').first().json;\\nconst clientName = clientData.client_name || 'unknown';\\n\\n// Construct stagingPath\\nconst stagingPath = `${clientName}/_Staging/${fileName}`;\\n\\n// Parse file size\\nlet fileSizeBytes = 0;\\nif (attachment.fileSize) {\\n  const sizeStr = attachment.fileSize;\\n  const match = sizeStr.match(/^([\\\\d.]+)\\\\s*(KB|MB|GB)$/i);\\n  if (match) {\\n    const value = parseFloat(match[1]);\\n    const unit = match[2].toUpperCase();\\n    const multipliers = { KB: 1024, MB: 1024 * 1024, GB: 1024 * 1024 * 1024 };\\n    fileSizeBytes = Math.round(value * multipliers[unit]);\\n  }\\n}\\n\\n// Extract email sender\\nlet emailFrom = '';\\nif (emailData.from && emailData.from.value && emailData.from.value[0]) {\\n  emailFrom = emailData.from.value[0].address;\\n}\\n\\n// ‚úÖ NEW: Get extracted text from Evaluate Extraction Quality node\\nconst extractionData = $('Evaluate Extraction Quality').first().json;\\nconst extractedText = extractionData.extractedText || '';\\nconst extractionMethod = extractionData.extractionMethod || 'digital_pre_chunk';\\nconst textLength = extractionData.textLength || 0;\\n\\n// Build complete Chunk 2 input\\nreturn [{\\n  json: {\\n    fileId: driveUpload.id,\\n    fileName: driveUpload.name,\\n    mimeType: driveUpload.mimeType,\\n    extension: extension,\\n    size: fileSizeBytes,\\n    emailId: emailData.id,\\n    emailFrom: emailFrom,\\n    emailSubject: emailData.subject,\\n    emailDate: emailData.date,\\n    stagingPath: stagingPath,\\n    originalFileName: attachment.fileName,\\n    extractedFromZip: false,\\n    zipFileName: null,\\n    client_name: clientData.client_name_raw,\\n    client_normalized: clientData.client_name,\\n    \\n    // ‚úÖ NEW: Pass extracted text to Chunk 2 (skip re-download)\\n    extractedText: extractedText,\\n    extractionMethod: extractionMethod,\\n    textLength: textLength,\\n    skipDownload: textLength > 100  // Skip download if we have meaningful text\\n  }\\n}];\"\n        },\n        \"id\": \"prepare-chunk2-existing-001\",\n        \"name\": \"Prepare for Chunk 2 (EXISTING)\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          3696,\n          496\n        ],\n        \"notes\": \"Enriches Google Drive data with email metadata for Chunk 2\"\n      },\n      {\n        \"parameters\": {\n          \"workflowId\": {\n            \"__rl\": true,\n            \"mode\": \"id\",\n            \"value\": \"qKyqsL64ReMiKpJ4\"\n          },\n          \"options\": {}\n        },\n        \"id\": \"execute-chunk2-existing-001\",\n        \"name\": \"Execute Chunk 2 (EXISTING)\",\n        \"type\": \"n8n-nodes-base.executeWorkflow\",\n        \"typeVersion\": 1.3,\n        \"position\": [\n          3920,\n          496\n        ],\n        \"notes\": \"Executes Chunk 2 text extraction workflow\"\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"markAsRead\",\n          \"messageId\": \"={{ $('Gmail Trigger - Unread with Attachments').first().json.id }}\"\n        },\n        \"id\": \"mark-read-existing-001\",\n        \"name\": \"Mark Email as Read (EXISTING)\",\n        \"type\": \"n8n-nodes-base.gmail\",\n        \"typeVersion\": 2.1,\n        \"position\": [\n          4144,\n          496\n        ],\n        \"webhookId\": \"64c1fe12-1ad8-47a2-b59a-502812a88c50\",\n        \"credentials\": {\n          \"gmailOAuth2\": {\n            \"id\": \"aYzk7sZF8ZVyfOan\",\n            \"name\": \"Gmail account\"\n          }\n        },\n        \"notes\": \"Marks the processed email as read\"\n      },\n      {\n        \"parameters\": {},\n        \"id\": \"noop-existing-complete-001\",\n        \"name\": \"NoOp - EXISTING Complete\",\n        \"type\": \"n8n-nodes-base.noOp\",\n        \"typeVersion\": 1,\n        \"position\": [\n          4368,\n          496\n        ]\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"move\",\n          \"fileId\": {\n            \"__rl\": true,\n            \"value\": \"={{ $json.file_id }}\",\n            \"mode\": \"id\"\n          },\n          \"driveId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"My Drive\"\n          },\n          \"folderId\": {\n            \"__rl\": true,\n            \"value\": \"={{ $json.Staging_Folder_ID }}\",\n            \"mode\": \"id\"\n          }\n        },\n        \"id\": \"b767c01a-345c-4a94-ba35-35f8dda0fb2c\",\n        \"name\": \"Move PDF to _Staging (NEW)\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          3248,\n          304\n        ],\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"operation\": \"move\",\n          \"fileId\": {\n            \"__rl\": true,\n            \"value\": \"={{ $json.file_id }}\",\n            \"mode\": \"id\"\n          },\n          \"driveId\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"My Drive\"\n          },\n          \"folderId\": {\n            \"__rl\": true,\n            \"value\": \"={{ $json.Staging_Folder_ID }}\",\n            \"mode\": \"id\"\n          }\n        },\n        \"id\": \"90cc99fd-908d-4149-a2f7-35f42ab2e232\",\n        \"name\": \"Move PDF to _Staging (EXISTING)\",\n        \"type\": \"n8n-nodes-base.googleDrive\",\n        \"typeVersion\": 3,\n        \"position\": [\n          3472,\n          496\n        ],\n        \"alwaysOutputData\": true,\n        \"credentials\": {\n          \"googleDriveOAuth2Api\": {\n            \"id\": \"a4m50EefR3DJoU0R\",\n            \"name\": \"Google Drive account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"workflowId\": {\n            \"__rl\": true,\n            \"value\": \"zbxHkXOoD1qaz6OS\",\n            \"mode\": \"list\",\n            \"cachedResultUrl\": \"/workflow/zbxHkXOoD1qaz6OS\",\n            \"cachedResultName\": \"AMA Chunk 0: Folder Initialization (V4 - Parameterized)\"\n          },\n          \"workflowInputs\": {\n            \"mappingMode\": \"defineBelow\",\n            \"value\": {\n              \"client_name\": \"={{ $json.client_name_raw }}\",\n              \"client_normalized\": \"={{ $json.client_name }}\",\n              \"parent_folder_id\": \"={{ $('Check Client Exists').item.json.parent_folder_id }}\"\n            },\n            \"matchingColumns\": [],\n            \"schema\": [\n              {\n                \"id\": \"client_name\",\n                \"displayName\": \"client_name\",\n                \"required\": false,\n                \"defaultMatch\": false,\n                \"display\": true,\n                \"canBeUsedToMatch\": true,\n                \"type\": \"string\"\n              },\n              {\n                \"id\": \"client_normalized\",\n                \"displayName\": \"client_normalized\",\n                \"required\": false,\n                \"defaultMatch\": false,\n                \"display\": true,\n                \"canBeUsedToMatch\": true,\n                \"type\": \"string\"\n              },\n              {\n                \"id\": \"parent_folder_id\",\n                \"displayName\": \"parent_folder_id\",\n                \"required\": false,\n                \"defaultMatch\": false,\n                \"display\": true,\n                \"canBeUsedToMatch\": true,\n                \"type\": \"string\"\n              }\n            ],\n            \"attemptToConvertTypes\": false,\n            \"convertFieldsToString\": true\n          },\n          \"options\": {}\n        },\n        \"id\": \"bc9b052a-1fdf-412c-990a-7c3e58178304\",\n        \"name\": \"Execute Chunk 0 - Create Folders (UNKNOWN)\",\n        \"type\": \"n8n-nodes-base.executeWorkflow\",\n        \"typeVersion\": 1.3,\n        \"position\": [\n          3248,\n          112\n        ]\n      },\n      {\n        \"parameters\": {\n          \"workflowId\": {\n            \"__rl\": true,\n            \"value\": \"zbxHkXOoD1qaz6OS\",\n            \"mode\": \"list\",\n            \"cachedResultUrl\": \"/workflow/zbxHkXOoD1qaz6OS\",\n            \"cachedResultName\": \"AMA Chunk 0: Folder Initialization (V4 - Parameterized)\"\n          },\n          \"workflowInputs\": {\n            \"mappingMode\": \"defineBelow\",\n            \"value\": {\n              \"client_name\": \"={{ $json.client_name_raw }}\",\n              \"client_normalized\": \"={{ $json.client_name }}\",\n              \"parent_folder_id\": \"={{ $('Check Client Exists').item.json.parent_folder_id }}\"\n            },\n            \"matchingColumns\": [],\n            \"schema\": [\n              {\n                \"id\": \"client_name\",\n                \"displayName\": \"client_name\",\n                \"required\": false,\n                \"defaultMatch\": false,\n                \"display\": true,\n                \"canBeUsedToMatch\": true,\n                \"type\": \"string\"\n              },\n              {\n                \"id\": \"client_normalized\",\n                \"displayName\": \"client_normalized\",\n                \"required\": false,\n                \"defaultMatch\": false,\n                \"display\": true,\n                \"canBeUsedToMatch\": true,\n                \"type\": \"string\"\n              },\n              {\n                \"id\": \"parent_folder_id\",\n                \"displayName\": \"parent_folder_id\",\n                \"required\": false,\n                \"defaultMatch\": false,\n                \"display\": true,\n                \"canBeUsedToMatch\": true,\n                \"type\": \"string\"\n              }\n            ],\n            \"attemptToConvertTypes\": false,\n            \"convertFieldsToString\": true\n          },\n          \"options\": {}\n        },\n        \"id\": \"execute-chunk0-001\",\n        \"name\": \"Execute Chunk 0 - Create Folders (NEW)\",\n        \"type\": \"n8n-nodes-base.executeWorkflow\",\n        \"typeVersion\": 1.3,\n        \"position\": [\n          2800,\n          304\n        ]\n      },\n      {\n        \"parameters\": {\n          \"amount\": 3\n        },\n        \"id\": \"wait-staging-existing-001\",\n        \"name\": \"Wait After Staging (EXISTING)\",\n        \"type\": \"n8n-nodes-base.wait\",\n        \"typeVersion\": 1.1,\n        \"position\": [\n          3584,\n          496\n        ],\n        \"executeOnce\": false,\n        \"alwaysOutputData\": true,\n        \"webhookId\": \"6d74a0e2-74ef-411a-83f9-c98a972b25df\"\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"const crypto = require('crypto');\\n\\n// Google Service Account credentials\\nconst serviceAccount = {\\n  projectId: 'n8n-integrations-482020',\\n  clientEmail: 'n8n-document-ai@n8n-integrations-482020.iam.gserviceaccount.com',\\n  privateKey: `-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCwWo8CBWPs5tvS\\nP01jLTf6Rc54JrOCEU1KIOpkZryrT082kD/eXx73unpLGUCb9t5u9kjCjiU8BPMp\\nqnPQSCVzeuMNWLYcyQfGIUFRfCSi/7bg5q1mwv+DkLsgNWx0mRAk5pfPCv9qW9qk\\n+XyNYtqk3FlgWBRtynwd49cCN1FoaRgTQTv6KsRtqV7nc6MyE+VyyhMY64uoQfCN\\nd+PrXkE20yDaNg/yZU/re3/2kqeWVt3F5nxZFbuM2wBof0wLQcqkZ/ggN9/C/zdp\\nBpTnZlTadNzjPePKGBaMHyDP01/E4xUU9d9TJMM4OWc5ReFIMlSdYnzjhuir1+5A\\no2JmvpmRAgMBAAECggEADZAkGC4H8wwHnfzmW8P6M9Jd6xm24UBUEb5u/c0fojaV\\noLGpZ9XS+48o9qZONMXgx5HuI0sWtq3+xuvoFP280PaDiImTv/+qDGU5sSWmFQSB\\nBn0B8GRQ4x0kzHkEtVb29I+TigXjgkTm5PHserHpSkKe0Re/wniPNnvzvk+OKu8W\\nvnSleUP8NamyIxoMRZNWYdUI/yJvU6o2nuxZKe6aVvaF2T3eQ/3pYucvfgsV7L1i\\nkle6T//NjEmrpeFtZEAgrnAAWLso7R+pbN08zc3Jbxb5Q1E6WABlTi6gbI9tmwuu\\n53pe1GY4AGNpfGUiIO/UX/R+9/DSYCMrQMhqTdD8fQKBgQDptBqfAmcDgC9hFkSA\\nopIxslCCsQ56eXTyZ0BL+qQiFyhQFmV3Do4vVLatJvZiUIWonNYxZYfxEMP06dW+\\nk/Bu4NAoSc46wlvY1Bj9xOn7s/afNlY4J0YKrSpIuqQZHyhjERvK7Nn1UHDZ92qJ\\nFXvaNJ0uUUYry5xuYrbwrfECKwKBgQDBLcNJsXKVYmaMh/xkucAKeeOWy/ME2kZz\\noyEFcmgQhKU0Sr7C0OdLE3JnlL+9oz0ashBPb06Y0vsqDzl+0iwU81oc1RD/wBZz\\nBgV2NB0jYvsIHFkI4BY5p4fePF5Q97UCaGttBf3JL1fFFeif/r1Rq2FbAnnpXsqF\\npHrOFKsBMwKBgQC6CmjiyhvNWp7c78gKiuBMdYHH+EDpWISzb2Rs15MPnFW4I4wU\\nUd74aLyfbJPYwfcUuf19BzFHwyvrbLZ95vEQoyCx4cctWYmaO4XFhpsphyK9rZjH\\nTORiHWW6zfFSGk6hRn5UdWYw9h9QNLh3dkXI9/dkZsiwln7qFOVDBYUFTwKBgC7r\\nnJlTnk8mXV4Y0XbtnvVscZj45IfzNFV189lM1nXcofu3g+nxr5wOlyUNfhzjfz3y\\nrf99O4vnAtZOaFqjVc2o5eRG5CAaWdmKRt1U/xbPPcXUjNOZCgzq4hdadlYYNEDn\\nd+A9Kk0pUJowHhZuWzFw/O6MBWxnd61KLAHOB1L9AoGARwyJIEwHeUeoAuCRlQyS\\nxYzI8eMIDJ7HSiaFms+j8cuNy76O9U5E0KVBz6BEeTfq+aym0vyZ6iKJ3+q/IXQ4\\no5jc6G6zgrMAgeuKzKFEwKNK/tm5j3FiDEzcUqLI00AfdG/f+QI/dTxbqnlB1tPn\\nT0v0rf9bjMnUWoH9kXFM+XA=\\n-----END PRIVATE KEY-----`\\n};\\n\\n// Step 1: Create JWT token\\nconst now = Math.floor(Date.now() / 1000);\\nconst jwtHeader = {\\n  alg: 'RS256',\\n  typ: 'JWT'\\n};\\n\\nconst jwtClaims = {\\n  iss: serviceAccount.clientEmail,\\n  scope: 'https://www.googleapis.com/auth/cloud-platform',\\n  aud: 'https://oauth2.googleapis.com/token',\\n  exp: now + 3600,\\n  iat: now\\n};\\n\\n// Encode header and claims\\nconst base64UrlEncode = (str) => {\\n  return Buffer.from(str)\\n    .toString('base64')\\n    .replace(/\\\\+/g, '-')\\n    .replace(/\\\\//g, '_')\\n    .replace(/=/g, '');\\n};\\n\\nconst encodedHeader = base64UrlEncode(JSON.stringify(jwtHeader));\\nconst encodedClaims = base64UrlEncode(JSON.stringify(jwtClaims));\\nconst signatureInput = `${encodedHeader}.${encodedClaims}`;\\n\\n// Sign with private key using crypto module\\nconst sign = crypto.createSign('RSA-SHA256');\\nsign.update(signatureInput);\\nconst signature = sign.sign(serviceAccount.privateKey, 'base64')\\n  .replace(/\\\\+/g, '-')\\n  .replace(/\\\\//g, '_')\\n  .replace(/=/g, '');\\n\\nconst jwt = `${signatureInput}.${signature}`;\\n\\n// Step 2: Exchange JWT for access token\\nconst tokenResponse = await this.helpers.httpRequest({\\n  method: 'POST',\\n  url: 'https://oauth2.googleapis.com/token',\\n  headers: {\\n    'Content-Type': 'application/x-www-form-urlencoded'\\n  },\\n  body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`\\n});\\n\\nconst accessToken = tokenResponse.access_token;\\n\\n// Step 3: Get PDF binary and convert to base64\\nconst item = $input.first();\\nconst binaryKey = Object.keys(item.binary)[0];\\nconst buffer = await this.helpers.getBinaryDataBuffer(0, binaryKey);\\nconst base64Content = buffer.toString('base64');\\n\\n// Step 4: Prepare Document AI request body\\nconst documentAiRequest = {\\n  rawDocument: {\\n    content: base64Content,\\n    mimeType: 'application/pdf'\\n  }\\n};\\n\\n// Return access token, request body, and original data\\nreturn {\\n  json: {\\n    ...item.json,\\n    accessToken: accessToken,\\n    documentAiRequest: documentAiRequest\\n  },\\n  binary: item.binary\\n};\"\n        },\n        \"id\": \"prepare-docai-request-001\",\n        \"name\": \"Prepare Document AI Request\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          1232,\n          464\n        ]\n      },\n      {\n        \"parameters\": {\n          \"method\": \"POST\",\n          \"url\": \"https://eu-documentai.googleapis.com/v1/projects/504943079120/locations/eu/processors/954baa10f2e87364:process\",\n          \"sendHeaders\": true,\n          \"headerParameters\": {\n            \"parameters\": [\n              {\n                \"name\": \"Authorization\",\n                \"value\": \"=Bearer {{ $json.accessToken }}\"\n              },\n              {\n                \"name\": \"Content-Type\",\n                \"value\": \"application/json\"\n              }\n            ]\n          },\n          \"sendBody\": true,\n          \"specifyBody\": \"json\",\n          \"jsonBody\": \"={{ JSON.stringify($json.documentAiRequest) }}\",\n          \"options\": {}\n        },\n        \"id\": \"call-docai-ocr-001\",\n        \"name\": \"Call Document AI OCR\",\n        \"type\": \"n8n-nodes-base.httpRequest\",\n        \"typeVersion\": 4.3,\n        \"position\": [\n          1456,\n          464\n        ],\n        \"notes\": \"Google Document AI OCR\\n\\nProcessor: 954baa10f2e87364\\nRegion: eu\\nProject: n8n-integrations-482020\"\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Parse Google Document AI response\\nconst item = $input.first();\\nconst docAiResponse = item.json;\\n\\nlet extractedText = '';\\nlet pageCount = 0;\\n\\n// Extract text from Document AI response\\nif (docAiResponse.document && docAiResponse.document.text) {\\n  extractedText = docAiResponse.document.text;\\n  pageCount = docAiResponse.document.pages ? docAiResponse.document.pages.length : 0;\\n}\\n\\n// Get original data from upstream node (Download PDF from Drive)\\nconst originalData = $('Download PDF from Drive').first().json;\\n\\nreturn {\\n  json: {\\n    ...originalData,\\n    extractedText: extractedText.trim(),\\n    ocrSuccess: extractedText.length > 0,\\n    ocrEngine: 'Google Document AI',\\n    pageCount: pageCount\\n  },\\n  binary: item.binary\\n};\"\n        },\n        \"id\": \"parse-docai-response-001\",\n        \"name\": \"Parse Document AI Response\",\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          1680,\n          464\n        ]\n      }\n    ],\n    \"connections\": {\n      \"Gmail Trigger - Unread with Attachments\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Filter PDF/ZIP Attachments\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Filter PDF/ZIP Attachments\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Upload PDF to Temp Folder\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Upload PDF to Temp Folder\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Extract File ID & Metadata\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Extract File ID & Metadata\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Download PDF from Drive\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Download PDF from Drive\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare Document AI Request\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Extract Text from PDF\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Evaluate Extraction Quality\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Evaluate Extraction Quality\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"AI Extract Client Name\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"AI Extract Client Name\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Normalize Client Name\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Normalize Client Name\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Lookup Client Registry\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Lookup Client Registry\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Check Client Exists\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Check Client Exists\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Decision Gate\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Decision Gate\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Handle Unidentified Client\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ],\n          [\n            {\n              \"node\": \"Execute Chunk 0 - Create Folders (NEW)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ],\n          [\n            {\n              \"node\": \"Lookup Staging Folder\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare UNKNOWN Client Data\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Execute Chunk 0 - Create Folders (UNKNOWN)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Lookup Staging Folder\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Filter Staging Folder ID\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Filter Staging Folder ID\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Check Routing Decision\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Extract 38_Unknowns Folder ID\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Validate Folder IDs\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Validate Folder IDs\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Move PDF to 38_Unknowns\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Move PDF to 38_Unknowns\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare Email Notification Data\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare Email Notification Data\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Build Email HTML Body\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Build Email HTML Body\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Send Email Notification\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Handle Unidentified Client\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare UNKNOWN Client Data\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Check Routing Decision\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare Missing Folder Error\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ],\n          [\n            {\n              \"node\": \"Move PDF to _Staging (EXISTING)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare Missing Folder Error\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare Registry Error Email Data\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare Registry Error Email Data\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Send Registry Error Email\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Send Registry Error Email\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Move to 38_Unknowns (Registry Error)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Move to 38_Unknowns (Registry Error)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Mark Email as Read (Registry Error)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Mark Email as Read (Registry Error)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"NoOp - Registry Error Complete\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Merge Chunk 0 Output (NEW)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Move PDF to _Staging (NEW)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare for Chunk 2 (NEW)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Execute Chunk 2 (NEW)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Execute Chunk 2 (NEW)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Mark Email as Read (NEW)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Mark Email as Read (NEW)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"NoOp - NEW Complete\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare for Chunk 2 (EXISTING)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Execute Chunk 2 (EXISTING)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Execute Chunk 2 (EXISTING)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Mark Email as Read (EXISTING)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Mark Email as Read (EXISTING)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"NoOp - EXISTING Complete\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Move PDF to _Staging (NEW)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare for Chunk 2 (NEW)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Execute Chunk 0 - Create Folders (UNKNOWN)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Extract 38_Unknowns Folder ID\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Execute Chunk 0 - Create Folders (NEW)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Merge Chunk 0 Output (NEW)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Move PDF to _Staging (EXISTING)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Wait After Staging (EXISTING)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Wait After Staging (EXISTING)\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare for Chunk 2 (EXISTING)\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare Document AI Request\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Call Document AI OCR\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Call Document AI OCR\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Parse Document AI Response\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Parse Document AI Response\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Evaluate Extraction Quality\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      }\n    },\n    \"settings\": {\n      \"executionOrder\": \"v1\",\n      \"callerPolicy\": \"workflowsFromSameOwner\",\n      \"availableInMCP\": false\n    },\n    \"staticData\": {\n      \"node:Gmail Trigger - Unread with Attachments\": {\n        \"Gmail Trigger - Unread with Attachments\": {\n          \"lastTimeChecked\": 1768604515,\n          \"possibleDuplicates\": [\n            \"19bc90b48fc17a7c\",\n            \"19bc90955c9b4263\"\n          ]\n        }\n      }\n    },\n    \"meta\": {\n      \"templateCredsSetupCompleted\": true\n    },\n    \"pinData\": {},\n    \"versionId\": \"d513e84d-0121-4a86-8d9a-2d8fec28ba91\",\n    \"activeVersionId\": \"d513e84d-0121-4a86-8d9a-2d8fec28ba91\",\n    \"versionCounter\": 488,\n    \"triggerCount\": 1,\n    \"shared\": [\n      {\n        \"updatedAt\": \"2026-01-07T09:49:33.855Z\",\n        \"createdAt\": \"2026-01-07T09:49:33.855Z\",\n        \"role\": \"workflow:owner\",\n        \"workflowId\": \"YGXWjWcBIk66ArvT\",\n        \"projectId\": \"Rs8mhw052fnrzWZM\",\n        \"project\": {\n          \"updatedAt\": \"2025-12-31T15:54:29.115Z\",\n          \"createdAt\": \"2025-12-31T15:27:33.865Z\",\n          \"id\": \"Rs8mhw052fnrzWZM\",\n          \"name\": \"Sway Clarke <sway@oloxa.ai>\",\n          \"type\": \"personal\",\n          \"icon\": null,\n          \"description\": null,\n          \"creatorId\": \"e9bd9112-c2e3-4f67-873a-e1001baeafd8\",\n          \"projectRelations\": [\n            {\n              \"updatedAt\": \"2025-12-31T15:27:33.865Z\",\n              \"createdAt\": \"2025-12-31T15:27:33.865Z\",\n              \"userId\": \"e9bd9112-c2e3-4f67-873a-e1001baeafd8\",\n              \"projectId\": \"Rs8mhw052fnrzWZM\",\n              \"user\": {\n                \"updatedAt\": \"2026-01-17T09:34:36.055Z\",\n                \"createdAt\": \"2025-12-31T15:27:33.119Z\",\n                \"id\": \"e9bd9112-c2e3-4f67-873a-e1001baeafd8\",\n                \"email\": \"sway@oloxa.ai\",\n                \"firstName\": \"Sway\",\n                \"lastName\": \"Clarke\",\n                \"personalizationAnswers\": {\n                  \"version\": \"v4\",\n                  \"personalization_survey_submitted_at\": \"2025-12-31T15:54:37.562Z\",\n                  \"personalization_survey_n8n_version\": \"2.1.4\"\n                },\n                \"settings\": {\n                  \"userActivated\": true,\n                  \"easyAIWorkflowOnboarded\": true,\n                  \"firstSuccessfulWorkflowId\": \"zbxHkXOoD1qaz6OS\",\n                  \"userActivatedAt\": 1767398053308,\n                  \"npsSurvey\": {\n                    \"responded\": true,\n                    \"lastShownAt\": 1767684846804\n                  }\n                },\n                \"disabled\": false,\n                \"mfaEnabled\": false,\n                \"lastActiveAt\": \"2026-01-16\",\n                \"isPending\": false\n              }\n            }\n          ]\n        }\n      }\n    ],\n    \"tags\": [],\n    \"activeVersion\": {\n      \"updatedAt\": \"2026-01-17T10:30:05.994Z\",\n      \"createdAt\": \"2026-01-17T10:30:05.994Z\",\n      \"versionId\": \"d513e84d-0121-4a86-8d9a-2d8fec28ba91\",\n      \"workflowId\": \"YGXWjWcBIk66ArvT\",\n      \"nodes\": [\n        {\n          \"parameters\": {\n            \"pollTimes\": {\n              \"item\": [\n                {\n                  \"mode\": \"everyMinute\"\n                }\n              ]\n            },\n            \"simple\": false,\n            \"filters\": {\n              \"labelIds\": [\n                \"INBOX\",\n                \"UNREAD\",\n                \"Label_8011160688574026773\"\n              ],\n              \"q\": \"has:attachment\"\n            },\n            \"options\": {\n              \"dataPropertyAttachmentsPrefixName\": \"attachment_\",\n              \"downloadAttachments\": true\n            }\n          },\n          \"id\": \"gmail-trigger-001\",\n          \"name\": \"Gmail Trigger - Unread with Attachments\",\n          \"type\": \"n8n-nodes-base.gmailTrigger\",\n          \"typeVersion\": 1.3,\n          \"position\": [\n            112,\n            304\n          ],\n          \"credentials\": {\n            \"gmailOAuth2\": {\n              \"id\": \"aYzk7sZF8ZVyfOan\",\n              \"name\": \"Gmail account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Filter PDF and ZIP attachments only\\nconst items = $input.all();\\nconst filtered = [];\\n\\nfor (const item of items) {\\n  // Gmail trigger stores attachments in item.binary, not item.json.attachments\\n  if (!item.binary) continue;\\n  \\n  // Iterate over binary keys (attachment_0, attachment_1, etc.)\\n  for (const [key, attachment] of Object.entries(item.binary)) {\\n    const filename = attachment.fileName;\\n    if (!filename) continue;\\n    \\n    const ext = filename.toLowerCase().split('.').pop();\\n    \\n    if (['pdf', 'zip'].includes(ext)) {\\n      filtered.push({\\n        json: {\\n          emailId: item.json.id,\\n          emailSubject: item.json.Subject || item.json.subject,\\n          emailFrom: item.json.From || item.json.from,\\n          emailDate: item.json.date,\\n          attachmentKey: key,\\n          filename: filename,\\n          mimeType: attachment.mimeType,\\n          size: attachment.fileSize\\n        },\\n        binary: {\\n          data: attachment\\n        }\\n      });\\n    }\\n  }\\n}\\n\\nreturn filtered;\"\n          },\n          \"id\": \"filter-attachments-001\",\n          \"name\": \"Filter PDF/ZIP Attachments\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            336,\n            304\n          ]\n        },\n        {\n          \"parameters\": {\n            \"driveId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"My Drive\"\n            },\n            \"folderId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"root\",\n              \"cachedResultName\": \"/ (Root folder)\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"upload-pdf-gdrive-001\",\n          \"name\": \"Upload PDF to Temp Folder\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            560,\n            304\n          ],\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Extract Google Drive file ID from upload response and preserve email metadata\\nconst uploadResult = $input.first().json;\\nconst emailData = $('Filter PDF/ZIP Attachments').first().json;\\n\\nreturn [{\\n  json: {\\n    file_id: uploadResult.id,\\n    filename: uploadResult.name,\\n    emailId: emailData.emailId,\\n    emailSubject: emailData.emailSubject,\\n    emailFrom: emailData.emailFrom,\\n    emailDate: emailData.emailDate\\n  }\\n}];\"\n          },\n          \"id\": \"extract-file-id-001\",\n          \"name\": \"Extract File ID & Metadata\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            784,\n            304\n          ]\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"download\",\n            \"fileId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"={{ $json.file_id }}\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"download-pdf-from-gdrive-001\",\n          \"name\": \"Download PDF from Drive\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            1008,\n            304\n          ],\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"pdf\",\n            \"options\": {\n              \"joinPages\": true,\n              \"keepSource\": \"json\"\n            }\n          },\n          \"id\": \"extract-text-001\",\n          \"name\": \"Extract Text from PDF\",\n          \"type\": \"n8n-nodes-base.extractFromFile\",\n          \"typeVersion\": 1.1,\n          \"position\": [\n            1232,\n            160\n          ],\n          \"disabled\": true,\n          \"notes\": \"‚ö†Ô∏è OLD METHOD - Disabled. Use 'Prepare Document AI Request' path instead for proper OCR.\"\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// V4: Evaluate extraction quality for each PDF\\nconst items = $input.all();\\nconst results = [];\\n\\nfor (const item of items) {\\n  // FIX: Check both extractedText (from OCR) and text (from digital extraction)\\n  const extractedText = item.json.extractedText || item.json.text || '';\\n  const wordCount = extractedText.trim().split(/\\\\s+/).length;\\n\\n  results.push({\\n    json: {\\n      ...item.json,\\n      wordCount: wordCount,\\n      needsOCR: wordCount < 10,\\n      extractionQuality: wordCount < 10 ? 'poor' : 'good',\\n      \\n      // Keep extracted text for downstream use\\n      extractedText: extractedText,\\n      textLength: extractedText.trim().length,\\n      extractionMethod: 'digital_pre_chunk'\\n    },\\n    binary: item.binary\\n  });\\n}\\n\\nreturn results;\"\n          },\n          \"id\": \"evaluate-extraction-001\",\n          \"name\": \"Evaluate Extraction Quality\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            1456,\n            304\n          ]\n        },\n        {\n          \"parameters\": {\n            \"resource\": \"chat\",\n            \"chatModel\": \"gpt-4.1-mini\",\n            \"prompt\": {\n              \"messages\": [\n                {\n                  \"role\": \"system\",\n                  \"content\": \"Extract the PROJECT or PROPERTY IDENTIFIER from this German real estate document.\\n\\nValid identifiers (in order of priority):\\n\\n1. STREET ADDRESS + CITY (MOST COMMON IN THESE DOCUMENTS):\\n   - \\\"Schlo√übergstra√üe 13, T√ºbingen\\\" ‚Üí \\\"Schlossberg 13\\\"\\n   - \\\"Schlo√übergstr. 13\\\" ‚Üí \\\"Schlossberg 13\\\"\\n   - Normalize: Remove \\\"stra√üe/str.\\\", keep number\\n\\n2. PROJECT CODES/ABBREVIATIONS:\\n   - \\\"BV Propos\\\" ‚Üí \\\"Propos\\\"\\n   - \\\"Projekt Schlo√überg\\\" ‚Üí \\\"Schlossberg\\\"\\n\\n3. PROPERTY/VILLA NAMES\\n\\n4. COMPANY NAMES (if property-related)\\n\\n5. PERSON/RECIPIENT NAMES (last resort)\\n\\nEXTRACTION RULES:\\n- Look for street addresses FIRST\\n- \\\"Schlo√überg\\\" and \\\"Schlossberg\\\" are the same (normalize to \\\"Schlossberg\\\")\\n- Combine street name + number: \\\"Schlo√übergstra√üe 13\\\" ‚Üí \\\"Schlossberg 13\\\"\\n\\nReturn ONLY the normalized identifier, nothing else.\\nIf no identifiable project/property exists, return exactly: UNKNOWN\"\n                },\n                {\n                  \"content\": \"={{ $json.extractedText }}\"\n                }\n              ]\n            },\n            \"options\": {},\n            \"requestOptions\": {}\n          },\n          \"id\": \"ai-extract-client-001\",\n          \"name\": \"AI Extract Client Name\",\n          \"type\": \"n8n-nodes-base.openAi\",\n          \"typeVersion\": 1.1,\n          \"position\": [\n            1680,\n            304\n          ],\n          \"credentials\": {\n            \"openAiApi\": {\n              \"id\": \"xmJ7t6kaKgMwA1ce\",\n              \"name\": \"OpenAi account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Get all input items\\nconst items = $input.all();\\nconst results = [];\\n\\n// Process each item\\nfor (const item of items) {\\n  let clientNameRaw = '';\\n  \\n  // Extract AI response from OpenAI node output\\n  // Chat API (unsimplified): choices[0].message.content\\n  if (item.json && item.json.choices && item.json.choices[0] && item.json.choices[0].message) {\\n    clientNameRaw = String(item.json.choices[0].message.content);\\n  }\\n  // Chat API (simplified): message.content\\n  else if (item.json && item.json.message && item.json.message.content) {\\n    clientNameRaw = String(item.json.message.content);\\n  }\\n  // Text API (simplified): text\\n  else if (item.json && item.json.text) {\\n    clientNameRaw = String(item.json.text);\\n  }\\n  \\n  clientNameRaw = clientNameRaw.trim();\\n  \\n  // CRITICAL FIX: Remove duplicate responses from Chat API\\n  // Chat API sometimes returns \\\"Villa Martens\\\\n\\\\nVilla Martens\\\"\\n  // Split by double newline and take first occurrence\\n  if (clientNameRaw.includes('\\\\n\\\\n')) {\\n    const parts = clientNameRaw.split('\\\\n\\\\n');\\n    // Check if it's a duplicate (same text repeated)\\n    if (parts.length === 2 && parts[0].trim() === parts[1].trim()) {\\n      clientNameRaw = parts[0].trim();\\n    }\\n  }\\n  \\n  // Normalize German client name for folder creation\\n  let clientName = '';\\n  if (clientNameRaw) {\\n    clientName = clientNameRaw\\n      .toLowerCase()\\n      .trim()\\n      .replace(/√§/g, 'ae')\\n      .replace(/√∂/g, 'oe')\\n      .replace(/√º/g, 'ue')\\n      .replace(/√ü/g, 'ss')\\n      .replace(/\\\\s*(gmbh|ag|kg|e\\\\.v\\\\.|mbh|co\\\\.|&\\\\s*co\\\\.?)\\\\s*/gi, '')\\n      .replace(/[^a-z0-9]/g, '_')\\n      .replace(/_+/g, '_')\\n      .replace(/^_|_$/g, '');\\n  }\\n  \\n  results.push({\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: '1ikw3k-EgpVg_h2ySDdqdUFB7-FQyYDFm'\\n    }\\n  });\\n}\\n\\nreturn results;\"\n          },\n          \"id\": \"normalize-name-001\",\n          \"name\": \"Normalize Client Name\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            1904,\n            304\n          ]\n        },\n        {\n          \"parameters\": {\n            \"documentId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI\"\n            },\n            \"sheetName\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": 762792134,\n              \"cachedResultName\": \"Client_Registry\",\n              \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI/edit#gid=762792134\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"lookup-registry-001\",\n          \"name\": \"Lookup Client Registry\",\n          \"type\": \"n8n-nodes-base.googleSheets\",\n          \"typeVersion\": 4.7,\n          \"position\": [\n            2128,\n            304\n          ],\n          \"alwaysOutputData\": true,\n          \"credentials\": {\n            \"googleSheetsOAuth2Api\": {\n              \"id\": \"H7ewI1sOrDYabelt\",\n              \"name\": \"Google Sheets account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// V7: Check if client exists in Client_Registry\\n// CRITICAL FIX V3: Detect literal \\\"UNKNOWN\\\" response from AI\\n\\n// Get normalized client name from Normalize Client Name node (not from $input!)\\nconst normalizeOutput = $('Normalize Client Name').first().json;\\nconst clientName = normalizeOutput.client_name || '';\\nconst clientNameRaw = normalizeOutput.client_name_raw || '';\\nconst parentFolderId = normalizeOutput.parent_folder_id || '';\\n\\n// Get registry rows from $input (Lookup Client Registry output)\\nconst registryRows = $input.all();\\n\\n// ‚úÖ FIRST: Check if AI literally returned \\\"UNKNOWN\\\"\\nif (clientNameRaw.toUpperCase().trim() === 'UNKNOWN') {\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'UNKNOWN',\\n      root_folder_id: null,\\n      staging_folder_id: null,\\n      extraction_failure: true,\\n      extraction_error_message: 'AI returned UNKNOWN'\\n    }\\n  }];\\n}\\n\\n// ‚úÖ SECOND: Detect AI extraction failures (technical + polite refusals)\\nconst extractionFailurePatterns = [\\n  // Technical error messages\\n  'unable_to_extract',\\n  'error_extracting',\\n  'could_not_identify',\\n  'could_not_extract',\\n  'no_client_name',\\n  'extraction_failed',\\n  'cannot_identify',\\n  // Polite AI refusals\\n  'i_m_sorry',\\n  'sorry_but',\\n  'doesn_t_seem',\\n  'does_not_appear',\\n  'no_company_name',\\n  'cannot_find',\\n  'not_able_to'\\n];\\n\\nconst isExtractionFailure = extractionFailurePatterns.some(pattern => \\n  clientName.toLowerCase().includes(pattern)\\n);\\n\\nif (isExtractionFailure) {\\n  // AI failed to extract client name ‚Üí Route to UNKNOWN path\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'UNKNOWN',\\n      root_folder_id: null,\\n      staging_folder_id: null,\\n      extraction_failure: true,\\n      extraction_error_message: clientNameRaw\\n    }\\n  }];\\n}\\n\\n// If registry is empty, client is NEW\\nif (registryRows.length === 0) {\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'NEW',\\n      root_folder_id: null,\\n      staging_folder_id: null\\n    }\\n  }];\\n}\\n\\n// Search registry for matching client (with same normalization)\\nconst clientRow = registryRows.find(row => {\\n  const registryClientName = row.json.Client_Name || '';\\n  const normalizedRegistryName = registryClientName\\n    .toLowerCase()\\n    .trim()\\n    .replace(/√§/g, 'ae')\\n    .replace(/√∂/g, 'oe')\\n    .replace(/√º/g, 'ue')\\n    .replace(/√ü/g, 'ss')\\n    .replace(/\\\\s*(gmbh|ag|kg|e\\\\.v\\\\.|mbh|co\\\\.|&\\\\s*co\\\\.?)\\\\s*/gi, '')\\n    .replace(/[^a-z0-9]/g, '_')\\n    .replace(/_+/g, '_')\\n    .replace(/^_|_$/g, '');\\n  \\n  return normalizedRegistryName === clientName;\\n});\\n\\nif (clientRow) {\\n  // Client exists ‚Üí EXISTING path\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'EXISTING',\\n      root_folder_id: clientRow.json.Root_Folder_ID,\\n      staging_folder_id: clientRow.json.Staging_Folder_ID\\n    }\\n  }];\\n} else {\\n  // Client not in registry ‚Üí NEW path\\n  return [{\\n    json: {\\n      client_name: clientName,\\n      client_name_raw: clientNameRaw,\\n      parent_folder_id: parentFolderId,\\n      client_status: 'NEW',\\n      root_folder_id: null,\\n      staging_folder_id: null\\n    }\\n  }];\\n}\"\n          },\n          \"id\": \"check-exists-001\",\n          \"name\": \"Check Client Exists\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            2352,\n            304\n          ]\n        },\n        {\n          \"parameters\": {\n            \"rules\": {\n              \"values\": [\n                {\n                  \"conditions\": {\n                    \"options\": {\n                      \"caseSensitive\": true,\n                      \"leftValue\": \"\",\n                      \"typeValidation\": \"strict\",\n                      \"version\": 3\n                    },\n                    \"conditions\": [\n                      {\n                        \"leftValue\": \"={{ $json.client_normalized }}\",\n                        \"rightValue\": \"\",\n                        \"operator\": {\n                          \"type\": \"string\",\n                          \"operation\": \"isEmpty\"\n                        },\n                        \"id\": \"fcfa78d7-b736-4c5c-8123-d82d2456ad6d\"\n                      },\n                      {\n                        \"leftValue\": \"={{ $json.client_status }}\",\n                        \"rightValue\": \"UNKNOWN\",\n                        \"operator\": {\n                          \"type\": \"string\",\n                          \"operation\": \"equals\"\n                        },\n                        \"id\": \"0d66b8d3-e3c7-4314-9d28-b4d60c45bef2\"\n                      }\n                    ],\n                    \"combinator\": \"or\"\n                  },\n                  \"renameOutput\": true,\n                  \"outputKey\": \"unknown_client\"\n                },\n                {\n                  \"conditions\": {\n                    \"options\": {\n                      \"caseSensitive\": true,\n                      \"leftValue\": \"\",\n                      \"typeValidation\": \"strict\",\n                      \"version\": 3\n                    },\n                    \"conditions\": [\n                      {\n                        \"leftValue\": \"={{ $json.client_status }}\",\n                        \"rightValue\": \"NEW\",\n                        \"operator\": {\n                          \"type\": \"string\",\n                          \"operation\": \"equals\"\n                        },\n                        \"id\": \"ed430b2e-0251-4783-9c3f-a0d015a07a18\"\n                      }\n                    ],\n                    \"combinator\": \"and\"\n                  },\n                  \"renameOutput\": true,\n                  \"outputKey\": \"new_client\"\n                },\n                {\n                  \"conditions\": {\n                    \"options\": {\n                      \"caseSensitive\": true,\n                      \"leftValue\": \"\",\n                      \"typeValidation\": \"strict\",\n                      \"version\": 3\n                    },\n                    \"conditions\": [\n                      {\n                        \"leftValue\": \"={{ $json.client_status }}\",\n                        \"rightValue\": \"EXISTING\",\n                        \"operator\": {\n                          \"type\": \"string\",\n                          \"operation\": \"equals\"\n                        },\n                        \"id\": \"3db6573d-2127-4c22-855f-afca26e1b811\"\n                      }\n                    ],\n                    \"combinator\": \"and\"\n                  },\n                  \"renameOutput\": true,\n                  \"outputKey\": \"existing_client\"\n                }\n              ]\n            },\n            \"options\": {}\n          },\n          \"id\": \"decision-gate-001\",\n          \"name\": \"Decision Gate\",\n          \"type\": \"n8n-nodes-base.switch\",\n          \"typeVersion\": 3.4,\n          \"position\": [\n            2576,\n            288\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Prepare UNKNOWN client data with simple static naming\\n// V3: Use simple UNKNOWN_CLIENT naming instead of timestamp\\nconst inputData = $input.first().json;\\n\\nconst clientName = \\\"unknown_client\\\";\\n\\nreturn [{\\n  json: {\\n    client_name: clientName,\\n    parent_folder_id: inputData.parent_folder_id,\\n    client_name_raw: inputData.client_name_raw,\\n    client_status: inputData.client_status,\\n    root_folder_id: inputData.root_folder_id,\\n    staging_folder_id: inputData.staging_folder_id,\\n    extraction_failure: inputData.extraction_failure,\\n    extraction_error_message: inputData.extraction_error_message,\\n    is_unknown_client: true,\\n    unknown_timestamp: new Date().toISOString()\\n  },\\n  binary: $input.first().binary\\n}];\"\n          },\n          \"id\": \"prepare-unknown-data-001\",\n          \"name\": \"Prepare UNKNOWN Client Data\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3024,\n            112\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Handle unidentified client - send to manual queue\\n  const items = $input.all();\\n  const results = [];\\n\\n  for (const item of items) {\\n    results.push({\\n      json: {\\n        status: 'FAILED',\\n        reason: 'Client name could not be identified',\\n        email_id: item.json.emailId,\\n        email_subject: item.json.emailSubject,\\n        timestamp: new Date().toISOString()\\n      }\\n    });\\n  }\\n\\n  return results;\"\n          },\n          \"id\": \"handle-unknown-001\",\n          \"name\": \"Handle Unidentified Client\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            2800,\n            112\n          ]\n        },\n        {\n          \"parameters\": {\n            \"documentId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI\"\n            },\n            \"sheetName\": {\n              \"__rl\": true,\n              \"value\": 762792134,\n              \"mode\": \"list\",\n              \"cachedResultName\": \"Client_Registry\",\n              \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/1T-jL-cLgplVeZ3EMroQxvGEqI5G7t81jRZ2qINDvXNI/edit#gid=762792134\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"lookup-staging-folder-001\",\n          \"name\": \"Lookup Staging Folder\",\n          \"type\": \"n8n-nodes-base.googleSheets\",\n          \"typeVersion\": 4.7,\n          \"position\": [\n            2800,\n            592\n          ],\n          \"credentials\": {\n            \"googleSheetsOAuth2Api\": {\n              \"id\": \"H7ewI1sOrDYabelt\",\n              \"name\": \"Google Sheets account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// V6: GRACEFUL ERROR HANDLING - No errors thrown, route to 38_Unknowns if missing\\n// Extract staging_folder_id from Client Registry lookup AND file_id from upload\\nconst clientName = $('Check Client Exists').first().json.client_name;\\nconst sheetRows = $input.all();\\nconst fileData = $('Extract File ID & Metadata').first().json;\\n\\n// Find matching row by normalizing Client_Name the same way as \\\"Normalize Client Name\\\" node\\nconst matchingRow = sheetRows.find(row => {\\n  const registryClientName = row.json.Client_Name || '';\\n  \\n  // Normalize Client_Name to match client_name format\\n  const normalizedName = registryClientName\\n    .toLowerCase()\\n    .trim()\\n    .replace(/√§/g, 'ae')\\n    .replace(/√∂/g, 'oe')\\n    .replace(/√º/g, 'ue')\\n    .replace(/√ü/g, 'ss')\\n    .replace(/\\\\s*(gmbh|ag|kg|e\\\\.v\\\\.|mbh|co\\\\.|&\\\\s*co\\\\.?)\\\\s*/gi, '')\\n    .replace(/[^a-z0-9]/g, '_')\\n    .replace(/_+/g, '_')\\n    .replace(/^_|_$/g, '');\\n  \\n  return normalizedName === clientName;\\n});\\n\\n// GRACEFUL HANDLING: Route to 38_Unknowns if no matching row\\nif (!matchingRow) {\\n  return [{\\n    json: {\\n      ...fileData,\\n      client_name: clientName,\\n      error: `No staging folder found for client: ${clientName}`,\\n      routeTo38Unknowns: true,\\n      errorType: 'missing_client_in_registry',\\n      skipChunk1: true\\n    }\\n  }];\\n}\\n\\nconst stagingFolderId = matchingRow.json.Staging_Folder_ID || matchingRow.json['01_Staging'];\\n\\n// GRACEFUL HANDLING: Route to 38_Unknowns if staging folder ID is empty\\nif (!stagingFolderId) {\\n  return [{\\n    json: {\\n      ...fileData,\\n      client_name: clientName,\\n      error: `Staging_Folder_ID is empty for client: ${clientName}`,\\n      routeTo38Unknowns: true,\\n      errorType: 'missing_staging_folder',\\n      skipChunk1: true\\n    }\\n  }];\\n}\\n\\n// SUCCESS PATH: Continue with staging folder ID\\nreturn [{\\n  json: {\\n    client_name: clientName,\\n    staging_folder_id: stagingFolderId,\\n    email_id: fileData.emailId,\\n    file_id: fileData.file_id,\\n    filename: fileData.filename,\\n    routeTo38Unknowns: false\\n  }\\n}];\"\n          },\n          \"id\": \"filter-staging-folder-001\",\n          \"name\": \"Filter Staging Folder ID\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3024,\n            592\n          ]\n        },\n        {\n          \"parameters\": {\n            \"conditions\": {\n              \"options\": {\n                \"caseSensitive\": true,\n                \"leftValue\": \"\",\n                \"typeValidation\": \"strict\",\n                \"version\": 2\n              },\n              \"conditions\": [\n                {\n                  \"id\": \"route-unknowns-check\",\n                  \"leftValue\": \"={{ $json.routeTo38Unknowns }}\",\n                  \"rightValue\": true,\n                  \"operator\": {\n                    \"type\": \"boolean\",\n                    \"operation\": \"true\",\n                    \"singleValue\": true\n                  }\n                }\n              ],\n              \"combinator\": \"and\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"check-routing-decision-001\",\n          \"name\": \"Check Routing Decision\",\n          \"type\": \"n8n-nodes-base.if\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3248,\n            592\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Prepare data for routing to 38_Unknowns when staging folder is missing\\nconst item = $input.first().json;\\n\\n// Create UNKNOWN_CLIENT structure to match existing unknowns path\\nreturn [{\\n  json: {\\n    client_name: 'unknown_client',\\n    parent_folder_id: '1ikw3k-EgpVg_h2ySDdqdUFB7-FQyYDFm',\\n    client_status: 'UNKNOWN',\\n    is_unknown_client: true,\\n    error_reason: item.error || 'Missing staging folder',\\n    error_type: item.errorType || 'missing_staging_folder',\\n    file_id: item.file_id,\\n    filename: item.filename,\\n    email_id: item.email_id,\\n    unknown_timestamp: new Date().toISOString()\\n  }\\n}];\"\n          },\n          \"id\": \"prepare-missing-folder-error-001\",\n          \"name\": \"Prepare Missing Folder Error\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3472,\n            688\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Extract 38_Unknowns folder ID from Chunk 0 response\\n// ALSO get file_id from earlier in workflow\\n\\nconst chunk0Response = $input.first().json;\\nconst folderData = chunk0Response.folderIDs || [];\\n\\nconst unknownsFolder = folderData.find(item =>\\n  item.Variable_Name === 'FOLDER_38_UNKNOWNS'\\n);\\n\\nif (!unknownsFolder || !unknownsFolder.Folder_ID) {\\n  throw new Error('FOLDER_38_UNKNOWNS not found in Chunk 0 response');\\n}\\n\\n// Get file_id from Extract File ID & Metadata node\\nconst fileMetadata = $('Extract File ID & Metadata').first().json;\\nconst fileId = fileMetadata.file_id;\\n\\nif (!fileId) {\\n  throw new Error('file_id not found from Extract File ID & Metadata node');\\n}\\n\\nreturn {\\n  json: {\\n    unknowns_folder_id: unknownsFolder.Folder_ID,\\n    temp_pdf_file_id: fileId,\\n    root_folder_id: chunk0Response.Root_Folder_ID,\\n    client_name: chunk0Response.Client_Name,\\n    ...chunk0Response\\n  },\\n  binary: $input.first().binary\\n};\\n\"\n          },\n          \"id\": \"extract-unknowns-folder-001\",\n          \"name\": \"Extract 38_Unknowns Folder ID\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3472,\n            112\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"const folderId = $json.unknowns_folder_id;\\nconst fileId = $json.temp_pdf_file_id;\\n\\nif (!folderId || folderId === '') {\\n  throw new Error('Missing unknowns_folder_id - cannot move file');\\n}\\n\\nif (!fileId || fileId === '') {\\n  throw new Error('Missing temp_pdf_file_id - no file to move');\\n}\\n\\nreturn {\\n  json: {\\n    unknowns_folder_id: folderId,\\n    temp_pdf_file_id: fileId,\\n    ...$json\\n  },\\n  binary: $input.first().binary\\n};\"\n          },\n          \"id\": \"validate-folder-ids-001\",\n          \"name\": \"Validate Folder IDs\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3696,\n            112\n          ]\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"move\",\n            \"fileId\": \"={{ $json.temp_pdf_file_id }}\",\n            \"driveId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"My Drive\"\n            },\n            \"folderId\": {\n              \"__rl\": true,\n              \"value\": \"={{ $('Execute Chunk 0 - Create Folders (UNKNOWN)').item.json.folderIDs[43].Folder_ID }}\",\n              \"mode\": \"\"\n            }\n          },\n          \"id\": \"move-pdf-unknowns-001\",\n          \"name\": \"Move PDF to 38_Unknowns\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            3920,\n            112\n          ],\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Get data from correct sources\\n// CRITICAL FIX: Get root_folder_id from Validate Folder IDs (before Move PDF wiped data)\\nconst folderData = $('Validate Folder IDs').first().json;\\nconst emailData = $('Gmail Trigger - Unread with Attachments').first().json;\\nconst moveResult = $input.first().json;\\n\\nconst rootFolderId = folderData.Root_Folder_ID || folderData.root_folder_id;\\nconst rootFolderName = folderData.Client_Name || folderData.client_name || 'UNKNOWN';\\nconst unknownsFolderId = folderData.unknowns_folder_id;\\nconst pdfFileId = moveResult.id || folderData.temp_pdf_file_id;\\n\\nconst pdfLink = `https://drive.google.com/file/d/${pdfFileId}/view`;\\nconst rootFolderLink = `https://drive.google.com/drive/folders/${rootFolderId}`;\\n\\nconst emailFrom = emailData.from || 'Unknown Sender';\\nconst emailSubject = emailData.subject || 'No Subject';\\nconst pdfFilename = folderData.pdf_filename || 'unknown.pdf';\\n\\nconst timestamp = new Date().toLocaleString('en-US', {\\n  timeZone: 'Europe/Berlin',\\n  year: 'numeric',\\n  month: '2-digit',\\n  day: '2-digit',\\n  hour: '2-digit',\\n  minute: '2-digit',\\n  hour12: false\\n});\\n\\nreturn [{\\n  json: {\\n    to: 'swayclarkeii@gmail.com',\\n    pdf_filename: pdfFilename,\\n    email_from: emailFrom,\\n    email_subject: emailSubject,\\n    root_folder_name: rootFolderName,\\n    pdf_link: pdfLink,\\n    root_folder_link: rootFolderLink,\\n    timestamp: timestamp\\n  },\\n  binary: $input.first().binary\\n}];\"\n          },\n          \"id\": \"prepare-email-data-001\",\n          \"name\": \"Prepare Email Notification Data\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            4144,\n            112\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Build HTML email body for UNKNOWN client notification\\nconst data = $input.first().json;\\n\\n// Extract just the email address (not the display name)\\nconst emailAddress = data.email_from?.value?.[0]?.address || 'Unknown Sender';\\n\\nconst htmlBody = `<!DOCTYPE html>\\n<html>\\n<body style=\\\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\\\">\\n  <div style=\\\"max-width: 600px; margin: 0 auto; padding: 20px;\\\">\\n    <h2 style=\\\"color: #d32f2f;\\\">‚ö†Ô∏è Unknown Client Document Received</h2>\\n    \\n    <p>A document was received but the client could not be identified. Manual review is required.</p>\\n    \\n    <div style=\\\"background: #f5f5f5; padding: 15px; border-left: 4px solid #1976d2; margin: 20px 0;\\\">\\n      <h3 style=\\\"margin-top: 0;\\\">Document Details</h3>\\n      <ul style=\\\"list-style: none; padding: 0;\\\">\\n        <li><strong>Filename:</strong> ${data.pdf_filename}</li>\\n        <li><strong>From:</strong> ${emailAddress}</li>\\n        <li><strong>Subject:</strong> ${data.email_subject}</li>\\n      </ul>\\n    </div>\\n    \\n    <div style=\\\"background: #fff3e0; padding: 15px; border-left: 4px solid #f57c00; margin: 20px 0;\\\">\\n      <h3 style=\\\"margin-top: 0;\\\">üìÇ Created Folder Structure</h3>\\n      <p>A temporary folder structure has been created:</p>\\n      <ul style=\\\"list-style: none; padding: 0;\\\">\\n        <li><strong>Root Folder:</strong> ${data.root_folder_name}</li>\\n        <li><strong>Document Location:</strong> SONSTIGES/38_Unknowns/</li>\\n      </ul>\\n    </div>\\n    \\n    <div style=\\\"margin: 30px 0;\\\">\\n      <h3>üîó Quick Actions</h3>\\n      <div style=\\\"margin: 10px 0;\\\">\\n        <a href=\\\"${data.pdf_link}\\\" \\n           style=\\\"display: inline-block; padding: 12px 24px; background: #1976d2; color: white; text-decoration: none; border-radius: 4px; margin-right: 10px;\\\">\\n          üìÑ View PDF\\n        </a>\\n        <a href=\\\"${data.root_folder_link}\\\" \\n           style=\\\"display: inline-block; padding: 12px 24px; background: #43a047; color: white; text-decoration: none; border-radius: 4px;\\\">\\n          üìÅ Open Folder Structure\\n        </a>\\n      </div>\\n    </div>\\n    \\n    <div style=\\\"background: #e3f2fd; padding: 15px; border-left: 4px solid #1976d2; margin: 20px 0;\\\">\\n      <h3 style=\\\"margin-top: 0;\\\">‚úÖ Next Steps</h3>\\n      <ol>\\n        <li>Review the PDF to identify the client</li>\\n        <li>Rename the root folder to the correct client name</li>\\n        <li>Update the Client_Registry sheet with the correct client name</li>\\n        <li>Move the PDF from 38_Unknowns to the appropriate subfolder</li>\\n      </ol>\\n    </div>\\n    \\n    <hr style=\\\"border: none; border-top: 1px solid #ddd; margin: 30px 0;\\\">\\n    \\n    <p style=\\\"font-size: 12px; color: #666;\\\">\\n      <strong>System:</strong> Eugene AMA Document Organizer V4<br>\\n      <strong>Timestamp:</strong> ${data.timestamp}\\n    </p>\\n  </div>\\n</body>\\n</html>`;\\n\\nreturn [{\\n  json: {\\n    ...data,\\n    html_body: htmlBody\\n  },\\n  binary: $input.first().binary\\n}];\"\n          },\n          \"id\": \"build-email-html-001\",\n          \"name\": \"Build Email HTML Body\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            4368,\n            112\n          ]\n        },\n        {\n          \"parameters\": {\n            \"sendTo\": \"swayclarkeii@gmail.com\",\n            \"subject\": \"={{ $json.emailSubject || '[ACTION REQUIRED] Unknown Client Document' }}\",\n            \"message\": \"={{ $json.html_body }}\",\n            \"options\": {}\n          },\n          \"id\": \"send-email-notification-001\",\n          \"name\": \"Send Email Notification\",\n          \"type\": \"n8n-nodes-base.gmail\",\n          \"typeVersion\": 2,\n          \"position\": [\n            4592,\n            112\n          ],\n          \"webhookId\": \"e028968d-b3d1-4dd6-bb18-20d1b6594069\",\n          \"credentials\": {\n            \"gmailOAuth2\": {\n              \"id\": \"aYzk7sZF8ZVyfOan\",\n              \"name\": \"Gmail account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Format error email data for registry corruption\\nconst inputData = $input.all();\\n\\nconst output = inputData.map(item => {\\n  const clientName = item.json.client_name || 'Unknown Client';\\n  const fileName = item.json.file_name || 'Unknown File';\\n  const emailSubject = item.json.email_subject || 'N/A';\\n  const emailFrom = item.json.email_from || 'N/A';\\n  const emailDate = item.json.email_date || 'N/A';\\n  \\n  return {\\n    json: {\\n      ...item.json,\\n      email_to: 'swayclarkeii@gmail.com',\\n      email_subject: `[URGENT] Registry Error: ${clientName} - Missing Staging Folder`,\\n      email_message: `CRITICAL REGISTRY ERROR DETECTED\\n\\nClient: ${clientName}\\nError Type: Client marked EXISTING but staging_folder_id is MISSING in Client Registry\\n\\n--- ACTION TAKEN ---\\nFile moved to 38_Unknowns folder for manual review\\n\\n--- ORIGINAL EMAIL DETAILS ---\\nSubject: ${emailSubject}\\nFrom: ${emailFrom}\\nDate: ${emailDate}\\nAttachment: ${fileName}\\n\\n--- NEXT STEPS ---\\nPlease:\\n1. Open the Client Registry spreadsheet\\n2. Find the row for \\\"${clientName}\\\"\\n3. Add the missing staging_folder_id to column E\\n4. Manually move the file from 38_Unknowns to the correct staging folder\\n\\nThis is a data integrity issue that needs immediate attention.\\n\\n---\\nWorkflow: AMA Pre-Chunk 0\\nNode: Registry Error Handler`\\n    }\\n  };\\n});\\n\\nreturn output;\"\n          },\n          \"id\": \"prepare-registry-error-email-001\",\n          \"name\": \"Prepare Registry Error Email Data\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3696,\n            688\n          ]\n        },\n        {\n          \"parameters\": {\n            \"sendTo\": \"={{ $json.email_to }}\",\n            \"subject\": \"={{ $json.email_subject }}\",\n            \"message\": \"={{ $json.email_message }}\",\n            \"options\": {}\n          },\n          \"id\": \"send-registry-error-email-001\",\n          \"name\": \"Send Registry Error Email\",\n          \"type\": \"n8n-nodes-base.gmail\",\n          \"typeVersion\": 2.1,\n          \"position\": [\n            3920,\n            688\n          ],\n          \"webhookId\": \"6b7c8ac4-c32d-40d5-b4d0-44a55bc16b79\",\n          \"credentials\": {\n            \"gmailOAuth2\": {\n              \"id\": \"aYzk7sZF8ZVyfOan\",\n              \"name\": \"Gmail account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"move\",\n            \"fileId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"={{ $json.file_id }}\"\n            },\n            \"driveId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"My Drive\"\n            },\n            \"folderId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"1qdUu-dIkQR0oDaZKAL_8OhI0jST89_Vu\"\n            }\n          },\n          \"id\": \"move-to-unknowns-registry-001\",\n          \"name\": \"Move to 38_Unknowns (Registry Error)\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            4144,\n            688\n          ],\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"addLabels\",\n            \"messageId\": \"={{ $json.email_id }}\",\n            \"labelIds\": [\n              \"INBOX\"\n            ]\n          },\n          \"id\": \"mark-read-registry-error-001\",\n          \"name\": \"Mark Email as Read (Registry Error)\",\n          \"type\": \"n8n-nodes-base.gmail\",\n          \"typeVersion\": 2.1,\n          \"position\": [\n            4368,\n            688\n          ],\n          \"webhookId\": \"f229ca84-1e69-43a0-90a0-f6ac4544b40f\",\n          \"credentials\": {\n            \"gmailOAuth2\": {\n              \"id\": \"aYzk7sZF8ZVyfOan\",\n              \"name\": \"Gmail account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {},\n          \"id\": \"noop-registry-complete-001\",\n          \"name\": \"NoOp - Registry Error Complete\",\n          \"type\": \"n8n-nodes-base.noOp\",\n          \"typeVersion\": 1,\n          \"position\": [\n            4592,\n            688\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Merge Chunk 0 output with original file data for NEW client path\\nconst chunk0Output = $input.first().json;\\n\\n// Get file_id from Extract File ID & Metadata node (far upstream)\\nconst fileMetadata = $('Extract File ID & Metadata').first().json;\\n\\nreturn [{\\n  json: {\\n    ...chunk0Output,\\n    file_id: fileMetadata.file_id,\\n    email_id: fileMetadata.emailId,\\n    filename: fileMetadata.filename\\n  }\\n}];\"\n          },\n          \"id\": \"0180f051-407b-453b-89fc-faaf3439c20d\",\n          \"name\": \"Merge Chunk 0 Output (NEW)\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 1,\n          \"position\": [\n            3024,\n            304\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Get Google Drive upload result from previous node\\nconst driveUpload = $input.first().json;\\n\\n// Retrieve email metadata from Gmail Trigger\\nconst emailData = $('Gmail Trigger - Unread with Attachments').first().json;\\n\\n// Retrieve binary metadata from Gmail Trigger\\nconst binaryData = $('Gmail Trigger - Unread with Attachments').first().binary;\\n\\n// Get first attachment key\\nconst attachmentKeys = Object.keys(binaryData);\\nconst attachmentKey = attachmentKeys[0];\\nconst attachment = binaryData[attachmentKey];\\n\\n// Extract file extension from filename\\nconst fileName = driveUpload.name;\\nconst extension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();\\n\\n// Get client data from Normalize Client Name node\\nconst clientData = $('Normalize Client Name').first().json;\\nconst clientName = clientData.client_name || 'unknown';\\n\\n// Construct stagingPath\\nconst stagingPath = `${clientName}/_Staging/${fileName}`;\\n\\n// Parse file size\\nlet fileSizeBytes = 0;\\nif (attachment.fileSize) {\\n  const sizeStr = attachment.fileSize;\\n  const match = sizeStr.match(/^([\\\\d.]+)\\\\s*(KB|MB|GB)$/i);\\n  if (match) {\\n    const value = parseFloat(match[1]);\\n    const unit = match[2].toUpperCase();\\n    const multipliers = { KB: 1024, MB: 1024 * 1024, GB: 1024 * 1024 * 1024 };\\n    fileSizeBytes = Math.round(value * multipliers[unit]);\\n  }\\n}\\n\\n// Extract email sender\\nlet emailFrom = '';\\nif (emailData.from && emailData.from.value && emailData.from.value[0]) {\\n  emailFrom = emailData.from.value[0].address;\\n}\\n\\n// ‚úÖ NEW: Get extracted text from Evaluate Extraction Quality node\\nconst extractionData = $('Evaluate Extraction Quality').first().json;\\nconst extractedText = extractionData.extractedText || '';\\nconst extractionMethod = extractionData.extractionMethod || 'digital_pre_chunk';\\nconst textLength = extractionData.textLength || 0;\\n\\n// Build complete Chunk 2 input\\nreturn [{\\n  json: {\\n    fileId: driveUpload.id,\\n    fileName: driveUpload.name,\\n    mimeType: driveUpload.mimeType,\\n    extension: extension,\\n    size: fileSizeBytes,\\n    emailId: emailData.id,\\n    emailFrom: emailFrom,\\n    emailSubject: emailData.subject,\\n    emailDate: emailData.date,\\n    stagingPath: stagingPath,\\n    originalFileName: attachment.fileName,\\n    extractedFromZip: false,\\n    zipFileName: null,\\n    client_name: clientData.client_name_raw,\\n    client_normalized: clientData.client_name,\\n    \\n    // ‚úÖ NEW: Pass extracted text to Chunk 2 (skip re-download)\\n    extractedText: extractedText,\\n    extractionMethod: extractionMethod,\\n    textLength: textLength,\\n    skipDownload: textLength > 100  // Skip download if we have meaningful text\\n  }\\n}];\"\n          },\n          \"id\": \"prepare-chunk2-new-001\",\n          \"name\": \"Prepare for Chunk 2 (NEW)\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3472,\n            304\n          ],\n          \"notes\": \"Enriches Google Drive data with email metadata for Chunk 2\"\n        },\n        {\n          \"parameters\": {\n            \"workflowId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"qKyqsL64ReMiKpJ4\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"execute-chunk2-new-001\",\n          \"name\": \"Execute Chunk 2 (NEW)\",\n          \"type\": \"n8n-nodes-base.executeWorkflow\",\n          \"typeVersion\": 1.3,\n          \"position\": [\n            3696,\n            304\n          ],\n          \"notes\": \"Executes Chunk 2 text extraction workflow\"\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"markAsRead\",\n            \"messageId\": \"={{ $('Gmail Trigger - Unread with Attachments').first().json.id }}\"\n          },\n          \"id\": \"mark-read-new-001\",\n          \"name\": \"Mark Email as Read (NEW)\",\n          \"type\": \"n8n-nodes-base.gmail\",\n          \"typeVersion\": 2.1,\n          \"position\": [\n            3920,\n            304\n          ],\n          \"webhookId\": \"9967ebd9-7776-4d6d-a993-a3c7353a8c26\",\n          \"credentials\": {\n            \"gmailOAuth2\": {\n              \"id\": \"aYzk7sZF8ZVyfOan\",\n              \"name\": \"Gmail account\"\n            }\n          },\n          \"notes\": \"Marks the processed email as read\"\n        },\n        {\n          \"parameters\": {},\n          \"id\": \"noop-new-complete-001\",\n          \"name\": \"NoOp - NEW Complete\",\n          \"type\": \"n8n-nodes-base.noOp\",\n          \"typeVersion\": 1,\n          \"position\": [\n            4144,\n            304\n          ]\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Get Google Drive upload result from previous node\\nconst driveUpload = $input.first().json;\\n\\n// Retrieve email metadata from Gmail Trigger\\nconst emailData = $('Gmail Trigger - Unread with Attachments').first().json;\\n\\n// Retrieve binary metadata from Gmail Trigger\\nconst binaryData = $('Gmail Trigger - Unread with Attachments').first().binary;\\n\\n// Get first attachment key\\nconst attachmentKeys = Object.keys(binaryData);\\nconst attachmentKey = attachmentKeys[0];\\nconst attachment = binaryData[attachmentKey];\\n\\n// Extract file extension from filename\\nconst fileName = driveUpload.name;\\nconst extension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();\\n\\n// Get client data from Normalize Client Name node\\nconst clientData = $('Normalize Client Name').first().json;\\nconst clientName = clientData.client_name || 'unknown';\\n\\n// Construct stagingPath\\nconst stagingPath = `${clientName}/_Staging/${fileName}`;\\n\\n// Parse file size\\nlet fileSizeBytes = 0;\\nif (attachment.fileSize) {\\n  const sizeStr = attachment.fileSize;\\n  const match = sizeStr.match(/^([\\\\d.]+)\\\\s*(KB|MB|GB)$/i);\\n  if (match) {\\n    const value = parseFloat(match[1]);\\n    const unit = match[2].toUpperCase();\\n    const multipliers = { KB: 1024, MB: 1024 * 1024, GB: 1024 * 1024 * 1024 };\\n    fileSizeBytes = Math.round(value * multipliers[unit]);\\n  }\\n}\\n\\n// Extract email sender\\nlet emailFrom = '';\\nif (emailData.from && emailData.from.value && emailData.from.value[0]) {\\n  emailFrom = emailData.from.value[0].address;\\n}\\n\\n// ‚úÖ NEW: Get extracted text from Evaluate Extraction Quality node\\nconst extractionData = $('Evaluate Extraction Quality').first().json;\\nconst extractedText = extractionData.extractedText || '';\\nconst extractionMethod = extractionData.extractionMethod || 'digital_pre_chunk';\\nconst textLength = extractionData.textLength || 0;\\n\\n// Build complete Chunk 2 input\\nreturn [{\\n  json: {\\n    fileId: driveUpload.id,\\n    fileName: driveUpload.name,\\n    mimeType: driveUpload.mimeType,\\n    extension: extension,\\n    size: fileSizeBytes,\\n    emailId: emailData.id,\\n    emailFrom: emailFrom,\\n    emailSubject: emailData.subject,\\n    emailDate: emailData.date,\\n    stagingPath: stagingPath,\\n    originalFileName: attachment.fileName,\\n    extractedFromZip: false,\\n    zipFileName: null,\\n    client_name: clientData.client_name_raw,\\n    client_normalized: clientData.client_name,\\n    \\n    // ‚úÖ NEW: Pass extracted text to Chunk 2 (skip re-download)\\n    extractedText: extractedText,\\n    extractionMethod: extractionMethod,\\n    textLength: textLength,\\n    skipDownload: textLength > 100  // Skip download if we have meaningful text\\n  }\\n}];\"\n          },\n          \"id\": \"prepare-chunk2-existing-001\",\n          \"name\": \"Prepare for Chunk 2 (EXISTING)\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            3696,\n            496\n          ],\n          \"notes\": \"Enriches Google Drive data with email metadata for Chunk 2\"\n        },\n        {\n          \"parameters\": {\n            \"workflowId\": {\n              \"__rl\": true,\n              \"mode\": \"id\",\n              \"value\": \"qKyqsL64ReMiKpJ4\"\n            },\n            \"options\": {}\n          },\n          \"id\": \"execute-chunk2-existing-001\",\n          \"name\": \"Execute Chunk 2 (EXISTING)\",\n          \"type\": \"n8n-nodes-base.executeWorkflow\",\n          \"typeVersion\": 1.3,\n          \"position\": [\n            3920,\n            496\n          ],\n          \"notes\": \"Executes Chunk 2 text extraction workflow\"\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"markAsRead\",\n            \"messageId\": \"={{ $('Gmail Trigger - Unread with Attachments').first().json.id }}\"\n          },\n          \"id\": \"mark-read-existing-001\",\n          \"name\": \"Mark Email as Read (EXISTING)\",\n          \"type\": \"n8n-nodes-base.gmail\",\n          \"typeVersion\": 2.1,\n          \"position\": [\n            4144,\n            496\n          ],\n          \"webhookId\": \"64c1fe12-1ad8-47a2-b59a-502812a88c50\",\n          \"credentials\": {\n            \"gmailOAuth2\": {\n              \"id\": \"aYzk7sZF8ZVyfOan\",\n              \"name\": \"Gmail account\"\n            }\n          },\n          \"notes\": \"Marks the processed email as read\"\n        },\n        {\n          \"parameters\": {},\n          \"id\": \"noop-existing-complete-001\",\n          \"name\": \"NoOp - EXISTING Complete\",\n          \"type\": \"n8n-nodes-base.noOp\",\n          \"typeVersion\": 1,\n          \"position\": [\n            4368,\n            496\n          ]\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"move\",\n            \"fileId\": {\n              \"__rl\": true,\n              \"value\": \"={{ $json.file_id }}\",\n              \"mode\": \"id\"\n            },\n            \"driveId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"My Drive\"\n            },\n            \"folderId\": {\n              \"__rl\": true,\n              \"value\": \"={{ $json.Staging_Folder_ID }}\",\n              \"mode\": \"id\"\n            }\n          },\n          \"id\": \"b767c01a-345c-4a94-ba35-35f8dda0fb2c\",\n          \"name\": \"Move PDF to _Staging (NEW)\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            3248,\n            304\n          ],\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"operation\": \"move\",\n            \"fileId\": {\n              \"__rl\": true,\n              \"value\": \"={{ $json.file_id }}\",\n              \"mode\": \"id\"\n            },\n            \"driveId\": {\n              \"__rl\": true,\n              \"mode\": \"list\",\n              \"value\": \"My Drive\"\n            },\n            \"folderId\": {\n              \"__rl\": true,\n              \"value\": \"={{ $json.Staging_Folder_ID }}\",\n              \"mode\": \"id\"\n            }\n          },\n          \"id\": \"90cc99fd-908d-4149-a2f7-35f42ab2e232\",\n          \"name\": \"Move PDF to _Staging (EXISTING)\",\n          \"type\": \"n8n-nodes-base.googleDrive\",\n          \"typeVersion\": 3,\n          \"position\": [\n            3472,\n            496\n          ],\n          \"alwaysOutputData\": true,\n          \"credentials\": {\n            \"googleDriveOAuth2Api\": {\n              \"id\": \"a4m50EefR3DJoU0R\",\n              \"name\": \"Google Drive account\"\n            }\n          }\n        },\n        {\n          \"parameters\": {\n            \"workflowId\": {\n              \"__rl\": true,\n              \"value\": \"zbxHkXOoD1qaz6OS\",\n              \"mode\": \"list\",\n              \"cachedResultUrl\": \"/workflow/zbxHkXOoD1qaz6OS\",\n              \"cachedResultName\": \"AMA Chunk 0: Folder Initialization (V4 - Parameterized)\"\n            },\n            \"workflowInputs\": {\n              \"mappingMode\": \"defineBelow\",\n              \"value\": {\n                \"client_name\": \"={{ $json.client_name_raw }}\",\n                \"client_normalized\": \"={{ $json.client_name }}\",\n                \"parent_folder_id\": \"={{ $('Check Client Exists').item.json.parent_folder_id }}\"\n              },\n              \"matchingColumns\": [],\n              \"schema\": [\n                {\n                  \"id\": \"client_name\",\n                  \"displayName\": \"client_name\",\n                  \"required\": false,\n                  \"defaultMatch\": false,\n                  \"display\": true,\n                  \"canBeUsedToMatch\": true,\n                  \"type\": \"string\"\n                },\n                {\n                  \"id\": \"client_normalized\",\n                  \"displayName\": \"client_normalized\",\n                  \"required\": false,\n                  \"defaultMatch\": false,\n                  \"display\": true,\n                  \"canBeUsedToMatch\": true,\n                  \"type\": \"string\"\n                },\n                {\n                  \"id\": \"parent_folder_id\",\n                  \"displayName\": \"parent_folder_id\",\n                  \"required\": false,\n                  \"defaultMatch\": false,\n                  \"display\": true,\n                  \"canBeUsedToMatch\": true,\n                  \"type\": \"string\"\n                }\n              ],\n              \"attemptToConvertTypes\": false,\n              \"convertFieldsToString\": true\n            },\n            \"options\": {}\n          },\n          \"id\": \"bc9b052a-1fdf-412c-990a-7c3e58178304\",\n          \"name\": \"Execute Chunk 0 - Create Folders (UNKNOWN)\",\n          \"type\": \"n8n-nodes-base.executeWorkflow\",\n          \"typeVersion\": 1.3,\n          \"position\": [\n            3248,\n            112\n          ]\n        },\n        {\n          \"parameters\": {\n            \"workflowId\": {\n              \"__rl\": true,\n              \"value\": \"zbxHkXOoD1qaz6OS\",\n              \"mode\": \"list\",\n              \"cachedResultUrl\": \"/workflow/zbxHkXOoD1qaz6OS\",\n              \"cachedResultName\": \"AMA Chunk 0: Folder Initialization (V4 - Parameterized)\"\n            },\n            \"workflowInputs\": {\n              \"mappingMode\": \"defineBelow\",\n              \"value\": {\n                \"client_name\": \"={{ $json.client_name_raw }}\",\n                \"client_normalized\": \"={{ $json.client_name }}\",\n                \"parent_folder_id\": \"={{ $('Check Client Exists').item.json.parent_folder_id }}\"\n              },\n              \"matchingColumns\": [],\n              \"schema\": [\n                {\n                  \"id\": \"client_name\",\n                  \"displayName\": \"client_name\",\n                  \"required\": false,\n                  \"defaultMatch\": false,\n                  \"display\": true,\n                  \"canBeUsedToMatch\": true,\n                  \"type\": \"string\"\n                },\n                {\n                  \"id\": \"client_normalized\",\n                  \"displayName\": \"client_normalized\",\n                  \"required\": false,\n                  \"defaultMatch\": false,\n                  \"display\": true,\n                  \"canBeUsedToMatch\": true,\n                  \"type\": \"string\"\n                },\n                {\n                  \"id\": \"parent_folder_id\",\n                  \"displayName\": \"parent_folder_id\",\n                  \"required\": false,\n                  \"defaultMatch\": false,\n                  \"display\": true,\n                  \"canBeUsedToMatch\": true,\n                  \"type\": \"string\"\n                }\n              ],\n              \"attemptToConvertTypes\": false,\n              \"convertFieldsToString\": true\n            },\n            \"options\": {}\n          },\n          \"id\": \"execute-chunk0-001\",\n          \"name\": \"Execute Chunk 0 - Create Folders (NEW)\",\n          \"type\": \"n8n-nodes-base.executeWorkflow\",\n          \"typeVersion\": 1.3,\n          \"position\": [\n            2800,\n            304\n          ]\n        },\n        {\n          \"parameters\": {\n            \"amount\": 3\n          },\n          \"id\": \"wait-staging-existing-001\",\n          \"name\": \"Wait After Staging (EXISTING)\",\n          \"type\": \"n8n-nodes-base.wait\",\n          \"typeVersion\": 1.1,\n          \"position\": [\n            3584,\n            496\n          ],\n          \"executeOnce\": false,\n          \"alwaysOutputData\": true,\n          \"webhookId\": \"6d74a0e2-74ef-411a-83f9-c98a972b25df\"\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"const crypto = require('crypto');\\n\\n// Google Service Account credentials\\nconst serviceAccount = {\\n  projectId: 'n8n-integrations-482020',\\n  clientEmail: 'n8n-document-ai@n8n-integrations-482020.iam.gserviceaccount.com',\\n  privateKey: `-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCwWo8CBWPs5tvS\\nP01jLTf6Rc54JrOCEU1KIOpkZryrT082kD/eXx73unpLGUCb9t5u9kjCjiU8BPMp\\nqnPQSCVzeuMNWLYcyQfGIUFRfCSi/7bg5q1mwv+DkLsgNWx0mRAk5pfPCv9qW9qk\\n+XyNYtqk3FlgWBRtynwd49cCN1FoaRgTQTv6KsRtqV7nc6MyE+VyyhMY64uoQfCN\\nd+PrXkE20yDaNg/yZU/re3/2kqeWVt3F5nxZFbuM2wBof0wLQcqkZ/ggN9/C/zdp\\nBpTnZlTadNzjPePKGBaMHyDP01/E4xUU9d9TJMM4OWc5ReFIMlSdYnzjhuir1+5A\\no2JmvpmRAgMBAAECggEADZAkGC4H8wwHnfzmW8P6M9Jd6xm24UBUEb5u/c0fojaV\\noLGpZ9XS+48o9qZONMXgx5HuI0sWtq3+xuvoFP280PaDiImTv/+qDGU5sSWmFQSB\\nBn0B8GRQ4x0kzHkEtVb29I+TigXjgkTm5PHserHpSkKe0Re/wniPNnvzvk+OKu8W\\nvnSleUP8NamyIxoMRZNWYdUI/yJvU6o2nuxZKe6aVvaF2T3eQ/3pYucvfgsV7L1i\\nkle6T//NjEmrpeFtZEAgrnAAWLso7R+pbN08zc3Jbxb5Q1E6WABlTi6gbI9tmwuu\\n53pe1GY4AGNpfGUiIO/UX/R+9/DSYCMrQMhqTdD8fQKBgQDptBqfAmcDgC9hFkSA\\nopIxslCCsQ56eXTyZ0BL+qQiFyhQFmV3Do4vVLatJvZiUIWonNYxZYfxEMP06dW+\\nk/Bu4NAoSc46wlvY1Bj9xOn7s/afNlY4J0YKrSpIuqQZHyhjERvK7Nn1UHDZ92qJ\\nFXvaNJ0uUUYry5xuYrbwrfECKwKBgQDBLcNJsXKVYmaMh/xkucAKeeOWy/ME2kZz\\noyEFcmgQhKU0Sr7C0OdLE3JnlL+9oz0ashBPb06Y0vsqDzl+0iwU81oc1RD/wBZz\\nBgV2NB0jYvsIHFkI4BY5p4fePF5Q97UCaGttBf3JL1fFFeif/r1Rq2FbAnnpXsqF\\npHrOFKsBMwKBgQC6CmjiyhvNWp7c78gKiuBMdYHH+EDpWISzb2Rs15MPnFW4I4wU\\nUd74aLyfbJPYwfcUuf19BzFHwyvrbLZ95vEQoyCx4cctWYmaO4XFhpsphyK9rZjH\\nTORiHWW6zfFSGk6hRn5UdWYw9h9QNLh3dkXI9/dkZsiwln7qFOVDBYUFTwKBgC7r\\nnJlTnk8mXV4Y0XbtnvVscZj45IfzNFV189lM1nXcofu3g+nxr5wOlyUNfhzjfz3y\\nrf99O4vnAtZOaFqjVc2o5eRG5CAaWdmKRt1U/xbPPcXUjNOZCgzq4hdadlYYNEDn\\nd+A9Kk0pUJowHhZuWzFw/O6MBWxnd61KLAHOB1L9AoGARwyJIEwHeUeoAuCRlQyS\\nxYzI8eMIDJ7HSiaFms+j8cuNy76O9U5E0KVBz6BEeTfq+aym0vyZ6iKJ3+q/IXQ4\\no5jc6G6zgrMAgeuKzKFEwKNK/tm5j3FiDEzcUqLI00AfdG/f+QI/dTxbqnlB1tPn\\nT0v0rf9bjMnUWoH9kXFM+XA=\\n-----END PRIVATE KEY-----`\\n};\\n\\n// Step 1: Create JWT token\\nconst now = Math.floor(Date.now() / 1000);\\nconst jwtHeader = {\\n  alg: 'RS256',\\n  typ: 'JWT'\\n};\\n\\nconst jwtClaims = {\\n  iss: serviceAccount.clientEmail,\\n  scope: 'https://www.googleapis.com/auth/cloud-platform',\\n  aud: 'https://oauth2.googleapis.com/token',\\n  exp: now + 3600,\\n  iat: now\\n};\\n\\n// Encode header and claims\\nconst base64UrlEncode = (str) => {\\n  return Buffer.from(str)\\n    .toString('base64')\\n    .replace(/\\\\+/g, '-')\\n    .replace(/\\\\//g, '_')\\n    .replace(/=/g, '');\\n};\\n\\nconst encodedHeader = base64UrlEncode(JSON.stringify(jwtHeader));\\nconst encodedClaims = base64UrlEncode(JSON.stringify(jwtClaims));\\nconst signatureInput = `${encodedHeader}.${encodedClaims}`;\\n\\n// Sign with private key using crypto module\\nconst sign = crypto.createSign('RSA-SHA256');\\nsign.update(signatureInput);\\nconst signature = sign.sign(serviceAccount.privateKey, 'base64')\\n  .replace(/\\\\+/g, '-')\\n  .replace(/\\\\//g, '_')\\n  .replace(/=/g, '');\\n\\nconst jwt = `${signatureInput}.${signature}`;\\n\\n// Step 2: Exchange JWT for access token\\nconst tokenResponse = await this.helpers.httpRequest({\\n  method: 'POST',\\n  url: 'https://oauth2.googleapis.com/token',\\n  headers: {\\n    'Content-Type': 'application/x-www-form-urlencoded'\\n  },\\n  body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`\\n});\\n\\nconst accessToken = tokenResponse.access_token;\\n\\n// Step 3: Get PDF binary and convert to base64\\nconst item = $input.first();\\nconst binaryKey = Object.keys(item.binary)[0];\\nconst buffer = await this.helpers.getBinaryDataBuffer(0, binaryKey);\\nconst base64Content = buffer.toString('base64');\\n\\n// Step 4: Prepare Document AI request body\\nconst documentAiRequest = {\\n  rawDocument: {\\n    content: base64Content,\\n    mimeType: 'application/pdf'\\n  }\\n};\\n\\n// Return access token, request body, and original data\\nreturn {\\n  json: {\\n    ...item.json,\\n    accessToken: accessToken,\\n    documentAiRequest: documentAiRequest\\n  },\\n  binary: item.binary\\n};\"\n          },\n          \"id\": \"prepare-docai-request-001\",\n          \"name\": \"Prepare Document AI Request\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            1232,\n            464\n          ]\n        },\n        {\n          \"parameters\": {\n            \"method\": \"POST\",\n            \"url\": \"https://eu-documentai.googleapis.com/v1/projects/504943079120/locations/eu/processors/954baa10f2e87364:process\",\n            \"sendHeaders\": true,\n            \"headerParameters\": {\n              \"parameters\": [\n                {\n                  \"name\": \"Authorization\",\n                  \"value\": \"=Bearer {{ $json.accessToken }}\"\n                },\n                {\n                  \"name\": \"Content-Type\",\n                  \"value\": \"application/json\"\n                }\n              ]\n            },\n            \"sendBody\": true,\n            \"specifyBody\": \"json\",\n            \"jsonBody\": \"={{ JSON.stringify($json.documentAiRequest) }}\",\n            \"options\": {}\n          },\n          \"id\": \"call-docai-ocr-001\",\n          \"name\": \"Call Document AI OCR\",\n          \"type\": \"n8n-nodes-base.httpRequest\",\n          \"typeVersion\": 4.3,\n          \"position\": [\n            1456,\n            464\n          ],\n          \"notes\": \"Google Document AI OCR\\n\\nProcessor: 954baa10f2e87364\\nRegion: eu\\nProject: n8n-integrations-482020\"\n        },\n        {\n          \"parameters\": {\n            \"jsCode\": \"// Parse Google Document AI response\\nconst item = $input.first();\\nconst docAiResponse = item.json;\\n\\nlet extractedText = '';\\nlet pageCount = 0;\\n\\n// Extract text from Document AI response\\nif (docAiResponse.document && docAiResponse.document.text) {\\n  extractedText = docAiResponse.document.text;\\n  pageCount = docAiResponse.document.pages ? docAiResponse.document.pages.length : 0;\\n}\\n\\n// Get original data from upstream node (Download PDF from Drive)\\nconst originalData = $('Download PDF from Drive').first().json;\\n\\nreturn {\\n  json: {\\n    ...originalData,\\n    extractedText: extractedText.trim(),\\n    ocrSuccess: extractedText.length > 0,\\n    ocrEngine: 'Google Document AI',\\n    pageCount: pageCount\\n  },\\n  binary: item.binary\\n};\"\n          },\n          \"id\": \"parse-docai-response-001\",\n          \"name\": \"Parse Document AI Response\",\n          \"type\": \"n8n-nodes-base.code\",\n          \"typeVersion\": 2,\n          \"position\": [\n            1680,\n            464\n          ]\n        }\n      ],\n      \"connections\": {\n        \"Gmail Trigger - Unread with Attachments\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Filter PDF/ZIP Attachments\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Filter PDF/ZIP Attachments\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Upload PDF to Temp Folder\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Upload PDF to Temp Folder\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Extract File ID & Metadata\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Extract File ID & Metadata\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Download PDF from Drive\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Download PDF from Drive\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare Document AI Request\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Extract Text from PDF\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Evaluate Extraction Quality\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Evaluate Extraction Quality\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"AI Extract Client Name\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"AI Extract Client Name\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Normalize Client Name\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Normalize Client Name\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Lookup Client Registry\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Lookup Client Registry\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Check Client Exists\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Check Client Exists\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Decision Gate\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Decision Gate\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Handle Unidentified Client\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ],\n            [\n              {\n                \"node\": \"Execute Chunk 0 - Create Folders (NEW)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ],\n            [\n              {\n                \"node\": \"Lookup Staging Folder\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare UNKNOWN Client Data\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Execute Chunk 0 - Create Folders (UNKNOWN)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Lookup Staging Folder\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Filter Staging Folder ID\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Filter Staging Folder ID\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Check Routing Decision\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Extract 38_Unknowns Folder ID\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Validate Folder IDs\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Validate Folder IDs\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Move PDF to 38_Unknowns\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Move PDF to 38_Unknowns\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare Email Notification Data\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare Email Notification Data\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Build Email HTML Body\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Build Email HTML Body\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Send Email Notification\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Handle Unidentified Client\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare UNKNOWN Client Data\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Check Routing Decision\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare Missing Folder Error\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ],\n            [\n              {\n                \"node\": \"Move PDF to _Staging (EXISTING)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare Missing Folder Error\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare Registry Error Email Data\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare Registry Error Email Data\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Send Registry Error Email\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Send Registry Error Email\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Move to 38_Unknowns (Registry Error)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Move to 38_Unknowns (Registry Error)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Mark Email as Read (Registry Error)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Mark Email as Read (Registry Error)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"NoOp - Registry Error Complete\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Merge Chunk 0 Output (NEW)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Move PDF to _Staging (NEW)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare for Chunk 2 (NEW)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Execute Chunk 2 (NEW)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Execute Chunk 2 (NEW)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Mark Email as Read (NEW)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Mark Email as Read (NEW)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"NoOp - NEW Complete\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare for Chunk 2 (EXISTING)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Execute Chunk 2 (EXISTING)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Execute Chunk 2 (EXISTING)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Mark Email as Read (EXISTING)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Mark Email as Read (EXISTING)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"NoOp - EXISTING Complete\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Move PDF to _Staging (NEW)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare for Chunk 2 (NEW)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Execute Chunk 0 - Create Folders (UNKNOWN)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Extract 38_Unknowns Folder ID\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Execute Chunk 0 - Create Folders (NEW)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Merge Chunk 0 Output (NEW)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Move PDF to _Staging (EXISTING)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Wait After Staging (EXISTING)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Wait After Staging (EXISTING)\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Prepare for Chunk 2 (EXISTING)\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Prepare Document AI Request\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Call Document AI OCR\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Call Document AI OCR\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Parse Document AI Response\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        },\n        \"Parse Document AI Response\": {\n          \"main\": [\n            [\n              {\n                \"node\": \"Evaluate Extraction Quality\",\n                \"type\": \"main\",\n                \"index\": 0\n              }\n            ]\n          ]\n        }\n      },\n      \"authors\": \"Sway Clarke\",\n      \"name\": null,\n      \"description\": null,\n      \"autosaved\": false,\n      \"workflowPublishHistory\": [\n        {\n          \"createdAt\": \"2026-01-17T10:30:06.400Z\",\n          \"id\": 866,\n          \"workflowId\": \"YGXWjWcBIk66ArvT\",\n          \"versionId\": \"d513e84d-0121-4a86-8d9a-2d8fec28ba91\",\n          \"event\": \"activated\",\n          \"userId\": \"e9bd9112-c2e3-4f67-873a-e1001baeafd8\"\n        }\n      ]\n    }\n  }\n}"
  }
]