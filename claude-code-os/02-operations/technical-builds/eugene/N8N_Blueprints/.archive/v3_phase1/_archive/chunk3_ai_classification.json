{
  "name": "Chunk 3: AI Classification 2-Level (Document Organizer V3)",
  "nodes": [
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "temperature": 0.1,
          "maxTokens": 50
        },
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "You are a document classifier for German Bauträger (construction developer) projects.\n\nYour task is to classify documents into ONE of these 4 categories:\n\n1. **OBJEKTUNTERLAGEN** (Property Documents)\n   Documents related to the physical property: purchase contracts, land registers, building permits, construction plans, DIN calculations, site plans, insurance, appraisals.\n   Key terms: Kaufvertrag, Grundbuch, Baugenehmigung, DIN 276, DIN 277, Bauzeichnung, Lageplan\n\n2. **WIRTSCHAFTLICHE** (Economic/Financial Documents)\n   Financial statements, tax documents, income verification, asset overviews.\n   Key terms: Jahresabschluss, BWA, Steuernummer, SCHUFA, Einkommensteuerbescheid, Vermögensübersicht\n\n3. **RECHTLICHE** (Legal Documents)\n   Corporate legal documents, registrations, licenses.\n   Key terms: Handelsregister, Gesellschaftsvertrag, §34c GewO, Personalausweis\n\n4. **SONSTIGES** (Other/Custom Documents)\n   Exit strategies, liquidation plans, documents not matching above categories.\n   Key terms: Exit, Ausstiegsstrategie, ROI, Liquidation\n\nAnalyze the document and respond with ONLY the category name.\n\nReturn ONLY: OBJEKTUNTERLAGEN, WIRTSCHAFTLICHE, RECHTLICHE, or SONSTIGES"
            },
            {
              "role": "user",
              "content": "Classify this German document:\n\n={{ $json.textForClassification }}"
            }
          ]
        }
      },
      "name": "AI Level 1: Category Detection",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [250, 400],
      "id": "node-ai-level1",
      "credentials": {
        "openAiApi": {
          "id": "{{OPENAI_CREDENTIAL_ID}}",
          "name": "OpenAI API"
        }
      },
      "notes": "First classification level: determines main category (4 options)"
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toUpperCase() }}",
              "value2": "OBJEKTUNTERLAGEN",
              "output": 0
            },
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toUpperCase() }}",
              "value2": "WIRTSCHAFTLICHE",
              "output": 1
            },
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toUpperCase() }}",
              "value2": "RECHTLICHE",
              "output": 2
            },
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toUpperCase() }}",
              "value2": "SONSTIGES",
              "output": 3
            }
          ],
          "fallbackOutput": 4
        },
        "options": {}
      },
      "name": "Switch: Route by Category",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [450, 400],
      "id": "node-category-switch",
      "notes": "Routes to Level 2 classification based on category. Fallback goes to UNKNOWN."
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "temperature": 0.1,
          "maxTokens": 50
        },
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "You are classifying a German OBJEKTUNTERLAGEN (property document).\n\nFor Phase 1, identify if this is ONE of these 3 priority types:\n\n1. **expose** - Project description, Exposé, Projektbeschreibung, teaser, property overview\n   Key indicators: \"Exposé\", \"Projektbeschreibung\", overview of property, marketing description\n\n2. **grundbuch** - Land register extract, Grundbuchauszug\n   Key indicators: \"Grundbuch\", \"Abteilung I/II/III\", property ownership records, \"Amtsgericht\"\n\n3. **calculation** - Developer calculation according to DIN 276, Bauträgerkalkulation\n   Key indicators: \"DIN 276\", \"Kostenberechnung\", \"Baukosten\", cost breakdown, development calculation\n\nIf the document matches ANY of these 3 types, return that type name.\nIf it is a different OBJEKTUNTERLAGEN type (Baugenehmigung, Kaufvertrag, Bauzeichnung, etc.), return: others\n\nReturn ONLY ONE of: expose, grundbuch, calculation, others"
            },
            {
              "role": "user",
              "content": "Classify this OBJEKTUNTERLAGEN document:\n\n={{ $json.textForClassification }}"
            }
          ]
        }
      },
      "name": "AI Level 2: Objektunterlagen Priority",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [650, 200],
      "id": "node-ai-level2-obj",
      "credentials": {
        "openAiApi": {
          "id": "{{OPENAI_CREDENTIAL_ID}}",
          "name": "OpenAI API"
        }
      },
      "notes": "Checks if OBJEKTUNTERLAGEN doc is one of 3 priorities (expose, grundbuch, calculation) or others"
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "temperature": 0.1,
          "maxTokens": 50
        },
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "You are classifying a German SONSTIGES (other) document.\n\nCheck if this is an EXIT STRATEGY document:\n\n**exitstrategie** - Exit strategy, liquidation plan, ROI projections, property sale timeline\n   Key indicators: \"Exit\", \"Ausstiegsstrategie\", \"Liquidation\", \"Verkaufsstrategie\", \"ROI\", \"Rendite\", timeline for selling\n\nIf it is an exit strategy, return: exitstrategie\nIf it is any other document type, return: others\n\nReturn ONLY: exitstrategie or others"
            },
            {
              "role": "user",
              "content": "Check if this is an exit strategy document:\n\n={{ $json.textForClassification }}"
            }
          ]
        }
      },
      "name": "AI Level 2: Check Exit Strategy",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [650, 600],
      "id": "node-ai-level2-sonstiges",
      "credentials": {
        "openAiApi": {
          "id": "{{OPENAI_CREDENTIAL_ID}}",
          "name": "OpenAI API"
        }
      },
      "notes": "Checks if SONSTIGES doc is exit strategy or generic other"
    },
    {
      "parameters": {
        "jsCode": "// WIRTSCHAFTLICHE and RECHTLICHE documents go to 'others' in Phase 1\n// They are valid documents but not priority - Eugene will manually sort\n\nconst items = $input.all();\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    documentType: 'others',\n    typeReason: 'Non-priority category (WIRTSCHAFTLICHE or RECHTLICHE)',\n    manualSortRequired: true\n  },\n  binary: item.binary\n}));"
      },
      "name": "Set Type: Others (Non-Priority Category)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400],
      "id": "node-set-others-nonpriority",
      "notes": "WIRTSCHAFTLICHE and RECHTLICHE docs go to Others folder in Phase 1"
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toLowerCase() }}",
              "value2": "expose",
              "output": 0
            },
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toLowerCase() }}",
              "value2": "grundbuch",
              "output": 1
            },
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toLowerCase() }}",
              "value2": "calculation",
              "output": 2
            },
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toLowerCase() }}",
              "value2": "others",
              "output": 3
            }
          ],
          "fallbackOutput": 3
        },
        "options": {}
      },
      "name": "Switch: Objektunterlagen Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [850, 200],
      "id": "node-obj-type-switch",
      "notes": "Routes to specific type or Others based on Level 2 classification"
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toLowerCase() }}",
              "value2": "exitstrategie",
              "output": 0
            },
            {
              "operation": "contains",
              "value1": "={{ $json.choices[0].message.content.toLowerCase() }}",
              "value2": "others",
              "output": 1
            }
          ],
          "fallbackOutput": 1
        },
        "options": {}
      },
      "name": "Switch: Exit or Others",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [850, 600],
      "id": "node-exit-type-switch",
      "notes": "Routes exit strategy to its folder, others to Others folder"
    },
    {
      "parameters": {
        "jsCode": "// Set filename prefix and routing info for each document type\n// V3.5 UPDATE: Added timestamp to filename for guaranteed uniqueness\n\nconst items = $input.all();\nconst documentType = '{{ $parameter.documentType }}';\nconst clientName = $vars.CLIENT_NAME || 'Eugene';\n\n// Generate date and time for filename\nconst now = new Date();\nconst date = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD\nconst time = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHMMSS\n\nconst typeConfig = {\n  'expose': {\n    prefix: 'EXPOSE',\n    folderPath: 'OBJEKTUNTERLAGEN/01_Projektbeschreibung/',\n    folderVar: 'FOLDER_01_PROJEKTBESCHREIBUNG'\n  },\n  'grundbuch': {\n    prefix: 'GRUNDBUCH',\n    folderPath: 'OBJEKTUNTERLAGEN/03_Grundbuchauszug/',\n    folderVar: 'FOLDER_03_GRUNDBUCHAUSZUG'\n  },\n  'calculation': {\n    prefix: 'KALK276',\n    folderPath: 'OBJEKTUNTERLAGEN/10_Bautraegerkalkulation_DIN276/',\n    folderVar: 'FOLDER_10_BAUTRAEGERKALKULATION'\n  },\n  'exitstrategie': {\n    prefix: 'EXIT',\n    folderPath: 'SONSTIGES/36_Exit_Strategie/',\n    folderVar: 'FOLDER_36_EXIT_STRATEGIE'\n  },\n  'others': {\n    prefix: 'OTHERS',\n    folderPath: 'SONSTIGES/37_Others/',\n    folderVar: 'FOLDER_37_OTHERS'\n  },\n  'unknown': {\n    prefix: 'UNKNOWN',\n    folderPath: 'SONSTIGES/38_Unknowns/',\n    folderVar: 'FOLDER_38_UNKNOWNS'\n  }\n};\n\nconst config = typeConfig[documentType] || typeConfig['unknown'];\nconst originalExt = (items[0].json.originalFileName || 'document.pdf').split('.').pop();\n// Updated format: PREFIX_CLIENT_DATE_TIME.ext (e.g., EXPOSE_Eugene_20251221_143052.pdf)\nconst newFileName = `${config.prefix}_${clientName}_${date}_${time}.${originalExt}`;\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    documentType: documentType,\n    newFileName: newFileName,\n    targetFolderPath: config.folderPath,\n    targetFolderVar: config.folderVar,\n    filePrefix: config.prefix,\n    clientName: clientName,\n    processedDate: date,\n    processedTime: time\n  },\n  binary: item.binary\n}));"
      },
      "name": "Set Filename: Expose",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 100],
      "id": "node-set-filename-expose",
      "notes": "Sets EXPOSE prefix and routing to 01_Projektbeschreibung folder (V3.5: added timestamp)"
    },
    {
      "parameters": {
        "jsCode": "// V3.5 UPDATE: Added timestamp to filename for guaranteed uniqueness\nconst items = $input.all();\nconst clientName = $vars.CLIENT_NAME || 'Eugene';\n\n// Generate date and time for filename\nconst now = new Date();\nconst date = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD\nconst time = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHMMSS\n\nconst originalExt = (items[0].json.originalFileName || 'document.pdf').split('.').pop();\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    documentType: 'grundbuch',\n    newFileName: `GRUNDBUCH_${clientName}_${date}_${time}.${originalExt}`,\n    targetFolderPath: 'OBJEKTUNTERLAGEN/03_Grundbuchauszug/',\n    targetFolderVar: 'FOLDER_03_GRUNDBUCHAUSZUG',\n    filePrefix: 'GRUNDBUCH',\n    clientName: clientName,\n    processedDate: date,\n    processedTime: time\n  },\n  binary: item.binary\n}));"
      },
      "name": "Set Filename: Grundbuch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 200],
      "id": "node-set-filename-grundbuch",
      "notes": "Sets GRUNDBUCH prefix and routing to 03_Grundbuchauszug folder (V3.5: added timestamp)"
    },
    {
      "parameters": {
        "jsCode": "// V3.5 UPDATE: Added timestamp to filename for guaranteed uniqueness\nconst items = $input.all();\nconst clientName = $vars.CLIENT_NAME || 'Eugene';\n\n// Generate date and time for filename\nconst now = new Date();\nconst date = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD\nconst time = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHMMSS\n\nconst originalExt = (items[0].json.originalFileName || 'document.pdf').split('.').pop();\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    documentType: 'calculation',\n    newFileName: `KALK276_${clientName}_${date}_${time}.${originalExt}`,\n    targetFolderPath: 'OBJEKTUNTERLAGEN/10_Bautraegerkalkulation_DIN276/',\n    targetFolderVar: 'FOLDER_10_BAUTRAEGERKALKULATION',\n    filePrefix: 'KALK276',\n    clientName: clientName,\n    processedDate: date,\n    processedTime: time\n  },\n  binary: item.binary\n}));"
      },
      "name": "Set Filename: Calculation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300],
      "id": "node-set-filename-calculation",
      "notes": "Sets KALK276 prefix and routing to 10_Bautraegerkalkulation folder (V3.5: added timestamp)"
    },
    {
      "parameters": {
        "jsCode": "// V3.5 UPDATE: Added timestamp to filename for guaranteed uniqueness\nconst items = $input.all();\nconst clientName = $vars.CLIENT_NAME || 'Eugene';\n\n// Generate date and time for filename\nconst now = new Date();\nconst date = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD\nconst time = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHMMSS\n\nconst originalExt = (items[0].json.originalFileName || 'document.pdf').split('.').pop();\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    documentType: 'exitstrategie',\n    newFileName: `EXIT_${clientName}_${date}_${time}.${originalExt}`,\n    targetFolderPath: 'SONSTIGES/36_Exit_Strategie/',\n    targetFolderVar: 'FOLDER_36_EXIT_STRATEGIE',\n    filePrefix: 'EXIT',\n    clientName: clientName,\n    processedDate: date,\n    processedTime: time\n  },\n  binary: item.binary\n}));"
      },
      "name": "Set Filename: Exit Strategy",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 550],
      "id": "node-set-filename-exit",
      "notes": "Sets EXIT prefix and routing to 36_Exit_Strategie folder (V3.5: added timestamp)"
    },
    {
      "parameters": {
        "jsCode": "// V3.5 UPDATE: Added timestamp to filename for guaranteed uniqueness\nconst items = $input.all();\nconst clientName = $vars.CLIENT_NAME || 'Eugene';\n\n// Generate date and time for filename\nconst now = new Date();\nconst date = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD\nconst time = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHMMSS\n\nconst originalExt = (items[0].json.originalFileName || 'document.pdf').split('.').pop();\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    documentType: 'others',\n    newFileName: `OTHERS_${clientName}_${date}_${time}.${originalExt}`,\n    targetFolderPath: 'SONSTIGES/37_Others/',\n    targetFolderVar: 'FOLDER_37_OTHERS',\n    filePrefix: 'OTHERS',\n    clientName: clientName,\n    processedDate: date,\n    processedTime: time,\n    manualSortRequired: true\n  },\n  binary: item.binary\n}));"
      },
      "name": "Set Filename: Others",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 450],
      "id": "node-set-filename-others",
      "notes": "Sets OTHERS prefix - Eugene will manually sort these later (V3.5: added timestamp)"
    },
    {
      "parameters": {
        "jsCode": "// V3.5 UPDATE: Added timestamp to filename for guaranteed uniqueness\nconst items = $input.all();\nconst clientName = $vars.CLIENT_NAME || 'Eugene';\n\n// Generate date and time for filename\nconst now = new Date();\nconst date = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD\nconst time = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHMMSS\n\nconst originalExt = (items[0].json.originalFileName || 'document.pdf').split('.').pop();\n\nreturn items.map(item => ({\n  json: {\n    ...item.json,\n    documentType: 'unknown',\n    newFileName: `UNKNOWN_${clientName}_${date}_${time}.${originalExt}`,\n    targetFolderPath: 'SONSTIGES/38_Unknowns/',\n    targetFolderVar: 'FOLDER_38_UNKNOWNS',\n    filePrefix: 'UNKNOWN',\n    clientName: clientName,\n    processedDate: date,\n    processedTime: time,\n    manualReviewRequired: true,\n    classificationFailed: true\n  },\n  binary: item.binary\n}));"
      },
      "name": "Set Filename: Unknown",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 700],
      "id": "node-set-filename-unknown",
      "notes": "Sets UNKNOWN prefix - classification failed, needs manual review (V3.5: added timestamp)"
    },
    {
      "parameters": {
        "mode": "append",
        "options": {}
      },
      "name": "Merge All Classified",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1250, 400],
      "id": "node-merge-classified",
      "notes": "Combines all classification branches into single stream for file operations"
    }
  ],
  "connections": {
    "AI Level 1: Category Detection": {
      "main": [
        [
          {
            "node": "Switch: Route by Category",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: Route by Category": {
      "main": [
        [
          {
            "node": "AI Level 2: Objektunterlagen Priority",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Type: Others (Non-Priority Category)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Type: Others (Non-Priority Category)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Level 2: Check Exit Strategy",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Filename: Unknown",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Level 2: Objektunterlagen Priority": {
      "main": [
        [
          {
            "node": "Switch: Objektunterlagen Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Level 2: Check Exit Strategy": {
      "main": [
        [
          {
            "node": "Switch: Exit or Others",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Type: Others (Non-Priority Category)": {
      "main": [
        [
          {
            "node": "Set Filename: Others",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: Objektunterlagen Type": {
      "main": [
        [
          {
            "node": "Set Filename: Expose",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Filename: Grundbuch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Filename: Calculation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Filename: Others",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: Exit or Others": {
      "main": [
        [
          {
            "node": "Set Filename: Exit Strategy",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Filename: Others",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Filename: Expose": {
      "main": [
        [
          {
            "node": "Merge All Classified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Filename: Grundbuch": {
      "main": [
        [
          {
            "node": "Merge All Classified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Filename: Calculation": {
      "main": [
        [
          {
            "node": "Merge All Classified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Filename: Exit Strategy": {
      "main": [
        [
          {
            "node": "Merge All Classified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Filename: Others": {
      "main": [
        [
          {
            "node": "Merge All Classified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Filename: Unknown": {
      "main": [
        [
          {
            "node": "Merge All Classified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": false
  },
  "versionId": "v3-chunk3-2025-12-21"
}
