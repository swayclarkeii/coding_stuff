{"breakpointLocation":"NONE","browserLog":false,"closeCookieModals":true,"debugLog":true,"downloadCss":true,"downloadMedia":true,"globs":["https://baliexception.com/**","https://www.estate-lombok.com/**","https://www.southlomboklandsales.com/**","https://www.majuproperties.com/**"],"headless":true,"ignoreCorsAndCsp":false,"ignoreSslErrors":false,"injectJQuery":true,"injectUnderscore":false,"keepUrlFragments":false,"linkSelector":"a[href*=\"/property/\"], a[href*=\"/properties/\"], a[href*=\"/villas-for-sale\"], a[href*=\"/villa/\"], a.property-card, a.listing-item","maxConcurrency":1,"maxCrawlingDepth":2,"maxInfiniteScrollHeight":0,"maxPagesPerCrawl":100,"maxRequestRetries":3,"maxResultsPerCrawl":100,"maxScrollHeightPixels":0,"pageFunction":"async function pageFunction(context) {\n    const { request, log } = context;\n    const url = request.url;\n\n    // === BALI REGION REJECTION (CRITICAL FIX) ===\n    // Skip Bali regions from Bali Exception - these were incorrectly scraped in previous run\n    if (url.includes('baliexception.com')) {\n        const baliRegions = ['/uluwatu/', '/legian/', '/canggu/', '/ubud/', \n                             '/seminyak/', '/karangasem/', '/tabanan/', '/bingin/', \n                             '/pererenan/', '/sanur/', '/denpasar/', '/jimbaran/',\n                             '/nusa-dua/', '/kerobokan/', '/berawa/', '/echo-beach/'];\n        for (const region of baliRegions) {\n            if (url.toLowerCase().includes(region)) {\n                log.info('SKIPPED (Bali region, not Lombok):', url);\n                return null;\n            }\n        }\n        // Also require 'lombok' in the URL path for Bali Exception\n        if (!url.toLowerCase().includes('/lombok/') && !url.toLowerCase().includes('lombok')) {\n            log.info('SKIPPED (Not a Lombok URL):', url);\n            return null;\n        }\n    }\n\n    // === PROPERTY PAGE DETECTION ===\n    const isPropertyPage = \n        // Bali Exception: property detail pages in the filtered results (MUST be Lombok)\n        (url.includes('baliexception.com') && \n         (url.includes('/properties/for-sale/') || url.includes('/property/')) &&\n         url.toLowerCase().includes('/lombok/')) ||\n        // Estate Lombok: villa detail pages\n        (url.includes('estate-lombok.com') && \n         (url.includes('/villas-for-sale-lombok/') || url.includes('/en/villa/'))) ||\n        // South Lombok Land Sales: /property/[name]/[id] format\n        (url.includes('southlomboklandsales.com') && \n         url.includes('/property/') && \n         url.split('/property/')[1] && \n         url.split('/property/')[1].includes('/')) ||\n        // Maju Properties: /property/[slug] or /properties/[slug]\n        (url.includes('majuproperties.com') && \n         (url.includes('/property/') || url.includes('/properties/')) &&\n         url !== 'https://www.majuproperties.com/properties' &&\n         !url.includes('?type='));\n\n    // === LISTING PAGES TO SKIP ===\n    const isListingPage = \n        // Bali Exception main area page\n        url === 'https://baliexception.com/area/lombok/' ||\n        url.match(/baliexception\\.com\\/area\\/lombok\\/?$/) ||\n        // Estate Lombok main listing page\n        url === 'https://www.estate-lombok.com/en/villas-for-sale-lombok' ||\n        url.match(/estate-lombok\\.com\\/en\\/villas-for-sale-lombok\\/?$/) ||\n        // South Lombok Land Sales main listing\n        url === 'https://www.southlomboklandsales.com/property' ||\n        // Maju Properties listing with filters\n        url.includes('majuproperties.com/properties?');\n\n    if (!isPropertyPage || isListingPage) {\n        log.info('SKIPPED (listing/non-property):', url);\n        return null;\n    }\n\n    // === EXTRACT DATA WITH IMPROVED CSS SELECTORS ===\n    const bodyText = document.body.innerText;\n    \n    // Try multiple selectors for title (site-specific)\n    let title = '';\n    const titleSelectors = [\n        'h1.property-title',\n        'h1.entry-title', \n        '.property-header h1',\n        'h1.title',\n        'h1'\n    ];\n    for (const selector of titleSelectors) {\n        const elem = document.querySelector(selector);\n        if (elem && elem.innerText.trim()) {\n            title = elem.innerText.trim();\n            break;\n        }\n    }\n\n    // === PROPERTY TYPE DETECTION (EXCLUDE LAND) ===\n    let propertyType = 'Unknown';\n    if (bodyText.match(/\\bvilla\\b/i)) {\n        propertyType = 'Villa';\n    } else if (bodyText.match(/\\bapartment\\b/i)) {\n        propertyType = 'Apartment';\n    } else if (bodyText.match(/\\bhouse\\b/i)) {\n        propertyType = 'House';\n    } else if (bodyText.match(/\\bresort\\b/i)) {\n        propertyType = 'Resort';\n    } else if (bodyText.match(/\\bbungalow\\b/i)) {\n        propertyType = 'Bungalow';\n    } else if (bodyText.match(/\\bland\\b/i) || bodyText.match(/\\blot\\b/i) || bodyText.match(/\\bplot\\b/i)) {\n        propertyType = 'Land';\n    }\n\n    // === SKIP LAND PROPERTIES (USER DOESN'T WANT THEM) ===\n    if (propertyType === 'Land') {\n        log.info('SKIPPED (land property):', url, '- User only wants villas/apartments');\n        return null;\n    }\n\n    // === CONSTRUCTION STATUS DETECTION (v4 logic from Task 1 + Bali Exception) ===\n    let constructionStatus = 'Unknown';\n    if (bodyText.match(/\\bbuilt\\b/i) ||\n        bodyText.match(/\\bcompleted\\b/i) ||\n        bodyText.match(/\\bready to move\\b/i) ||\n        bodyText.match(/\\bmove-in ready\\b/i) ||\n        bodyText.match(/\\bready now\\b/i) ||          // NEW - Bali Exception\n        bodyText.match(/\\brenovated\\b/i)) {\n        constructionStatus = 'Completed';\n    }\n    else if (bodyText.match(/\\boff[\\s-]?plan\\b/i) ||\n             bodyText.match(/\\bpre-construction\\b/i)) {\n        constructionStatus = 'Off-Plan';\n    }\n    else if (bodyText.match(/\\bunder construction\\b/i) ||\n             bodyText.match(/\\bin construction\\b/i) ||\n             bodyText.match(/\\bin progress\\b/i) ||\n             bodyText.match(/\\bbeing built\\b/i) ||\n             bodyText.match(/\\bcompletion\\b/i) ||\n             bodyText.match(/\\bavailable from\\b/i) ||\n             bodyText.match(/\\bdelivery\\b/i) ||\n             bodyText.match(/\\bhandover\\b/i)) {\n        constructionStatus = 'Under Construction';\n    }\n\n    // === YEAR BUILT DETECTION (flexible formats) ===\n    let yearBuilt = '';\n\n    // Pattern 1: Standard format (year built: 2025, construction: 2026, completion: 2026)\n    const yearMatch1 = bodyText.match(/(?:year\\s+built|built|construction|completion)\\s*:?\\s*(20\\d{2})/i);\n    if (yearMatch1) {\n        yearBuilt = yearMatch1[1];\n    }\n\n    // Pattern 2: Month + Year format (December 2026, January 2026)\n    if (!yearBuilt) {\n        const yearMatch2 = bodyText.match(/(?:january|february|march|april|may|june|july|august|september|october|november|december)\\s+(20\\d{2})/i);\n        if (yearMatch2) {\n            yearBuilt = yearMatch2[1];\n        }\n    }\n\n    // Pattern 3: Context-based (find year near completion/construction/available/delivery)\n    if (!yearBuilt) {\n        const yearMatch3 = bodyText.match(/(?:completion|construction|available|delivery|handover)[^.]*?(20\\d{2})/i);\n        if (yearMatch3) {\n            yearBuilt = yearMatch3[1];\n        }\n    }\n\n    // === FUTURE YEAR VALIDATION (v4 fix) ===\n    if (yearBuilt) {\n        const currentYear = new Date().getFullYear();\n        const propYear = parseInt(yearBuilt, 10);\n\n        // Future year = ALWAYS under construction (override any keyword-based status)\n        if (propYear > currentYear) {\n            constructionStatus = 'Under Construction';\n        }\n    }\n\n    // === PRICE EXTRACTION (Multi-format with CSS selectors first) ===\n    let priceRaw = '';\n    \n    // Try CSS selectors first (more reliable)\n    const priceSelectors = [\n        '.property-price',\n        '.price',\n        'span.price',\n        'div.price',\n        '.listing-price',\n        '.property-meta-price'\n    ];\n    for (const selector of priceSelectors) {\n        const elem = document.querySelector(selector);\n        if (elem && elem.innerText.trim()) {\n            priceRaw = elem.innerText.trim();\n            break;\n        }\n    }\n    \n    // Fallback to regex patterns if CSS selectors fail\n    if (!priceRaw) {\n        const pricePatterns = [\n            /USD\\s*[\\d,.]+/gi,                                      // USD 285000\n            /\\$\\s*[\\d,]+\\.?\\d*/gi,                                  // $285,000 or $285K\n            /Rp\\s*[\\d.,]+\\s*(B|Billion|M|Million|Miliar|Juta)?/gi, // IDR: Rp 3.60 Billion\n            /IDR\\s*[\\d.,]+/gi,                                      // IDR 3600000000\n            /€\\s*[\\d,.]+/gi,                                        // EUR: €285,000\n            /EUR\\s*[\\d,.]+/gi                                       // EUR 285000\n        ];\n\n        for (const pattern of pricePatterns) {\n            const matches = bodyText.match(pattern);\n            if (matches && matches.length > 0) {\n                priceRaw = matches[0];\n                break;\n            }\n        }\n    }\n\n    // === OWNERSHIP EXTRACTION ===\n    let ownership = '';\n    if (bodyText.match(/\\bHGB\\b/i)) {\n        ownership = 'HGB';\n    } else if (bodyText.match(/\\bFreehold\\b/i)) {\n        ownership = 'Freehold';\n    } else if (bodyText.match(/\\bLeasehold\\b/i)) {\n        ownership = 'Leasehold';\n    }\n\n    // === STATUS EXTRACTION ===\n    let status = '';\n    if (bodyText.match(/\\bFor Sale\\b/i) || bodyText.match(/\\bSale\\b/i)) {\n        status = 'For Sale';\n    } else if (bodyText.match(/\\bSold\\b/i)) {\n        status = 'Sold';\n    } else if (bodyText.match(/\\bFor Rent\\b/i) || bodyText.match(/\\bLease\\b/i)) {\n        status = 'For Rent';\n    }\n\n    // === LOCATION FLAGS ===\n    const hasKuta = bodyText.toLowerCase().includes('kuta');\n    const hasSelong = bodyText.toLowerCase().includes('selong');\n    const hasMandalika = bodyText.toLowerCase().includes('mandalika');\n    const hasFreehold = bodyText.toLowerCase().includes('freehold');\n    const hasLeasehold = bodyText.toLowerCase().includes('leasehold');\n\n    // === SOURCE DETECTION ===\n    let source = 'Unknown';\n    if (url.includes('baliexception.com')) source = 'Bali Exception';\n    else if (url.includes('estate-lombok.com')) source = 'Estate Lombok';\n    else if (url.includes('southlomboklandsales.com')) source = 'South Lombok Land Sales';\n    else if (url.includes('majuproperties.com')) source = 'Maju Properties';\n\n    log.info('EXTRACTED:', title, '| Price:', priceRaw, '| Construction:', constructionStatus, '| Year:', yearBuilt, '| Type:', propertyType, '| Source:', source);\n\n    return {\n        url: url,\n        title: title,\n        priceRaw: priceRaw,\n        ownership: ownership,\n        status: status,\n        constructionStatus: constructionStatus,\n        yearBuilt: yearBuilt,\n        propertyType: propertyType,\n        source: source,\n        hasKuta: hasKuta,\n        hasSelong: hasSelong,\n        hasMandalika: hasMandalika,\n        hasFreehold: hasFreehold,\n        hasLeasehold: hasLeasehold,\n        scrapedAt: new Date().toISOString()\n    };\n}","pageFunctionTimeoutSecs":60,"pageLoadTimeoutSecs":60,"proxyConfiguration":{"useApifyProxy":true},"respectRobotsTxtFile":false,"startUrls":[{"url":"https://baliexception.com/area/lombok/"},{"url":"https://www.estate-lombok.com/en/villas-for-sale-lombok"},{"url":"https://www.southlomboklandsales.com/property"},{"url":"https://www.majuproperties.com/properties?type=villa&location=kuta"}],"useChrome":false,"useStealth":false,"waitUntil":["networkidle2"],"runMode":"PRODUCTION","pseudoUrls":[],"excludes":[],"proxyRotation":"RECOMMENDED","initialCookies":[],"customData":{}}
