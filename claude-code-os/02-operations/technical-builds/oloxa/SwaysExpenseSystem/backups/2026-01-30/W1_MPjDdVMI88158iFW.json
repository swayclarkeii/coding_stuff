{"updatedAt":"2026-01-30T21:35:09.365Z","createdAt":"2026-01-02T10:12:47.693Z","id":"MPjDdVMI88158iFW","name":"Expense System - Workflow 1: PDF Intake & Parsing","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"triggerOn":"specificFolder","folderToWatch":{"__rl":true,"value":"1UYhIP6Nontc2vuE2G1aMvkggaEk6szv8","mode":"id"},"event":"fileCreated","options":{}},"id":"57e59b24-d291-4209-8a91-59a61c13fdb4","name":"Watch Bank Statements Folder","type":"n8n-nodes-base.googleDriveTrigger","typeVersion":1,"position":[272,336],"credentials":{"googleDriveOAuth2Api":{"id":"a4m50EefR3DJoU0R","name":"Google Drive account"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"mode":"id","value":"={{($json.body && $json.body.id) || $json.id}}"},"options":{}},"id":"2ac5e2bf-bb6d-425c-8d5b-b74b8cc502db","name":"Download PDF","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[496,432],"credentials":{"googleDriveOAuth2Api":{"id":"a4m50EefR3DJoU0R","name":"Google Drive account"}}},{"parameters":{"jsCode":"// Extract metadata from the PDF file\nconst item = $input.first();\n\n// Handle both webhook (binary) and Google Drive trigger (json)\nconst fileName = item.binary?.data?.fileName || item.json.name || (item.json.path ? item.json.path.split('/').pop() : null);\n\n// Get fileId - try webhook trigger first, then Drive trigger, then item.json\nlet fileId = 'unknown-file';\ntry {\n  const webhookData = $('Webhook Trigger (Testing)').all();\n  if (webhookData.length > 0) {\n    const webhookJson = webhookData[0].json;\n    fileId = (webhookJson.body && webhookJson.body.id) || webhookJson.id || 'webhook-upload';\n  }\n} catch (e) {\n  // Webhook trigger not executed, try Drive trigger\n  try {\n    const driveData = $('Watch Bank Statements Folder').all();\n    if (driveData.length > 0) {\n      fileId = driveData[0].json.id || 'drive-trigger';\n    }\n  } catch (e2) {\n    // Neither trigger executed, use item.json\n    fileId = item.json.id || 'unknown-file';\n  }\n}\n\nif (!fileName) {\n  throw new Error('Could not extract filename from trigger data. Available data: ' + JSON.stringify({json: Object.keys(item.json), binary: Object.keys(item.binary || {})}));\n}\n\n// Parse bank from filename - supports TWO formats:\n// Format A: \"BankName_\" (e.g., \"ING_2025-01_Statement.pdf\")\n// Format B: \"BankName - \" (e.g., \"Barclay - Sep 2025.pdf\")\nlet bankMatch = fileName.match(/^([A-Za-z&-]+)_/);\nif (!bankMatch) {\n  // Try space-dash-space format\n  // FIXED: Removed hyphen from character class to avoid greedy matching\n  bankMatch = fileName.match(/^([A-Za-z& ]+)\\s-\\s/);\n}\nconst bank = bankMatch ? bankMatch[1].trim() : 'Unknown';\n\n// Parse month/year from filename - supports THREE formats:\n// Format 1: ING_2025-11_Statement.pdf (YYYY-MM)\n// Format 2: Miles&More_Nov2025_Statement.pdf (TextMonth+YYYY, no space)\n// Format 3: Barclay - Sep 2025.pdf (TextMonth YYYY, with space)\n\nlet year, month;\n\n// Try YYYY-MM format first (Format 1)\nconst numericMatch = fileName.match(/_([0-9]{4})-([0-9]{2})_/);\nif (numericMatch) {\n  year = numericMatch[1];\n  month = numericMatch[2];\n} else {\n  // Try TextMonth+YYYY format (Format 2: Nov2025, DEC2025)\n  const textMonthMatch = fileName.match(/_(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)([0-9]{4})_/i);\n  if (textMonthMatch) {\n    const monthText = textMonthMatch[1].toLowerCase();\n    const monthMap = {\n      'jan': '01', 'january': '01',\n      'feb': '02', 'february': '02',\n      'mar': '03', 'march': '03',\n      'apr': '04', 'april': '04',\n      'may': '05',\n      'jun': '06', 'june': '06',\n      'jul': '07', 'july': '07',\n      'aug': '08', 'august': '08',\n      'sep': '09', 'september': '09',\n      'oct': '10', 'october': '10',\n      'nov': '11', 'november': '11',\n      'dec': '12', 'december': '12'\n    };\n    month = monthMap[monthText];\n    year = textMonthMatch[2];\n  } else {\n    // Try \"Month YYYY\" format (Format 3: Sep 2025, September 2025)\n    const spaceMonthMatch = fileName.match(/\\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)\\s([0-9]{4})/i);\n    if (spaceMonthMatch) {\n      const monthText = spaceMonthMatch[1].toLowerCase();\n      const monthMap = {\n        'jan': '01', 'january': '01',\n        'feb': '02', 'february': '02',\n        'mar': '03', 'march': '03',\n        'apr': '04', 'april': '04',\n        'may': '05',\n        'jun': '06', 'june': '06',\n        'jul': '07', 'july': '07',\n        'aug': '08', 'august': '08',\n        'sep': '09', 'september': '09',\n        'oct': '10', 'october': '10',\n        'nov': '11', 'november': '11',\n        'dec': '12', 'december': '12'\n      };\n      month = monthMap[monthText];\n      year = spaceMonthMatch[2];\n    } else {\n      // Fallback to current date\n      year = new Date().getFullYear().toString();\n      month = (new Date().getMonth() + 1).toString().padStart(2, '0');\n    }\n  }\n}\n\n// Generate statement ID\nconst statementId = `STMT-${bank}-${year}${month}-${Date.now()}`;\n\n// ✅ CORRECT: Preserve entire binary object (not nested)\nreturn {\n  json: {\n    fileName,\n    fileId,\n    bank,\n    year,\n    month,\n    statementId\n  },\n  binary: item.binary\n};"},"id":"67fb890a-f117-461f-a8e6-b88be91270af","name":"Extract File Metadata","type":"n8n-nodes-base.code","typeVersion":2,"position":[720,432]},{"parameters":{"method":"POST","url":"https://api.anthropic.com/v1/messages","authentication":"predefinedCredentialType","nodeCredentialType":"anthropicApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"anthropic-version","value":"2023-06-01"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.requestBody }}","options":{}},"id":"ac158557-c9bb-41bd-b782-4bdf4a21e359","name":"Parse PDF with Anthropic Vision","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,432],"credentials":{"openAiApi":{"id":"xmJ7t6kaKgMwA1ce","name":"OpenAi account"},"anthropicApi":{"id":"MRSNO4UW3OEIA3tQ","name":"Anthropic account"},"httpHeaderAuth":{"id":"vfoYopBRX35Znmq6","name":"Anthropic API key"}}},{"parameters":{"jsCode":"// Parse Anthropic response and prepare transaction data\nconst response = $input.first().json;\nconst textContent = response.content[0].text;\n\n// Strip markdown code fences if present (Anthropic wraps JSON in ```json...```)\nconst jsonText = textContent.replace(/^```json\\n?/, '').replace(/\\n?```$/, '').trim();\n\n// Parse the JSON\nconst parsedData = JSON.parse(jsonText);\n\n// Extract bank name from Claude's response (new format)\nconst bankFromVision = parsedData.bank || 'Unknown';\nconst transactions = parsedData.transactions || [];\n\nconst metadata = $('Extract File Metadata').first().json;\n\n// Generate new StatementID with correct bank from Vision AI\nconst statementId = `STMT-${bankFromVision}-${metadata.year}${metadata.month}-${Date.now()}`;\n\nreturn transactions.map((txn, index) => ({\n  json: {\n    TransactionID: `${statementId}-${(index + 1).toString().padStart(3, '0')}`,\n    Date: txn.date,\n    Bank: bankFromVision,\n    Amount: txn.amount.toString(),\n    Currency: txn.currency || 'EUR',\n    Description: txn.description,\n    Vendor: '',\n    Category: '',\n    ReceiptID: '',\n    StatementID: statementId,\n    MatchStatus: 'unmatched',\n    MatchConfidence: '0',\n    Notes: '',\n    Tags: '',\n    Type: 'expense',\n    AnnualInvoiceID: '',\n    _metadata: {\n      bankFromVision: bankFromVision,\n      transactionCount: transactions.length\n    }\n  }\n}));"},"id":"b7a79304-94aa-4a5f-b17d-b4724a3b4842","name":"Parse Anthropic Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1392,432]},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"id","value":"1l1uA8qA0DCGzGLBhmP2HqTzaajjbkURY2SLeqSuHMXM"},"sheetName":{"__rl":true,"mode":"name","value":"Transactions"},"columns":{"mappingMode":"defineBelow","value":{"TransactionID":"={{$json.TransactionID}}","Date":"={{$json.Date}}","Bank":"={{$json.Bank}}","Amount":"={{$json.Amount}}","Currency":"={{$json.Currency}}","Description":"={{$json.Description}}","Vendor":"={{$json.Vendor}}","Category":"={{$json.Category}}","ReceiptID":"={{$json.ReceiptID}}","StatementID":"={{$json.StatementID}}","MatchStatus":"={{$json.MatchStatus}}","MatchConfidence":"={{$json.MatchConfidence}}","Notes":"={{$json.Notes}}","Tags":"={{$json.Tags}}","Type":"={{$json.Type}}","AnnualInvoiceID":"={{$json.AnnualInvoiceID}}"},"matchingColumns":[],"schema":[{"id":"TransactionID","displayName":"TransactionID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Bank","displayName":"Bank","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Amount","displayName":"Amount","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Currency","displayName":"Currency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Description","displayName":"Description","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Vendor","displayName":"Vendor","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Category","displayName":"Category","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ReceiptID","displayName":"ReceiptID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"StatementID","displayName":"StatementID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"MatchStatus","displayName":"MatchStatus","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"MatchConfidence","displayName":"MatchConfidence","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Notes","displayName":"Notes","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Tags","displayName":"Tags","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"AnnualInvoiceID","displayName":"AnnualInvoiceID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"3c0e0cd8-934a-4c8e-9798-2363c1e1ac94","name":"Write Transactions to Database","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2512,336],"retryOnFail":true,"maxTries":5,"waitBetweenTries":15000,"credentials":{"googleSheetsOAuth2Api":{"id":"H7ewI1sOrDYabelt","name":"Google Sheets account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"id","value":"1l1uA8qA0DCGzGLBhmP2HqTzaajjbkURY2SLeqSuHMXM"},"sheetName":{"__rl":true,"mode":"name","value":"Statements"},"columns":{"mappingMode":"defineBelow","value":{"StatementID":"={{$json.StatementID}}","Bank":"={{$json.Bank}}","Month":"={{$json.Month}}","Year":"={{$json.Year}}","FileID":"={{$json.FileID}}","FilePath":"={{$json.FilePath}}","ProcessedDate":"={{$json.ProcessedDate}}","TransactionCount":"={{$json.TransactionCount}}"},"matchingColumns":[],"schema":[{"id":"StatementID","displayName":"StatementID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Bank","displayName":"Bank","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Month","displayName":"Month","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Year","displayName":"Year","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FileID","displayName":"FileID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FilePath","displayName":"FilePath","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ProcessedDate","displayName":"ProcessedDate","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"TransactionCount","displayName":"TransactionCount","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"ef9db69e-d93b-4da0-a2ba-4b256df8d9a8","name":"Log Statement Record","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[1840,528],"retryOnFail":true,"maxTries":5,"waitBetweenTries":15000,"credentials":{"googleSheetsOAuth2Api":{"id":"H7ewI1sOrDYabelt","name":"Google Sheets account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"move","fileId":{"__rl":true,"mode":"id","value":"={{$('Extract File Metadata').first().json.fileId}}"},"driveId":{"__rl":true,"mode":"list","value":"My Drive"},"folderId":{"__rl":true,"mode":"id","value":"1uohhbtaE6qvS08awMEYdVP6BqgRLxgjH"}},"id":"aa07e622-f2a6-4c1a-ae6a-779bc2ab0a05","name":"Move PDF to Archive","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2736,336],"credentials":{"googleDriveOAuth2Api":{"id":"a4m50EefR3DJoU0R","name":"Google Drive account"}}},{"parameters":{"jsCode":"// Build the Anthropic API request with proper binary handling for filesystem mode\nconst inputItem = $input.first();\nconst metadata = inputItem.json;\n\n// CRITICAL FIX for n8n 2.1.4 filesystem mode:\n// Use this.helpers.getBinaryDataBuffer() to read actual file from disk\nconst binaryPropertyName = 'data';\nconst binaryBuffer = await this.helpers.getBinaryDataBuffer(0, binaryPropertyName);\nconst base64Data = binaryBuffer.toString('base64');\n\n// Verify we got actual PDF data (should start with JVBERi... which is \"%PDF-\" in base64)\nif (base64Data.startsWith('ZmlsZXN5c3RlbS')) {\n  throw new Error('ERROR: Still encoding filesystem reference, not PDF bytes. Got: ' + base64Data.substring(0, 50));\n}\n\n// Additional validation: Check if it starts with valid PDF header\nif (!base64Data.startsWith('JVBERi')) {\n  throw new Error('ERROR: Base64 does not start with PDF magic bytes. Got: ' + base64Data.substring(0, 50));\n}\n\n// Build the complete Anthropic API request with DOCUMENT type\n// UPDATED: Ask Claude to identify the bank from PDF branding/header\nconst requestBody = {\n  model: \"claude-sonnet-4-5\",\n  max_tokens: 8192,\n  messages: [\n    {\n      role: \"user\",\n      content: [\n        {\n          type: \"text\",\n          text: \"You are a German bank statement parser. Extract the following from this bank statement:\\n\\n1. **Bank Name**: Identify which bank issued this statement (e.g., \\\"Barclay\\\", \\\"Miles & More\\\", \\\"ING\\\", etc.). Look at the logo, header, or footer.\\n2. **Transactions**: Extract all transactions as an array.\\n\\nReturn JSON in this format:\\n{\\n  \\\"bank\\\": \\\"BankName\\\",\\n  \\\"transactions\\\": [\\n    {\\\"date\\\": \\\"DD.MM.YYYY\\\", \\\"description\\\": \\\"...\\\", \\\"amount\\\": -123.45, \\\"currency\\\": \\\"EUR\\\"}\\n  ]\\n}\"\n        },\n        {\n          type: \"document\",\n          source: {\n            type: \"base64\",\n            media_type: \"application/pdf\",\n            data: base64Data\n          }\n        }\n      ]\n    }\n  ]\n};\n\n// Return the request body and metadata\nreturn {\n  json: {\n    requestBody: requestBody,\n    fileName: metadata.fileName,\n    fileId: metadata.fileId,\n    bankFromFilename: metadata.bank,\n    year: metadata.year,\n    month: metadata.month,\n    statementId: metadata.statementId\n  }\n};"},"id":"build-api-request-body","name":"Build Anthropic API Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[944,432],"notes":"FIXED: Uses this.helpers.getBinaryDataBuffer() for n8n 2.1.4 filesystem mode"},{"parameters":{"httpMethod":"POST","path":"process-bank-statement","options":{}},"id":"webhook-trigger-temp","name":"Webhook Trigger (Testing)","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[272,528],"webhookId":"269749e6-82e7-4207-b235-594e683e7c1d"},{"parameters":{"jsCode":"// Prepare single statement log entry\nconst transactions = $input.all();\nconst firstTransaction = transactions[0].json;\nconst metadata = $('Extract File Metadata').first().json;\n\nreturn {\n  json: {\n    StatementID: firstTransaction.StatementID,\n    Bank: firstTransaction.Bank,\n    Month: metadata.month,\n    Year: metadata.year,\n    FileID: metadata.fileId,\n    FilePath: metadata.fileName,\n    ProcessedDate: new Date().toISOString(),\n    TransactionCount: transactions.length\n  }\n};"},"id":"prepare-statement-log","name":"Prepare Statement Log","type":"n8n-nodes-base.code","typeVersion":2,"position":[1616,528]},{"parameters":{"jsCode":"// Pass through all transactions unchanged\n// They will be filtered after reading existing transactions\nreturn $input.all();"},"id":"check-duplicates","name":"Check for Duplicates","type":"n8n-nodes-base.code","typeVersion":2,"position":[1616,336]},{"parameters":{"documentId":{"mode":"id","value":"1l1uA8qA0DCGzGLBhmP2HqTzaajjbkURY2SLeqSuHMXM"},"sheetName":{"mode":"name","value":"Transactions"},"options":{}},"id":"read-existing-transactions","name":"Read Existing Transactions","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2064,336],"retryOnFail":true,"maxTries":5,"waitBetweenTries":15000,"credentials":{"googleSheetsOAuth2Api":{"id":"H7ewI1sOrDYabelt","name":"Google Sheets account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Get new transactions from Parse Response\nconst newTransactions = $('Parse Anthropic Response').all();\n\n// Get existing transactions from Google Sheets\nconst existingTransactions = $input.all();\n\n// Build set of existing keys for O(1) lookup\nconst existingKeys = new Set(\n  existingTransactions.map(item => \n    `${item.json.Date}_${item.json.Bank}_${item.json.Amount}_${item.json.Description}`\n  )\n);\n\n// Filter out duplicates\nconst uniqueTransactions = newTransactions.filter(item => {\n  const key = `${item.json.Date}_${item.json.Bank}_${item.json.Amount}_${item.json.Description}`;\n  const isDuplicate = existingKeys.has(key);\n  if (isDuplicate) {\n    console.log(`Skipping duplicate: ${key}`);\n  }\n  return !isDuplicate;\n});\n\nif (uniqueTransactions.length === 0) {\n  console.log('No new transactions to add (all duplicates)');\n  return [];\n}\n\nconsole.log(`Adding ${uniqueTransactions.length} new transactions (${newTransactions.length - uniqueTransactions.length} duplicates skipped)`);\n\nreturn uniqueTransactions;"},"id":"filter-non-duplicates","name":"Filter Non-Duplicates","type":"n8n-nodes-base.code","typeVersion":2,"position":[2288,336]},{"parameters":{"amount":60},"id":"wait-before-sheets-read","name":"Wait 60s (Rate Limit Buffer)","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1840,336],"webhookId":"bede71f7-8bc0-4d4a-a5e3-1bb89f32d909"}],"connections":{"Watch Bank Statements Folder":{"main":[[{"node":"Download PDF","type":"main","index":0}]]},"Download PDF":{"main":[[{"node":"Extract File Metadata","type":"main","index":0}]]},"Parse PDF with Anthropic Vision":{"main":[[{"node":"Parse Anthropic Response","type":"main","index":0}]]},"Parse Anthropic Response":{"main":[[{"node":"Prepare Statement Log","type":"main","index":0},{"node":"Check for Duplicates","type":"main","index":0}]]},"Write Transactions to Database":{"main":[[{"node":"Move PDF to Archive","type":"main","index":0}]]},"Extract File Metadata":{"main":[[{"node":"Build Anthropic API Request","type":"main","index":0}]]},"Build Anthropic API Request":{"main":[[{"node":"Parse PDF with Anthropic Vision","type":"main","index":0}]]},"Webhook Trigger (Testing)":{"main":[[{"node":"Download PDF","type":"main","index":0}]]},"Prepare Statement Log":{"main":[[{"node":"Log Statement Record","type":"main","index":0}]]},"Read Existing Transactions":{"main":[[{"node":"Filter Non-Duplicates","type":"main","index":0}]]},"Filter Non-Duplicates":{"main":[[{"node":"Write Transactions to Database","type":"main","index":0}]]},"Check for Duplicates":{"main":[[{"node":"Wait 60s (Rate Limit Buffer)","type":"main","index":0}]]},"Wait 60s (Rate Limit Buffer)":{"main":[[{"node":"Read Existing Transactions","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false,"callerPolicy":"workflowsFromSameOwner","timeSavedMode":"fixed"},"staticData":{"node:Watch Bank Statements Folder":{"lastTimeChecked":"2026-01-30T21:35:12Z"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"1ad542a2-d082-463f-a800-2d3037e1bf55","activeVersionId":"1ad542a2-d082-463f-a800-2d3037e1bf55","versionCounter":421,"triggerCount":2,"shared":[{"updatedAt":"2026-01-02T10:12:47.693Z","createdAt":"2026-01-02T10:12:47.693Z","role":"workflow:owner","workflowId":"MPjDdVMI88158iFW","projectId":"Rs8mhw052fnrzWZM","project":{"updatedAt":"2025-12-31T15:54:29.115Z","createdAt":"2025-12-31T15:27:33.865Z","id":"Rs8mhw052fnrzWZM","name":"Sway Clarke <sway@oloxa.ai>","type":"personal","icon":null,"description":null,"creatorId":"e9bd9112-c2e3-4f67-873a-e1001baeafd8","projectRelations":[{"updatedAt":"2025-12-31T15:27:33.865Z","createdAt":"2025-12-31T15:27:33.865Z","userId":"e9bd9112-c2e3-4f67-873a-e1001baeafd8","projectId":"Rs8mhw052fnrzWZM","user":{"updatedAt":"2026-01-30T10:57:22.083Z","createdAt":"2025-12-31T15:27:33.119Z","id":"e9bd9112-c2e3-4f67-873a-e1001baeafd8","email":"sway@oloxa.ai","firstName":"Sway","lastName":"Clarke","personalizationAnswers":{"version":"v4","personalization_survey_submitted_at":"2025-12-31T15:54:37.562Z","personalization_survey_n8n_version":"2.1.4"},"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"zbxHkXOoD1qaz6OS","userActivatedAt":1767398053308,"npsSurvey":{"responded":true,"lastShownAt":1767684846804}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-01-29","isPending":false}}]}}],"tags":[],"activeVersion":{"updatedAt":"2026-01-30T21:35:13.262Z","createdAt":"2026-01-30T21:35:09.367Z","versionId":"1ad542a2-d082-463f-a800-2d3037e1bf55","workflowId":"MPjDdVMI88158iFW","nodes":[{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"triggerOn":"specificFolder","folderToWatch":{"__rl":true,"value":"1UYhIP6Nontc2vuE2G1aMvkggaEk6szv8","mode":"id"},"event":"fileCreated","options":{}},"id":"57e59b24-d291-4209-8a91-59a61c13fdb4","name":"Watch Bank Statements Folder","type":"n8n-nodes-base.googleDriveTrigger","typeVersion":1,"position":[272,336],"credentials":{"googleDriveOAuth2Api":{"id":"a4m50EefR3DJoU0R","name":"Google Drive account"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"mode":"id","value":"={{($json.body && $json.body.id) || $json.id}}"},"options":{}},"id":"2ac5e2bf-bb6d-425c-8d5b-b74b8cc502db","name":"Download PDF","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[496,432],"credentials":{"googleDriveOAuth2Api":{"id":"a4m50EefR3DJoU0R","name":"Google Drive account"}}},{"parameters":{"jsCode":"// Extract metadata from the PDF file\nconst item = $input.first();\n\n// Handle both webhook (binary) and Google Drive trigger (json)\nconst fileName = item.binary?.data?.fileName || item.json.name || (item.json.path ? item.json.path.split('/').pop() : null);\n\n// Get fileId - try webhook trigger first, then Drive trigger, then item.json\nlet fileId = 'unknown-file';\ntry {\n  const webhookData = $('Webhook Trigger (Testing)').all();\n  if (webhookData.length > 0) {\n    const webhookJson = webhookData[0].json;\n    fileId = (webhookJson.body && webhookJson.body.id) || webhookJson.id || 'webhook-upload';\n  }\n} catch (e) {\n  // Webhook trigger not executed, try Drive trigger\n  try {\n    const driveData = $('Watch Bank Statements Folder').all();\n    if (driveData.length > 0) {\n      fileId = driveData[0].json.id || 'drive-trigger';\n    }\n  } catch (e2) {\n    // Neither trigger executed, use item.json\n    fileId = item.json.id || 'unknown-file';\n  }\n}\n\nif (!fileName) {\n  throw new Error('Could not extract filename from trigger data. Available data: ' + JSON.stringify({json: Object.keys(item.json), binary: Object.keys(item.binary || {})}));\n}\n\n// Parse bank from filename - supports TWO formats:\n// Format A: \"BankName_\" (e.g., \"ING_2025-01_Statement.pdf\")\n// Format B: \"BankName - \" (e.g., \"Barclay - Sep 2025.pdf\")\nlet bankMatch = fileName.match(/^([A-Za-z&-]+)_/);\nif (!bankMatch) {\n  // Try space-dash-space format\n  // FIXED: Removed hyphen from character class to avoid greedy matching\n  bankMatch = fileName.match(/^([A-Za-z& ]+)\\s-\\s/);\n}\nconst bank = bankMatch ? bankMatch[1].trim() : 'Unknown';\n\n// Parse month/year from filename - supports THREE formats:\n// Format 1: ING_2025-11_Statement.pdf (YYYY-MM)\n// Format 2: Miles&More_Nov2025_Statement.pdf (TextMonth+YYYY, no space)\n// Format 3: Barclay - Sep 2025.pdf (TextMonth YYYY, with space)\n\nlet year, month;\n\n// Try YYYY-MM format first (Format 1)\nconst numericMatch = fileName.match(/_([0-9]{4})-([0-9]{2})_/);\nif (numericMatch) {\n  year = numericMatch[1];\n  month = numericMatch[2];\n} else {\n  // Try TextMonth+YYYY format (Format 2: Nov2025, DEC2025)\n  const textMonthMatch = fileName.match(/_(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)([0-9]{4})_/i);\n  if (textMonthMatch) {\n    const monthText = textMonthMatch[1].toLowerCase();\n    const monthMap = {\n      'jan': '01', 'january': '01',\n      'feb': '02', 'february': '02',\n      'mar': '03', 'march': '03',\n      'apr': '04', 'april': '04',\n      'may': '05',\n      'jun': '06', 'june': '06',\n      'jul': '07', 'july': '07',\n      'aug': '08', 'august': '08',\n      'sep': '09', 'september': '09',\n      'oct': '10', 'october': '10',\n      'nov': '11', 'november': '11',\n      'dec': '12', 'december': '12'\n    };\n    month = monthMap[monthText];\n    year = textMonthMatch[2];\n  } else {\n    // Try \"Month YYYY\" format (Format 3: Sep 2025, September 2025)\n    const spaceMonthMatch = fileName.match(/\\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)\\s([0-9]{4})/i);\n    if (spaceMonthMatch) {\n      const monthText = spaceMonthMatch[1].toLowerCase();\n      const monthMap = {\n        'jan': '01', 'january': '01',\n        'feb': '02', 'february': '02',\n        'mar': '03', 'march': '03',\n        'apr': '04', 'april': '04',\n        'may': '05',\n        'jun': '06', 'june': '06',\n        'jul': '07', 'july': '07',\n        'aug': '08', 'august': '08',\n        'sep': '09', 'september': '09',\n        'oct': '10', 'october': '10',\n        'nov': '11', 'november': '11',\n        'dec': '12', 'december': '12'\n      };\n      month = monthMap[monthText];\n      year = spaceMonthMatch[2];\n    } else {\n      // Fallback to current date\n      year = new Date().getFullYear().toString();\n      month = (new Date().getMonth() + 1).toString().padStart(2, '0');\n    }\n  }\n}\n\n// Generate statement ID\nconst statementId = `STMT-${bank}-${year}${month}-${Date.now()}`;\n\n// ✅ CORRECT: Preserve entire binary object (not nested)\nreturn {\n  json: {\n    fileName,\n    fileId,\n    bank,\n    year,\n    month,\n    statementId\n  },\n  binary: item.binary\n};"},"id":"67fb890a-f117-461f-a8e6-b88be91270af","name":"Extract File Metadata","type":"n8n-nodes-base.code","typeVersion":2,"position":[720,432]},{"parameters":{"method":"POST","url":"https://api.anthropic.com/v1/messages","authentication":"predefinedCredentialType","nodeCredentialType":"anthropicApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"anthropic-version","value":"2023-06-01"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.requestBody }}","options":{}},"id":"ac158557-c9bb-41bd-b782-4bdf4a21e359","name":"Parse PDF with Anthropic Vision","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1168,432],"credentials":{"openAiApi":{"id":"xmJ7t6kaKgMwA1ce","name":"OpenAi account"},"anthropicApi":{"id":"MRSNO4UW3OEIA3tQ","name":"Anthropic account"},"httpHeaderAuth":{"id":"vfoYopBRX35Znmq6","name":"Anthropic API key"}}},{"parameters":{"jsCode":"// Parse Anthropic response and prepare transaction data\nconst response = $input.first().json;\nconst textContent = response.content[0].text;\n\n// Strip markdown code fences if present (Anthropic wraps JSON in ```json...```)\nconst jsonText = textContent.replace(/^```json\\n?/, '').replace(/\\n?```$/, '').trim();\n\n// Parse the JSON\nconst parsedData = JSON.parse(jsonText);\n\n// Extract bank name from Claude's response (new format)\nconst bankFromVision = parsedData.bank || 'Unknown';\nconst transactions = parsedData.transactions || [];\n\nconst metadata = $('Extract File Metadata').first().json;\n\n// Generate new StatementID with correct bank from Vision AI\nconst statementId = `STMT-${bankFromVision}-${metadata.year}${metadata.month}-${Date.now()}`;\n\nreturn transactions.map((txn, index) => ({\n  json: {\n    TransactionID: `${statementId}-${(index + 1).toString().padStart(3, '0')}`,\n    Date: txn.date,\n    Bank: bankFromVision,\n    Amount: txn.amount.toString(),\n    Currency: txn.currency || 'EUR',\n    Description: txn.description,\n    Vendor: '',\n    Category: '',\n    ReceiptID: '',\n    StatementID: statementId,\n    MatchStatus: 'unmatched',\n    MatchConfidence: '0',\n    Notes: '',\n    Tags: '',\n    Type: 'expense',\n    AnnualInvoiceID: '',\n    _metadata: {\n      bankFromVision: bankFromVision,\n      transactionCount: transactions.length\n    }\n  }\n}));"},"id":"b7a79304-94aa-4a5f-b17d-b4724a3b4842","name":"Parse Anthropic Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1392,432]},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"id","value":"1l1uA8qA0DCGzGLBhmP2HqTzaajjbkURY2SLeqSuHMXM"},"sheetName":{"__rl":true,"mode":"name","value":"Transactions"},"columns":{"mappingMode":"defineBelow","value":{"TransactionID":"={{$json.TransactionID}}","Date":"={{$json.Date}}","Bank":"={{$json.Bank}}","Amount":"={{$json.Amount}}","Currency":"={{$json.Currency}}","Description":"={{$json.Description}}","Vendor":"={{$json.Vendor}}","Category":"={{$json.Category}}","ReceiptID":"={{$json.ReceiptID}}","StatementID":"={{$json.StatementID}}","MatchStatus":"={{$json.MatchStatus}}","MatchConfidence":"={{$json.MatchConfidence}}","Notes":"={{$json.Notes}}","Tags":"={{$json.Tags}}","Type":"={{$json.Type}}","AnnualInvoiceID":"={{$json.AnnualInvoiceID}}"},"matchingColumns":[],"schema":[{"id":"TransactionID","displayName":"TransactionID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Bank","displayName":"Bank","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Amount","displayName":"Amount","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Currency","displayName":"Currency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Description","displayName":"Description","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Vendor","displayName":"Vendor","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Category","displayName":"Category","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ReceiptID","displayName":"ReceiptID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"StatementID","displayName":"StatementID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"MatchStatus","displayName":"MatchStatus","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"MatchConfidence","displayName":"MatchConfidence","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Notes","displayName":"Notes","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Tags","displayName":"Tags","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"AnnualInvoiceID","displayName":"AnnualInvoiceID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"3c0e0cd8-934a-4c8e-9798-2363c1e1ac94","name":"Write Transactions to Database","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2512,336],"retryOnFail":true,"maxTries":5,"waitBetweenTries":15000,"credentials":{"googleSheetsOAuth2Api":{"id":"H7ewI1sOrDYabelt","name":"Google Sheets account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"append","documentId":{"__rl":true,"mode":"id","value":"1l1uA8qA0DCGzGLBhmP2HqTzaajjbkURY2SLeqSuHMXM"},"sheetName":{"__rl":true,"mode":"name","value":"Statements"},"columns":{"mappingMode":"defineBelow","value":{"StatementID":"={{$json.StatementID}}","Bank":"={{$json.Bank}}","Month":"={{$json.Month}}","Year":"={{$json.Year}}","FileID":"={{$json.FileID}}","FilePath":"={{$json.FilePath}}","ProcessedDate":"={{$json.ProcessedDate}}","TransactionCount":"={{$json.TransactionCount}}"},"matchingColumns":[],"schema":[{"id":"StatementID","displayName":"StatementID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Bank","displayName":"Bank","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Month","displayName":"Month","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Year","displayName":"Year","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FileID","displayName":"FileID","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"FilePath","displayName":"FilePath","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ProcessedDate","displayName":"ProcessedDate","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"TransactionCount","displayName":"TransactionCount","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"ef9db69e-d93b-4da0-a2ba-4b256df8d9a8","name":"Log Statement Record","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[1840,528],"retryOnFail":true,"maxTries":5,"waitBetweenTries":15000,"credentials":{"googleSheetsOAuth2Api":{"id":"H7ewI1sOrDYabelt","name":"Google Sheets account"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"move","fileId":{"__rl":true,"mode":"id","value":"={{$('Extract File Metadata').first().json.fileId}}"},"driveId":{"__rl":true,"mode":"list","value":"My Drive"},"folderId":{"__rl":true,"mode":"id","value":"1uohhbtaE6qvS08awMEYdVP6BqgRLxgjH"}},"id":"aa07e622-f2a6-4c1a-ae6a-779bc2ab0a05","name":"Move PDF to Archive","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2736,336],"credentials":{"googleDriveOAuth2Api":{"id":"a4m50EefR3DJoU0R","name":"Google Drive account"}}},{"parameters":{"jsCode":"// Build the Anthropic API request with proper binary handling for filesystem mode\nconst inputItem = $input.first();\nconst metadata = inputItem.json;\n\n// CRITICAL FIX for n8n 2.1.4 filesystem mode:\n// Use this.helpers.getBinaryDataBuffer() to read actual file from disk\nconst binaryPropertyName = 'data';\nconst binaryBuffer = await this.helpers.getBinaryDataBuffer(0, binaryPropertyName);\nconst base64Data = binaryBuffer.toString('base64');\n\n// Verify we got actual PDF data (should start with JVBERi... which is \"%PDF-\" in base64)\nif (base64Data.startsWith('ZmlsZXN5c3RlbS')) {\n  throw new Error('ERROR: Still encoding filesystem reference, not PDF bytes. Got: ' + base64Data.substring(0, 50));\n}\n\n// Additional validation: Check if it starts with valid PDF header\nif (!base64Data.startsWith('JVBERi')) {\n  throw new Error('ERROR: Base64 does not start with PDF magic bytes. Got: ' + base64Data.substring(0, 50));\n}\n\n// Build the complete Anthropic API request with DOCUMENT type\n// UPDATED: Ask Claude to identify the bank from PDF branding/header\nconst requestBody = {\n  model: \"claude-sonnet-4-5\",\n  max_tokens: 8192,\n  messages: [\n    {\n      role: \"user\",\n      content: [\n        {\n          type: \"text\",\n          text: \"You are a German bank statement parser. Extract the following from this bank statement:\\n\\n1. **Bank Name**: Identify which bank issued this statement (e.g., \\\"Barclay\\\", \\\"Miles & More\\\", \\\"ING\\\", etc.). Look at the logo, header, or footer.\\n2. **Transactions**: Extract all transactions as an array.\\n\\nReturn JSON in this format:\\n{\\n  \\\"bank\\\": \\\"BankName\\\",\\n  \\\"transactions\\\": [\\n    {\\\"date\\\": \\\"DD.MM.YYYY\\\", \\\"description\\\": \\\"...\\\", \\\"amount\\\": -123.45, \\\"currency\\\": \\\"EUR\\\"}\\n  ]\\n}\"\n        },\n        {\n          type: \"document\",\n          source: {\n            type: \"base64\",\n            media_type: \"application/pdf\",\n            data: base64Data\n          }\n        }\n      ]\n    }\n  ]\n};\n\n// Return the request body and metadata\nreturn {\n  json: {\n    requestBody: requestBody,\n    fileName: metadata.fileName,\n    fileId: metadata.fileId,\n    bankFromFilename: metadata.bank,\n    year: metadata.year,\n    month: metadata.month,\n    statementId: metadata.statementId\n  }\n};"},"id":"build-api-request-body","name":"Build Anthropic API Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[944,432],"notes":"FIXED: Uses this.helpers.getBinaryDataBuffer() for n8n 2.1.4 filesystem mode"},{"parameters":{"httpMethod":"POST","path":"process-bank-statement","options":{}},"id":"webhook-trigger-temp","name":"Webhook Trigger (Testing)","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[272,528],"webhookId":"269749e6-82e7-4207-b235-594e683e7c1d"},{"parameters":{"jsCode":"// Prepare single statement log entry\nconst transactions = $input.all();\nconst firstTransaction = transactions[0].json;\nconst metadata = $('Extract File Metadata').first().json;\n\nreturn {\n  json: {\n    StatementID: firstTransaction.StatementID,\n    Bank: firstTransaction.Bank,\n    Month: metadata.month,\n    Year: metadata.year,\n    FileID: metadata.fileId,\n    FilePath: metadata.fileName,\n    ProcessedDate: new Date().toISOString(),\n    TransactionCount: transactions.length\n  }\n};"},"id":"prepare-statement-log","name":"Prepare Statement Log","type":"n8n-nodes-base.code","typeVersion":2,"position":[1616,528]},{"parameters":{"jsCode":"// Pass through all transactions unchanged\n// They will be filtered after reading existing transactions\nreturn $input.all();"},"id":"check-duplicates","name":"Check for Duplicates","type":"n8n-nodes-base.code","typeVersion":2,"position":[1616,336]},{"parameters":{"documentId":{"mode":"id","value":"1l1uA8qA0DCGzGLBhmP2HqTzaajjbkURY2SLeqSuHMXM"},"sheetName":{"mode":"name","value":"Transactions"},"options":{}},"id":"read-existing-transactions","name":"Read Existing Transactions","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2064,336],"retryOnFail":true,"maxTries":5,"waitBetweenTries":15000,"credentials":{"googleSheetsOAuth2Api":{"id":"H7ewI1sOrDYabelt","name":"Google Sheets account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Get new transactions from Parse Response\nconst newTransactions = $('Parse Anthropic Response').all();\n\n// Get existing transactions from Google Sheets\nconst existingTransactions = $input.all();\n\n// Build set of existing keys for O(1) lookup\nconst existingKeys = new Set(\n  existingTransactions.map(item => \n    `${item.json.Date}_${item.json.Bank}_${item.json.Amount}_${item.json.Description}`\n  )\n);\n\n// Filter out duplicates\nconst uniqueTransactions = newTransactions.filter(item => {\n  const key = `${item.json.Date}_${item.json.Bank}_${item.json.Amount}_${item.json.Description}`;\n  const isDuplicate = existingKeys.has(key);\n  if (isDuplicate) {\n    console.log(`Skipping duplicate: ${key}`);\n  }\n  return !isDuplicate;\n});\n\nif (uniqueTransactions.length === 0) {\n  console.log('No new transactions to add (all duplicates)');\n  return [];\n}\n\nconsole.log(`Adding ${uniqueTransactions.length} new transactions (${newTransactions.length - uniqueTransactions.length} duplicates skipped)`);\n\nreturn uniqueTransactions;"},"id":"filter-non-duplicates","name":"Filter Non-Duplicates","type":"n8n-nodes-base.code","typeVersion":2,"position":[2288,336]},{"parameters":{"amount":60},"id":"wait-before-sheets-read","name":"Wait 60s (Rate Limit Buffer)","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1840,336],"webhookId":"bede71f7-8bc0-4d4a-a5e3-1bb89f32d909"}],"connections":{"Watch Bank Statements Folder":{"main":[[{"node":"Download PDF","type":"main","index":0}]]},"Download PDF":{"main":[[{"node":"Extract File Metadata","type":"main","index":0}]]},"Parse PDF with Anthropic Vision":{"main":[[{"node":"Parse Anthropic Response","type":"main","index":0}]]},"Parse Anthropic Response":{"main":[[{"node":"Prepare Statement Log","type":"main","index":0},{"node":"Check for Duplicates","type":"main","index":0}]]},"Write Transactions to Database":{"main":[[{"node":"Move PDF to Archive","type":"main","index":0}]]},"Extract File Metadata":{"main":[[{"node":"Build Anthropic API Request","type":"main","index":0}]]},"Build Anthropic API Request":{"main":[[{"node":"Parse PDF with Anthropic Vision","type":"main","index":0}]]},"Webhook Trigger (Testing)":{"main":[[{"node":"Download PDF","type":"main","index":0}]]},"Prepare Statement Log":{"main":[[{"node":"Log Statement Record","type":"main","index":0}]]},"Read Existing Transactions":{"main":[[{"node":"Filter Non-Duplicates","type":"main","index":0}]]},"Filter Non-Duplicates":{"main":[[{"node":"Write Transactions to Database","type":"main","index":0}]]},"Check for Duplicates":{"main":[[{"node":"Wait 60s (Rate Limit Buffer)","type":"main","index":0}]]},"Wait 60s (Rate Limit Buffer)":{"main":[[{"node":"Read Existing Transactions","type":"main","index":0}]]}},"authors":"Sway Clarke","name":"Version 1ad542a2","description":"","autosaved":false,"workflowPublishHistory":[{"createdAt":"2026-01-30T21:35:13.258Z","id":2174,"workflowId":"MPjDdVMI88158iFW","versionId":"1ad542a2-d082-463f-a800-2d3037e1bf55","event":"activated","userId":"e9bd9112-c2e3-4f67-873a-e1001baeafd8"}]}}