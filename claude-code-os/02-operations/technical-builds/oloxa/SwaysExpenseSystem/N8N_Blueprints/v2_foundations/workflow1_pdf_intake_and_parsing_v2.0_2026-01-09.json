{
  "name": "Expense System - Workflow 1: PDF Intake & Parsing",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "value": "1stmB5nWmoViQKKuQqpkWICPrfPQ_GDN1",
          "mode": "id"
        },
        "event": "fileUpdated",
        "options": {}
      },
      "id": "57e59b24-d291-4209-8a91-59a61c13fdb4",
      "name": "Watch Bank Statements Folder",
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        336,
        432
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "a4m50EefR3DJoU0R",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "mode": "id",
          "value": "={{$json.id}}"
        },
        "options": {}
      },
      "id": "2ac5e2bf-bb6d-425c-8d5b-b74b8cc502db",
      "name": "Download PDF",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        560,
        432
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "a4m50EefR3DJoU0R",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract metadata from the PDF file\nconst item = $input.first();\nconst fileName = item.json.name;\nconst fileId = item.json.id;\n\n// Parse bank from filename (e.g., \"ING_2025-01_Statement.pdf\")\nconst bankMatch = fileName.match(/^([A-Za-z-]+)_/);\nconst bank = bankMatch ? bankMatch[1] : 'Unknown';\n\n// Parse month/year from filename\nconst dateMatch = fileName.match(/_([0-9]{4})-([0-9]{2})_/);\nconst year = dateMatch ? dateMatch[1] : new Date().getFullYear().toString();\nconst month = dateMatch ? dateMatch[2] : (new Date().getMonth() + 1).toString().padStart(2, '0');\n\n// Generate statement ID\nconst statementId = `STMT-${bank}-${year}${month}-${Date.now()}`;\n\n// âœ… CORRECT: Preserve entire binary object (not nested)\nreturn {\n  json: {\n    fileName,\n    fileId,\n    bank,\n    year,\n    month,\n    statementId\n  },\n  binary: item.binary\n};"
      },
      "id": "67fb890a-f117-461f-a8e6-b88be91270af",
      "name": "Extract File Metadata",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        432
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build the Anthropic API request with proper binary handling for filesystem mode\nconst inputItem = $input.first();\nconst metadata = inputItem.json;\n\n// CRITICAL FIX for n8n 2.1.4 filesystem mode:\n// Use this.helpers.getBinaryDataBuffer() to read actual file from disk\nconst binaryPropertyName = 'data';\nconst binaryBuffer = await this.helpers.getBinaryDataBuffer(0, binaryPropertyName);\nconst base64Data = binaryBuffer.toString('base64');\n\n// Verify we got actual PDF data (should start with JVBERi... which is \"%PDF-\" in base64)\nif (base64Data.startsWith('ZmlsZXN5c3RlbS')) {\n  throw new Error('ERROR: Still encoding filesystem reference, not PDF bytes. Got: ' + base64Data.substring(0, 50));\n}\n\n// Additional validation: Check if it starts with valid PDF header\nif (!base64Data.startsWith('JVBERi')) {\n  throw new Error('ERROR: Base64 does not start with PDF magic bytes. Got: ' + base64Data.substring(0, 50));\n}\n\n// Build the complete Anthropic API request with DOCUMENT type\nconst requestBody = {\n  model: \"claude-sonnet-4-5\",\n  max_tokens: 4096,\n  messages: [\n    {\n      role: \"user\",\n      content: [\n        {\n          type: \"text\",\n          text: \"You are a German bank statement parser. Extract all transactions from this bank statement and return them as a JSON array with fields: date (DD.MM.YYYY), description, amount (negative for expenses, positive for income), currency.\"\n        },\n        {\n          type: \"document\",\n          source: {\n            type: \"base64\",\n            media_type: \"application/pdf\",\n            data: base64Data\n          }\n        }\n      ]\n    }\n  ]\n};\n\n// Return the request body and metadata\nreturn {\n  json: {\n    requestBody: requestBody,\n    fileName: metadata.fileName,\n    fileId: metadata.fileId,\n    bank: metadata.bank,\n    year: metadata.year,\n    month: metadata.month,\n    statementId: metadata.statementId\n  }\n};"
      },
      "id": "build-api-request-body",
      "name": "Build Anthropic API Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        432
      ],
      "notes": "FIXED: Uses this.helpers.getBinaryDataBuffer() for n8n 2.1.4 filesystem mode"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ $json.requestBody }}",
        "options": {}
      },
      "id": "ac158557-c9bb-41bd-b782-4bdf4a21e359",
      "name": "Parse PDF with Anthropic Vision",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1232,
        432
      ],
      "credentials": {
        "openAiApi": {
          "id": "xmJ7t6kaKgMwA1ce",
          "name": "OpenAi account"
        },
        "anthropicApi": {
          "id": "MRSNO4UW3OEIA3tQ",
          "name": "Anthropic account"
        },
        "httpHeaderAuth": {
          "id": "vfoYopBRX35Znmq6",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Anthropic response and prepare transaction data\nconst response = $input.first().json;\nconst textContent = response.content[0].text;\n\n// Strip markdown code fences if present (Anthropic wraps JSON in ```json...```)\nconst jsonText = textContent.replace(/^```json\\n?/, '').replace(/\\n?```$/, '').trim();\n\n// Parse the JSON\nconst transactions = JSON.parse(jsonText);\n\nconst metadata = $('Extract File Metadata').first().json;\n\nreturn transactions.map((txn, index) => ({\n  json: {\n    TransactionID: `${metadata.statementId}-${(index + 1).toString().padStart(3, '0')}`,\n    Date: txn.date,\n    Bank: metadata.bank,\n    Amount: txn.amount.toString(),\n    Currency: txn.currency || 'EUR',\n    Description: txn.description,\n    Vendor: '',\n    Category: '',\n    ReceiptID: '',\n    StatementID: metadata.statementId,\n    MatchStatus: 'unmatched',\n    MatchConfidence: '0',\n    Notes: '',\n    Tags: '',\n    Type: 'expense',\n    AnnualInvoiceID: ''\n  }\n}));"
      },
      "id": "b7a79304-94aa-4a5f-b17d-b4724a3b4842",
      "name": "Parse Anthropic Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        432
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1l1uA8qA0DCGzGLBhmP2HqTzaajjbkURY2SLeqSuHMXM"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "Transactions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "TransactionID": "={{$json.TransactionID}}",
            "Date": "={{$json.Date}}",
            "Bank": "={{$json.Bank}}",
            "Amount": "={{$json.Amount}}",
            "Currency": "={{$json.Currency}}",
            "Description": "={{$json.Description}}",
            "Vendor": "={{$json.Vendor}}",
            "Category": "={{$json.Category}}",
            "ReceiptID": "={{$json.ReceiptID}}",
            "StatementID": "={{$json.StatementID}}",
            "MatchStatus": "={{$json.MatchStatus}}",
            "MatchConfidence": "={{$json.MatchConfidence}}",
            "Notes": "={{$json.Notes}}",
            "Tags": "={{$json.Tags}}",
            "Type": "={{$json.Type}}",
            "AnnualInvoiceID": "={{$json.AnnualInvoiceID}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "TransactionID",
              "displayName": "TransactionID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Date",
              "displayName": "Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Bank",
              "displayName": "Bank",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Amount",
              "displayName": "Amount",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Currency",
              "displayName": "Currency",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Description",
              "displayName": "Description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Vendor",
              "displayName": "Vendor",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Category",
              "displayName": "Category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ReceiptID",
              "displayName": "ReceiptID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "StatementID",
              "displayName": "StatementID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "MatchStatus",
              "displayName": "MatchStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "MatchConfidence",
              "displayName": "MatchConfidence",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Notes",
              "displayName": "Notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Tags",
              "displayName": "Tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Type",
              "displayName": "Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "AnnualInvoiceID",
              "displayName": "AnnualInvoiceID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "3c0e0cd8-934a-4c8e-9798-2363c1e1ac94",
      "name": "Write Transactions to Database",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1680,
        336
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H7ewI1sOrDYabelt",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "1l1uA8qA0DCGzGLBhmP2HqTzaajjbkURY2SLeqSuHMXM"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "Statements"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "StatementID": "={{$('Extract File Metadata').first().json.statementId}}",
            "Bank": "={{$('Extract File Metadata').first().json.bank}}",
            "Month": "={{$('Extract File Metadata').first().json.month}}",
            "Year": "={{$('Extract File Metadata').first().json.year}}",
            "FileID": "={{$('Extract File Metadata').first().json.fileId}}",
            "FilePath": "={{$('Extract File Metadata').first().json.fileName}}",
            "ProcessedDate": "={{new Date().toISOString()}}",
            "TransactionCount": "={{$('Parse OpenAI Response').all().length}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "StatementID",
              "displayName": "StatementID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Bank",
              "displayName": "Bank",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Month",
              "displayName": "Month",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Year",
              "displayName": "Year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FileID",
              "displayName": "FileID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FilePath",
              "displayName": "FilePath",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ProcessedDate",
              "displayName": "ProcessedDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "TransactionCount",
              "displayName": "TransactionCount",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "ef9db69e-d93b-4da0-a2ba-4b256df8d9a8",
      "name": "Log Statement Record",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1680,
        528
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H7ewI1sOrDYabelt",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "move",
        "fileId": {
          "__rl": true,
          "mode": "id",
          "value": "={{$('Watch Bank Statements Folder').first().json.id}}"
        },
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "mode": "id",
          "value": "1Z5VTiBW7RBEZaLXbsCdvWZrhj9SLmp3r"
        }
      },
      "id": "aa07e622-f2a6-4c1a-ae6a-779bc2ab0a05",
      "name": "Move PDF to Archive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1904,
        336
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "a4m50EefR3DJoU0R",
          "name": "Google Drive account"
        }
      }
    }
  ],
  "connections": {
    "Watch Bank Statements Folder": {
      "main": [
        [
          {
            "node": "Download PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download PDF": {
      "main": [
        [
          {
            "node": "Extract File Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract File Metadata": {
      "main": [
        [
          {
            "node": "Build Anthropic API Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Anthropic API Request": {
      "main": [
        [
          {
            "node": "Parse PDF with Anthropic Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse PDF with Anthropic Vision": {
      "main": [
        [
          {
            "node": "Parse Anthropic Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Anthropic Response": {
      "main": [
        [
          {
            "node": "Write Transactions to Database",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log Statement Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Transactions to Database": {
      "main": [
        [
          {
            "node": "Move PDF to Archive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ccf61903-153a-4322-b508-2ae170447fcb",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "MPjDdVMI88158iFW",
  "tags": []
}
