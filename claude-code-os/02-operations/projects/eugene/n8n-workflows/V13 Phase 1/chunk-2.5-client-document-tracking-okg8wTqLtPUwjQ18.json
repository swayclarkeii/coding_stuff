{
  "updatedAt": "2026-01-29T12:27:46.531Z",
  "createdAt": "2026-01-08T21:33:22.263Z",
  "id": "okg8wTqLtPUwjQ18",
  "name": "Chunk 2.5 - Client Document Tracking (Eugene Document Organizer)",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "id": "trigger-1",
      "name": "Execute Workflow Trigger (Refreshed)",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        80,
        464
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build Tier 1 Classification Prompt\n// Classify document into 1 of 4 broad categories\n\n// === Process ALL items, not just first ===\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  // === CRITICAL: Extract and preserve ALL file metadata fields ===\n  const fileId = item.json.fileId || item.json.body?.fileId || null;\n  const filename = item.json.fileName || item.json.filename || item.json.body?.fileName || item.json.body?.filename || 'unknown_file.pdf';\n  const fileUrl = item.json.fileUrl || item.json.body?.fileUrl || null;\n\n  // FIX: Use actual emailFrom instead of hardcoded test email\n  const clientEmail = item.json.emailFrom || item.json.senderEmail || item.json.clientEmail || item.json.body?.emailFrom || item.json.body?.clientEmail || 'unknown@example.com';\n\n  // Tier 1 Prompt: Classify into 4 broad categories\n  const tier1Prompt = `You are a German real estate document classifier for AMA Capital.\n\nTASK: Classify this document into ONE of 4 broad categories based on the filename.\n\nFILENAME: ${filename}\nCLIENT: ${clientEmail}\n\nCATEGORIES:\n\n1. OBJEKTUNTERLAGEN (Property/Object Documents)\n   Keywords: Projekt, Beschreibung, Expose, Grundbuch, Kaufvertrag, Bau, Lageplan, Zeichnungen, Genehmigung, DIN276, DIN277, Werkvertrag, Flaeche, Erschlie\u00dfung, Bodenschutz, Altlasten, Baulasten, Baugrund\n\n   INCLUDES municipal/infrastructure documents:\n   - Erschlie\u00dfungsbeitragsbescheinigung (development contribution)\n   - Bodenschutz (soil protection)\n   - Altlastenkataster (contaminated sites)\n   - Baulastenverzeichnis (building encumbrances)\n\n   Examples: Project descriptions, land register, purchase agreements, building permits, construction drawings, calculations, municipal property certificates\n\n2. WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents)\n\n   Keywords to identify:\n   - Finanzierung, Finanzierungsbest\u00e4tigung, Darlehen, Kredit, Zinssatz\n   - Kalkulation, DIN276, Baukosten, Herstellkosten\n   - Verkaufspreise, Kaufpreise, Preisliste\n   - Angebot (if from bank/financial institution OR contains pricing)\n   - Werkvertrag, GU-Vertrag, Bauvertrag\n   - **Memo/Memorandum (if contains financial data: amounts, financing terms, capital requirements, loan conditions)**\n\n   DO NOT CONFUSE WITH SONSTIGES (Miscellaneous):\n   - \"Memo\" or \"Memorandum\" alone does NOT automatically mean SONSTIGES\n   - Check content: if memo contains financing key data \u2192 WIRTSCHAFTLICHE_UNTERLAGEN\n     - Financing key data includes: project volume, capital requirement, loan amounts, interest rates, financing terms, collateral details\n   - If memo contains financial investment proposals or financing requests \u2192 WIRTSCHAFTLICHE_UNTERLAGEN\n   - Only classify as SONSTIGES if memo is general correspondence without financial specifics\n\n   Examples: Sales prices, construction schedules, insurance, VAT returns, financial statements, loan agreements, financing memos\n\n3. RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents)\n   Keywords: Gesellschaft, Vertrag, Handelsregister, Gewerbe, Steuer, ID, Freistellung (TAX exemption only), Vollmacht\n\n   EXCLUDES property-related municipal certificates (those go in OBJEKTUNTERLAGEN)\n\n   Examples: Partnership agreements, commercial register, business registration, TAX ID, TAX exemption certificates, powers of attorney\n\n4. SONSTIGES (Miscellaneous)\n   Keywords: Gutachter, Korrespondenz, Sonstiges, Others\n   Examples: Expert assignments, correspondence, general miscellaneous\n\nCRITICAL CONSISTENCY RULE:\nBase your classification PRIMARILY on FILENAME keywords. The filename is the most reliable indicator of document type.\n\nDecision priority:\n1. **Filename keywords** (highest priority) - analyze German terms in filename\n2. Document structure (if filename is generic like \"document.pdf\")\n3. Content analysis (fallback only)\n\nWHY: This ensures the same filename always gets the same tier 1 category, improving duplicate consistency.\n\nEXAMPLE: \"Erschlie\u00dfungsbeitragsbescheinigung.pdf\"\n- Filename contains \"Erschlie\u00dfung\" \u2192 OBJEKTUNTERLAGEN \u2713\n- Even if content is hard to read, filename determines category\n\nINSTRUCTIONS:\n1. Analyze the filename for German keywords\n2. Match to the most appropriate category\n3. Provide confidence score (0-100)\n4. Explain your reasoning in 1-2 sentences\n\nRESPONSE FORMAT (JSON only, no markdown):\n{\n  \"tier1Category\": \"OBJEKTUNTERLAGEN | WIRTSCHAFTLICHE_UNTERLAGEN | RECHTLICHE_UNTERLAGEN | SONSTIGES\",\n  \"tier1Confidence\": 85,\n  \"reasoning\": \"Brief explanation of why this category was chosen\"\n}\n\nSTRICT RULES:\n- Response must be valid JSON only\n- tier1Confidence must be 0-100 number\n- tier1Category must be exactly one of the 4 options above\n- No markdown formatting\n- No code blocks\n- No explanatory text outside JSON`;\n\n  outputItems.push({\n    json: {\n      tier1Prompt,\n      // === EXPLICITLY PRESERVE ALL FILE METADATA (CRITICAL) ===\n      fileId,\n      fileName: filename,\n      fileUrl,\n      clientEmail,\n      // === CRITICAL: Preserve client_name and client_normalized ===\n      client_name: item.json.client_name,\n      client_normalized: item.json.client_normalized,\n      // Pass through all input data for additional fields\n      ...item.json\n    }\n  });\n}\n\nreturn outputItems;\n"
      },
      "id": "code-1",
      "name": "Build AI Classification Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        160
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse Tier 1 Classification Result + Build Dynamic Tier 2 Prompt\n// FIX: Process ALL items, not just first\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n\n  // Get corresponding items from previous nodes\n  const promptData = $('Build AI Classification Prompt').all()[i].json;\n  const tier1Result = $('Parse Claude Tier 1 Response').all()[i].json;\n\n  const fileId = promptData.fileId;\n  const fileName = promptData.fileName;\n  const fileUrl = promptData.fileUrl;\n  const clientEmail = promptData.clientEmail;\n  const client_name = promptData.client_name;\n  const client_normalized = promptData.client_normalized;\n\n  if (!tier1Result || !tier1Result.tier1Category) {\n    outputItems.push({\n      json: {\n        error: 'Failed to parse Tier 1 classification',\n        tier1Category: 'UNKNOWN',\n        tier1Confidence: 0,\n        tier2Prompt: 'ERROR: Failed to parse Tier 1 classification',\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        ...item.json\n      }\n    });\n    continue;\n  }\n\n  const { tier1Category, tier1Confidence, tier1Reasoning } = tier1Result;\n  const reasoning = tier1Reasoning || '';\n\n  let tier2Prompt = '';\n\n  if (tier1Category === 'OBJEKTUNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as OBJEKTUNTERLAGEN (Property/Object Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n01_Projektbeschreibung (Expos\u00e9/Project Description) \u2b50 CORE\\n   Keywords: Projekt, Beschreibung, Expose, Overview, Proposal, Teaser, Marketing, Verkaufs (in marketing context)\\n   Description: Marketing-oriented project overview, property description, investment proposal\\n\\n   BOUNDARY RULES - Use 01_Projektbeschreibung when:\\n   \u2713 Filename contains: Expose, Projekt, Beschreibung, Teaser, Praesentation\\n   \u2713 Marketing/sales focused materials\\n   \u2713 Investment proposals\\n\\n   DO NOT use 01_Projektbeschreibung for:\\n   \u2717 Energieausweis / Energiebedarfsausweis \u2192 use 37_Others (technical certificate)\\n   \u2717 Detailed Baubeschreibung (Regelgeschoss, Dachgeschoss, etc.) \u2192 use 14_Bau_Ausstattungsbeschreibung\\n   \u2717 Highly technical specifications \u2192 use 14_Bau_Ausstattungsbeschreibung\\n\\n   DISTINCTION: 01 is for MARKETING, 14 is for TECHNICAL/CONSTRUCTION details\\n\\n02_Kaufvertrag (Purchase Agreement)\\n   Keywords: Kauf, Vertrag, Purchase, Agreement\\n   Description: Property purchase contract\\n\\n03_Grundbuchauszug (Land Register Extract) \u2b50 CORE\\n   Keywords: Grundbuch, Land, Register, Auszug\\n   Description: Official land registry extract\\n\\n04_Eintragungsbewilligungen (Entry Permits)\\n   Keywords: Eintragung, Bewilligung, Entry, Permit\\n   Description: Permits for land register entries\\n\\n05_Bodenrichtwert (Land Value)\\n   Keywords: Boden, Richtwert, Land, Value\\n   Description: Official land value assessment\\n\\n06_Baulastenverzeichnis (Building Encumbrance Register)\\n   Keywords: Baulast, Verzeichnis, Encumbrance\\n   Description: Register of building encumbrances\\n\\n07_Altlastenkataster (Contaminated Sites Register)\\n   Keywords: Altlast, Kataster, Contaminated\\n   Description: Register of contaminated sites\\n\\n08_Baugrundgutachten (Soil Survey)\\n   Keywords: Baugrund, Gutachten, Soil, Survey\\n   Description: Soil conditions assessment\\n\\n09_Lageplan (Site Plan)\\n   Keywords: Lage, Plan, Site, Grundstueck, Gelaende (without \\\"Bebauung\\\")\\n   Description: Physical site location and layout plan\\n\\n   DO NOT CONFUSE WITH:\\n   \u2717 Bebauungsplan \u2192 use 37_Others (zoning/regulatory plan)\\n\\n   DISTINCTION:\\n   - Lageplan = physical layout of site (WHAT IS)\\n   - Bebauungsplan = zoning regulations (WHAT CAN BE BUILT)\\n\\n   If filename contains \\\"Bebauung\\\" or \\\"Bebauungsplan\\\", use 37_Others\\n   If filename contains just \\\"Lage\\\" or \\\"Lageplan\\\", use 09_Lageplan\\n\\n10_Bautraegerkalkulation_DIN276 (Developer Calculation) \u2b50 CORE\\n   Keywords: Bautraeger, Kalkulation, DIN276, Calculation\\n   Description: Developer cost calculation per DIN276 standard\\n\\n   DO NOT CONFUSE WITH 11_Verkaufspreise (Sales Prices):\\n\\n   KEY DIFFERENCES to distinguish DIN276 calculations from sales price lists:\\n\\n   DIN276 Bautr\u00e4gerkalkulation contains:\\n   - DIN276 cost groups (100-800): Grundst\u00fcck, Herrichten, Geb\u00e4ude, etc.\\n   - HK (Herstellkosten) = construction/manufacturing costs\\n   - Developer profit margins, financing costs, sales costs\\n   - Terms: Baukosten, Baunebenkosten, Projektentwicklung, Gewinn\\n\\n   Verkaufspreise (Sales Prices) contains:\\n   - Customer-facing unit prices: \\\"Kaufpreis WE\\\" (purchase price per unit)\\n   - Individual apartment/unit listings with end-buyer prices\\n   - Terms: Verkaufspreis, Kaufpreis, Endpreis, Kundenpreis\\n\\n   FILENAME PRIORITY (Iteration 2 consistency rule):\\n   - If filename contains \\\"Kalkulation\\\" \u2192 Check content structure FIRST\\n   - If content shows DIN276 cost groups (100-800) OR \\\"HK\\\" (Herstellkosten) \u2192 10_Bautraegerkalkulation_DIN276\\n   - If content shows \\\"Kaufpreis WE\\\" or individual unit customer prices \u2192 11_Verkaufspreise\\n   - \\\"Kaufpreisliste\\\" in DIN276 context = internal pricing calculation, NOT customer sales prices\\n\\n   CRITICAL: A document can contain BOTH cost calculations AND sales prices in different sections. Prioritize the DOMINANT content type:\\n   - If majority is DIN276 cost breakdown with developer calculations \u2192 10_Bautraegerkalkulation_DIN276\\n   - If majority is customer unit price list \u2192 11_Verkaufspreise\\n\\n15_Flaechenberechnung_DIN277 (Area Calculation DIN277)\\n   Keywords: Flaeche, Berechnung, DIN277, Area\\n   Description: Area calculation per DIN277 standard\\n\\n16_GU_Werkvertraege (General Contractor Agreements)\\n   Keywords: GU, Werkvertrag, Contractor, Agreement\\n   Description: General contractor work agreements\\n\\n17_Bauzeichnungen (Construction Drawings)\\n   Keywords: Bau, Zeichnung, Construction, Drawing\\n   Description: Construction and architectural drawings\\n\\n18_Baugenehmigung (Building Permit)\\n   Keywords: Bau, Genehmigung, Building, Permit\\n   Description: Official building permit\\n\\n14_Bau_Ausstattungsbeschreibung (Construction & Equipment Description)\\n   Keywords: Bau, Ausstattung, Beschreibung, Baubeschreibung, Equipment, Regelgeschoss, Dachgeschoss, Geschoss, Technisch\\n   Description: Detailed technical construction specifications and equipment details\\n\\n   USE this for:\\n   \u2713 Baubeschreibung Regelgeschoss (floor-specific technical specs)\\n   \u2713 Baubeschreibung Dachgeschoss\\n   \u2713 Detailed Ausstattungsbeschreibung (equipment specifications)\\n   \u2713 Technical construction details\\n\\n   DISTINCTION: This is TECHNICAL, not marketing-oriented\\n\\nCRITICAL CONSISTENCY RULE:\\nBase your classification PRIMARILY on FILENAME keywords. When the same filename is processed multiple times, it MUST receive the same documentType every time.\\n\\nDecision priority:\\n1. **Filename keywords** (highest priority) - German terms in filename\\n2. Tier 1 category context (from upstream)\\n3. Document structure/content (if filename is ambiguous)\\n\\nFALLBACK RULE - When to use \\\"OTHER\\\" categories:\\nUse 37_Others or 38_Unknowns ONLY when:\\n\u2713 Filename is generic/unclear (e.g., \\\"document.pdf\\\", \\\"file123.pdf\\\")\\n\u2713 Filename keywords don't match ANY specific category\\n\u2713 Confidence is genuinely low (<70%)\\n\\nDO NOT use \\\"OTHER\\\" when:\\n\u2717 Your reasoning identifies a specific category\\n\u2717 Filename contains clear keywords matching a category\\n\u2717 This would create self-contradictory classifications\\n\\nRULE: Your classification must align with your reasoning.\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"01_Projektbeschreibung\\\",\\n  \\\"tier2Confidence\\\": 88,\\n  \\\"germanName\\\": \\\"Projektbeschreibung\\\",\\n  \\\"englishName\\\": \\\"Expos\u00e9/Project Description\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above (e.g., \\\"01_Projektbeschreibung\\\")\\n- isCoreType: true for \u2b50 CORE types, false for others\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'WIRTSCHAFTLICHE_UNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n11_Verkaufspreise (Sales Prices)\\n   Keywords: Verkauf, Preis, Sales, Price, Kaufpreis, Wohnungspreise, Verkaufspreis\\n   Description: CUSTOMER sales prices - what end buyers pay the developer\\n\\n   CRITICAL DISTINCTION - Cost vs Price:\\n   \u2713 Use 11_Verkaufspreise for: Customer-facing sales prices\\n   \u2717 DO NOT use for:\\n     - Richtpreisangebot (contractor bid) \u2192 use 37_Others\\n     - GU Angebot (general contractor offer) \u2192 use 16_GU_Werkvertraege if contract-like, else 37_Others\\n     - Baukosten (construction costs) \u2192 use 10_Bautraegerkalkulation_DIN276 if DIN276, else 37_Others\\n\\n   RULE OF THUMB:\\n   - If filename contains \\\"GU\\\", \\\"Richtpreis\\\", \\\"Angebot\\\", \\\"Baukosten\\\" \u2192 NOT customer sales prices\\n   - If filename contains \\\"Verkauf\\\", \\\"Kaufpreis\\\", \\\"Wohnungspreise\\\" \u2192 YES, customer sales prices\\n\\n12_Bauzeitenplan_Liquiditaet (Construction Schedule & Liquidity)\\n   Keywords: Bauzeit, Plan, Liquiditaet, Schedule\\n   Description: Construction timeline and liquidity planning\\n\\n13_Vertriebsweg (Distribution Channel)\\n   Keywords: Vertrieb, Weg, Distribution, Channel\\n   Description: Sales and distribution strategy\\n\\n14_Bau_Ausstattungsbeschreibung (Construction & Equipment Description)\\n   Keywords: Bau, Ausstattung, Beschreibung, Baubeschreibung, Equipment\\n   Description: Construction specifications and equipment details\\n\\n19_Teilungserklaerung (Declaration of Division)\\n   Keywords: Teilung, Erklaerung, Division, Declaration\\n   Description: Property division declaration\\n\\n20_Versicherungen (Insurance)\\n   Keywords: Versicherung, Insurance\\n   Description: Insurance policies and documentation\\n\\n21_Muster_Verkaufsvertrag (Sample Sales Contract)\\n   Keywords: Muster, Verkauf, Vertrag, Sample, Sales\\n   Description: Template sales contract\\n\\n23_Umsatzsteuervoranmeldung (VAT Advance Return)\\n   Keywords: Umsatz, Steuer, Voranmeldung, VAT\\n   Description: VAT advance return filings\\n\\n24_BWA (Business Evaluation)\\n   Keywords: BWA, Business, Evaluation\\n   Description: Business evaluation report\\n\\n25_Jahresabschluss (Annual Financial Statement)\\n   Keywords: Jahres, Abschluss, Annual, Financial\\n   Description: Annual financial statement\\n\\n26_Finanzierungsbestaetigung (Financing Confirmation)\\n   Keywords: Finanzierung, Bestaetigung, Financing, Confirmation\\n   Description: Financing approval or confirmation\\n\\n   INCLUDES Financing Memos/Memorandums:\\n\\n   - Investment memos, financing proposals, capital requirement memos\\n   - \\\"Memo\\\" or \\\"Memorandum\\\" that contains:\\n     - Project financing details (volume, capital needs, loan amounts)\\n     - Financing terms (interest rates, loan duration, security/collateral)\\n     - Bank financing offers or confirmations\\n     - Investment financing structures\\n\\n   Examples:\\n   - \\\"OCP_Memo_New-KaulsCity.pdf\\\" with 60 Mio EUR financing request \u2192 26_Finanzierungsbestaetigung\\n   - \\\"Finanzierungs-Memo Projekt X\\\" with loan terms \u2192 26_Finanzierungsbestaetigung\\n   - \\\"Investment Memorandum\\\" with financing structure \u2192 26_Finanzierungsbestaetigung\\n\\n   DO NOT CONFUSE WITH 35_Sonstiges_Allgemein:\\n   - If document title contains \\\"Memo\\\" BUT content is financing-focused \u2192 26_Finanzierungsbestaetigung\\n   - Only classify as SONSTIGES if memo lacks financial specifics\\n\\n27_Darlehensvertrag (Loan Agreement)\\n   Keywords: Darlehen, Vertrag, Loan, Agreement\\n   Description: Loan contract\\n\\n16_GU_Werkvertraege (General Contractor Agreements)\\n   Keywords: GU, Werkvertrag, Contractor, Agreement, Generalunternehmer\\n   Description: General contractor work agreements\\n\\n   CAN ALSO USE for: GU cost estimates/bids that are contract-related\\n   Examples: GU Werkvertrag, GU Angebot, Generalunternehmer Vertrag\\n\\n   CONSISTENCY RULE for Contractor Quotes (Richtpreisangebot):\\n\\n   If filename contains:\\n   - \\\"GU\\\" (Generalunternehmer/General Contractor) + \\\"Angebot\\\" OR \\\"Richtpreisangebot\\\" \u2192 ALWAYS 16_GU_Werkvertraege\\n   - \\\"Richtpreisangebot\\\" + construction/building scope \u2192 Check for contractor identity (GU, Bauunternehmen)\\n\\n   DO NOT CONFUSE WITH 11_Verkaufspreise:\\n   - Richtpreisangebot = contractor's bid/quote TO the developer (construction cost estimate)\\n   - Verkaufspreise = sales prices FROM developer TO end customers\\n   - Key distinction: contractor quotes describe construction work scope, customer prices describe unit features\\n\\n   FILENAME PRIORITY RULE:\\n   - \\\"GU\\\" + any pricing document (Angebot, Richtpreisangebot, Quote) \u2192 16_GU_Werkvertraege\\n   - Ignore other filename elements if \\\"GU\\\" is present with pricing terms\\n\\nCRITICAL CONSISTENCY RULE:\\nBase your classification PRIMARILY on FILENAME keywords. When the same filename is processed multiple times, it MUST receive the same documentType every time.\\n\\nDecision priority:\\n1. **Filename keywords** (highest priority) - German terms in filename\\n2. Tier 1 category context (from upstream)\\n3. Document structure/content (if filename is ambiguous)\\n\\nFALLBACK RULE - When to use \\\"OTHER\\\" categories:\\nUse 37_Others or 38_Unknowns ONLY when:\\n\u2713 Filename is generic/unclear (e.g., \\\"document.pdf\\\", \\\"file123.pdf\\\")\\n\u2713 Filename keywords don't match ANY specific category\\n\u2713 Confidence is genuinely low (<70%)\\n\\nDO NOT use \\\"OTHER\\\" when:\\n\u2717 Your reasoning identifies a specific category\\n\u2717 Filename contains clear keywords matching a category\\n\u2717 This would create self-contradictory classifications\\n\\nRULE: Your classification must align with your reasoning.\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"11_Verkaufspreise\\\",\\n  \\\"tier2Confidence\\\": 92,\\n  \\\"germanName\\\": \\\"Verkaufspreise\\\",\\n  \\\"englishName\\\": \\\"Sales Prices\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all WIRTSCHAFTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'RECHTLICHE_UNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n28_Gesellschaftsvertrag (Partnership Agreement)\\n   Keywords: Gesellschaft, Vertrag, Partnership, Agreement\\n   Description: Company partnership or shareholder agreement\\n\\n29_Handelsregisterauszug (Commercial Register Extract)\\n   Keywords: Handelsregister, Auszug, Commercial, Register\\n   Description: Commercial register extract\\n\\n30_Gewerbeanmeldung (Business Registration)\\n   Keywords: Gewerbe, Anmeldung, Business, Registration\\n   Description: Business registration documentation\\n\\n31_Steuer_ID (Tax ID)\\n   Keywords: Steuer, ID, Tax\\n   Description: Tax identification number\\n\\n32_Freistellungsbescheinigung (Tax Exemption Certificate)\\n   Keywords: Freistellung, Bescheinigung (TAX context only), Exemption, Certificate, Steuer + Freistellung\\n   Description: TAX exemption certificate (Steuerfreistellung)\\n\\n   CRITICAL: This is ONLY for TAX-related exemption certificates\\n\\n   DO NOT CONFUSE WITH:\\n   \u2717 Erschlie\u00dfungsbeitragsbescheinigung (development contribution) \u2192 should be OBJEKTUNTERLAGEN (not your tier!)\\n   \u2717 Other municipal certificates \u2192 likely OBJEKTUNTERLAGEN\\n\\n   RULE: If filename contains \\\"Erschlie\u00dfung\\\", \\\"Baulasten\\\", \\\"Bodenschutz\\\", \\\"Altlasten\\\" \u2192 NOT this category (those are property/infrastructure, not tax)\\n\\n   Only use 32_Freistellungsbescheinigung if:\\n   - Clear TAX context in filename OR\\n   - Filename is just \\\"Freistellungsbescheinigung\\\" without other context\\n\\n33_Vollmachten (Powers of Attorney)\\n   Keywords: Vollmacht, Power, Attorney\\n   Description: Power of attorney documents\\n\\nCRITICAL CONSISTENCY RULE:\\nBase your classification PRIMARILY on FILENAME keywords. When the same filename is processed multiple times, it MUST receive the same documentType every time.\\n\\nDecision priority:\\n1. **Filename keywords** (highest priority) - German terms in filename\\n2. Tier 1 category context (from upstream)\\n3. Document structure/content (if filename is ambiguous)\\n\\nFALLBACK RULE - When to use \\\"OTHER\\\" categories:\\nUse 37_Others or 38_Unknowns ONLY when:\\n\u2713 Filename is generic/unclear (e.g., \\\"document.pdf\\\", \\\"file123.pdf\\\")\\n\u2713 Filename keywords don't match ANY specific category\\n\u2713 Confidence is genuinely low (<70%)\\n\\nDO NOT use \\\"OTHER\\\" when:\\n\u2717 Your reasoning identifies a specific category\\n\u2717 Filename contains clear keywords matching a category\\n\u2717 This would create self-contradictory classifications\\n\\nRULE: Your classification must align with your reasoning.\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"28_Gesellschaftsvertrag\\\",\\n  \\\"tier2Confidence\\\": 85,\\n  \\\"germanName\\\": \\\"Gesellschaftsvertrag\\\",\\n  \\\"englishName\\\": \\\"Partnership Agreement\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all RECHTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'SONSTIGES') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as SONSTIGES (Miscellaneous) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n22_Gutachterauftrag (Expert Assignment)\\n   Keywords: Gutachter, Auftrag, Expert, Assignment\\n   Description: Expert assessment assignment\\n\\n34_Korrespondenz (Correspondence)\\n   Keywords: Korrespondenz, Email, Brief, Letter, Correspondence\\n   Description: Email correspondence and letters\\n\\n35_Sonstiges_Allgemein (General Miscellaneous)\\n   Keywords: Sonstiges, Misc, General\\n   Description: General miscellaneous documents\\n\\n36_Exit_Strategie (Exit Strategy) \u2b50 CORE\\n   Keywords: Exit, Strategie, Strategy\\n   Description: Investment exit strategy\\n\\n37_Others (Others)\\n   Keywords: Other, Andere\\n   Description: Other unclassified documents\\n\\n38_Unknowns (Unknowns)\\n   Keywords: Unknown, Unbekannt\\n   Description: Unknown document type (LAST RESORT - use only when truly unclear)\\n\\nCRITICAL CONSISTENCY RULE:\\nBase your classification PRIMARILY on FILENAME keywords. When the same filename is processed multiple times, it MUST receive the same documentType every time.\\n\\nDecision priority:\\n1. **Filename keywords** (highest priority) - German terms in filename\\n2. Tier 1 category context (from upstream)\\n3. Document structure/content (if filename is ambiguous)\\n\\nFALLBACK RULE - When to use \\\"OTHER\\\" categories:\\nUse 37_Others or 38_Unknowns ONLY when:\\n\u2713 Filename is generic/unclear (e.g., \\\"document.pdf\\\", \\\"file123.pdf\\\")\\n\u2713 Filename keywords don't match ANY specific category\\n\u2713 Confidence is genuinely low (<70%)\\n\\nDO NOT use \\\"OTHER\\\" when:\\n\u2717 Your reasoning identifies a specific category\\n\u2717 Filename contains clear keywords matching a category\\n\u2717 This would create self-contradictory classifications\\n\\nRULE: Your classification must align with your reasoning. If you say \\\"marketing brochure\\\" in reasoning, classify it appropriately, NOT as Sonstiges.\\n\\nIMPORTANT: 38_Unknowns is LAST RESORT. Only use when truly unable to classify.\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n5. Use 38_Unknowns ONLY if truly unclear\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"36_Exit_Strategie\\\",\\n  \\\"tier2Confidence\\\": 95,\\n  \\\"germanName\\\": \\\"Exit Strategie\\\",\\n  \\\"englishName\\\": \\\"Exit Strategy\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: true ONLY for 36_Exit_Strategie\\n- Valid JSON only, no markdown`;\n  } else {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nERROR: Unknown category \\\"${tier1Category}\\\". Please classify as SONSTIGES > 38_Unknowns.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"38_Unknowns\\\",\\n  \\\"tier2Confidence\\\": 0,\\n  \\\"germanName\\\": \\\"Unknowns\\\",\\n  \\\"englishName\\\": \\\"Unknown\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Unknown Tier 1 category: ${tier1Category}\\\"\\n}`;\n  }\n\n  if (tier1Confidence < 60) {\n    outputItems.push({\n      json: {\n        tier1Category, tier1Confidence, tier1Reasoning: reasoning, tier2Prompt,\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        lowConfidence: true, confidenceFailureStage: 'tier1',\n        ...item.json\n      }\n    });\n  } else {\n    outputItems.push({\n      json: {\n        tier1Category, tier1Confidence, tier1Reasoning: reasoning, tier2Prompt,\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        ...item.json\n      }\n    });\n  }\n}\n\nreturn outputItems;\n"
      },
      "id": "code-2",
      "name": "Parse Classification Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2320,
        160
      ]
    },
    {
      "parameters": {
        "documentId": {
          "mode": "id",
          "value": "12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I"
        },
        "sheetName": {
          "mode": "name",
          "value": "Dokumenten_Tracker"
        },
        "options": {}
      },
      "id": "sheets-1",
      "name": "Lookup Client in Client_Tracker",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4112,
        160
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H7ewI1sOrDYabelt",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// FIX: Don't loop through sheet rows - we're processing ONE file\n// The Sheets lookup gives us ALL rows to search through\n// UPDATED: Use Dokumenten_Tracker with 'Mandant' field\n\n// Get classification data (the single file being processed)\nconst classificationData = $('Determine Action Type').first().json;\n\n// Get ALL tracker rows to search through\nconst trackerData = $('Lookup Client in Client_Tracker').all();\n\n// Get client info from classification data\nconst clientNormalized = classificationData.client_normalized || classificationData.clientNormalized || '';\nconst documentType = classificationData.documentType || '';\nconst confidence = classificationData.combinedConfidence || classificationData.tier2Confidence || 0;\nconst fileId = classificationData.fileId || '';\nconst fileName = classificationData.fileName || '';\n\n// Check if confidence is too low\nif (confidence < 70) {\n  return [{\n    json: {\n      ...classificationData,  // Preserve all classification data\n      chunk2_5_status: 'error_unclear_type',\n      errorMessage: `Low confidence (${confidence}%) - document type unclear`\n    }\n  }];\n}\n\n// Check if any data was returned from tracker\nif (!trackerData || trackerData.length === 0) {\n  return [{\n    json: {\n      ...classificationData,\n      chunk2_5_status: 'error_client_not_found',\n      errorMessage: 'No data returned from Dokumenten_Tracker lookup'\n    }\n  }];\n}\n\n// Find matching client row (using Mandant field)\nlet rowIndex = -1;\nconst clientRow = trackerData.find((row, idx) => {\n  const sheetClientName = row.json.Mandant || '';\n  const normalizedSheetName = sheetClientName\n    .toLowerCase()\n    .trim()\n    .replace(/\u00e4/g, 'ae')\n    .replace(/\u00f6/g, 'oe')\n    .replace(/\u00fc/g, 'ue')\n    .replace(/\u00df/g, 'ss')\n    .replace(/\\s*(gmbh|ag|kg|e\\.v\\.|mbh|co\\.|&\\s*co\\.?)\\s*/gi, '')\n    .replace(/[^a-z0-9]/g, '_')\n    .replace(/_+/g, '_')\n    .replace(/^_|_$/g, '');\n  \n  if (normalizedSheetName === clientNormalized) {\n    // Google Sheets returns data starting from row 2 (row 1 is header)\n    // Array index 0 = row 2, index 1 = row 3, etc.\n    rowIndex = idx + 2;\n    return true;\n  }\n  return false;\n});\n\nif (!clientRow || !clientRow.json.Mandant) {\n  return [{\n    json: {\n      ...classificationData,\n      chunk2_5_status: 'error_client_not_found',\n      errorMessage: `Client not found in tracker: \"${clientNormalized}\"`\n    }\n  }];\n}\n\n// Client found and validated - output SINGLE item\nreturn [{\n  json: {\n    ...classificationData,        // All classification data (fileId, confidence, documentType, etc.)\n    ...clientRow.json,            // Sheet row data\n    clientFound: true,\n    trackerRowIndex: rowIndex,    // Calculated row number (1-based)\n    trackerClientName: clientRow.json.Mandant,\n    chunk2_5_status: 'success'\n  }\n}];"
      },
      "id": "code-3",
      "name": "Find Client Row and Validate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4336,
        160
      ]
    },
    {
      "parameters": {
        "documentId": {
          "mode": "id",
          "value": "1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "AMA_Folder_IDs",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU/edit#gid=0"
        },
        "options": {}
      },
      "id": "sheets-3",
      "name": "Lookup Client in AMA_Folder_IDs",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5680,
        64
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H7ewI1sOrDYabelt",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get Destination Folder ID - V14 Simplified Routing\n// SIMPLIFIED LOGIC:\n// - Core 4 documents -> Specific folders (01, 03, 10, 36)\n// - ALL OTHER documents -> 37_Others folder\n// - Tracker still gets updated with whatever was classified\n\nconst classificationData = $('Find Client Row and Validate').first().json;\n\n// Get fileId from classification data (passed through from trigger)\nconst fileId = classificationData.fileId;\nconst fileName = classificationData.fileName;\n\n// Get classification info\nconst documentType = classificationData.documentType;\nconst tier1Category = classificationData.tier1Category;\nconst client_name = classificationData.client_name;\nconst client_normalized = classificationData.client_normalized;\n\n// Build lookup from ALL folder rows\nconst allFolderRows = $input.all();\nconst folderLookup = {};\nfor (const row of allFolderRows) {\n  folderLookup[row.json.Variable_Name] = row.json.Folder_ID;\n}\n\nlet finalFolderId;\nlet destinationFolderName;\nlet variableNameSearched;\n\n// Define Core 4 document types\nconst CORE_4_TYPES = [\n  '01_Projektbeschreibung',\n  '03_Grundbuchauszug',\n  '10_Bautraegerkalkulation_DIN276',\n  '36_Exit_Strategie'\n];\n\n// Check if this is a Core 4 document\nif (CORE_4_TYPES.includes(documentType)) {\n  // CORE 4 DOCUMENTS -> Route to specific folders\n  const coreMapping = {\n    '01_Projektbeschreibung': { varName: 'FOLDER_01_PROJEKTBESCHREIBUNG', displayName: '01_Projektbeschreibung' },\n    '03_Grundbuchauszug': { varName: 'FOLDER_03_GRUNDBUCHAUSZUG', displayName: '03_Grundbuchauszug' },\n    '10_Bautraegerkalkulation_DIN276': { varName: 'FOLDER_10_BAUTRAEGERKALKULATION', displayName: '10_Bautraegerkalkulation' },\n    '36_Exit_Strategie': { varName: 'FOLDER_36_EXIT_STRATEGIE', displayName: '36_Exit_Strategie' }\n  };\n\n  const mapping = coreMapping[documentType];\n  if (mapping) {\n    variableNameSearched = mapping.varName;\n    destinationFolderName = mapping.displayName;\n  } else {\n    // Fallback to 37_Others if mapping not found (shouldn't happen)\n    variableNameSearched = 'FOLDER_37_OTHERS';\n    destinationFolderName = '37_Others';\n  }\n} else {\n  // ALL OTHER DOCUMENTS -> Route to 37_Others\n  variableNameSearched = 'FOLDER_37_OTHERS';\n  destinationFolderName = '37_Others';\n}\n\n// Get folder ID from lookup\nfinalFolderId = folderLookup[variableNameSearched];\n\nreturn [{\n  json: {\n    fileId: fileId,\n    fileName: fileName,\n    finalFolderId: finalFolderId,\n    destinationFolderName: destinationFolderName,\n    documentType: documentType,\n    tier1Category: tier1Category,\n    client_name: client_name,\n    client_normalized: client_normalized,\n    debug_variableNameSearched: variableNameSearched,\n    debug_folderLookupSize: Object.keys(folderLookup).length,\n    debug_isCore4: CORE_4_TYPES.includes(documentType)\n  }\n}];"
      },
      "id": "code-4",
      "name": "Get Destination Folder ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5904,
        64
      ]
    },
    {
      "parameters": {
        "operation": "move",
        "fileId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.fileId }}"
        },
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.finalFolderId }}"
        }
      },
      "id": "drive-1",
      "name": "Move File to Final Location",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        6128,
        64
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "a4m50EefR3DJoU0R",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare Success Output - Returns data to Quick Test Runner\n// FIXED: Explicitly include reasoning fields\n\nconst items = $input.all();\nconst outputItems = [];\n\n// Get classification data from Build Google Sheets API Update Request\nconst cd = $(\"Build Google Sheets API Update Request\").first().json;\n\n// Get folder info from Get Destination Folder ID\nconst folderInfo = $(\"Get Destination Folder ID\").first().json;\n\nfor (const item of items) {\n  const dr = item.json;\n  outputItems.push({\n    json: {\n      // Tier 1 classification\n      tier1Category: cd.tier1Category,\n      tier1Confidence: cd.tier1Confidence,\n      tier1Reasoning: cd.tier1Reasoning || '',\n      \n      // Tier 2 classification\n      documentType: cd.documentType,\n      tier2Confidence: cd.tier2Confidence,\n      tier2Reasoning: cd.tier2Reasoning || '',\n      combinedConfidence: cd.combinedConfidence,\n      germanName: cd.germanName,\n      englishName: cd.englishName,\n      \n      // Tracker info\n      mappedColumnName: cd.mappedColumnName,\n      columnLetter: cd.columnLetter,\n      trackerRowIndex: cd.trackerRowIndex,\n      \n      // File info\n      fileId: cd.fileId,\n      fileName: cd.fileName,\n      client_normalized: cd.client_normalized,\n      clientEmail: cd.clientEmail,\n      \n      // Folder info\n      destinationFolderName: folderInfo.destinationFolderName,\n      finalFolderId: folderInfo.finalFolderId,\n      \n      // Drive response\n      driveFileId: dr.id,\n      driveFileName: dr.name,\n      \n      // Status\n      trackerUpdated: true,\n      chunk2_5_status: 'success',\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-5",
      "name": "Prepare Success Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6352,
        240
      ]
    },
    {
      "parameters": {
        "documentId": {
          "mode": "id",
          "value": "1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "AMA_Folder_IDs",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU/edit#gid=0"
        },
        "options": {}
      },
      "id": "sheets-4",
      "name": "Lookup 38_Unknowns Folder",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4784,
        304
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H7ewI1sOrDYabelt",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// FIX: Process ALL items from main data\nconst folderData = $input.all();\nconst mainDataItems = $('Find Client Row and Validate').all();\nconst outputItems = [];\n\n// Skip header row from folder data\nconst dataRows = folderData.slice(1);\n\n// Look for 38_Unknowns folder ID (should be same for all items)\nlet unknownsFolderId = null;\nif (dataRows.length > 0) {\n  for (const row of dataRows) {\n    const rowData = row.json;\n    for (const key in rowData) {\n      if (key.includes('38_Unknowns')) {\n        unknownsFolderId = rowData[key];\n        break;\n      }\n    }\n    if (unknownsFolderId) break;\n  }\n\n  if (!unknownsFolderId) {\n    // Try to get from first row (assuming it might be a global folder)\n    unknownsFolderId = dataRows[0].json['38_Unknowns'] || null;\n  }\n}\n\n// Return one output item per main data item\nfor (const mainData of mainDataItems) {\n  outputItems.push({\n    json: {\n      ...mainData.json,\n      unknownsFolderId: unknownsFolderId,\n      errorFallbackUsed: !unknownsFolderId\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-6",
      "name": "Get 38_Unknowns Folder ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5008,
        304
      ]
    },
    {
      "parameters": {
        "operation": "move",
        "fileId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.fileId }}"
        },
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.unknownsFolderId }}"
        }
      },
      "id": "drive-2",
      "name": "Move File to 38_Unknowns",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        5232,
        304
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "a4m50EefR3DJoU0R",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// FIX: Process ALL items\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const mainData = item.json;\n\n  // FIX: Use client_normalized (snake_case) to match what's being passed\n  const clientName = mainData.client_normalized || mainData.clientNormalized || 'Unknown';\n  const fileName = mainData.fileName || 'Unknown';\n  const fileId = mainData.fileId || '';\n  const errorStatus = mainData.chunk2_5_status || 'unknown_error';\n  const errorMessage = mainData.errorMessage || 'No error details provided';\n  const documentType = mainData.documentType || 'Unknown';\n  const confidence = mainData.documentClassificationConfidence || 0;\n\n  let issueDescription = '';\n  if (errorStatus === 'error_client_not_found') {\n    issueDescription = `Client \\\"${clientName}\\\" was not found in the Client_Tracker sheet.`;\n  } else if (errorStatus === 'error_unclear_type') {\n    issueDescription = `Document type classification had low confidence (${confidence}%). Classified as: ${documentType}.`;\n  } else if (errorStatus === 'error_folder_not_found') {\n    issueDescription = `Destination folder for document type \\\"${documentType}\\\" was not found in AMA_Folder_IDs.`;\n  } else {\n    issueDescription = errorMessage;\n  }\n\n  const fileLink = `https://drive.google.com/file/d/${fileId}/view`;\n\n  const emailSubject = `Eugene: Document Classification Issue - ${clientName}`;\n  const emailBody = `<html>\n<body>\n<h2>Document Classification Issue</h2>\n<p>A document could not be automatically classified and has been moved to the 38_Unknowns folder.</p>\n\n<h3>Details:</h3>\n<ul>\n  <li><strong>Client:</strong> ${clientName}</li>\n  <li><strong>Filename:</strong> ${fileName}</li>\n  <li><strong>Issue:</strong> ${issueDescription}</li>\n  <li><strong>Classified Type:</strong> ${documentType} (${confidence}% confidence)</li>\n  <li><strong>Error Status:</strong> ${errorStatus}</li>\n</ul>\n\n<h3>File Location:</h3>\n<p><a href=\\\"${fileLink}\\\">View file in Google Drive</a></p>\n\n<p>Please review this document and manually classify it.</p>\n</body>\n</html>`;\n\n  outputItems.push({\n    json: {\n      ...mainData,\n      emailSubject: emailSubject,\n      emailBody: emailBody,\n      trackerUpdated: false,\n      chunk2_5_status: errorStatus,\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-7",
      "name": "Prepare Error Email Body",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5456,
        304
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.emailRecipient || 'sway@thebluebottle.io' }}",
        "subject": "Document Classification Error - Action Required",
        "message": "={{ $json.emailBody }}",
        "options": {}
      },
      "id": "gmail-1",
      "name": "Send Error Notification Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        5680,
        304
      ],
      "webhookId": "d50e78b4-8ae0-4171-b62f-c2afdafc7e58",
      "credentials": {
        "gmailOAuth2": {
          "id": "gmailOAuth2",
          "name": "Gmail OAuth2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare Tracker Update Data - UPDATED for Dokumenten_Tracker\n// Now processes ALL document types (not just Core 4)\n// Added aliases for English/German variations\n// DUAL CLASSIFICATION: Handles secondary document types\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const data = item.json;\n\n  // CONDITIONAL: Only prepare tracker data if trackerUpdate === true\n  if (data.trackerUpdate !== true) {\n    // SECONDARY or LOW_CONFIDENCE: Skip tracker update, pass through to folder move\n    outputItems.push({\n      json: {\n        skipTrackerUpdate: true,\n        ...data\n      }\n    });\n    continue;\n  }\n\n  // Get document type from classification\n  const documentType = data.documentType;\n\n  // Map old/English document types to new German types (backwards compatibility)\n  const oldToNewTypeMap = {\n    // Core 4 - multiple aliases\n    '01_Projektbeschreibung': '01_Projektbeschreibung',\n    '01_Expose': '01_Projektbeschreibung',\n    '01_Expos\u00e9': '01_Projektbeschreibung',\n    'Expose': '01_Projektbeschreibung',\n    'Expos\u00e9': '01_Projektbeschreibung',\n    '03_Grundbuchauszug': '02_Grundbuchauszug',\n    'Grundbuchauszug': '02_Grundbuchauszug',\n    'Grundbuch': '02_Grundbuchauszug',\n    '10_Bautraegerkalkulation_DIN276': '03_Bautraegerkalkulation_DIN276',\n    'Bautraegerkalkulation': '03_Bautraegerkalkulation_DIN276',\n    'Calculation': '03_Bautraegerkalkulation_DIN276',\n    'DIN276': '03_Bautraegerkalkulation_DIN276',\n    '36_Exit_Strategie': '04_Exit_Strategie',\n    'Exit_Strategy': '04_Exit_Strategie',\n    'Exit Strategy': '04_Exit_Strategie',\n    // Other document types\n    '09_Altlastenkataster': '05_Altlastenkataster',\n    '10_Baugrundgutachten': '06_Baugrundgutachten',\n    '11_Lageplan': '07_Lageplan',\n    '12_Flaechenberechnung': '08_Flaechenberechnung',\n    '13_GU_Werkvertraege': '09_GU_Werkvertraege',\n    '14_Bauzeichnungen': '10_Bauzeichnungen',\n    '15_Baugenehmigung': '11_Baugenehmigung',\n    '16_Gutachterauftrag': '12_Gutachterauftrag',\n    '17_Verkaufspreise': '13_Verkaufspreise',\n    '18_Bauzeitenplan': '14_Bauzeitenplan',\n    '19_Vertriebsweg': '15_Vertriebsweg',\n    '20_Ausstattungsbeschreibung': '16_Ausstattungsbeschreibung',\n    '21_Teilungserklaerung': '17_Teilungserklaerung',\n    '22_Versicherungen': '18_Versicherungen',\n    '23_Muster_Verkaufsvertrag': '19_Muster_Verkaufsvertrag',\n    '24_Umsatzsteuervoranmeldung': '20_Umsatzsteuervoranmeldung',\n    '25_BWA': '21_BWA',\n    '26_Jahresabschluss': '22_Jahresabschluss',\n    '27_Finanzierungsbestaetigung': '23_Finanzierungsbestaetigung',\n    '28_Darlehensvertrag': '24_Darlehensvertrag',\n    '29_Gesellschaftsvertrag': '25_Gesellschaftsvertrag',\n    '30_Handelsregisterauszug': '26_Handelsregisterauszug',\n    '31_Gewerbeanmeldung': '27_Gewerbeanmeldung',\n    '32_Steuer_ID': '28_Steuer_ID',\n    '33_Freistellungsbescheinigung': '29_Freistellungsbescheinigung',\n    '34_Vollmachten': '30_Vollmachten',\n    '35_Korrespondenz': '31_Korrespondenz',\n    '36_Sonstiges': '32_Sonstiges'\n  };\n\n  // Use new type if mapping exists, otherwise use original\n  const normalizedDocType = oldToNewTypeMap[documentType] || documentType;\n\n  // Map document types to tracker columns (German names)\n  const trackerColumnMapping = {\n    '01_Projektbeschreibung': '01_Projektbeschreibung',\n    '02_Grundbuchauszug': '02_Grundbuchauszug',\n    '03_Bautraegerkalkulation_DIN276': '03_Bautraegerkalkulation_DIN276',\n    '04_Exit_Strategie': '04_Exit_Strategie',\n    '05_Altlastenkataster': '05_Altlastenkataster',\n    '06_Baugrundgutachten': '06_Baugrundgutachten',\n    '07_Lageplan': '07_Lageplan',\n    '08_Flaechenberechnung': '08_Flaechenberechnung',\n    '09_GU_Werkvertraege': '09_GU_Werkvertraege',\n    '10_Bauzeichnungen': '10_Bauzeichnungen',\n    '11_Baugenehmigung': '11_Baugenehmigung',\n    '12_Gutachterauftrag': '12_Gutachterauftrag',\n    '13_Verkaufspreise': '13_Verkaufspreise',\n    '14_Bauzeitenplan': '14_Bauzeitenplan',\n    '15_Vertriebsweg': '15_Vertriebsweg',\n    '16_Ausstattungsbeschreibung': '16_Ausstattungsbeschreibung',\n    '17_Teilungserklaerung': '17_Teilungserklaerung',\n    '18_Versicherungen': '18_Versicherungen',\n    '19_Muster_Verkaufsvertrag': '19_Muster_Verkaufsvertrag',\n    '20_Umsatzsteuervoranmeldung': '20_Umsatzsteuervoranmeldung',\n    '21_BWA': '21_BWA',\n    '22_Jahresabschluss': '22_Jahresabschluss',\n    '23_Finanzierungsbestaetigung': '23_Finanzierungsbestaetigung',\n    '24_Darlehensvertrag': '24_Darlehensvertrag',\n    '25_Gesellschaftsvertrag': '25_Gesellschaftsvertrag',\n    '26_Handelsregisterauszug': '26_Handelsregisterauszug',\n    '27_Gewerbeanmeldung': '27_Gewerbeanmeldung',\n    '28_Steuer_ID': '28_Steuer_ID',\n    '29_Freistellungsbescheinigung': '29_Freistellungsbescheinigung',\n    '30_Vollmachten': '30_Vollmachten',\n    '31_Korrespondenz': '31_Korrespondenz',\n    '32_Sonstiges': '32_Sonstiges',\n    '33_Unbekannt': '33_Unbekannt'\n  };\n\n  const trackerColumn = trackerColumnMapping[normalizedDocType];\n\n  if (!trackerColumn) {\n    // Unknown document type - use 33_Unbekannt\n    outputItems.push({\n      json: {\n        trackerColumn: '33_Unbekannt',\n        trackerValue: '\u2713',\n        unknownDocType: normalizedDocType,\n        skipTrackerUpdate: false,\n        ...data\n      }\n    });\n    continue;\n  }\n\n  // DUAL CLASSIFICATION: Handle secondary document type if present\n  let secondaryTrackerColumn = null;\n  if (data.hasSecondaryClassification && data.secondaryDocumentType) {\n    const normalizedSecondaryType = oldToNewTypeMap[data.secondaryDocumentType] || data.secondaryDocumentType;\n    secondaryTrackerColumn = trackerColumnMapping[normalizedSecondaryType] || null;\n  }\n\n  // Prepare update data for Dokumenten_Tracker\n  outputItems.push({\n    json: {\n      trackerColumn,\n      trackerValue: '\u2713',\n      skipTrackerUpdate: false,\n      // DUAL CLASSIFICATION FIELDS\n      secondaryTrackerColumn,\n      hasSecondaryClassification: data.hasSecondaryClassification || false,\n      ...data\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-8",
      "name": "Prepare Tracker Update Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4784,
        64
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ ({ \"model\": \"gpt-4\", \"messages\": [{\"role\": \"user\", \"content\": $json.tier1Prompt}], \"temperature\": 0 }) }}",
        "options": {}
      },
      "id": "http-openai-1",
      "name": "Classify Document with GPT-4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2096,
        704
      ],
      "credentials": {
        "openAiApi": {
          "id": "xmJ7t6kaKgMwA1ce",
          "name": "OpenAi account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ ({ \"model\": \"gpt-4\", \"messages\": [{\"role\": \"user\", \"content\": $json.tier2Prompt}], \"temperature\": 0 }) }}",
        "options": {}
      },
      "id": "3732e080-c0d3-4763-957d-d4d90761ddd8",
      "name": "Tier 2 GPT-4 API Call",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3440,
        704
      ],
      "credentials": {
        "openAiApi": {
          "id": "xmJ7t6kaKgMwA1ce",
          "name": "OpenAi account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Parse Tier 2 Classification Result from Claude Vision\n// FIX: Process ALL items, not just first\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  // Get corresponding Tier 2 result\n  const tier2Result = $('Parse Claude Tier 2 Response').all()[i].json;\n\n  if (!tier2Result || !tier2Result.documentType) {\n    // Parsing failed - route to LOW_CONFIDENCE\n    outputItems.push({\n      json: {\n        error: 'Failed to parse Tier 2 classification',\n        lowConfidence: true,\n        confidenceFailureStage: 'tier2_parse_error',\n        ...tier2Result\n      }\n    });\n    continue;\n  }\n\n  const {\n    documentType, tier2Confidence, germanName, englishName, isCoreType, tier2Reasoning,\n    fileId, fileName, fileUrl, clientEmail,\n    client_name, client_normalized,  // FIX: Preserve client data\n    tier1Category, tier1Confidence, tier1Reasoning\n  } = tier2Result;\n\n  // THRESHOLD CHECK: Tier 2 confidence must be >= 70%\n  if (tier2Confidence < 70) {\n    outputItems.push({\n      json: {\n        documentType, tier2Confidence, lowConfidence: true, confidenceFailureStage: 'tier2',\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        tier1Category, tier1Confidence, tier1Reasoning\n      }\n    });\n  } else {\n    // Calculate combined confidence\n    const combinedConfidence = Math.round((tier1Confidence + tier2Confidence) / 2);\n\n    outputItems.push({\n      json: {\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        tier1Category, tier1Confidence, tier1Reasoning,\n        documentType, tier2Confidence, combinedConfidence,\n        germanName, englishName, isCoreType, tier2Reasoning\n      }\n    });\n  }\n}\n\nreturn outputItems;"
      },
      "id": "86d8d160-de91-464d-92d0-7db05b7c3f4f",
      "name": "Parse Tier 2 Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3664,
        160
      ]
    },
    {
      "parameters": {
        "jsCode": "// Action Mapper: Determine routing based on classification results\n\nconst data = $input.first().json;\n\n// Check for low confidence flags\nif (data.lowConfidence === true) {\n  return [{\n    json: {\n      ...data,  // \u2190 CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n      actionType: 'LOW_CONFIDENCE',\n      destinationFolder: '38_Unknowns',\n      trackerUpdate: false,\n      sendNotification: true\n    }\n  }];\n}\n\n// Check if CORE type\nif (data.isCoreType === true) {\n  // CORE types: Specific folder + tracker update\n  return [{\n    json: {\n      ...data,  // \u2190 CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n      actionType: 'CORE',\n      trackerUpdate: true,\n      sendNotification: false\n    }\n  }];\n}\n\n// SECONDARY types: 37_Other folder + tracker update (so Eugene can see what they are)\nreturn [{\n  json: {\n    ...data,  // \u2190 CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n    actionType: 'SECONDARY',\n    destinationFolder: '37_Other',\n    trackerUpdate: true,\n    sendNotification: false\n  }\n}];"
      },
      "id": "89b7324c-80e6-4902-9ab5-3f26be09e92a",
      "name": "Determine Action Type",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3888,
        160
      ]
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": "={{ $json.fileId }}",
        "options": {}
      },
      "id": "drive-download-1",
      "name": "Download PDF for Classification",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        528,
        160
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "a4m50EefR3DJoU0R",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Convert PDF to Base64\n// Processing one file at a time (via Split In Batches upstream)\n// Rate limiting handled by Wait nodes between Claude Vision calls\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  try {\n    const binaryKey = Object.keys(item.binary || {})[0];\n    \n    if (!binaryKey) {\n      // No binary data, pass through\n      outputItems.push({\n        json: {\n          ...item.json,\n          pdfError: 'No binary data found'\n        }\n      });\n      continue;\n    }\n    \n    const buffer = await this.helpers.getBinaryDataBuffer(items.indexOf(item), binaryKey);\n    const base64Content = buffer.toString('base64');\n    const mimeType = item.json.mimeType || 'application/pdf';\n    const fileSizeKB = Math.round(buffer.length / 1024);\n    \n    outputItems.push({\n      json: {\n        ...item.json,\n        imageData: {\n          type: 'base64',\n          media_type: mimeType,\n          data: base64Content\n        },\n        pdfMetadata: {\n          fileSizeKB: fileSizeKB,\n          note: 'Full PDF sent - rate limiting via Wait nodes'\n        }\n      },\n      binary: item.binary\n    });\n  } catch (error) {\n    outputItems.push({\n      json: {\n        ...item.json,\n        pdfError: error.message\n      }\n    });\n  }\n}\n\nreturn outputItems;"
      },
      "id": "code-convert-pdf",
      "name": "Convert PDF to Base64",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        160
      ]
    },
    {
      "parameters": {
        "jsCode": "// RATE LIMIT PROTECTION: Wait 30 seconds before each Claude API call\nawait new Promise(resolve => setTimeout(resolve, 30000));\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  // FIX: Get tier1Prompt from the SAME item, not always from first()\n  const tier1Prompt = item.json.tier1Prompt;\n  const imageData = item.json.imageData;\n\n  if (!imageData || !imageData.data) {\n    throw new Error('No image data found in item');\n  }\n\n  const requestBody = {\n    model: 'claude-sonnet-4-20250514',\n    max_tokens: 200,\n    messages: [\n      {\n        role: 'user',\n        content: [\n          {\n            type: 'document',\n            source: {\n              type: 'base64',\n              media_type: imageData.media_type,\n              data: imageData.data\n            }\n          },\n          {\n            type: 'text',\n            text: tier1Prompt\n          }\n        ]\n      }\n    ]\n  };\n\n  outputItems.push({\n    json: {\n      ...item.json,\n      claudeRequestBody: requestBody\n    },\n    binary: item.binary\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-build-claude-tier1",
      "name": "Build Claude Tier 1 Request Body",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        160
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.claudeRequestBody }}",
        "options": {}
      },
      "id": "http-claude-tier1",
      "name": "Claude Vision Tier 1 Classification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1648,
        160
      ],
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 120000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "vfoYopBRX35Znmq6",
          "name": "Anthropic API key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const response = item.json;\n\n  if (!response.content || !response.content[0] || !response.content[0].text) {\n    throw new Error('Invalid Claude API response structure');\n  }\n\n  let textContent = response.content[0].text.trim();\n\n  // Strip markdown code fences if present\n  if (textContent.startsWith('```json')) {\n    textContent = textContent\n      .replace(/^```json\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  } else if (textContent.startsWith('```')) {\n    textContent = textContent\n      .replace(/^```\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  }\n\n  const parsedResult = JSON.parse(textContent);\n  \n  // FIX CRITICAL: Get metadata from the corresponding item in previous node\n  const previousData = $('Build Claude Tier 1 Request Body').all()[i].json;\n\n  outputItems.push({\n    json: {\n      ...previousData,  // PRESERVE ALL INCOMING DATA including client_name, client_normalized\n      tier1Category: parsedResult.tier1Category,\n      tier1Confidence: parsedResult.tier1Confidence,\n      tier1Reasoning: parsedResult.reasoning || ''\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-parse-claude-tier1",
      "name": "Parse Claude Tier 1 Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2096,
        160
      ]
    },
    {
      "parameters": {
        "jsCode": "// RATE LIMIT PROTECTION: Wait 30 seconds before each Claude API call\nawait new Promise(resolve => setTimeout(resolve, 30000));\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const tier2Prompt = item.json.tier2Prompt;\n  \n  // FIX: Get imageData from the corresponding item, not always first()\n  const imageData = $('Convert PDF to Base64').all()[i].json.imageData;\n\n  if (!imageData || !imageData.data) {\n    throw new Error('No image data found for Tier 2 classification');\n  }\n\n  const requestBody = {\n    model: 'claude-sonnet-4-20250514',\n    max_tokens: 300,\n    messages: [\n      {\n        role: 'user',\n        content: [\n          {\n            type: 'document',\n            source: {\n              type: 'base64',\n              media_type: imageData.media_type,\n              data: imageData.data\n            }\n          },\n          {\n            type: 'text',\n            text: tier2Prompt\n          }\n        ]\n      }\n    ]\n  };\n\n  outputItems.push({\n    json: {\n      ...item.json,\n      claudeTier2RequestBody: requestBody\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-build-claude-tier2",
      "name": "Build Claude Tier 2 Request Body",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2544,
        160
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.claudeTier2RequestBody }}",
        "options": {}
      },
      "id": "http-claude-tier2",
      "name": "Claude Vision Tier 2 Classification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2992,
        160
      ],
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 120000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "vfoYopBRX35Znmq6",
          "name": "Anthropic API key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const response = item.json;\n\n  if (!response.content || !response.content[0] || !response.content[0].text) {\n    throw new Error('Invalid Claude API Tier 2 response structure');\n  }\n\n  let textContent = response.content[0].text.trim();\n\n  // Strip markdown code fences if present\n  if (textContent.startsWith('```json')) {\n    textContent = textContent\n      .replace(/^```json\\\\s*\\\\n/, '')\n      .replace(/\\\\n```\\\\s*$/, '');\n  } else if (textContent.startsWith('```')) {\n    textContent = textContent\n      .replace(/^```\\\\s*\\\\n/, '')\n      .replace(/\\\\n```\\\\s*$/, '');\n  }\n\n  // ROBUST JSON EXTRACTION: Handle prose text wrapping JSON\n  let parsedResult;\n  \n  // Try direct parse first\n  try {\n    parsedResult = JSON.parse(textContent);\n  } catch (directParseError) {\n    // If direct parse fails, try to extract JSON from the text\n    \n    // Method 1: Find JSON object in the text (starts with { ends with })\n    const jsonMatch = textContent.match(/\\\\{[\\\\s\\\\S]*\\\\}/g);\n    if (jsonMatch && jsonMatch.length > 0) {\n      // Try the last match (most likely the full JSON object)\n      for (let j = jsonMatch.length - 1; j >= 0; j--) {\n        try {\n          parsedResult = JSON.parse(jsonMatch[j]);\n          break; // Success! Exit loop\n        } catch (e) {\n          continue; // Try next match\n        }\n      }\n    }\n    \n    // Method 2: Look for JSON inside markdown code block in the middle of text\n    if (!parsedResult) {\n      const codeBlockMatch = textContent.match(/```(?:json)?\\\\s*([\\\\s\\\\S]*?)```/);\n      if (codeBlockMatch && codeBlockMatch[1]) {\n        try {\n          parsedResult = JSON.parse(codeBlockMatch[1].trim());\n        } catch (e) {\n          // Still failed\n        }\n      }\n    }\n    \n    // If all extraction methods failed, throw with helpful message\n    if (!parsedResult) {\n      throw new Error(`Could not extract JSON from Claude response. First 200 chars: ${textContent.substring(0, 200)}...`);\n    }\n  }\n\n  // FIX: Get metadata from the corresponding item in previous node\n  const previousData = $('Parse Classification Result').all()[i].json;\n\n  // DUAL CLASSIFICATION: Extract secondary classification if present\n  const hasSecondaryClassification = parsedResult.hasSecondaryClassification === true;\n  const secondaryDocumentType = hasSecondaryClassification ? parsedResult.secondaryDocumentType : null;\n  const secondaryGermanName = hasSecondaryClassification ? parsedResult.secondaryGermanName : null;\n  const secondaryReasoning = hasSecondaryClassification ? parsedResult.secondaryReasoning : null;\n\n  outputItems.push({\n    json: {\n      ...previousData,  // This preserves client_name, client_normalized, etc.\n      documentType: parsedResult.documentType,\n      tier2Confidence: parsedResult.tier2Confidence,\n      germanName: parsedResult.germanName,\n      englishName: parsedResult.englishName,\n      isCoreType: parsedResult.isCoreType,\n      tier2Reasoning: parsedResult.reasoning || '',\n      // DUAL CLASSIFICATION FIELDS\n      hasSecondaryClassification,\n      secondaryDocumentType,\n      secondaryGermanName,\n      secondaryReasoning\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-parse-claude-tier2",
      "name": "Parse Claude Tier 2 Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3440,
        160
      ]
    },
    {
      "parameters": {
        "amount": 60
      },
      "id": "wait-after-tier1",
      "name": "Wait After Tier 1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1872,
        160
      ],
      "webhookId": "09d67e4e-d872-45b3-8421-4639ada494f7"
    },
    {
      "parameters": {
        "amount": 60
      },
      "id": "wait-after-tier2",
      "name": "Wait After Tier 2",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3216,
        160
      ],
      "webhookId": "2ebc9318-2e89-4007-9cdc-f38f3121d489"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "split-batches-001",
      "name": "Process One File at a Time",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        304,
        464
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "85b5d5c7-cb7b-43fb-a47a-7def8098a29b",
                    "leftValue": "={{ $json.chunk2_5_status }}",
                    "rightValue": "error_unclear_type",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "error"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "bc10ada4-798c-4d82-9b0b-062f7679e1c2",
                    "leftValue": "={{ $json.chunk2_5_status }}",
                    "rightValue": "success",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update_tracker"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "032787ac-b6d7-417a-8011-f68246aed0e6",
                    "leftValue": "={{ $json.chunk2_5_status }}",
                    "rightValue": "error_client_not_found",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "skip_tracker"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "d4336ded-fbdb-4dff-9518-4523471dc798",
      "name": "Route Based on Document Type1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        4560,
        128
      ]
    },
    {
      "parameters": {
        "amount": 20
      },
      "id": "wait-before-tier1",
      "name": "Wait Before Tier 1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1424,
        160
      ],
      "webhookId": "dcfb75d4-4b31-4f3d-8d62-6a7d74a8cb4d"
    },
    {
      "parameters": {
        "amount": 20
      },
      "id": "wait-before-tier2",
      "name": "Wait Before Tier 2",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2768,
        160
      ],
      "webhookId": "9bef8db0-18fb-4e3a-ae5b-1e8bcde21d96"
    },
    {
      "parameters": {
        "jsCode": "// Build Google Sheets API Update Request - UPDATED for Dokumenten_Tracker\n// Maps AI document types to actual sheet column names\n// FIXED: Explicitly include reasoning fields\n// DUAL CLASSIFICATION: Adds secondary tracker updates if present\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const data = item.json;\n\n  // If skipTrackerUpdate is true, pass through without update\n  if (data.skipTrackerUpdate === true) {\n    outputItems.push({\n      json: {\n        ...data,\n        trackerUpdateSkipped: true\n      }\n    });\n    continue;\n  }\n\n  // Map AI document types to sheet column names\n  const aiToSheetMapping = {\n    '01_Projektbeschreibung': '01_Expos\u00e9',\n    '02_Kaufvertrag': '02_Grundbuchauszug',\n    '03_Grundbuchauszug': '02_Grundbuchauszug',\n    '10_Bautraegerkalkulation_DIN276': '03_Bautraegerkalkulation_DIN276',\n    '36_Exit_Strategie': '04_Exit_Strategie',\n    '07_Altlastenkataster': '05_Altlastenkataster',\n    '08_Baugrundgutachten': '06_Baugrundgutachten',\n    '09_Lageplan': '07_Lageplan',\n    '15_Flaechenberechnung_DIN277': '08_Flaechenberechnung',\n    '16_GU_Werkvertraege': '09_GU_Werkvertraege',\n    '17_Bauzeichnungen': '10_Bauzeichnungen',\n    '18_Baugenehmigung': '11_Baugenehmigung',\n    '22_Gutachterauftrag': '12_Gutachterauftrag',\n    '11_Verkaufspreise': '13_Verkaufspreise',\n    '12_Bauzeitenplan_Liquiditaet': '14_Bauzeitenplan',\n    '13_Vertriebsweg': '15_Vertriebsweg',\n    '14_Bau_Ausstattungsbeschreibung': '16_Ausstattungsbeschreibung',\n    '19_Teilungserklaerung': '17_Teilungserklaerung',\n    '20_Versicherungen': '18_Versicherungen',\n    '21_Muster_Verkaufsvertrag': '19_Muster_Verkaufsvertrag',\n    '23_Umsatzsteuervoranmeldung': '20_Umsatzsteuervoranmeldung',\n    '24_BWA': '21_BWA',\n    '25_Jahresabschluss': '22_Jahresabschluss',\n    '26_Finanzierungsbestaetigung': '23_Finanzierungsbestaetigung',\n    '27_Darlehensvertrag': '24_Darlehensvertrag',\n    '28_Gesellschaftsvertrag': '25_Gesellschaftsvertrag',\n    '29_Handelsregisterauszug': '26_Handelsregisterauszug',\n    '30_Gewerbeanmeldung': '27_Gewerbeanmeldung',\n    '31_Steuer_ID': '28_Steuer_ID',\n    '32_Freistellungsbescheinigung': '29_Freistellungsbescheinigung',\n    '33_Vollmachten': '30_Vollmachten',\n    '34_Korrespondenz': '31_Korrespondenz',\n    '35_Sonstiges_Allgemein': '32_Sonstiges',\n    '37_Others': '32_Sonstiges',\n    '38_Unknowns': '33_Unbekannt'\n  };\n\n  // Map sheet column names to column letters (A-AI)\n  const columnLetterMapping = {\n    'Mandant': 'A',\n    'Letzte_Aktualisierung': 'B',\n    '01_Expos\u00e9': 'C',\n    '02_Grundbuchauszug': 'D',\n    '03_Bautraegerkalkulation_DIN276': 'E',\n    '04_Exit_Strategie': 'F',\n    '05_Altlastenkataster': 'G',\n    '06_Baugrundgutachten': 'H',\n    '07_Lageplan': 'I',\n    '08_Flaechenberechnung': 'J',\n    '09_GU_Werkvertraege': 'K',\n    '10_Bauzeichnungen': 'L',\n    '11_Baugenehmigung': 'M',\n    '12_Gutachterauftrag': 'N',\n    '13_Verkaufspreise': 'O',\n    '14_Bauzeitenplan': 'P',\n    '15_Vertriebsweg': 'Q',\n    '16_Ausstattungsbeschreibung': 'R',\n    '17_Teilungserklaerung': 'S',\n    '18_Versicherungen': 'T',\n    '19_Muster_Verkaufsvertrag': 'U',\n    '20_Umsatzsteuervoranmeldung': 'V',\n    '21_BWA': 'W',\n    '22_Jahresabschluss': 'X',\n    '23_Finanzierungsbestaetigung': 'Y',\n    '24_Darlehensvertrag': 'Z',\n    '25_Gesellschaftsvertrag': 'AA',\n    '26_Handelsregisterauszug': 'AB',\n    '27_Gewerbeanmeldung': 'AC',\n    '28_Steuer_ID': 'AD',\n    '29_Freistellungsbescheinigung': 'AE',\n    '30_Vollmachten': 'AF',\n    '31_Korrespondenz': 'AG',\n    '32_Sonstiges': 'AH',\n    '33_Unbekannt': 'AI'\n  };\n\n  // Get document type from AI classification\n  const documentType = data.documentType || data.trackerColumn;\n  const trackerRowIndex = data.trackerRowIndex;\n  const trackerValue = data.trackerValue || '\u2713';\n\n  // First map AI type to sheet column name\n  let sheetColumnName = aiToSheetMapping[documentType];\n  \n  // If not in AI mapping, check if it's already a sheet column name\n  if (!sheetColumnName && columnLetterMapping[documentType]) {\n    sheetColumnName = documentType;\n  }\n  \n  // Fallback to 33_Unbekannt if unknown\n  if (!sheetColumnName) {\n    console.log(`Unknown document type: ${documentType}, defaulting to 33_Unbekannt`);\n    sheetColumnName = '33_Unbekannt';\n  }\n\n  const columnLetter = columnLetterMapping[sheetColumnName];\n  const timestampColumn = columnLetterMapping['Letzte_Aktualisierung'];\n  \n  if (!columnLetter) {\n    throw new Error(`No column letter mapping for: ${sheetColumnName}`);\n  }\n\n  // Build ranges for update\n  const statusRange = `Dokumenten_Tracker!${columnLetter}${trackerRowIndex}`;\n  const timestampRange = `Dokumenten_Tracker!${timestampColumn}${trackerRowIndex}`;\n  const timestamp = new Date().toISOString();\n\n  // Build batchUpdate request body - START WITH PRIMARY CLASSIFICATION\n  const updateData = [\n    {\n      range: statusRange,\n      values: [[trackerValue]]\n    },\n    {\n      range: timestampRange,\n      values: [[timestamp]]\n    }\n  ];\n\n  // DUAL CLASSIFICATION: Add secondary update if present\n  if (data.hasSecondaryClassification && data.secondaryTrackerColumn) {\n    // Map secondary tracker column to sheet column name\n    let secondarySheetColumnName = aiToSheetMapping[data.secondaryTrackerColumn];\n    if (!secondarySheetColumnName && columnLetterMapping[data.secondaryTrackerColumn]) {\n      secondarySheetColumnName = data.secondaryTrackerColumn;\n    }\n    \n    if (secondarySheetColumnName) {\n      const secondaryColumnLetter = columnLetterMapping[secondarySheetColumnName];\n      if (secondaryColumnLetter) {\n        const secondaryStatusRange = `Dokumenten_Tracker!${secondaryColumnLetter}${trackerRowIndex}`;\n        updateData.push({\n          range: secondaryStatusRange,\n          values: [['\u2713 (sec)']]\n        });\n      }\n    }\n  }\n\n  const requestBody = {\n    data: updateData,\n    valueInputOption: 'USER_ENTERED'\n  };\n\n  // FIXED: Explicitly include all fields including reasoning\n  outputItems.push({\n    json: {\n      // Core classification data\n      fileId: data.fileId,\n      fileName: data.fileName,\n      fileUrl: data.fileUrl,\n      clientEmail: data.clientEmail,\n      client_name: data.client_name,\n      client_normalized: data.client_normalized,\n      \n      // Tier 1 classification\n      tier1Category: data.tier1Category,\n      tier1Confidence: data.tier1Confidence,\n      tier1Reasoning: data.tier1Reasoning || '',\n      \n      // Tier 2 classification\n      documentType: data.documentType,\n      tier2Confidence: data.tier2Confidence,\n      tier2Reasoning: data.tier2Reasoning || '',\n      combinedConfidence: data.combinedConfidence,\n      germanName: data.germanName,\n      englishName: data.englishName,\n      isCoreType: data.isCoreType,\n      \n      // DUAL CLASSIFICATION\n      hasSecondaryClassification: data.hasSecondaryClassification || false,\n      secondaryDocumentType: data.secondaryDocumentType || null,\n      secondaryGermanName: data.secondaryGermanName || null,\n      secondaryReasoning: data.secondaryReasoning || null,\n      secondaryTrackerColumn: data.secondaryTrackerColumn || null,\n      \n      // Tracker info\n      trackerRowIndex: trackerRowIndex,\n      trackerColumn: data.trackerColumn,\n      trackerValue: trackerValue,\n      \n      // API request data\n      sheetsApiRequestBody: requestBody,\n      spreadsheetId: '12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I',\n      mappedColumnName: sheetColumnName,\n      columnLetter: columnLetter\n    }\n  });\n}\n\nreturn outputItems;"
      },
      "id": "code-build-sheets-api-update",
      "name": "Build Google Sheets API Update Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5008,
        64
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheetId }}/values:batchUpdate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleSheetsOAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.sheetsApiRequestBody }}",
        "options": {}
      },
      "id": "http-update-tracker",
      "name": "Update Client_Tracker Row (API)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5456,
        -64
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "H7ewI1sOrDYabelt",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "skip-check",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              },
              "leftValue": "={{ $json.skipTrackerUpdate }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "if-skip-tracker",
      "name": "Should Update Tracker?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5232,
        64
      ]
    },
    {
      "id": "if-dual-classification",
      "name": "Check Dual Classification",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3664,
        320
      ],
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict",
            "combinator": "and"
          },
          "conditions": [
            {
              "id": "dual-class-check",
              "leftValue": "={{ $json.hasSecondaryClassification }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      }
    },
    {
      "id": "gmail-dual-classification",
      "name": "Send Dual Classification Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        3888,
        440
      ],
      "parameters": {
        "resource": "message",
        "operation": "send",
        "sendTo": "sway@thebluebottle.io",
        "subject": "Document with Multiple Classifications - Review Needed",
        "emailFormat": "text",
        "message": "=Document requires review - multiple valid classifications detected\\n\\n**File Details:**\\n- File Name: {{ $json.fileName }}\\n- Client: {{ $json.client_name }}\\n\\n**Primary Classification:**\\n- Tier 1: {{ $json.tier1Category }}\\n- Tier 2: {{ $json.documentType }} ({{ $json.germanName }})\\n- Reasoning: {{ $json.tier2Reasoning }}\\n\\n**Secondary Classification:**\\n- Document Type: {{ $json.secondaryDocumentType }} ({{ $json.secondaryGermanName }})\\n- Reasoning: {{ $json.secondaryReasoning }}\\n\\n**Action Required:**\\nReview the document and determine which classification is correct, or if both should be applied.\\n\\nFile URL: {{ $json.fileUrl }}",
        "options": {}
      },
      "credentials": {
        "gmailOAuth2": {
          "id": "aYzk7sZF8ZVyfOan",
          "name": "Gmail account"
        }
      }
    }
  ],
  "connections": {
    "Lookup Client in Client_Tracker": {
      "main": [
        [
          {
            "node": "Find Client Row and Validate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lookup Client in AMA_Folder_IDs": {
      "main": [
        [
          {
            "node": "Get Destination Folder ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Destination Folder ID": {
      "main": [
        [
          {
            "node": "Move File to Final Location",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Move File to Final Location": {
      "main": [
        [
          {
            "node": "Prepare Success Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lookup 38_Unknowns Folder": {
      "main": [
        [
          {
            "node": "Get 38_Unknowns Folder ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get 38_Unknowns Folder ID": {
      "main": [
        [
          {
            "node": "Move File to 38_Unknowns",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Move File to 38_Unknowns": {
      "main": [
        [
          {
            "node": "Prepare Error Email Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Error Email Body": {
      "main": [
        [
          {
            "node": "Send Error Notification Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classify Document with GPT-4": {
      "main": [
        [
          {
            "node": "Parse Classification Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tier 2 GPT-4 API Call": {
      "main": [
        [
          {
            "node": "Parse Tier 2 Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Tier 2 Result": {
      "main": [
        [
          {
            "node": "Determine Action Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determine Action Type": {
      "main": [
        [
          {
            "node": "Lookup Client in Client_Tracker",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Client Row and Validate": {
      "main": [
        [
          {
            "node": "Route Based on Document Type1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download PDF for Classification": {
      "main": [
        [
          {
            "node": "Convert PDF to Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert PDF to Base64": {
      "main": [
        [
          {
            "node": "Build AI Classification Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Classification Prompt": {
      "main": [
        [
          {
            "node": "Build Claude Tier 1 Request Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Claude Tier 1 Response": {
      "main": [
        [
          {
            "node": "Parse Classification Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Classification Result": {
      "main": [
        [
          {
            "node": "Build Claude Tier 2 Request Body",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Claude Tier 2 Response": {
      "main": [
        [
          {
            "node": "Check Dual Classification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude Vision Tier 1 Classification": {
      "main": [
        [
          {
            "node": "Wait After Tier 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait After Tier 1": {
      "main": [
        [
          {
            "node": "Parse Claude Tier 1 Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude Vision Tier 2 Classification": {
      "main": [
        [
          {
            "node": "Wait After Tier 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait After Tier 2": {
      "main": [
        [
          {
            "node": "Parse Claude Tier 2 Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Workflow Trigger (Refreshed)": {
      "main": [
        [
          {
            "node": "Process One File at a Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Success Output": {
      "main": [
        [
          {
            "node": "Process One File at a Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Error Notification Email": {
      "main": [
        [
          {
            "node": "Process One File at a Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Based on Document Type1": {
      "main": [
        [
          {
            "node": "Lookup 38_Unknowns Folder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Tracker Update Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Lookup 38_Unknowns Folder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Lookup 38_Unknowns Folder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process One File at a Time": {
      "1": [
        [
          {
            "node": "Download PDF for Classification",
            "type": "0",
            "index": 0
          }
        ]
      ],
      "main": [
        [],
        [
          {
            "node": "Download PDF for Classification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Claude Tier 1 Request Body": {
      "main": [
        [
          {
            "node": "Wait Before Tier 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Before Tier 1": {
      "main": [
        [
          {
            "node": "Claude Vision Tier 1 Classification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Claude Tier 2 Request Body": {
      "main": [
        [
          {
            "node": "Wait Before Tier 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Before Tier 2": {
      "main": [
        [
          {
            "node": "Claude Vision Tier 2 Classification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Tracker Update Data": {
      "main": [
        [
          {
            "node": "Build Google Sheets API Update Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Client_Tracker Row (API)": {
      "main": [
        [
          {
            "node": "Lookup Client in AMA_Folder_IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Update Tracker?": {
      "main": [
        [
          {
            "node": "Update Client_Tracker Row (API)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Lookup Client in AMA_Folder_IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Google Sheets API Update Request": {
      "main": [
        [
          {
            "node": "Should Update Tracker?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Dual Classification": {
      "main": [
        [
          {
            "node": "Send Dual Classification Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Parse Tier 2 Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Dual Classification Email": {
      "main": [
        [
          {
            "node": "Parse Tier 2 Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "3a8f8199-e96a-4682-a8e8-77478e798553",
  "activeVersionId": "3a8f8199-e96a-4682-a8e8-77478e798553",
  "versionCounter": 727,
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2026-01-08T21:33:22.263Z",
      "createdAt": "2026-01-08T21:33:22.263Z",
      "role": "workflow:owner",
      "workflowId": "okg8wTqLtPUwjQ18",
      "projectId": "Rs8mhw052fnrzWZM",
      "project": {
        "updatedAt": "2025-12-31T15:54:29.115Z",
        "createdAt": "2025-12-31T15:27:33.865Z",
        "id": "Rs8mhw052fnrzWZM",
        "name": "Sway Clarke <sway@oloxa.ai>",
        "type": "personal",
        "icon": null,
        "description": null,
        "creatorId": "e9bd9112-c2e3-4f67-873a-e1001baeafd8",
        "projectRelations": [
          {
            "updatedAt": "2025-12-31T15:27:33.865Z",
            "createdAt": "2025-12-31T15:27:33.865Z",
            "userId": "e9bd9112-c2e3-4f67-873a-e1001baeafd8",
            "projectId": "Rs8mhw052fnrzWZM",
            "user": {
              "updatedAt": "2026-01-28T23:00:37.532Z",
              "createdAt": "2025-12-31T15:27:33.119Z",
              "id": "e9bd9112-c2e3-4f67-873a-e1001baeafd8",
              "email": "sway@oloxa.ai",
              "firstName": "Sway",
              "lastName": "Clarke",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-12-31T15:54:37.562Z",
                "personalization_survey_n8n_version": "2.1.4"
              },
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "zbxHkXOoD1qaz6OS",
                "userActivatedAt": 1767398053308,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1767684846804
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2026-01-28",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": {
    "updatedAt": "2026-01-29T12:27:33.017Z",
    "createdAt": "2026-01-29T12:27:33.017Z",
    "versionId": "3a8f8199-e96a-4682-a8e8-77478e798553",
    "workflowId": "okg8wTqLtPUwjQ18",
    "nodes": [
      {
        "parameters": {
          "inputSource": "passthrough"
        },
        "id": "trigger-1",
        "name": "Execute Workflow Trigger (Refreshed)",
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "typeVersion": 1.1,
        "position": [
          80,
          464
        ]
      },
      {
        "parameters": {
          "jsCode": "// Build Tier 1 Classification Prompt\n// Classify document into 1 of 4 broad categories\n\n// === Process ALL items, not just first ===\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  // === CRITICAL: Extract and preserve ALL file metadata fields ===\n  const fileId = item.json.fileId || item.json.body?.fileId || null;\n  const filename = item.json.fileName || item.json.filename || item.json.body?.fileName || item.json.body?.filename || 'unknown_file.pdf';\n  const fileUrl = item.json.fileUrl || item.json.body?.fileUrl || null;\n\n  // FIX: Use actual emailFrom instead of hardcoded test email\n  const clientEmail = item.json.emailFrom || item.json.senderEmail || item.json.clientEmail || item.json.body?.emailFrom || item.json.body?.clientEmail || 'unknown@example.com';\n\n  // Tier 1 Prompt: Classify into 4 broad categories\n  const tier1Prompt = `You are a German real estate document classifier for AMA Capital.\n\nTASK: Classify this document into ONE of 4 broad categories based on the filename.\n\nFILENAME: ${filename}\nCLIENT: ${clientEmail}\n\nCATEGORIES:\n\n1. OBJEKTUNTERLAGEN (Property/Object Documents)\n   Keywords: Projekt, Beschreibung, Expose, Grundbuch, Kaufvertrag, Bau, Lageplan, Zeichnungen, Genehmigung, DIN276, DIN277, Werkvertrag, Flaeche, Erschlie\u00dfung, Bodenschutz, Altlasten, Baulasten, Baugrund\n\n   INCLUDES municipal/infrastructure documents:\n   - Erschlie\u00dfungsbeitragsbescheinigung (development contribution)\n   - Bodenschutz (soil protection)\n   - Altlastenkataster (contaminated sites)\n   - Baulastenverzeichnis (building encumbrances)\n\n   Examples: Project descriptions, land register, purchase agreements, building permits, construction drawings, calculations, municipal property certificates\n\n2. WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents)\n\n   Keywords to identify:\n   - Finanzierung, Finanzierungsbest\u00e4tigung, Darlehen, Kredit, Zinssatz\n   - Kalkulation, DIN276, Baukosten, Herstellkosten\n   - Verkaufspreise, Kaufpreise, Preisliste\n   - Angebot (if from bank/financial institution OR contains pricing)\n   - Werkvertrag, GU-Vertrag, Bauvertrag\n   - **Memo/Memorandum (if contains financial data: amounts, financing terms, capital requirements, loan conditions)**\n\n   DO NOT CONFUSE WITH SONSTIGES (Miscellaneous):\n   - \"Memo\" or \"Memorandum\" alone does NOT automatically mean SONSTIGES\n   - Check content: if memo contains financing key data \u2192 WIRTSCHAFTLICHE_UNTERLAGEN\n     - Financing key data includes: project volume, capital requirement, loan amounts, interest rates, financing terms, collateral details\n   - If memo contains financial investment proposals or financing requests \u2192 WIRTSCHAFTLICHE_UNTERLAGEN\n   - Only classify as SONSTIGES if memo is general correspondence without financial specifics\n\n   Examples: Sales prices, construction schedules, insurance, VAT returns, financial statements, loan agreements, financing memos\n\n3. RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents)\n   Keywords: Gesellschaft, Vertrag, Handelsregister, Gewerbe, Steuer, ID, Freistellung (TAX exemption only), Vollmacht\n\n   EXCLUDES property-related municipal certificates (those go in OBJEKTUNTERLAGEN)\n\n   Examples: Partnership agreements, commercial register, business registration, TAX ID, TAX exemption certificates, powers of attorney\n\n4. SONSTIGES (Miscellaneous)\n   Keywords: Gutachter, Korrespondenz, Sonstiges, Others\n   Examples: Expert assignments, correspondence, general miscellaneous\n\nCRITICAL CONSISTENCY RULE:\nBase your classification PRIMARILY on FILENAME keywords. The filename is the most reliable indicator of document type.\n\nDecision priority:\n1. **Filename keywords** (highest priority) - analyze German terms in filename\n2. Document structure (if filename is generic like \"document.pdf\")\n3. Content analysis (fallback only)\n\nWHY: This ensures the same filename always gets the same tier 1 category, improving duplicate consistency.\n\nEXAMPLE: \"Erschlie\u00dfungsbeitragsbescheinigung.pdf\"\n- Filename contains \"Erschlie\u00dfung\" \u2192 OBJEKTUNTERLAGEN \u2713\n- Even if content is hard to read, filename determines category\n\nINSTRUCTIONS:\n1. Analyze the filename for German keywords\n2. Match to the most appropriate category\n3. Provide confidence score (0-100)\n4. Explain your reasoning in 1-2 sentences\n\nRESPONSE FORMAT (JSON only, no markdown):\n{\n  \"tier1Category\": \"OBJEKTUNTERLAGEN | WIRTSCHAFTLICHE_UNTERLAGEN | RECHTLICHE_UNTERLAGEN | SONSTIGES\",\n  \"tier1Confidence\": 85,\n  \"reasoning\": \"Brief explanation of why this category was chosen\"\n}\n\nSTRICT RULES:\n- Response must be valid JSON only\n- tier1Confidence must be 0-100 number\n- tier1Category must be exactly one of the 4 options above\n- No markdown formatting\n- No code blocks\n- No explanatory text outside JSON`;\n\n  outputItems.push({\n    json: {\n      tier1Prompt,\n      // === EXPLICITLY PRESERVE ALL FILE METADATA (CRITICAL) ===\n      fileId,\n      fileName: filename,\n      fileUrl,\n      clientEmail,\n      // === CRITICAL: Preserve client_name and client_normalized ===\n      client_name: item.json.client_name,\n      client_normalized: item.json.client_normalized,\n      // Pass through all input data for additional fields\n      ...item.json\n    }\n  });\n}\n\nreturn outputItems;\n"
        },
        "id": "code-1",
        "name": "Build AI Classification Prompt",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          976,
          160
        ]
      },
      {
        "parameters": {
          "jsCode": "// Parse Tier 1 Classification Result + Build Dynamic Tier 2 Prompt\n// FIX: Process ALL items, not just first\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n\n  // Get corresponding items from previous nodes\n  const promptData = $('Build AI Classification Prompt').all()[i].json;\n  const tier1Result = $('Parse Claude Tier 1 Response').all()[i].json;\n\n  const fileId = promptData.fileId;\n  const fileName = promptData.fileName;\n  const fileUrl = promptData.fileUrl;\n  const clientEmail = promptData.clientEmail;\n  const client_name = promptData.client_name;\n  const client_normalized = promptData.client_normalized;\n\n  if (!tier1Result || !tier1Result.tier1Category) {\n    outputItems.push({\n      json: {\n        error: 'Failed to parse Tier 1 classification',\n        tier1Category: 'UNKNOWN',\n        tier1Confidence: 0,\n        tier2Prompt: 'ERROR: Failed to parse Tier 1 classification',\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        ...item.json\n      }\n    });\n    continue;\n  }\n\n  const { tier1Category, tier1Confidence, tier1Reasoning } = tier1Result;\n  const reasoning = tier1Reasoning || '';\n\n  let tier2Prompt = '';\n\n  if (tier1Category === 'OBJEKTUNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as OBJEKTUNTERLAGEN (Property/Object Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n01_Projektbeschreibung (Expos\u00e9/Project Description) \u2b50 CORE\\n   Keywords: Projekt, Beschreibung, Expose, Overview, Proposal, Teaser, Marketing, Verkaufs (in marketing context)\\n   Description: Marketing-oriented project overview, property description, investment proposal\\n\\n   BOUNDARY RULES - Use 01_Projektbeschreibung when:\\n   \u2713 Filename contains: Expose, Projekt, Beschreibung, Teaser, Praesentation\\n   \u2713 Marketing/sales focused materials\\n   \u2713 Investment proposals\\n\\n   DO NOT use 01_Projektbeschreibung for:\\n   \u2717 Energieausweis / Energiebedarfsausweis \u2192 use 37_Others (technical certificate)\\n   \u2717 Detailed Baubeschreibung (Regelgeschoss, Dachgeschoss, etc.) \u2192 use 14_Bau_Ausstattungsbeschreibung\\n   \u2717 Highly technical specifications \u2192 use 14_Bau_Ausstattungsbeschreibung\\n\\n   DISTINCTION: 01 is for MARKETING, 14 is for TECHNICAL/CONSTRUCTION details\\n\\n02_Kaufvertrag (Purchase Agreement)\\n   Keywords: Kauf, Vertrag, Purchase, Agreement\\n   Description: Property purchase contract\\n\\n03_Grundbuchauszug (Land Register Extract) \u2b50 CORE\\n   Keywords: Grundbuch, Land, Register, Auszug\\n   Description: Official land registry extract\\n\\n04_Eintragungsbewilligungen (Entry Permits)\\n   Keywords: Eintragung, Bewilligung, Entry, Permit\\n   Description: Permits for land register entries\\n\\n05_Bodenrichtwert (Land Value)\\n   Keywords: Boden, Richtwert, Land, Value\\n   Description: Official land value assessment\\n\\n06_Baulastenverzeichnis (Building Encumbrance Register)\\n   Keywords: Baulast, Verzeichnis, Encumbrance\\n   Description: Register of building encumbrances\\n\\n07_Altlastenkataster (Contaminated Sites Register)\\n   Keywords: Altlast, Kataster, Contaminated\\n   Description: Register of contaminated sites\\n\\n08_Baugrundgutachten (Soil Survey)\\n   Keywords: Baugrund, Gutachten, Soil, Survey\\n   Description: Soil conditions assessment\\n\\n09_Lageplan (Site Plan)\\n   Keywords: Lage, Plan, Site, Grundstueck, Gelaende (without \\\"Bebauung\\\")\\n   Description: Physical site location and layout plan\\n\\n   DO NOT CONFUSE WITH:\\n   \u2717 Bebauungsplan \u2192 use 37_Others (zoning/regulatory plan)\\n\\n   DISTINCTION:\\n   - Lageplan = physical layout of site (WHAT IS)\\n   - Bebauungsplan = zoning regulations (WHAT CAN BE BUILT)\\n\\n   If filename contains \\\"Bebauung\\\" or \\\"Bebauungsplan\\\", use 37_Others\\n   If filename contains just \\\"Lage\\\" or \\\"Lageplan\\\", use 09_Lageplan\\n\\n10_Bautraegerkalkulation_DIN276 (Developer Calculation) \u2b50 CORE\\n   Keywords: Bautraeger, Kalkulation, DIN276, Calculation\\n   Description: Developer cost calculation per DIN276 standard\\n\\n   DO NOT CONFUSE WITH 11_Verkaufspreise (Sales Prices):\\n\\n   KEY DIFFERENCES to distinguish DIN276 calculations from sales price lists:\\n\\n   DIN276 Bautr\u00e4gerkalkulation contains:\\n   - DIN276 cost groups (100-800): Grundst\u00fcck, Herrichten, Geb\u00e4ude, etc.\\n   - HK (Herstellkosten) = construction/manufacturing costs\\n   - Developer profit margins, financing costs, sales costs\\n   - Terms: Baukosten, Baunebenkosten, Projektentwicklung, Gewinn\\n\\n   Verkaufspreise (Sales Prices) contains:\\n   - Customer-facing unit prices: \\\"Kaufpreis WE\\\" (purchase price per unit)\\n   - Individual apartment/unit listings with end-buyer prices\\n   - Terms: Verkaufspreis, Kaufpreis, Endpreis, Kundenpreis\\n\\n   FILENAME PRIORITY (Iteration 2 consistency rule):\\n   - If filename contains \\\"Kalkulation\\\" \u2192 Check content structure FIRST\\n   - If content shows DIN276 cost groups (100-800) OR \\\"HK\\\" (Herstellkosten) \u2192 10_Bautraegerkalkulation_DIN276\\n   - If content shows \\\"Kaufpreis WE\\\" or individual unit customer prices \u2192 11_Verkaufspreise\\n   - \\\"Kaufpreisliste\\\" in DIN276 context = internal pricing calculation, NOT customer sales prices\\n\\n   CRITICAL: A document can contain BOTH cost calculations AND sales prices in different sections. Prioritize the DOMINANT content type:\\n   - If majority is DIN276 cost breakdown with developer calculations \u2192 10_Bautraegerkalkulation_DIN276\\n   - If majority is customer unit price list \u2192 11_Verkaufspreise\\n\\n15_Flaechenberechnung_DIN277 (Area Calculation DIN277)\\n   Keywords: Flaeche, Berechnung, DIN277, Area\\n   Description: Area calculation per DIN277 standard\\n\\n16_GU_Werkvertraege (General Contractor Agreements)\\n   Keywords: GU, Werkvertrag, Contractor, Agreement\\n   Description: General contractor work agreements\\n\\n17_Bauzeichnungen (Construction Drawings)\\n   Keywords: Bau, Zeichnung, Construction, Drawing\\n   Description: Construction and architectural drawings\\n\\n18_Baugenehmigung (Building Permit)\\n   Keywords: Bau, Genehmigung, Building, Permit\\n   Description: Official building permit\\n\\n14_Bau_Ausstattungsbeschreibung (Construction & Equipment Description)\\n   Keywords: Bau, Ausstattung, Beschreibung, Baubeschreibung, Equipment, Regelgeschoss, Dachgeschoss, Geschoss, Technisch\\n   Description: Detailed technical construction specifications and equipment details\\n\\n   USE this for:\\n   \u2713 Baubeschreibung Regelgeschoss (floor-specific technical specs)\\n   \u2713 Baubeschreibung Dachgeschoss\\n   \u2713 Detailed Ausstattungsbeschreibung (equipment specifications)\\n   \u2713 Technical construction details\\n\\n   DISTINCTION: This is TECHNICAL, not marketing-oriented\\n\\nCRITICAL CONSISTENCY RULE:\\nBase your classification PRIMARILY on FILENAME keywords. When the same filename is processed multiple times, it MUST receive the same documentType every time.\\n\\nDecision priority:\\n1. **Filename keywords** (highest priority) - German terms in filename\\n2. Tier 1 category context (from upstream)\\n3. Document structure/content (if filename is ambiguous)\\n\\nFALLBACK RULE - When to use \\\"OTHER\\\" categories:\\nUse 37_Others or 38_Unknowns ONLY when:\\n\u2713 Filename is generic/unclear (e.g., \\\"document.pdf\\\", \\\"file123.pdf\\\")\\n\u2713 Filename keywords don't match ANY specific category\\n\u2713 Confidence is genuinely low (<70%)\\n\\nDO NOT use \\\"OTHER\\\" when:\\n\u2717 Your reasoning identifies a specific category\\n\u2717 Filename contains clear keywords matching a category\\n\u2717 This would create self-contradictory classifications\\n\\nRULE: Your classification must align with your reasoning.\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"01_Projektbeschreibung\\\",\\n  \\\"tier2Confidence\\\": 88,\\n  \\\"germanName\\\": \\\"Projektbeschreibung\\\",\\n  \\\"englishName\\\": \\\"Expos\u00e9/Project Description\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above (e.g., \\\"01_Projektbeschreibung\\\")\\n- isCoreType: true for \u2b50 CORE types, false for others\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'WIRTSCHAFTLICHE_UNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as WIRTSCHAFTLICHE_UNTERLAGEN (Financial/Economic Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n11_Verkaufspreise (Sales Prices)\\n   Keywords: Verkauf, Preis, Sales, Price, Kaufpreis, Wohnungspreise, Verkaufspreis\\n   Description: CUSTOMER sales prices - what end buyers pay the developer\\n\\n   CRITICAL DISTINCTION - Cost vs Price:\\n   \u2713 Use 11_Verkaufspreise for: Customer-facing sales prices\\n   \u2717 DO NOT use for:\\n     - Richtpreisangebot (contractor bid) \u2192 use 37_Others\\n     - GU Angebot (general contractor offer) \u2192 use 16_GU_Werkvertraege if contract-like, else 37_Others\\n     - Baukosten (construction costs) \u2192 use 10_Bautraegerkalkulation_DIN276 if DIN276, else 37_Others\\n\\n   RULE OF THUMB:\\n   - If filename contains \\\"GU\\\", \\\"Richtpreis\\\", \\\"Angebot\\\", \\\"Baukosten\\\" \u2192 NOT customer sales prices\\n   - If filename contains \\\"Verkauf\\\", \\\"Kaufpreis\\\", \\\"Wohnungspreise\\\" \u2192 YES, customer sales prices\\n\\n12_Bauzeitenplan_Liquiditaet (Construction Schedule & Liquidity)\\n   Keywords: Bauzeit, Plan, Liquiditaet, Schedule\\n   Description: Construction timeline and liquidity planning\\n\\n13_Vertriebsweg (Distribution Channel)\\n   Keywords: Vertrieb, Weg, Distribution, Channel\\n   Description: Sales and distribution strategy\\n\\n14_Bau_Ausstattungsbeschreibung (Construction & Equipment Description)\\n   Keywords: Bau, Ausstattung, Beschreibung, Baubeschreibung, Equipment\\n   Description: Construction specifications and equipment details\\n\\n19_Teilungserklaerung (Declaration of Division)\\n   Keywords: Teilung, Erklaerung, Division, Declaration\\n   Description: Property division declaration\\n\\n20_Versicherungen (Insurance)\\n   Keywords: Versicherung, Insurance\\n   Description: Insurance policies and documentation\\n\\n21_Muster_Verkaufsvertrag (Sample Sales Contract)\\n   Keywords: Muster, Verkauf, Vertrag, Sample, Sales\\n   Description: Template sales contract\\n\\n23_Umsatzsteuervoranmeldung (VAT Advance Return)\\n   Keywords: Umsatz, Steuer, Voranmeldung, VAT\\n   Description: VAT advance return filings\\n\\n24_BWA (Business Evaluation)\\n   Keywords: BWA, Business, Evaluation\\n   Description: Business evaluation report\\n\\n25_Jahresabschluss (Annual Financial Statement)\\n   Keywords: Jahres, Abschluss, Annual, Financial\\n   Description: Annual financial statement\\n\\n26_Finanzierungsbestaetigung (Financing Confirmation)\\n   Keywords: Finanzierung, Bestaetigung, Financing, Confirmation\\n   Description: Financing approval or confirmation\\n\\n   INCLUDES Financing Memos/Memorandums:\\n\\n   - Investment memos, financing proposals, capital requirement memos\\n   - \\\"Memo\\\" or \\\"Memorandum\\\" that contains:\\n     - Project financing details (volume, capital needs, loan amounts)\\n     - Financing terms (interest rates, loan duration, security/collateral)\\n     - Bank financing offers or confirmations\\n     - Investment financing structures\\n\\n   Examples:\\n   - \\\"OCP_Memo_New-KaulsCity.pdf\\\" with 60 Mio EUR financing request \u2192 26_Finanzierungsbestaetigung\\n   - \\\"Finanzierungs-Memo Projekt X\\\" with loan terms \u2192 26_Finanzierungsbestaetigung\\n   - \\\"Investment Memorandum\\\" with financing structure \u2192 26_Finanzierungsbestaetigung\\n\\n   DO NOT CONFUSE WITH 35_Sonstiges_Allgemein:\\n   - If document title contains \\\"Memo\\\" BUT content is financing-focused \u2192 26_Finanzierungsbestaetigung\\n   - Only classify as SONSTIGES if memo lacks financial specifics\\n\\n27_Darlehensvertrag (Loan Agreement)\\n   Keywords: Darlehen, Vertrag, Loan, Agreement\\n   Description: Loan contract\\n\\n16_GU_Werkvertraege (General Contractor Agreements)\\n   Keywords: GU, Werkvertrag, Contractor, Agreement, Generalunternehmer\\n   Description: General contractor work agreements\\n\\n   CAN ALSO USE for: GU cost estimates/bids that are contract-related\\n   Examples: GU Werkvertrag, GU Angebot, Generalunternehmer Vertrag\\n\\n   CONSISTENCY RULE for Contractor Quotes (Richtpreisangebot):\\n\\n   If filename contains:\\n   - \\\"GU\\\" (Generalunternehmer/General Contractor) + \\\"Angebot\\\" OR \\\"Richtpreisangebot\\\" \u2192 ALWAYS 16_GU_Werkvertraege\\n   - \\\"Richtpreisangebot\\\" + construction/building scope \u2192 Check for contractor identity (GU, Bauunternehmen)\\n\\n   DO NOT CONFUSE WITH 11_Verkaufspreise:\\n   - Richtpreisangebot = contractor's bid/quote TO the developer (construction cost estimate)\\n   - Verkaufspreise = sales prices FROM developer TO end customers\\n   - Key distinction: contractor quotes describe construction work scope, customer prices describe unit features\\n\\n   FILENAME PRIORITY RULE:\\n   - \\\"GU\\\" + any pricing document (Angebot, Richtpreisangebot, Quote) \u2192 16_GU_Werkvertraege\\n   - Ignore other filename elements if \\\"GU\\\" is present with pricing terms\\n\\nCRITICAL CONSISTENCY RULE:\\nBase your classification PRIMARILY on FILENAME keywords. When the same filename is processed multiple times, it MUST receive the same documentType every time.\\n\\nDecision priority:\\n1. **Filename keywords** (highest priority) - German terms in filename\\n2. Tier 1 category context (from upstream)\\n3. Document structure/content (if filename is ambiguous)\\n\\nFALLBACK RULE - When to use \\\"OTHER\\\" categories:\\nUse 37_Others or 38_Unknowns ONLY when:\\n\u2713 Filename is generic/unclear (e.g., \\\"document.pdf\\\", \\\"file123.pdf\\\")\\n\u2713 Filename keywords don't match ANY specific category\\n\u2713 Confidence is genuinely low (<70%)\\n\\nDO NOT use \\\"OTHER\\\" when:\\n\u2717 Your reasoning identifies a specific category\\n\u2717 Filename contains clear keywords matching a category\\n\u2717 This would create self-contradictory classifications\\n\\nRULE: Your classification must align with your reasoning.\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"11_Verkaufspreise\\\",\\n  \\\"tier2Confidence\\\": 92,\\n  \\\"germanName\\\": \\\"Verkaufspreise\\\",\\n  \\\"englishName\\\": \\\"Sales Prices\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all WIRTSCHAFTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'RECHTLICHE_UNTERLAGEN') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as RECHTLICHE_UNTERLAGEN (Legal/Compliance Documents) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n28_Gesellschaftsvertrag (Partnership Agreement)\\n   Keywords: Gesellschaft, Vertrag, Partnership, Agreement\\n   Description: Company partnership or shareholder agreement\\n\\n29_Handelsregisterauszug (Commercial Register Extract)\\n   Keywords: Handelsregister, Auszug, Commercial, Register\\n   Description: Commercial register extract\\n\\n30_Gewerbeanmeldung (Business Registration)\\n   Keywords: Gewerbe, Anmeldung, Business, Registration\\n   Description: Business registration documentation\\n\\n31_Steuer_ID (Tax ID)\\n   Keywords: Steuer, ID, Tax\\n   Description: Tax identification number\\n\\n32_Freistellungsbescheinigung (Tax Exemption Certificate)\\n   Keywords: Freistellung, Bescheinigung (TAX context only), Exemption, Certificate, Steuer + Freistellung\\n   Description: TAX exemption certificate (Steuerfreistellung)\\n\\n   CRITICAL: This is ONLY for TAX-related exemption certificates\\n\\n   DO NOT CONFUSE WITH:\\n   \u2717 Erschlie\u00dfungsbeitragsbescheinigung (development contribution) \u2192 should be OBJEKTUNTERLAGEN (not your tier!)\\n   \u2717 Other municipal certificates \u2192 likely OBJEKTUNTERLAGEN\\n\\n   RULE: If filename contains \\\"Erschlie\u00dfung\\\", \\\"Baulasten\\\", \\\"Bodenschutz\\\", \\\"Altlasten\\\" \u2192 NOT this category (those are property/infrastructure, not tax)\\n\\n   Only use 32_Freistellungsbescheinigung if:\\n   - Clear TAX context in filename OR\\n   - Filename is just \\\"Freistellungsbescheinigung\\\" without other context\\n\\n33_Vollmachten (Powers of Attorney)\\n   Keywords: Vollmacht, Power, Attorney\\n   Description: Power of attorney documents\\n\\nCRITICAL CONSISTENCY RULE:\\nBase your classification PRIMARILY on FILENAME keywords. When the same filename is processed multiple times, it MUST receive the same documentType every time.\\n\\nDecision priority:\\n1. **Filename keywords** (highest priority) - German terms in filename\\n2. Tier 1 category context (from upstream)\\n3. Document structure/content (if filename is ambiguous)\\n\\nFALLBACK RULE - When to use \\\"OTHER\\\" categories:\\nUse 37_Others or 38_Unknowns ONLY when:\\n\u2713 Filename is generic/unclear (e.g., \\\"document.pdf\\\", \\\"file123.pdf\\\")\\n\u2713 Filename keywords don't match ANY specific category\\n\u2713 Confidence is genuinely low (<70%)\\n\\nDO NOT use \\\"OTHER\\\" when:\\n\u2717 Your reasoning identifies a specific category\\n\u2717 Filename contains clear keywords matching a category\\n\u2717 This would create self-contradictory classifications\\n\\nRULE: Your classification must align with your reasoning.\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"28_Gesellschaftsvertrag\\\",\\n  \\\"tier2Confidence\\\": 85,\\n  \\\"germanName\\\": \\\"Gesellschaftsvertrag\\\",\\n  \\\"englishName\\\": \\\"Partnership Agreement\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: false for all RECHTLICHE types (none are CORE)\\n- Valid JSON only, no markdown`;\n  } else if (tier1Category === 'SONSTIGES') {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nTIER 1 RESULT: This document was classified as SONSTIGES (Miscellaneous) with ${tier1Confidence}% confidence.\\n\\nTASK: Now classify into the SPECIFIC document type from the list below.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nSPECIFIC TYPES (choose ONE):\\n\\n22_Gutachterauftrag (Expert Assignment)\\n   Keywords: Gutachter, Auftrag, Expert, Assignment\\n   Description: Expert assessment assignment\\n\\n34_Korrespondenz (Correspondence)\\n   Keywords: Korrespondenz, Email, Brief, Letter, Correspondence\\n   Description: Email correspondence and letters\\n\\n35_Sonstiges_Allgemein (General Miscellaneous)\\n   Keywords: Sonstiges, Misc, General\\n   Description: General miscellaneous documents\\n\\n36_Exit_Strategie (Exit Strategy) \u2b50 CORE\\n   Keywords: Exit, Strategie, Strategy\\n   Description: Investment exit strategy\\n\\n37_Others (Others)\\n   Keywords: Other, Andere\\n   Description: Other unclassified documents\\n\\n38_Unknowns (Unknowns)\\n   Keywords: Unknown, Unbekannt\\n   Description: Unknown document type (LAST RESORT - use only when truly unclear)\\n\\nCRITICAL CONSISTENCY RULE:\\nBase your classification PRIMARILY on FILENAME keywords. When the same filename is processed multiple times, it MUST receive the same documentType every time.\\n\\nDecision priority:\\n1. **Filename keywords** (highest priority) - German terms in filename\\n2. Tier 1 category context (from upstream)\\n3. Document structure/content (if filename is ambiguous)\\n\\nFALLBACK RULE - When to use \\\"OTHER\\\" categories:\\nUse 37_Others or 38_Unknowns ONLY when:\\n\u2713 Filename is generic/unclear (e.g., \\\"document.pdf\\\", \\\"file123.pdf\\\")\\n\u2713 Filename keywords don't match ANY specific category\\n\u2713 Confidence is genuinely low (<70%)\\n\\nDO NOT use \\\"OTHER\\\" when:\\n\u2717 Your reasoning identifies a specific category\\n\u2717 Filename contains clear keywords matching a category\\n\u2717 This would create self-contradictory classifications\\n\\nRULE: Your classification must align with your reasoning. If you say \\\"marketing brochure\\\" in reasoning, classify it appropriately, NOT as Sonstiges.\\n\\nIMPORTANT: 38_Unknowns is LAST RESORT. Only use when truly unable to classify.\\n\\nINSTRUCTIONS:\\n1. Analyze filename for specific German keywords\\n2. Choose the MOST SPECIFIC type that matches\\n3. Provide confidence score (0-100)\\n4. Explain your reasoning\\n5. Use 38_Unknowns ONLY if truly unclear\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"36_Exit_Strategie\\\",\\n  \\\"tier2Confidence\\\": 95,\\n  \\\"germanName\\\": \\\"Exit Strategie\\\",\\n  \\\"englishName\\\": \\\"Exit Strategy\\\",\\n  \\\"isCoreType\\\": true,\\n  \\\"reasoning\\\": \\\"Brief explanation\\\"\\n}\\n\\nSTRICT RULES:\\n- documentType must EXACTLY match one of the codes above\\n- isCoreType: true ONLY for 36_Exit_Strategie\\n- Valid JSON only, no markdown`;\n  } else {\n    tier2Prompt = `You are a German real estate document classifier for AMA Capital.\\n\\nERROR: Unknown category \\\"${tier1Category}\\\". Please classify as SONSTIGES > 38_Unknowns.\\n\\nFILENAME: ${fileName}\\nCLIENT: ${clientEmail}\\n\\nRESPONSE FORMAT (JSON only):\\n{\\n  \\\"documentType\\\": \\\"38_Unknowns\\\",\\n  \\\"tier2Confidence\\\": 0,\\n  \\\"germanName\\\": \\\"Unknowns\\\",\\n  \\\"englishName\\\": \\\"Unknown\\\",\\n  \\\"isCoreType\\\": false,\\n  \\\"reasoning\\\": \\\"Unknown Tier 1 category: ${tier1Category}\\\"\\n}`;\n  }\n\n  if (tier1Confidence < 60) {\n    outputItems.push({\n      json: {\n        tier1Category, tier1Confidence, tier1Reasoning: reasoning, tier2Prompt,\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        lowConfidence: true, confidenceFailureStage: 'tier1',\n        ...item.json\n      }\n    });\n  } else {\n    outputItems.push({\n      json: {\n        tier1Category, tier1Confidence, tier1Reasoning: reasoning, tier2Prompt,\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        ...item.json\n      }\n    });\n  }\n}\n\nreturn outputItems;\n"
        },
        "id": "code-2",
        "name": "Parse Classification Result",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2320,
          160
        ]
      },
      {
        "parameters": {
          "documentId": {
            "mode": "id",
            "value": "12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I"
          },
          "sheetName": {
            "mode": "name",
            "value": "Dokumenten_Tracker"
          },
          "options": {}
        },
        "id": "sheets-1",
        "name": "Lookup Client in Client_Tracker",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          4112,
          160
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H7ewI1sOrDYabelt",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// FIX: Don't loop through sheet rows - we're processing ONE file\n// The Sheets lookup gives us ALL rows to search through\n// UPDATED: Use Dokumenten_Tracker with 'Mandant' field\n\n// Get classification data (the single file being processed)\nconst classificationData = $('Determine Action Type').first().json;\n\n// Get ALL tracker rows to search through\nconst trackerData = $('Lookup Client in Client_Tracker').all();\n\n// Get client info from classification data\nconst clientNormalized = classificationData.client_normalized || classificationData.clientNormalized || '';\nconst documentType = classificationData.documentType || '';\nconst confidence = classificationData.combinedConfidence || classificationData.tier2Confidence || 0;\nconst fileId = classificationData.fileId || '';\nconst fileName = classificationData.fileName || '';\n\n// Check if confidence is too low\nif (confidence < 70) {\n  return [{\n    json: {\n      ...classificationData,  // Preserve all classification data\n      chunk2_5_status: 'error_unclear_type',\n      errorMessage: `Low confidence (${confidence}%) - document type unclear`\n    }\n  }];\n}\n\n// Check if any data was returned from tracker\nif (!trackerData || trackerData.length === 0) {\n  return [{\n    json: {\n      ...classificationData,\n      chunk2_5_status: 'error_client_not_found',\n      errorMessage: 'No data returned from Dokumenten_Tracker lookup'\n    }\n  }];\n}\n\n// Find matching client row (using Mandant field)\nlet rowIndex = -1;\nconst clientRow = trackerData.find((row, idx) => {\n  const sheetClientName = row.json.Mandant || '';\n  const normalizedSheetName = sheetClientName\n    .toLowerCase()\n    .trim()\n    .replace(/\u00e4/g, 'ae')\n    .replace(/\u00f6/g, 'oe')\n    .replace(/\u00fc/g, 'ue')\n    .replace(/\u00df/g, 'ss')\n    .replace(/\\s*(gmbh|ag|kg|e\\.v\\.|mbh|co\\.|&\\s*co\\.?)\\s*/gi, '')\n    .replace(/[^a-z0-9]/g, '_')\n    .replace(/_+/g, '_')\n    .replace(/^_|_$/g, '');\n  \n  if (normalizedSheetName === clientNormalized) {\n    // Google Sheets returns data starting from row 2 (row 1 is header)\n    // Array index 0 = row 2, index 1 = row 3, etc.\n    rowIndex = idx + 2;\n    return true;\n  }\n  return false;\n});\n\nif (!clientRow || !clientRow.json.Mandant) {\n  return [{\n    json: {\n      ...classificationData,\n      chunk2_5_status: 'error_client_not_found',\n      errorMessage: `Client not found in tracker: \"${clientNormalized}\"`\n    }\n  }];\n}\n\n// Client found and validated - output SINGLE item\nreturn [{\n  json: {\n    ...classificationData,        // All classification data (fileId, confidence, documentType, etc.)\n    ...clientRow.json,            // Sheet row data\n    clientFound: true,\n    trackerRowIndex: rowIndex,    // Calculated row number (1-based)\n    trackerClientName: clientRow.json.Mandant,\n    chunk2_5_status: 'success'\n  }\n}];"
        },
        "id": "code-3",
        "name": "Find Client Row and Validate",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4336,
          160
        ]
      },
      {
        "parameters": {
          "documentId": {
            "mode": "id",
            "value": "1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU"
          },
          "sheetName": {
            "__rl": true,
            "value": "gid=0",
            "mode": "list",
            "cachedResultName": "AMA_Folder_IDs",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU/edit#gid=0"
          },
          "options": {}
        },
        "id": "sheets-3",
        "name": "Lookup Client in AMA_Folder_IDs",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          5680,
          64
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H7ewI1sOrDYabelt",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Get Destination Folder ID - V14 Simplified Routing\n// SIMPLIFIED LOGIC:\n// - Core 4 documents -> Specific folders (01, 03, 10, 36)\n// - ALL OTHER documents -> 37_Others folder\n// - Tracker still gets updated with whatever was classified\n\nconst classificationData = $('Find Client Row and Validate').first().json;\n\n// Get fileId from classification data (passed through from trigger)\nconst fileId = classificationData.fileId;\nconst fileName = classificationData.fileName;\n\n// Get classification info\nconst documentType = classificationData.documentType;\nconst tier1Category = classificationData.tier1Category;\nconst client_name = classificationData.client_name;\nconst client_normalized = classificationData.client_normalized;\n\n// Build lookup from ALL folder rows\nconst allFolderRows = $input.all();\nconst folderLookup = {};\nfor (const row of allFolderRows) {\n  folderLookup[row.json.Variable_Name] = row.json.Folder_ID;\n}\n\nlet finalFolderId;\nlet destinationFolderName;\nlet variableNameSearched;\n\n// Define Core 4 document types\nconst CORE_4_TYPES = [\n  '01_Projektbeschreibung',\n  '03_Grundbuchauszug',\n  '10_Bautraegerkalkulation_DIN276',\n  '36_Exit_Strategie'\n];\n\n// Check if this is a Core 4 document\nif (CORE_4_TYPES.includes(documentType)) {\n  // CORE 4 DOCUMENTS -> Route to specific folders\n  const coreMapping = {\n    '01_Projektbeschreibung': { varName: 'FOLDER_01_PROJEKTBESCHREIBUNG', displayName: '01_Projektbeschreibung' },\n    '03_Grundbuchauszug': { varName: 'FOLDER_03_GRUNDBUCHAUSZUG', displayName: '03_Grundbuchauszug' },\n    '10_Bautraegerkalkulation_DIN276': { varName: 'FOLDER_10_BAUTRAEGERKALKULATION', displayName: '10_Bautraegerkalkulation' },\n    '36_Exit_Strategie': { varName: 'FOLDER_36_EXIT_STRATEGIE', displayName: '36_Exit_Strategie' }\n  };\n\n  const mapping = coreMapping[documentType];\n  if (mapping) {\n    variableNameSearched = mapping.varName;\n    destinationFolderName = mapping.displayName;\n  } else {\n    // Fallback to 37_Others if mapping not found (shouldn't happen)\n    variableNameSearched = 'FOLDER_37_OTHERS';\n    destinationFolderName = '37_Others';\n  }\n} else {\n  // ALL OTHER DOCUMENTS -> Route to 37_Others\n  variableNameSearched = 'FOLDER_37_OTHERS';\n  destinationFolderName = '37_Others';\n}\n\n// Get folder ID from lookup\nfinalFolderId = folderLookup[variableNameSearched];\n\nreturn [{\n  json: {\n    fileId: fileId,\n    fileName: fileName,\n    finalFolderId: finalFolderId,\n    destinationFolderName: destinationFolderName,\n    documentType: documentType,\n    tier1Category: tier1Category,\n    client_name: client_name,\n    client_normalized: client_normalized,\n    debug_variableNameSearched: variableNameSearched,\n    debug_folderLookupSize: Object.keys(folderLookup).length,\n    debug_isCore4: CORE_4_TYPES.includes(documentType)\n  }\n}];"
        },
        "id": "code-4",
        "name": "Get Destination Folder ID",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5904,
          64
        ]
      },
      {
        "parameters": {
          "operation": "move",
          "fileId": {
            "__rl": true,
            "mode": "id",
            "value": "={{ $json.fileId }}"
          },
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "mode": "id",
            "value": "={{ $json.finalFolderId }}"
          }
        },
        "id": "drive-1",
        "name": "Move File to Final Location",
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          6128,
          64
        ],
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "a4m50EefR3DJoU0R",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Prepare Success Output - Returns data to Quick Test Runner\n// FIXED: Explicitly include reasoning fields\n\nconst items = $input.all();\nconst outputItems = [];\n\n// Get classification data from Build Google Sheets API Update Request\nconst cd = $(\"Build Google Sheets API Update Request\").first().json;\n\n// Get folder info from Get Destination Folder ID\nconst folderInfo = $(\"Get Destination Folder ID\").first().json;\n\nfor (const item of items) {\n  const dr = item.json;\n  outputItems.push({\n    json: {\n      // Tier 1 classification\n      tier1Category: cd.tier1Category,\n      tier1Confidence: cd.tier1Confidence,\n      tier1Reasoning: cd.tier1Reasoning || '',\n      \n      // Tier 2 classification\n      documentType: cd.documentType,\n      tier2Confidence: cd.tier2Confidence,\n      tier2Reasoning: cd.tier2Reasoning || '',\n      combinedConfidence: cd.combinedConfidence,\n      germanName: cd.germanName,\n      englishName: cd.englishName,\n      \n      // Tracker info\n      mappedColumnName: cd.mappedColumnName,\n      columnLetter: cd.columnLetter,\n      trackerRowIndex: cd.trackerRowIndex,\n      \n      // File info\n      fileId: cd.fileId,\n      fileName: cd.fileName,\n      client_normalized: cd.client_normalized,\n      clientEmail: cd.clientEmail,\n      \n      // Folder info\n      destinationFolderName: folderInfo.destinationFolderName,\n      finalFolderId: folderInfo.finalFolderId,\n      \n      // Drive response\n      driveFileId: dr.id,\n      driveFileName: dr.name,\n      \n      // Status\n      trackerUpdated: true,\n      chunk2_5_status: 'success',\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-5",
        "name": "Prepare Success Output",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          6352,
          240
        ]
      },
      {
        "parameters": {
          "documentId": {
            "mode": "id",
            "value": "1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU"
          },
          "sheetName": {
            "__rl": true,
            "value": "gid=0",
            "mode": "list",
            "cachedResultName": "AMA_Folder_IDs",
            "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1-CPnCr3locAORVX5tUEoh6r0i-x3tQ_ROTN0VXatOAU/edit#gid=0"
          },
          "options": {}
        },
        "id": "sheets-4",
        "name": "Lookup 38_Unknowns Folder",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.7,
        "position": [
          4784,
          304
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H7ewI1sOrDYabelt",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// FIX: Process ALL items from main data\nconst folderData = $input.all();\nconst mainDataItems = $('Find Client Row and Validate').all();\nconst outputItems = [];\n\n// Skip header row from folder data\nconst dataRows = folderData.slice(1);\n\n// Look for 38_Unknowns folder ID (should be same for all items)\nlet unknownsFolderId = null;\nif (dataRows.length > 0) {\n  for (const row of dataRows) {\n    const rowData = row.json;\n    for (const key in rowData) {\n      if (key.includes('38_Unknowns')) {\n        unknownsFolderId = rowData[key];\n        break;\n      }\n    }\n    if (unknownsFolderId) break;\n  }\n\n  if (!unknownsFolderId) {\n    // Try to get from first row (assuming it might be a global folder)\n    unknownsFolderId = dataRows[0].json['38_Unknowns'] || null;\n  }\n}\n\n// Return one output item per main data item\nfor (const mainData of mainDataItems) {\n  outputItems.push({\n    json: {\n      ...mainData.json,\n      unknownsFolderId: unknownsFolderId,\n      errorFallbackUsed: !unknownsFolderId\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-6",
        "name": "Get 38_Unknowns Folder ID",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5008,
          304
        ]
      },
      {
        "parameters": {
          "operation": "move",
          "fileId": {
            "__rl": true,
            "mode": "id",
            "value": "={{ $json.fileId }}"
          },
          "driveId": {
            "__rl": true,
            "mode": "list",
            "value": "My Drive"
          },
          "folderId": {
            "__rl": true,
            "mode": "id",
            "value": "={{ $json.unknownsFolderId }}"
          }
        },
        "id": "drive-2",
        "name": "Move File to 38_Unknowns",
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          5232,
          304
        ],
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "a4m50EefR3DJoU0R",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// FIX: Process ALL items\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const mainData = item.json;\n\n  // FIX: Use client_normalized (snake_case) to match what's being passed\n  const clientName = mainData.client_normalized || mainData.clientNormalized || 'Unknown';\n  const fileName = mainData.fileName || 'Unknown';\n  const fileId = mainData.fileId || '';\n  const errorStatus = mainData.chunk2_5_status || 'unknown_error';\n  const errorMessage = mainData.errorMessage || 'No error details provided';\n  const documentType = mainData.documentType || 'Unknown';\n  const confidence = mainData.documentClassificationConfidence || 0;\n\n  let issueDescription = '';\n  if (errorStatus === 'error_client_not_found') {\n    issueDescription = `Client \\\"${clientName}\\\" was not found in the Client_Tracker sheet.`;\n  } else if (errorStatus === 'error_unclear_type') {\n    issueDescription = `Document type classification had low confidence (${confidence}%). Classified as: ${documentType}.`;\n  } else if (errorStatus === 'error_folder_not_found') {\n    issueDescription = `Destination folder for document type \\\"${documentType}\\\" was not found in AMA_Folder_IDs.`;\n  } else {\n    issueDescription = errorMessage;\n  }\n\n  const fileLink = `https://drive.google.com/file/d/${fileId}/view`;\n\n  const emailSubject = `Eugene: Document Classification Issue - ${clientName}`;\n  const emailBody = `<html>\n<body>\n<h2>Document Classification Issue</h2>\n<p>A document could not be automatically classified and has been moved to the 38_Unknowns folder.</p>\n\n<h3>Details:</h3>\n<ul>\n  <li><strong>Client:</strong> ${clientName}</li>\n  <li><strong>Filename:</strong> ${fileName}</li>\n  <li><strong>Issue:</strong> ${issueDescription}</li>\n  <li><strong>Classified Type:</strong> ${documentType} (${confidence}% confidence)</li>\n  <li><strong>Error Status:</strong> ${errorStatus}</li>\n</ul>\n\n<h3>File Location:</h3>\n<p><a href=\\\"${fileLink}\\\">View file in Google Drive</a></p>\n\n<p>Please review this document and manually classify it.</p>\n</body>\n</html>`;\n\n  outputItems.push({\n    json: {\n      ...mainData,\n      emailSubject: emailSubject,\n      emailBody: emailBody,\n      trackerUpdated: false,\n      chunk2_5_status: errorStatus,\n      processedAt: new Date().toISOString()\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-7",
        "name": "Prepare Error Email Body",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5456,
          304
        ]
      },
      {
        "parameters": {
          "sendTo": "={{ $json.emailRecipient || 'sway@thebluebottle.io' }}",
          "subject": "Document Classification Error - Action Required",
          "message": "={{ $json.emailBody }}",
          "options": {}
        },
        "id": "gmail-1",
        "name": "Send Error Notification Email",
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          5680,
          304
        ],
        "webhookId": "d50e78b4-8ae0-4171-b62f-c2afdafc7e58",
        "credentials": {
          "gmailOAuth2": {
            "id": "gmailOAuth2",
            "name": "Gmail OAuth2"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Prepare Tracker Update Data - UPDATED for Dokumenten_Tracker\n// Now processes ALL document types (not just Core 4)\n// Added aliases for English/German variations\n// DUAL CLASSIFICATION: Handles secondary document types\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const data = item.json;\n\n  // CONDITIONAL: Only prepare tracker data if trackerUpdate === true\n  if (data.trackerUpdate !== true) {\n    // SECONDARY or LOW_CONFIDENCE: Skip tracker update, pass through to folder move\n    outputItems.push({\n      json: {\n        skipTrackerUpdate: true,\n        ...data\n      }\n    });\n    continue;\n  }\n\n  // Get document type from classification\n  const documentType = data.documentType;\n\n  // Map old/English document types to new German types (backwards compatibility)\n  const oldToNewTypeMap = {\n    // Core 4 - multiple aliases\n    '01_Projektbeschreibung': '01_Projektbeschreibung',\n    '01_Expose': '01_Projektbeschreibung',\n    '01_Expos\u00e9': '01_Projektbeschreibung',\n    'Expose': '01_Projektbeschreibung',\n    'Expos\u00e9': '01_Projektbeschreibung',\n    '03_Grundbuchauszug': '02_Grundbuchauszug',\n    'Grundbuchauszug': '02_Grundbuchauszug',\n    'Grundbuch': '02_Grundbuchauszug',\n    '10_Bautraegerkalkulation_DIN276': '03_Bautraegerkalkulation_DIN276',\n    'Bautraegerkalkulation': '03_Bautraegerkalkulation_DIN276',\n    'Calculation': '03_Bautraegerkalkulation_DIN276',\n    'DIN276': '03_Bautraegerkalkulation_DIN276',\n    '36_Exit_Strategie': '04_Exit_Strategie',\n    'Exit_Strategy': '04_Exit_Strategie',\n    'Exit Strategy': '04_Exit_Strategie',\n    // Other document types\n    '09_Altlastenkataster': '05_Altlastenkataster',\n    '10_Baugrundgutachten': '06_Baugrundgutachten',\n    '11_Lageplan': '07_Lageplan',\n    '12_Flaechenberechnung': '08_Flaechenberechnung',\n    '13_GU_Werkvertraege': '09_GU_Werkvertraege',\n    '14_Bauzeichnungen': '10_Bauzeichnungen',\n    '15_Baugenehmigung': '11_Baugenehmigung',\n    '16_Gutachterauftrag': '12_Gutachterauftrag',\n    '17_Verkaufspreise': '13_Verkaufspreise',\n    '18_Bauzeitenplan': '14_Bauzeitenplan',\n    '19_Vertriebsweg': '15_Vertriebsweg',\n    '20_Ausstattungsbeschreibung': '16_Ausstattungsbeschreibung',\n    '21_Teilungserklaerung': '17_Teilungserklaerung',\n    '22_Versicherungen': '18_Versicherungen',\n    '23_Muster_Verkaufsvertrag': '19_Muster_Verkaufsvertrag',\n    '24_Umsatzsteuervoranmeldung': '20_Umsatzsteuervoranmeldung',\n    '25_BWA': '21_BWA',\n    '26_Jahresabschluss': '22_Jahresabschluss',\n    '27_Finanzierungsbestaetigung': '23_Finanzierungsbestaetigung',\n    '28_Darlehensvertrag': '24_Darlehensvertrag',\n    '29_Gesellschaftsvertrag': '25_Gesellschaftsvertrag',\n    '30_Handelsregisterauszug': '26_Handelsregisterauszug',\n    '31_Gewerbeanmeldung': '27_Gewerbeanmeldung',\n    '32_Steuer_ID': '28_Steuer_ID',\n    '33_Freistellungsbescheinigung': '29_Freistellungsbescheinigung',\n    '34_Vollmachten': '30_Vollmachten',\n    '35_Korrespondenz': '31_Korrespondenz',\n    '36_Sonstiges': '32_Sonstiges'\n  };\n\n  // Use new type if mapping exists, otherwise use original\n  const normalizedDocType = oldToNewTypeMap[documentType] || documentType;\n\n  // Map document types to tracker columns (German names)\n  const trackerColumnMapping = {\n    '01_Projektbeschreibung': '01_Projektbeschreibung',\n    '02_Grundbuchauszug': '02_Grundbuchauszug',\n    '03_Bautraegerkalkulation_DIN276': '03_Bautraegerkalkulation_DIN276',\n    '04_Exit_Strategie': '04_Exit_Strategie',\n    '05_Altlastenkataster': '05_Altlastenkataster',\n    '06_Baugrundgutachten': '06_Baugrundgutachten',\n    '07_Lageplan': '07_Lageplan',\n    '08_Flaechenberechnung': '08_Flaechenberechnung',\n    '09_GU_Werkvertraege': '09_GU_Werkvertraege',\n    '10_Bauzeichnungen': '10_Bauzeichnungen',\n    '11_Baugenehmigung': '11_Baugenehmigung',\n    '12_Gutachterauftrag': '12_Gutachterauftrag',\n    '13_Verkaufspreise': '13_Verkaufspreise',\n    '14_Bauzeitenplan': '14_Bauzeitenplan',\n    '15_Vertriebsweg': '15_Vertriebsweg',\n    '16_Ausstattungsbeschreibung': '16_Ausstattungsbeschreibung',\n    '17_Teilungserklaerung': '17_Teilungserklaerung',\n    '18_Versicherungen': '18_Versicherungen',\n    '19_Muster_Verkaufsvertrag': '19_Muster_Verkaufsvertrag',\n    '20_Umsatzsteuervoranmeldung': '20_Umsatzsteuervoranmeldung',\n    '21_BWA': '21_BWA',\n    '22_Jahresabschluss': '22_Jahresabschluss',\n    '23_Finanzierungsbestaetigung': '23_Finanzierungsbestaetigung',\n    '24_Darlehensvertrag': '24_Darlehensvertrag',\n    '25_Gesellschaftsvertrag': '25_Gesellschaftsvertrag',\n    '26_Handelsregisterauszug': '26_Handelsregisterauszug',\n    '27_Gewerbeanmeldung': '27_Gewerbeanmeldung',\n    '28_Steuer_ID': '28_Steuer_ID',\n    '29_Freistellungsbescheinigung': '29_Freistellungsbescheinigung',\n    '30_Vollmachten': '30_Vollmachten',\n    '31_Korrespondenz': '31_Korrespondenz',\n    '32_Sonstiges': '32_Sonstiges',\n    '33_Unbekannt': '33_Unbekannt'\n  };\n\n  const trackerColumn = trackerColumnMapping[normalizedDocType];\n\n  if (!trackerColumn) {\n    // Unknown document type - use 33_Unbekannt\n    outputItems.push({\n      json: {\n        trackerColumn: '33_Unbekannt',\n        trackerValue: '\u2713',\n        unknownDocType: normalizedDocType,\n        skipTrackerUpdate: false,\n        ...data\n      }\n    });\n    continue;\n  }\n\n  // DUAL CLASSIFICATION: Handle secondary document type if present\n  let secondaryTrackerColumn = null;\n  if (data.hasSecondaryClassification && data.secondaryDocumentType) {\n    const normalizedSecondaryType = oldToNewTypeMap[data.secondaryDocumentType] || data.secondaryDocumentType;\n    secondaryTrackerColumn = trackerColumnMapping[normalizedSecondaryType] || null;\n  }\n\n  // Prepare update data for Dokumenten_Tracker\n  outputItems.push({\n    json: {\n      trackerColumn,\n      trackerValue: '\u2713',\n      skipTrackerUpdate: false,\n      // DUAL CLASSIFICATION FIELDS\n      secondaryTrackerColumn,\n      hasSecondaryClassification: data.hasSecondaryClassification || false,\n      ...data\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-8",
        "name": "Prepare Tracker Update Data",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4784,
          64
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.openai.com/v1/chat/completions",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ ({ \"model\": \"gpt-4\", \"messages\": [{\"role\": \"user\", \"content\": $json.tier1Prompt}], \"temperature\": 0 }) }}",
          "options": {}
        },
        "id": "http-openai-1",
        "name": "Classify Document with GPT-4",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2096,
          704
        ],
        "credentials": {
          "openAiApi": {
            "id": "xmJ7t6kaKgMwA1ce",
            "name": "OpenAi account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.openai.com/v1/chat/completions",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openAiApi",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ ({ \"model\": \"gpt-4\", \"messages\": [{\"role\": \"user\", \"content\": $json.tier2Prompt}], \"temperature\": 0 }) }}",
          "options": {}
        },
        "id": "3732e080-c0d3-4763-957d-d4d90761ddd8",
        "name": "Tier 2 GPT-4 API Call",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          3440,
          704
        ],
        "credentials": {
          "openAiApi": {
            "id": "xmJ7t6kaKgMwA1ce",
            "name": "OpenAi account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "jsCode": "// Parse Tier 2 Classification Result from Claude Vision\n// FIX: Process ALL items, not just first\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  // Get corresponding Tier 2 result\n  const tier2Result = $('Parse Claude Tier 2 Response').all()[i].json;\n\n  if (!tier2Result || !tier2Result.documentType) {\n    // Parsing failed - route to LOW_CONFIDENCE\n    outputItems.push({\n      json: {\n        error: 'Failed to parse Tier 2 classification',\n        lowConfidence: true,\n        confidenceFailureStage: 'tier2_parse_error',\n        ...tier2Result\n      }\n    });\n    continue;\n  }\n\n  const {\n    documentType, tier2Confidence, germanName, englishName, isCoreType, tier2Reasoning,\n    fileId, fileName, fileUrl, clientEmail,\n    client_name, client_normalized,  // FIX: Preserve client data\n    tier1Category, tier1Confidence, tier1Reasoning\n  } = tier2Result;\n\n  // THRESHOLD CHECK: Tier 2 confidence must be >= 70%\n  if (tier2Confidence < 70) {\n    outputItems.push({\n      json: {\n        documentType, tier2Confidence, lowConfidence: true, confidenceFailureStage: 'tier2',\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        tier1Category, tier1Confidence, tier1Reasoning\n      }\n    });\n  } else {\n    // Calculate combined confidence\n    const combinedConfidence = Math.round((tier1Confidence + tier2Confidence) / 2);\n\n    outputItems.push({\n      json: {\n        fileId, fileName, fileUrl, clientEmail, client_name, client_normalized,\n        tier1Category, tier1Confidence, tier1Reasoning,\n        documentType, tier2Confidence, combinedConfidence,\n        germanName, englishName, isCoreType, tier2Reasoning\n      }\n    });\n  }\n}\n\nreturn outputItems;"
        },
        "id": "86d8d160-de91-464d-92d0-7db05b7c3f4f",
        "name": "Parse Tier 2 Result",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3664,
          160
        ]
      },
      {
        "parameters": {
          "jsCode": "// Action Mapper: Determine routing based on classification results\n\nconst data = $input.first().json;\n\n// Check for low confidence flags\nif (data.lowConfidence === true) {\n  return [{\n    json: {\n      ...data,  // \u2190 CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n      actionType: 'LOW_CONFIDENCE',\n      destinationFolder: '38_Unknowns',\n      trackerUpdate: false,\n      sendNotification: true\n    }\n  }];\n}\n\n// Check if CORE type\nif (data.isCoreType === true) {\n  // CORE types: Specific folder + tracker update\n  return [{\n    json: {\n      ...data,  // \u2190 CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n      actionType: 'CORE',\n      trackerUpdate: true,\n      sendNotification: false\n    }\n  }];\n}\n\n// SECONDARY types: 37_Other folder + tracker update (so Eugene can see what they are)\nreturn [{\n  json: {\n    ...data,  // \u2190 CRITICAL: Preserve ALL incoming fields (fileId, fileName, etc.)\n    actionType: 'SECONDARY',\n    destinationFolder: '37_Other',\n    trackerUpdate: true,\n    sendNotification: false\n  }\n}];"
        },
        "id": "89b7324c-80e6-4902-9ab5-3f26be09e92a",
        "name": "Determine Action Type",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3888,
          160
        ]
      },
      {
        "parameters": {
          "operation": "download",
          "fileId": "={{ $json.fileId }}",
          "options": {}
        },
        "id": "drive-download-1",
        "name": "Download PDF for Classification",
        "type": "n8n-nodes-base.googleDrive",
        "typeVersion": 3,
        "position": [
          528,
          160
        ],
        "credentials": {
          "googleDriveOAuth2Api": {
            "id": "a4m50EefR3DJoU0R",
            "name": "Google Drive account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Convert PDF to Base64\n// Processing one file at a time (via Split In Batches upstream)\n// Rate limiting handled by Wait nodes between Claude Vision calls\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  try {\n    const binaryKey = Object.keys(item.binary || {})[0];\n    \n    if (!binaryKey) {\n      // No binary data, pass through\n      outputItems.push({\n        json: {\n          ...item.json,\n          pdfError: 'No binary data found'\n        }\n      });\n      continue;\n    }\n    \n    const buffer = await this.helpers.getBinaryDataBuffer(items.indexOf(item), binaryKey);\n    const base64Content = buffer.toString('base64');\n    const mimeType = item.json.mimeType || 'application/pdf';\n    const fileSizeKB = Math.round(buffer.length / 1024);\n    \n    outputItems.push({\n      json: {\n        ...item.json,\n        imageData: {\n          type: 'base64',\n          media_type: mimeType,\n          data: base64Content\n        },\n        pdfMetadata: {\n          fileSizeKB: fileSizeKB,\n          note: 'Full PDF sent - rate limiting via Wait nodes'\n        }\n      },\n      binary: item.binary\n    });\n  } catch (error) {\n    outputItems.push({\n      json: {\n        ...item.json,\n        pdfError: error.message\n      }\n    });\n  }\n}\n\nreturn outputItems;"
        },
        "id": "code-convert-pdf",
        "name": "Convert PDF to Base64",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          752,
          160
        ]
      },
      {
        "parameters": {
          "jsCode": "// RATE LIMIT PROTECTION: Wait 30 seconds before each Claude API call\nawait new Promise(resolve => setTimeout(resolve, 30000));\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  // FIX: Get tier1Prompt from the SAME item, not always from first()\n  const tier1Prompt = item.json.tier1Prompt;\n  const imageData = item.json.imageData;\n\n  if (!imageData || !imageData.data) {\n    throw new Error('No image data found in item');\n  }\n\n  const requestBody = {\n    model: 'claude-sonnet-4-20250514',\n    max_tokens: 200,\n    messages: [\n      {\n        role: 'user',\n        content: [\n          {\n            type: 'document',\n            source: {\n              type: 'base64',\n              media_type: imageData.media_type,\n              data: imageData.data\n            }\n          },\n          {\n            type: 'text',\n            text: tier1Prompt\n          }\n        ]\n      }\n    ]\n  };\n\n  outputItems.push({\n    json: {\n      ...item.json,\n      claudeRequestBody: requestBody\n    },\n    binary: item.binary\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-build-claude-tier1",
        "name": "Build Claude Tier 1 Request Body",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1200,
          160
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.anthropic.com/v1/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "anthropic-version",
                "value": "2023-06-01"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ $json.claudeRequestBody }}",
          "options": {}
        },
        "id": "http-claude-tier1",
        "name": "Claude Vision Tier 1 Classification",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          1648,
          160
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "waitBetweenTries": 120000,
        "credentials": {
          "httpHeaderAuth": {
            "id": "vfoYopBRX35Znmq6",
            "name": "Anthropic API key"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const response = item.json;\n\n  if (!response.content || !response.content[0] || !response.content[0].text) {\n    throw new Error('Invalid Claude API response structure');\n  }\n\n  let textContent = response.content[0].text.trim();\n\n  // Strip markdown code fences if present\n  if (textContent.startsWith('```json')) {\n    textContent = textContent\n      .replace(/^```json\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  } else if (textContent.startsWith('```')) {\n    textContent = textContent\n      .replace(/^```\\s*\\n/, '')\n      .replace(/\\n```\\s*$/, '');\n  }\n\n  const parsedResult = JSON.parse(textContent);\n  \n  // FIX CRITICAL: Get metadata from the corresponding item in previous node\n  const previousData = $('Build Claude Tier 1 Request Body').all()[i].json;\n\n  outputItems.push({\n    json: {\n      ...previousData,  // PRESERVE ALL INCOMING DATA including client_name, client_normalized\n      tier1Category: parsedResult.tier1Category,\n      tier1Confidence: parsedResult.tier1Confidence,\n      tier1Reasoning: parsedResult.reasoning || ''\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-parse-claude-tier1",
        "name": "Parse Claude Tier 1 Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2096,
          160
        ]
      },
      {
        "parameters": {
          "jsCode": "// RATE LIMIT PROTECTION: Wait 30 seconds before each Claude API call\nawait new Promise(resolve => setTimeout(resolve, 30000));\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const tier2Prompt = item.json.tier2Prompt;\n  \n  // FIX: Get imageData from the corresponding item, not always first()\n  const imageData = $('Convert PDF to Base64').all()[i].json.imageData;\n\n  if (!imageData || !imageData.data) {\n    throw new Error('No image data found for Tier 2 classification');\n  }\n\n  const requestBody = {\n    model: 'claude-sonnet-4-20250514',\n    max_tokens: 300,\n    messages: [\n      {\n        role: 'user',\n        content: [\n          {\n            type: 'document',\n            source: {\n              type: 'base64',\n              media_type: imageData.media_type,\n              data: imageData.data\n            }\n          },\n          {\n            type: 'text',\n            text: tier2Prompt\n          }\n        ]\n      }\n    ]\n  };\n\n  outputItems.push({\n    json: {\n      ...item.json,\n      claudeTier2RequestBody: requestBody\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-build-claude-tier2",
        "name": "Build Claude Tier 2 Request Body",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2544,
          160
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://api.anthropic.com/v1/messages",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "anthropic-version",
                "value": "2023-06-01"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ $json.claudeTier2RequestBody }}",
          "options": {}
        },
        "id": "http-claude-tier2",
        "name": "Claude Vision Tier 2 Classification",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2992,
          160
        ],
        "retryOnFail": true,
        "maxTries": 5,
        "waitBetweenTries": 120000,
        "credentials": {
          "httpHeaderAuth": {
            "id": "vfoYopBRX35Znmq6",
            "name": "Anthropic API key"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\nconst outputItems = [];\n\nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const response = item.json;\n\n  if (!response.content || !response.content[0] || !response.content[0].text) {\n    throw new Error('Invalid Claude API Tier 2 response structure');\n  }\n\n  let textContent = response.content[0].text.trim();\n\n  // Strip markdown code fences if present\n  if (textContent.startsWith('```json')) {\n    textContent = textContent\n      .replace(/^```json\\\\s*\\\\n/, '')\n      .replace(/\\\\n```\\\\s*$/, '');\n  } else if (textContent.startsWith('```')) {\n    textContent = textContent\n      .replace(/^```\\\\s*\\\\n/, '')\n      .replace(/\\\\n```\\\\s*$/, '');\n  }\n\n  // ROBUST JSON EXTRACTION: Handle prose text wrapping JSON\n  let parsedResult;\n  \n  // Try direct parse first\n  try {\n    parsedResult = JSON.parse(textContent);\n  } catch (directParseError) {\n    // If direct parse fails, try to extract JSON from the text\n    \n    // Method 1: Find JSON object in the text (starts with { ends with })\n    const jsonMatch = textContent.match(/\\\\{[\\\\s\\\\S]*\\\\}/g);\n    if (jsonMatch && jsonMatch.length > 0) {\n      // Try the last match (most likely the full JSON object)\n      for (let j = jsonMatch.length - 1; j >= 0; j--) {\n        try {\n          parsedResult = JSON.parse(jsonMatch[j]);\n          break; // Success! Exit loop\n        } catch (e) {\n          continue; // Try next match\n        }\n      }\n    }\n    \n    // Method 2: Look for JSON inside markdown code block in the middle of text\n    if (!parsedResult) {\n      const codeBlockMatch = textContent.match(/```(?:json)?\\\\s*([\\\\s\\\\S]*?)```/);\n      if (codeBlockMatch && codeBlockMatch[1]) {\n        try {\n          parsedResult = JSON.parse(codeBlockMatch[1].trim());\n        } catch (e) {\n          // Still failed\n        }\n      }\n    }\n    \n    // If all extraction methods failed, throw with helpful message\n    if (!parsedResult) {\n      throw new Error(`Could not extract JSON from Claude response. First 200 chars: ${textContent.substring(0, 200)}...`);\n    }\n  }\n\n  // FIX: Get metadata from the corresponding item in previous node\n  const previousData = $('Parse Classification Result').all()[i].json;\n\n  // DUAL CLASSIFICATION: Extract secondary classification if present\n  const hasSecondaryClassification = parsedResult.hasSecondaryClassification === true;\n  const secondaryDocumentType = hasSecondaryClassification ? parsedResult.secondaryDocumentType : null;\n  const secondaryGermanName = hasSecondaryClassification ? parsedResult.secondaryGermanName : null;\n  const secondaryReasoning = hasSecondaryClassification ? parsedResult.secondaryReasoning : null;\n\n  outputItems.push({\n    json: {\n      ...previousData,  // This preserves client_name, client_normalized, etc.\n      documentType: parsedResult.documentType,\n      tier2Confidence: parsedResult.tier2Confidence,\n      germanName: parsedResult.germanName,\n      englishName: parsedResult.englishName,\n      isCoreType: parsedResult.isCoreType,\n      tier2Reasoning: parsedResult.reasoning || '',\n      // DUAL CLASSIFICATION FIELDS\n      hasSecondaryClassification,\n      secondaryDocumentType,\n      secondaryGermanName,\n      secondaryReasoning\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-parse-claude-tier2",
        "name": "Parse Claude Tier 2 Response",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3440,
          160
        ]
      },
      {
        "parameters": {
          "amount": 60
        },
        "id": "wait-after-tier1",
        "name": "Wait After Tier 1",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          1872,
          160
        ],
        "webhookId": "09d67e4e-d872-45b3-8421-4639ada494f7"
      },
      {
        "parameters": {
          "amount": 60
        },
        "id": "wait-after-tier2",
        "name": "Wait After Tier 2",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          3216,
          160
        ],
        "webhookId": "2ebc9318-2e89-4007-9cdc-f38f3121d489"
      },
      {
        "parameters": {
          "options": {}
        },
        "id": "split-batches-001",
        "name": "Process One File at a Time",
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          304,
          464
        ]
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "85b5d5c7-cb7b-43fb-a47a-7def8098a29b",
                      "leftValue": "={{ $json.chunk2_5_status }}",
                      "rightValue": "error_unclear_type",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "error"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "bc10ada4-798c-4d82-9b0b-062f7679e1c2",
                      "leftValue": "={{ $json.chunk2_5_status }}",
                      "rightValue": "success",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "update_tracker"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 3
                  },
                  "conditions": [
                    {
                      "id": "032787ac-b6d7-417a-8011-f68246aed0e6",
                      "leftValue": "={{ $json.chunk2_5_status }}",
                      "rightValue": "error_client_not_found",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "skip_tracker"
              }
            ]
          },
          "options": {
            "fallbackOutput": "extra"
          }
        },
        "id": "d4336ded-fbdb-4dff-9518-4523471dc798",
        "name": "Route Based on Document Type1",
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.4,
        "position": [
          4560,
          128
        ]
      },
      {
        "parameters": {
          "amount": 20
        },
        "id": "wait-before-tier1",
        "name": "Wait Before Tier 1",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          1424,
          160
        ],
        "webhookId": "dcfb75d4-4b31-4f3d-8d62-6a7d74a8cb4d"
      },
      {
        "parameters": {
          "amount": 20
        },
        "id": "wait-before-tier2",
        "name": "Wait Before Tier 2",
        "type": "n8n-nodes-base.wait",
        "typeVersion": 1.1,
        "position": [
          2768,
          160
        ],
        "webhookId": "9bef8db0-18fb-4e3a-ae5b-1e8bcde21d96"
      },
      {
        "parameters": {
          "jsCode": "// Build Google Sheets API Update Request - UPDATED for Dokumenten_Tracker\n// Maps AI document types to actual sheet column names\n// FIXED: Explicitly include reasoning fields\n// DUAL CLASSIFICATION: Adds secondary tracker updates if present\n\nconst items = $input.all();\nconst outputItems = [];\n\nfor (const item of items) {\n  const data = item.json;\n\n  // If skipTrackerUpdate is true, pass through without update\n  if (data.skipTrackerUpdate === true) {\n    outputItems.push({\n      json: {\n        ...data,\n        trackerUpdateSkipped: true\n      }\n    });\n    continue;\n  }\n\n  // Map AI document types to sheet column names\n  const aiToSheetMapping = {\n    '01_Projektbeschreibung': '01_Expos\u00e9',\n    '02_Kaufvertrag': '02_Grundbuchauszug',\n    '03_Grundbuchauszug': '02_Grundbuchauszug',\n    '10_Bautraegerkalkulation_DIN276': '03_Bautraegerkalkulation_DIN276',\n    '36_Exit_Strategie': '04_Exit_Strategie',\n    '07_Altlastenkataster': '05_Altlastenkataster',\n    '08_Baugrundgutachten': '06_Baugrundgutachten',\n    '09_Lageplan': '07_Lageplan',\n    '15_Flaechenberechnung_DIN277': '08_Flaechenberechnung',\n    '16_GU_Werkvertraege': '09_GU_Werkvertraege',\n    '17_Bauzeichnungen': '10_Bauzeichnungen',\n    '18_Baugenehmigung': '11_Baugenehmigung',\n    '22_Gutachterauftrag': '12_Gutachterauftrag',\n    '11_Verkaufspreise': '13_Verkaufspreise',\n    '12_Bauzeitenplan_Liquiditaet': '14_Bauzeitenplan',\n    '13_Vertriebsweg': '15_Vertriebsweg',\n    '14_Bau_Ausstattungsbeschreibung': '16_Ausstattungsbeschreibung',\n    '19_Teilungserklaerung': '17_Teilungserklaerung',\n    '20_Versicherungen': '18_Versicherungen',\n    '21_Muster_Verkaufsvertrag': '19_Muster_Verkaufsvertrag',\n    '23_Umsatzsteuervoranmeldung': '20_Umsatzsteuervoranmeldung',\n    '24_BWA': '21_BWA',\n    '25_Jahresabschluss': '22_Jahresabschluss',\n    '26_Finanzierungsbestaetigung': '23_Finanzierungsbestaetigung',\n    '27_Darlehensvertrag': '24_Darlehensvertrag',\n    '28_Gesellschaftsvertrag': '25_Gesellschaftsvertrag',\n    '29_Handelsregisterauszug': '26_Handelsregisterauszug',\n    '30_Gewerbeanmeldung': '27_Gewerbeanmeldung',\n    '31_Steuer_ID': '28_Steuer_ID',\n    '32_Freistellungsbescheinigung': '29_Freistellungsbescheinigung',\n    '33_Vollmachten': '30_Vollmachten',\n    '34_Korrespondenz': '31_Korrespondenz',\n    '35_Sonstiges_Allgemein': '32_Sonstiges',\n    '37_Others': '32_Sonstiges',\n    '38_Unknowns': '33_Unbekannt'\n  };\n\n  // Map sheet column names to column letters (A-AI)\n  const columnLetterMapping = {\n    'Mandant': 'A',\n    'Letzte_Aktualisierung': 'B',\n    '01_Expos\u00e9': 'C',\n    '02_Grundbuchauszug': 'D',\n    '03_Bautraegerkalkulation_DIN276': 'E',\n    '04_Exit_Strategie': 'F',\n    '05_Altlastenkataster': 'G',\n    '06_Baugrundgutachten': 'H',\n    '07_Lageplan': 'I',\n    '08_Flaechenberechnung': 'J',\n    '09_GU_Werkvertraege': 'K',\n    '10_Bauzeichnungen': 'L',\n    '11_Baugenehmigung': 'M',\n    '12_Gutachterauftrag': 'N',\n    '13_Verkaufspreise': 'O',\n    '14_Bauzeitenplan': 'P',\n    '15_Vertriebsweg': 'Q',\n    '16_Ausstattungsbeschreibung': 'R',\n    '17_Teilungserklaerung': 'S',\n    '18_Versicherungen': 'T',\n    '19_Muster_Verkaufsvertrag': 'U',\n    '20_Umsatzsteuervoranmeldung': 'V',\n    '21_BWA': 'W',\n    '22_Jahresabschluss': 'X',\n    '23_Finanzierungsbestaetigung': 'Y',\n    '24_Darlehensvertrag': 'Z',\n    '25_Gesellschaftsvertrag': 'AA',\n    '26_Handelsregisterauszug': 'AB',\n    '27_Gewerbeanmeldung': 'AC',\n    '28_Steuer_ID': 'AD',\n    '29_Freistellungsbescheinigung': 'AE',\n    '30_Vollmachten': 'AF',\n    '31_Korrespondenz': 'AG',\n    '32_Sonstiges': 'AH',\n    '33_Unbekannt': 'AI'\n  };\n\n  // Get document type from AI classification\n  const documentType = data.documentType || data.trackerColumn;\n  const trackerRowIndex = data.trackerRowIndex;\n  const trackerValue = data.trackerValue || '\u2713';\n\n  // First map AI type to sheet column name\n  let sheetColumnName = aiToSheetMapping[documentType];\n  \n  // If not in AI mapping, check if it's already a sheet column name\n  if (!sheetColumnName && columnLetterMapping[documentType]) {\n    sheetColumnName = documentType;\n  }\n  \n  // Fallback to 33_Unbekannt if unknown\n  if (!sheetColumnName) {\n    console.log(`Unknown document type: ${documentType}, defaulting to 33_Unbekannt`);\n    sheetColumnName = '33_Unbekannt';\n  }\n\n  const columnLetter = columnLetterMapping[sheetColumnName];\n  const timestampColumn = columnLetterMapping['Letzte_Aktualisierung'];\n  \n  if (!columnLetter) {\n    throw new Error(`No column letter mapping for: ${sheetColumnName}`);\n  }\n\n  // Build ranges for update\n  const statusRange = `Dokumenten_Tracker!${columnLetter}${trackerRowIndex}`;\n  const timestampRange = `Dokumenten_Tracker!${timestampColumn}${trackerRowIndex}`;\n  const timestamp = new Date().toISOString();\n\n  // Build batchUpdate request body - START WITH PRIMARY CLASSIFICATION\n  const updateData = [\n    {\n      range: statusRange,\n      values: [[trackerValue]]\n    },\n    {\n      range: timestampRange,\n      values: [[timestamp]]\n    }\n  ];\n\n  // DUAL CLASSIFICATION: Add secondary update if present\n  if (data.hasSecondaryClassification && data.secondaryTrackerColumn) {\n    // Map secondary tracker column to sheet column name\n    let secondarySheetColumnName = aiToSheetMapping[data.secondaryTrackerColumn];\n    if (!secondarySheetColumnName && columnLetterMapping[data.secondaryTrackerColumn]) {\n      secondarySheetColumnName = data.secondaryTrackerColumn;\n    }\n    \n    if (secondarySheetColumnName) {\n      const secondaryColumnLetter = columnLetterMapping[secondarySheetColumnName];\n      if (secondaryColumnLetter) {\n        const secondaryStatusRange = `Dokumenten_Tracker!${secondaryColumnLetter}${trackerRowIndex}`;\n        updateData.push({\n          range: secondaryStatusRange,\n          values: [['\u2713 (sec)']]\n        });\n      }\n    }\n  }\n\n  const requestBody = {\n    data: updateData,\n    valueInputOption: 'USER_ENTERED'\n  };\n\n  // FIXED: Explicitly include all fields including reasoning\n  outputItems.push({\n    json: {\n      // Core classification data\n      fileId: data.fileId,\n      fileName: data.fileName,\n      fileUrl: data.fileUrl,\n      clientEmail: data.clientEmail,\n      client_name: data.client_name,\n      client_normalized: data.client_normalized,\n      \n      // Tier 1 classification\n      tier1Category: data.tier1Category,\n      tier1Confidence: data.tier1Confidence,\n      tier1Reasoning: data.tier1Reasoning || '',\n      \n      // Tier 2 classification\n      documentType: data.documentType,\n      tier2Confidence: data.tier2Confidence,\n      tier2Reasoning: data.tier2Reasoning || '',\n      combinedConfidence: data.combinedConfidence,\n      germanName: data.germanName,\n      englishName: data.englishName,\n      isCoreType: data.isCoreType,\n      \n      // DUAL CLASSIFICATION\n      hasSecondaryClassification: data.hasSecondaryClassification || false,\n      secondaryDocumentType: data.secondaryDocumentType || null,\n      secondaryGermanName: data.secondaryGermanName || null,\n      secondaryReasoning: data.secondaryReasoning || null,\n      secondaryTrackerColumn: data.secondaryTrackerColumn || null,\n      \n      // Tracker info\n      trackerRowIndex: trackerRowIndex,\n      trackerColumn: data.trackerColumn,\n      trackerValue: trackerValue,\n      \n      // API request data\n      sheetsApiRequestBody: requestBody,\n      spreadsheetId: '12N2C8iWeHkxJQ2qz7m3aTyZw3X1gXbyyyFa-rP0tD7I',\n      mappedColumnName: sheetColumnName,\n      columnLetter: columnLetter\n    }\n  });\n}\n\nreturn outputItems;"
        },
        "id": "code-build-sheets-api-update",
        "name": "Build Google Sheets API Update Request",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5008,
          64
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheetId }}/values:batchUpdate",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "googleSheetsOAuth2Api",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ $json.sheetsApiRequestBody }}",
          "options": {}
        },
        "id": "http-update-tracker",
        "name": "Update Client_Tracker Row (API)",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          5456,
          -64
        ],
        "credentials": {
          "googleSheetsOAuth2Api": {
            "id": "H7ewI1sOrDYabelt",
            "name": "Google Sheets account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "version": 2,
              "leftValue": "",
              "caseSensitive": true,
              "typeValidation": "strict"
            },
            "combinator": "and",
            "conditions": [
              {
                "id": "skip-check",
                "operator": {
                  "type": "boolean",
                  "operation": "false",
                  "singleValue": true
                },
                "leftValue": "={{ $json.skipTrackerUpdate }}",
                "rightValue": ""
              }
            ]
          },
          "options": {}
        },
        "id": "if-skip-tracker",
        "name": "Should Update Tracker?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          5232,
          64
        ]
      },
      {
        "id": "if-dual-classification",
        "name": "Check Dual Classification",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.3,
        "position": [
          3664,
          320
        ],
        "parameters": {
          "conditions": {
            "options": {
              "version": 2,
              "leftValue": "",
              "caseSensitive": true,
              "typeValidation": "strict",
              "combinator": "and"
            },
            "conditions": [
              {
                "id": "dual-class-check",
                "leftValue": "={{ $json.hasSecondaryClassification }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ]
          }
        }
      },
      {
        "id": "gmail-dual-classification",
        "name": "Send Dual Classification Email",
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.2,
        "position": [
          3888,
          440
        ],
        "parameters": {
          "resource": "message",
          "operation": "send",
          "sendTo": "sway@thebluebottle.io",
          "subject": "Document with Multiple Classifications - Review Needed",
          "emailFormat": "text",
          "message": "=Document requires review - multiple valid classifications detected\\n\\n**File Details:**\\n- File Name: {{ $json.fileName }}\\n- Client: {{ $json.client_name }}\\n\\n**Primary Classification:**\\n- Tier 1: {{ $json.tier1Category }}\\n- Tier 2: {{ $json.documentType }} ({{ $json.germanName }})\\n- Reasoning: {{ $json.tier2Reasoning }}\\n\\n**Secondary Classification:**\\n- Document Type: {{ $json.secondaryDocumentType }} ({{ $json.secondaryGermanName }})\\n- Reasoning: {{ $json.secondaryReasoning }}\\n\\n**Action Required:**\\nReview the document and determine which classification is correct, or if both should be applied.\\n\\nFile URL: {{ $json.fileUrl }}",
          "options": {}
        },
        "credentials": {
          "gmailOAuth2": {
            "id": "aYzk7sZF8ZVyfOan",
            "name": "Gmail account"
          }
        }
      }
    ],
    "connections": {
      "Lookup Client in Client_Tracker": {
        "main": [
          [
            {
              "node": "Find Client Row and Validate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Lookup Client in AMA_Folder_IDs": {
        "main": [
          [
            {
              "node": "Get Destination Folder ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Destination Folder ID": {
        "main": [
          [
            {
              "node": "Move File to Final Location",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Move File to Final Location": {
        "main": [
          [
            {
              "node": "Prepare Success Output",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Lookup 38_Unknowns Folder": {
        "main": [
          [
            {
              "node": "Get 38_Unknowns Folder ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get 38_Unknowns Folder ID": {
        "main": [
          [
            {
              "node": "Move File to 38_Unknowns",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Move File to 38_Unknowns": {
        "main": [
          [
            {
              "node": "Prepare Error Email Body",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Error Email Body": {
        "main": [
          [
            {
              "node": "Send Error Notification Email",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Classify Document with GPT-4": {
        "main": [
          [
            {
              "node": "Parse Classification Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tier 2 GPT-4 API Call": {
        "main": [
          [
            {
              "node": "Parse Tier 2 Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Tier 2 Result": {
        "main": [
          [
            {
              "node": "Determine Action Type",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Determine Action Type": {
        "main": [
          [
            {
              "node": "Lookup Client in Client_Tracker",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Find Client Row and Validate": {
        "main": [
          [
            {
              "node": "Route Based on Document Type1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Download PDF for Classification": {
        "main": [
          [
            {
              "node": "Convert PDF to Base64",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert PDF to Base64": {
        "main": [
          [
            {
              "node": "Build AI Classification Prompt",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build AI Classification Prompt": {
        "main": [
          [
            {
              "node": "Build Claude Tier 1 Request Body",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Claude Tier 1 Response": {
        "main": [
          [
            {
              "node": "Parse Classification Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Classification Result": {
        "main": [
          [
            {
              "node": "Build Claude Tier 2 Request Body",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Claude Tier 2 Response": {
        "main": [
          [
            {
              "node": "Check Dual Classification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Claude Vision Tier 1 Classification": {
        "main": [
          [
            {
              "node": "Wait After Tier 1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait After Tier 1": {
        "main": [
          [
            {
              "node": "Parse Claude Tier 1 Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Claude Vision Tier 2 Classification": {
        "main": [
          [
            {
              "node": "Wait After Tier 2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait After Tier 2": {
        "main": [
          [
            {
              "node": "Parse Claude Tier 2 Response",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Execute Workflow Trigger (Refreshed)": {
        "main": [
          [
            {
              "node": "Process One File at a Time",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Success Output": {
        "main": [
          [
            {
              "node": "Process One File at a Time",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Error Notification Email": {
        "main": [
          [
            {
              "node": "Process One File at a Time",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Route Based on Document Type1": {
        "main": [
          [
            {
              "node": "Lookup 38_Unknowns Folder",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Prepare Tracker Update Data",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Lookup 38_Unknowns Folder",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Lookup 38_Unknowns Folder",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process One File at a Time": {
        "1": [
          [
            {
              "node": "Download PDF for Classification",
              "type": "0",
              "index": 0
            }
          ]
        ],
        "main": [
          [],
          [
            {
              "node": "Download PDF for Classification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Claude Tier 1 Request Body": {
        "main": [
          [
            {
              "node": "Wait Before Tier 1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait Before Tier 1": {
        "main": [
          [
            {
              "node": "Claude Vision Tier 1 Classification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Claude Tier 2 Request Body": {
        "main": [
          [
            {
              "node": "Wait Before Tier 2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait Before Tier 2": {
        "main": [
          [
            {
              "node": "Claude Vision Tier 2 Classification",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Tracker Update Data": {
        "main": [
          [
            {
              "node": "Build Google Sheets API Update Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Update Client_Tracker Row (API)": {
        "main": [
          [
            {
              "node": "Lookup Client in AMA_Folder_IDs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Should Update Tracker?": {
        "main": [
          [
            {
              "node": "Update Client_Tracker Row (API)",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Lookup Client in AMA_Folder_IDs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Google Sheets API Update Request": {
        "main": [
          [
            {
              "node": "Should Update Tracker?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Dual Classification": {
        "main": [
          [
            {
              "node": "Send Dual Classification Email",
              "type": "main",
              "index": 0
            },
            {
              "node": "Parse Tier 2 Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Send Dual Classification Email": {
        "main": [
          [
            {
              "node": "Parse Tier 2 Result",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Sway Clarke",
    "name": null,
    "description": null,
    "autosaved": false,
    "workflowPublishHistory": [
      {
        "createdAt": "2026-01-29T12:27:33.165Z",
        "id": 1686,
        "workflowId": "okg8wTqLtPUwjQ18",
        "versionId": "3a8f8199-e96a-4682-a8e8-77478e798553",
        "event": "activated",
        "userId": "e9bd9112-c2e3-4f67-873a-e1001baeafd8"
      },
      {
        "createdAt": "2026-01-29T12:27:46.949Z",
        "id": 1687,
        "workflowId": "okg8wTqLtPUwjQ18",
        "versionId": "3a8f8199-e96a-4682-a8e8-77478e798553",
        "event": "activated",
        "userId": "e9bd9112-c2e3-4f67-873a-e1001baeafd8"
      }
    ]
  }
}