# Claude Code Project Instructions

## üö® AGENT DELEGATION PROTOCOL (CHECK THIS FIRST)

**MANDATORY: Before EVERY action, check if you should delegate to an agent.**

### Decision Flowchart

```
USER REQUEST
     ‚Üì
1. Is this a browser task? ‚Üí YES ‚Üí browser-ops-agent (ALWAYS)
     ‚Üì NO
2. Is this building/modifying n8n workflows?
   - Adding ‚â•3 nodes? ‚Üí YES ‚Üí solution-builder-agent
   - Modifying ‚â•3 nodes? ‚Üí YES ‚Üí solution-builder-agent
   - Creating new workflow? ‚Üí YES ‚Üí solution-builder-agent
   - Complex logic changes? ‚Üí YES ‚Üí solution-builder-agent
     ‚Üì NO (‚â§2 simple updates)
3. Is this testing a workflow? ‚Üí YES ‚Üí test-runner-agent
     ‚Üì NO
4. Is this checking feasibility? ‚Üí YES ‚Üí architecture-feasibility-agent
     ‚Üì NO
5. Is this planning implementation? ‚Üí YES ‚Üí idea-architect-agent
     ‚Üì NO
6. Do it yourself in main conversation
```

### Strict Delegation Rules (Non-Negotiable)

| You See This | Do This | NEVER Do This |
|--------------|---------|---------------|
| **ANY Playwright tool** (`mcp__playwright__*`) | **browser-ops-agent** | Direct Playwright in main |
| **ANY OAuth/credential setup** | **browser-ops-agent** | Manual browser navigation |
| **Build new n8n workflow** | **solution-builder-agent** | Direct MCP calls yourself |
| **Modify ‚â•3 n8n nodes** | **solution-builder-agent** | Multiple update_partial calls |
| **Add ‚â•3 n8n nodes** | **solution-builder-agent** | Multiple addNode operations |
| **"Is this feasible?"** question | **architecture-feasibility-agent** | Research yourself |
| **"How should I implement?"** | **idea-architect-agent** | Design yourself |
| **Test n8n workflow** | **test-runner-agent** | Manual execution testing |

### Numeric Thresholds (Automatic Delegation)

**ALWAYS delegate when ANY of these are true:**

- **Browser actions**: ANY Playwright tool use ‚Üí browser-ops-agent
- **n8n complexity**: ‚â•3 nodes to add/modify ‚Üí solution-builder-agent
- **Token cost**: Estimated >5,000 tokens ‚Üí delegate to appropriate agent
- **Multi-step**: >3 sequential operations ‚Üí delegate to appropriate agent
- **OAuth/auth**: ANY credential setup ‚Üí browser-ops-agent
- **Workflow testing**: ANY test execution ‚Üí test-runner-agent

### Main Conversation Limits

**You CAN do in main conversation:**
- Read/Write/Edit files (documentation, code)
- Simple Bash commands (git, ls, etc.)
- ‚â§2 simple n8n node updates (parameter changes only)
- Ask clarifying questions
- Update MY-JOURNEY.md, VERSION_LOG.md
- Orchestrate between agents

**You CANNOT do in main conversation:**
- ‚ùå Use ANY Playwright tool
- ‚ùå Build or modify n8n workflows (‚â•3 nodes)
- ‚ùå Set up OAuth/credentials
- ‚ùå Test workflows
- ‚ùå Check feasibility of designs
- ‚ùå Plan implementation strategies
- ‚ùå Complex multi-step browser tasks

### Cost Efficiency Reminder

**Why delegation matters:**
- Playwright in main = 20K-150K tokens per snapshot
- browser-ops-agent = optimized, 5-10x cheaper
- solution-builder-agent = knows n8n patterns, faster
- **Main doing agent work = 10x token waste**

### Agent Resume Protocol

**Before launching ANY new agent:**

1. **Check for existing agents** - Look for agent IDs in recent conversation
2. **Resume if possible** - Use `resume` parameter to continue existing agent work
3. **Launch parallel when appropriate** - Multiple independent agents can run simultaneously

**Resume syntax:**
```javascript
Task({
  subagent_type: "solution-builder-agent",
  resume: "a8db5f3",  // Continue with full context
  prompt: "Continue building the workflow"
})
```

**Parallel launch (single message with multiple Task calls):**
```javascript
// Launch solution-builder AND test-runner simultaneously
Task({ subagent_type: "solution-builder-agent", prompt: "Build workflow" })
Task({ subagent_type: "test-runner-agent", prompt: "Test workflow XYZ" })
```

### Agent ID Display (MANDATORY)

**When any agent completes, IMMEDIATELY show:**

```markdown
‚úÖ Agent completed
Agent ID: a8db5f3
Type: solution-builder-agent
Status: Success
```

**Why:** Agent IDs may not be visible in Cursor chat window. Sway needs to see them to resume work later.

---

## ‚ö†Ô∏è PRE-ACTION PROTOCOL (Read Before Every Tool Call)

**STOP before calling ANY tool. Verify these conditions FIRST.**

### Before ANY MCP Tool Call

**1. Check Agent Delegation First**
- Go to flowchart above
- If task matches agent criteria ‚Üí STOP and delegate
- Only proceed if task is explicitly in "Main Conversation Limits"

**2. Ask Before Assuming**
- **If user request is ambiguous** ‚Üí Ask clarifying questions BEFORE acting
- **If multiple approaches possible** ‚Üí Ask which approach Sway prefers
- **If information might be known** ‚Üí Ask Sway instead of calling MCP tools
- **Better to ask 1 question than waste 5K tokens on wrong approach**

**3. Before `mcp__n8n-mcp__n8n_get_workflow`:**

**STOP. Ask yourself:**

1. **Do I already have this information?**
   - ‚úÖ YES ‚Üí Use it. Don't call MCP.
   - ‚ùå NO ‚Üí Continue to question 2.

2. **Can Sway answer this faster than an MCP call?**
   - ‚úÖ YES ‚Üí Ask Sway. Don't call MCP.
   - ‚ùå NO ‚Üí Continue to question 3.

3. **What's the MINIMUM mode I need?**
   - Just checking if workflow exists/is active? ‚Üí `mode: "minimal"` (200 tokens)
   - Need execution stats? ‚Üí `mode: "details"` (500 tokens)
   - Need to see workflow flow/topology? ‚Üí `mode: "structure"` (2,000 tokens)
   - Need complete node parameters for building? ‚Üí `mode: "full"` (13,000 tokens)

   **DEFAULT to minimal. Only escalate if absolutely necessary.**

4. **Is this information in a previous error context?**
   - ‚úÖ YES ‚Üí Use the error context. Don't call MCP.
   - ‚ùå NO ‚Üí Proceed with MINIMUM mode from step 3.

**4. Before `mcp__n8n-mcp__n8n_update_partial_workflow`:**

**STOP. Count the changes:**
- Adding/modifying ‚â•3 nodes? ‚Üí STOP. Use **solution-builder-agent**
- Adding <3 simple nodes? ‚Üí Proceed with direct MCP call
- Modifying parameters only (‚â§2 nodes)? ‚Üí Proceed with direct MCP call

**5. Before ANY Playwright tool:**

**STOP.**

- ‚ùå **NEVER use Playwright tools directly in main conversation**
- ‚úÖ **ALWAYS use browser-ops-agent**

**No exceptions. No "quick checks". Always delegate.**

---

## User Reference

**ALWAYS refer to the user as "Sway"** in all communications, documentation, and updates.

**Sway's Email Address:** swayclarkeii@gmail.com (used for all Gmail integrations, n8n workflows, and testing)

---

## Integration Guidelines

**CRITICAL: ALWAYS Use MCP Server Tools for All Integrations**

- **ALWAYS** use MCP server tools (`mcp__*__*`) for ALL integrations and external services
- **NEVER** use direct API calls (HTTP requests, fetch, etc.) unless **explicitly** requested by Sway
- This applies to ALL services: n8n, Notion, Google services, GitHub, Fathom, and any other integrations

**Examples of correct tool usage:**
- ‚úÖ n8n: Use `mcp__n8n-mcp__*` tools (never direct n8n API)
- ‚úÖ Notion: Use `mcp__notion__*` tools (never direct Notion API)
- ‚úÖ Google Docs/Sheets/Drive: Use `mcp__google-docs__*` or `mcp__google-sheets__*` tools
- ‚úÖ GitHub: Use `mcp__github-mcp__*` tools

**Only use direct API calls when:**
- Sway explicitly says "use the API directly" or "make an API call"
- No MCP tool exists for the specific service (rare)

---

## OAuth Refresh Protocol

**CRITICAL: ALWAYS handle OAuth token refreshes autonomously using browser-ops-agent.**

See full protocol at: `/Users/swayclarke/coding_stuff/OAUTH_REFRESH_PROTOCOL.md`

**Quick Reference:**
- **DO NOT** ask Sway to complete OAuth pop-ups or copy/paste URLs
- **ALWAYS** use **browser-ops-agent** for OAuth flows
- Applies to: Google, GitHub, Notion, Fathom, n8n, and all OAuth services
- Only request manual intervention for: 2FA codes, account lockouts, payment authorization

**Correct Approach:**
```
User: "Refresh OAuth credentials for Gmail"
Main: *launches browser-ops-agent with OAuth task*
Main: "‚úÖ Agent completed - OAuth credentials refreshed"
```

**NEVER do OAuth in main conversation** - it wastes 100K+ tokens on Playwright snapshots.

---

## n8n MCP Server Commands

**CRITICAL**: ALWAYS use `mcp__n8n-mcp__*` tools for ALL n8n operations. NEVER use direct n8n API calls - they erase credentials.

### Before ANY n8n Workflow Modification

**STOP. Check agent delegation rules:**

1. **Adding ‚â•3 nodes?** ‚Üí Use **solution-builder-agent**
2. **Modifying ‚â•3 nodes?** ‚Üí Use **solution-builder-agent**
3. **Creating new workflow?** ‚Üí Use **solution-builder-agent**
4. **Complex logic changes?** ‚Üí Use **solution-builder-agent**
5. **Only ‚â§2 simple parameter updates?** ‚Üí Proceed with MCP call

### Command Documentation

**Always check documentation first** when unsure about command syntax:
```
mcp__n8n-mcp__tools_documentation(
  topic: "n8n_update_partial_workflow",
  depth: "full"
)
```

### Common n8n MCP Tools

1. **Get workflow data**: `mcp__n8n-mcp__n8n_get_workflow` (use appropriate mode!)
2. **Update workflow**: `mcp__n8n-mcp__n8n_update_partial_workflow` (check delegation first!)
3. **Validate workflow**: `mcp__n8n-mcp__n8n_validate_workflow`
4. **Get node info**: `mcp__n8n-mcp__get_node`
5. **Search nodes**: `mcp__n8n-mcp__search_nodes`

### Token Efficiency Guidelines (MANDATORY)

**ALWAYS minimize token usage when calling n8n MCP tools.**

#### n8n_get_workflow Mode Costs

| Mode | Token Cost | Use When |
|------|------------|----------|
| `minimal` | ~200 tokens | Check if workflow exists, is active, or get basic metadata |
| `details` | ~500 tokens | Get metadata + execution stats |
| `structure` | ~2,000 tokens | See node names and connection topology only |
| `full` | ~13,000 tokens | Need complete node parameters for building/debugging |

#### Best Practices (Follow These Always)

1. ‚úÖ **Ask user first** - If user likely knows the answer, ask instead of calling MCP
2. ‚úÖ **Start with minimal mode** - Use `mode: "minimal"` to check workflow status
3. ‚úÖ **Use structure for topology** - Only when you need to see workflow flow
4. ‚úÖ **Reserve full mode** - Only for building/debugging node configurations
5. ‚úÖ **One call per task** - Don't call structure then full; go straight to what you need

#### Anti-Patterns (Never Do These)

- ‚ùå Calling `mode: "structure"` then `mode: "full"` in same conversation
- ‚ùå Using `mode: "full"` just to check if workflow is active
- ‚ùå Using `mode: "full"` to verify a single parameter value
- ‚ùå Getting workflow data when user can answer the question
- ‚ùå Calling MCP to check something visible in previous conversation context

### Critical: n8n_update_partial_workflow Syntax

**Common Mistakes to AVOID:**
- ‚ùå Using `sourceNode` and `targetNode` (WRONG)
- ‚ùå Using `sourceOutput: 0` as number (WRONG)
- ‚ùå Guessing parameter names instead of checking docs

**Correct Syntax:**
- ‚úÖ Use `source` and `target` for node names
- ‚úÖ Use `sourceOutput: "main"` as string
- ‚úÖ Use exact node names (case-sensitive)

### Operation Types

#### Adding a Node
```javascript
{
  "type": "addNode",
  "node": {
    "name": "List All Folders",
    "type": "n8n-nodes-base.googleDrive",
    "parameters": {
      "resource": "folder",
      "operation": "getAll",
      "driveId": {"__rl": true, "mode": "list", "value": "My Drive"},
      "folderId": {"__rl": true, "value": "={{$('Create Root Folder').first().json.id}}", "mode": "id"},
      "options": {"recursive": true}
    },
    "position": [1000, 500]
  }
}
```

#### Adding a Connection
```javascript
{
  "type": "addConnection",
  "source": "Loop Subfolders",          // Exact source node name
  "sourceOutput": "done",               // Output name (string)
  "target": "List All Folders",         // Exact target node name
  "targetInput": "main"                 // Input name (string, usually "main")
}
```

#### Updating Node Code
```javascript
{
  "type": "updateNode",
  "nodeName": "Collect Folder IDs",
  "updates": {
    "parameters": {
      "jsCode": "// Updated JavaScript code here"
    }
  }
}
```

### Important n8n Workflow Patterns

**splitInBatches Loop Limitation**:
- `$('NodeName').all()` DOES NOT work inside splitInBatches loops
- It only returns the **last iteration**, not accumulated data
- **Solution**: Use a separate node to fetch all data after loops complete

**Google Drive Search Scoping**:
- ALWAYS scope searches to specific folders using `folderId` parameter
- Use `recursive: true` to get all subfolders
- Prevents searching 70K+ files in entire My Drive (performance issue)

---

## Notion Integration

When referencing "to-do list", "tasks", or "my tasks", use this Notion database:

- **Database ID (legacy):** `889fff97-1c29-490b-a57c-322c0736e90a`
- **Data Source ID (new API):** `39b8b725-0dbd-4ec2-b405-b3bba0c1d97e`
- **URL:** https://www.notion.so/889fff971c29490ba57c322c0736e90a

### CRITICAL: Notion API 2025-09-03 Changes

The Notion API changed significantly on 2025-09-03. Key changes:
- **Databases vs Data Sources**: Now separate concepts - databases are containers, data sources hold the schema/content
- **Page creation**: Requires `data_source_id` instead of `database_id` in parent
- **Querying**: Use `mcp__notion__API-query-data-source` with data_source_id

**Old format (deprecated):**
```json
{"parent": {"type": "database_id", "database_id": "889fff97..."}}
```

**New format (2025-09-03+):**
```json
{"parent": {"type": "data_source_id", "data_source_id": "39b8b725..."}}
```

### CRITICAL: Notion MCP Configuration

‚úÖ **Status: Official Notion MCP server is connected and working**

**Current Configuration (~/.claude.json):**
```json
"notion": {
  "type": "stdio",
  "command": "npx",
  "args": ["-y", "@notionhq/notion-mcp-server"],
  "env": {
    "NOTION_TOKEN": "ntn_J75587080087TBhkjcxsZBYMUajbCtySV0xnp1xgPH57SC"
  }
}
```

**Environment Variable Requirements:**
- Official package (`@notionhq/notion-mcp-server`) requires `NOTION_TOKEN` (NOT `NOTION_API_KEY`)
- Alternative package (`@suekou/mcp-notion-server`) uses `NOTION_API_KEY`

**Integration Token:**
- Name: "Claude Code MCP"
- Token: `ntn_J75587080087TBhkjcxsZBYMUajbCtySV0xnp1xgPH57SC`

### Known MCP Server Bug (Verify Status)

‚ö†Ô∏è **WARNING**: The official Notion MCP server (`@notionhq/notion-mcp-server`) had a known bug where object parameters like `parent` get double-stringified. This causes page creation to fail with:
```
body.parent should be an object or undefined, instead was "{\"type\":...
```

**Current Status:**
- ‚úÖ Server connection: Working
- ‚úÖ Reading/querying data: Working
- ‚ùå Creating pages: Broken (due to bug)

**Workaround for page creation (if bug still exists):**
1. Use n8n workflow "Add Task to Notion" (workflow ID: `koJAMDJv2Gk7HzdS`)
2. Add tasks directly in Notion UI
3. Check bug status: https://github.com/makenotion/notion-mcp-server/issues/82

**Note:** Before using workaround, test if page creation works directly - bug may have been fixed.

### Efficient Querying

Use `mcp__notion__API-query-data-source` with the data_source_id:

```
data_source_id: "39b8b725-0dbd-4ec2-b405-b3bba0c1d97e"
filter: { "property": "Complete", "checkbox": { "equals": false } }
page_size: 20
```

### Key Properties in Tasks Database
- **Name** (title): Task name
- **Complete** (checkbox): Whether task is done
- **Status** (status): Current state (To-do, Doing, Done)
- **When** (date): Due date
- **Priority** (select): Task priority
- **Project** (relation): Related project
- **Area** (relation): Life area

### Task Status Management Rules

**CRITICAL**: When updating Notion tasks, ALWAYS update BOTH the "Complete" checkbox AND the "Status" field together:

1. **When user is working on a task:**
   - Set Status to "Doing": `{"Status": {"status": {"name": "Doing"}}}`
   - Keep Complete as false: `{"Complete": {"checkbox": false}}`

2. **When task is complete/done:**
   - Set Status to "Done": `{"Status": {"status": {"name": "Done"}}}`
   - Set Complete to true: `{"Complete": {"checkbox": true}}`

3. **Default behavior:**
   - When user says "mark as done" or "complete": Update BOTH Status to "Done" AND Complete to true
   - When user says "I'm working on": Update Status to "Doing"
   - This ensures tasks move correctly in the Kanban board

**Example updates:**
```
# Marking task as done:
{"Complete": {"checkbox": true}, "Status": {"status": {"name": "Done"}}}

# Starting work on task:
{"Status": {"status": {"name": "Doing"}}}
```

---

## Daily Updates & Progress Tracking

### CRITICAL DISTINCTION: Tasks vs Updates

**Tasks** ‚Üí Notion Tasks Database (889fff97-1c29-490b-a57c-322c0736e90a):
- Action items with due dates
- Things that need to be completed
- Personal todos (shoes to return, books to read, etc.)
- Examples: "Upload coach feedback", "Return shoes", "Schedule call"

**Updates** ‚Üí MY-JOURNEY.md (/Users/swayclarke/coding_stuff/claude-code-os/00-progress-advisor/MY-JOURNEY.md):
- All client and project progress
- Business learnings and insights
- Call summaries and key takeaways
- Milestones achieved
- Strategy decisions made
- System improvements built
- Examples: "Lombok Task 2 V4 approved", "Jennifer call insights", "Built Google Slides automation"

### Automatic Update Rules

When the user provides ANY update about:
- Client progress (Eugene, Lombok Capital, Jennifer & Fernandez, etc.)
- Project status changes
- Calls completed or insights gained
- Systems or automation built
- Business learnings or realizations

**AUTOMATICALLY do BOTH:**
1. Add relevant tasks to Notion (if there are action items)
2. Document the update in MY-JOURNEY.md in the appropriate section:
   - Add to "Milestones Log" (date + brief summary)
   - Create/update detailed entry in "Notes & Insights" section
   - Add key learnings to "What I'm Learning" section

**DO NOT wait for the user to ask** - proactively update MY-JOURNEY.md whenever they share progress.

### MY-JOURNEY.md Structure to Update

1. **Milestones Log**: Add date + brief entry (one line)
2. **What I'm Learning**: Add any new insights or lessons (bullet points)
3. **Notes & Insights**: Add dated section with detailed breakdown of:
   - Client/project progress
   - Key decisions made
   - Systems built
   - Learnings extracted
   - Next actions identified

Use the current date in "Month Day, Year" format (e.g., "January 4, 2026") for all entries.

---

## Global Versioning System

### CRITICAL: Automatic Versioning for All New Projects

When building ANY new system, automation, agent, workflow, or significant documentation:

**AUTOMATICALLY create a VERSION_LOG.md** in the project folder using the template at:
`/Users/swayclarke/coding_stuff/claude-code-os/VERSION_TEMPLATE.md`

**DO NOT wait for Sway to ask** - proactively create version tracking for all builds.

### What Requires a VERSION_LOG.md

**Always create VERSION_LOG.md for:**
- n8n workflows and automation systems
- New client projects (Eugene, Lombok, etc.)
- Agent prompt templates and skills
- Integration systems (Google, Notion, etc.)
- Any multi-component build with blueprints/exports
- Documentation systems with multiple versions

**When to create it:**
- At project initialization (v0.0.0 draft state)
- BEFORE building the first component
- As part of project setup, not after completion

### Semantic Versioning Rules

**MAJOR.MINOR.PATCH format:**
- **MAJOR (v1.0.0)**: Breaking changes, complete rewrites, major milestones
- **MINOR (v1.1.0)**: New features, enhancements, backward compatible
- **PATCH (v1.0.1)**: Bug fixes, small improvements, refinements

**When to increment:**
- New n8n workflow added = MINOR version
- Workflow node parameter change = PATCH version
- Complete system rewrite = MAJOR version
- Blueprint export at milestone = Document in current version

### VERSION_LOG.md Requirements

**Every VERSION_LOG.md MUST include:**
1. **Quick Reference Table** - Current version, status, date
2. **Versioning Scheme** - MAJOR.MINOR.PATCH definitions
3. **Complete Version History** - All versions with:
   - Components created/modified
   - What works / What doesn't work
   - Known issues and blockers
   - Rollback instructions
   - Files & resources (IDs, URLs, paths)
4. **Component Inventory** - All Google Drive IDs, n8n workflow IDs, Sheet IDs
5. **Rollback Procedures** - Step-by-step for each component type
6. **Blueprint Naming Convention** - How to name exported files

### Blueprint File Naming

**Standard format:** `{component}_v{version}_{date}.json`

**Examples:**
- `chunk0_v1.2_parameterized_20251230.json`
- `test_orchestrator_v1.0_20251230.json`

**Archived files:** `_archived/{component}_v{version}_{date}_ARCHIVED.json`

### Version Update Workflow

**At each milestone:**
1. Export all n8n workflows as JSON to `N8N_Blueprints/v{major}_{phase}/` folder
2. Update VERSION_LOG.md with new version entry
3. Archive old blueprint files to `_archived/` folder
4. Update component inventory with new IDs
5. Document rollback procedures for the new version
6. Test that rollback to previous version works

### Decentralized Architecture

- Each project manages its own VERSION_LOG.md
- No global version index (doesn't scale)
- Use `Glob **/VERSION_LOG.md` to discover all versioned projects
- Generate on-demand reports when Sway asks "show me all versioned projects"

### Integration with MY-JOURNEY.md

When reaching major milestones (v1.0, v2.0, etc.):
- Update VERSION_LOG.md with technical details
- Update MY-JOURNEY.md with business context and learnings
- VERSION_LOG.md = technical rollback and component tracking
- MY-JOURNEY.md = business progress and insights
